## Обзор проекта SurgIl_Dashboard

### Основные подсистемы

- **FastAPI-приложение (`backend/app.py`)**  
  **Роль**: точка входа, создание `FastAPI`‑приложения, подключение middleware сессий, регистрация роутеров документов и оборудования, а также большой монолитный блок бизнес‑логики по пользователям, реагентам и скважинам.  
  **Особенности**: содержит множество эндпойнтов (аутентификация, админка пользователей, учёт реагентов, страницы скважин, API по событиям), значительный объём доменной логики прямо в обработчиках.

- **Слой моделей (`backend/models/*.py`)**  
  **Роль**: описание доменных сущностей через SQLAlchemy (скважины, оборудование, статусы, события, пользователи, реагенты и т.п.).  
  **Ключевые модели**:
  - `wells.py`, `well_status.py`, `well_notes.py`, `well_equipment.py`, `well_channel.py` – всё вокруг скважин и их состояния;
  - `equipment.py` – оборудование, его установки, обслуживание, soft‑delete;
  - `events.py` – события по скважинам (давления, вбросы реагентов, др.);
  - `reagent_catalog.py`, `reagents.py`, `reagent_inventory.py` – каталог реагентов, приходы и остатки;
  - `users.py`, `events.py` (доп. сущности для логов входа, прав и т.п.).

- **Работа с БД (`backend/db.py`, `backend/services/*.py`, `backend/repositories/*.py`)**  
  - `db.py` – создание `SessionLocal`, зависимость `get_db` для FastAPI.
  - `services/`:
    - `well_service.py`, `well_db_load.py` – загрузка/сервисные операции над скважинами;
    - `equipment_loader.py` – загрузка и кэш справочника оборудования (`EQUIPMENT_LIST`, `EQUIPMENT_BY_CODE`);
    - `reagent_balance_service.py` – бизнес‑логика расчёта баланса реагентов;
    - `init_db.py` – инициализация БД.
  - `repositories/reagents_service.py` – репозиторий для операций с приходами реагентов (создание, выборки, агрегации).

- **API-слой (`backend/api/*.py`)**  
  - `api/wells.py` – JSON‑API для списка скважин и получения одной скважины (`/api/wells`, `/api/wells/{id}`).
  - `api/reagents.py` – JSON‑API для прихода реагентов и балансов (`/api/reagents`, `/api/reagents/balance`).
  Эти роутеры инклюдятся в `app.py` и используются фронтендом/внешними интеграциями.

- **Роутеры документов и оборудования (`backend/routers/*.py`)**  
  - `equipment_management.py` – веб‑страницы и API для управления оборудованием: список, детали, создание, перемещение, импорт/экспорт, обслуживание, установки.
  - `equipment_admin.py` – админский диагностический экран по оборудованию и «тестовые» операции.
  - `equipment_documents.py` – генерация и управление актами монтажа/демонтажа оборудования (документы, LaTeX → PDF).
  - `documents_pages.py` – общий модуль по актам: канбан, создание/редактирование, акты расхода реагентов, генерация PDF.
  - `documents_well_handover.py` – акты приёма/передачи скважин (логика дат, подбор давлений по событиям и генерация PDF).
  - `well_equipment_integration.py` – интеграционный роутер, дублирующий значительную часть API по оборудованию, плюс API связи скважин и оборудования.

- **Подсистема документов (`backend/documents/*`)**  
  - `models.py` – типы документов, сами документы, строки документа.
  - `numbering.py` – генерация номеров документов по типу/скважине/периоду.
  - `service.py`, `services/reagent_expense.py` – бизнес‑логика формирования актов, автозаполнение строк по событиям.
  - `outputs/documents_module` и `templates/latex/*.tex` – LaTeX‑шаблоны и генерируемые PDF (вместе с `backend/generated/pdf` и `backend/static/generated/pdf`).

- **Аутентификация и зависимости (`backend/auth.py`, `backend/deps.py`, `backend/settings.py`)**  
  - `auth.py` – хэширование паролей, верификация, функции `get_current_user`, `get_current_user_optional`, `get_reagents_user`.
  - `deps.py` – зависимости FastAPI для получения текущего пользователя/админа.
  - `settings.py` – конфигурация (`APP_TITLE`, секреты сессий и т.д.).

- **Конфигурация оборудования и статусов (`backend/config/*`)**  
  - `equipment_config.py` + `equipment-config.js` – типы оборудования, настройки отображения, справочные данные.
  - `status_registry.py`, `statuses.json` – регистр статусов скважин, CSS‑классы, группировка для сайдбара и фильтрации.

- **Веб‑слой (шаблоны и статика)**  
  - `templates/*.html` – Jinja2‑шаблоны:
    - `auth_base.html` + `login.html`, `register.html` – страница логина/регистрации;
    - `base.html` – базовый лэйаут для внутренних страниц;
    - `visual.html` – дашборд событий/реагентов с таймлайном;
    - `well.html` – страница конкретной скважины с графиком событий;
    - `admin_*` и `admin_reagents*.html` – админка пользователей и учёта реагентов;
    - `equipment_*.html` – управление оборудованием;
    - `documents/*.html` – интерфейс работы с актами и их деталями.
  - `static/css/*.css` – базовый стиль, таблицы, стили аутентификации.
  - `static/js/*.js` – интерактивные графики и таймлайны (см. ниже).

- **Frontend-графики (JS)**  
  - `static/js/visual_timeline.js` – интерактивный таймлайн событий/вбросов для страницы `visual.html`:
    - Chart.js + adapter‑luxon + zoom‑plugin;
    - фильтрация по периодам (`tl_period`, custom‑диапазоны), по реагентам/событиям/статусам/скважинам;
    - кастомные легенды и сохранение пользовательских цветов в `localStorage`.
  - `static/js/reagents.js` – таймлайн и горизонтальная диаграмма остатков реагентов для `admin_reagents.html`:
    - один и тот же набор цветов реагентов для таймлайна и сток‑графика;
    - продвинутые легенды (поиск по реагентам и скважинам, включение/отключение событий).
  - `static/js/well_events_chart.js` – график событий/реагентных операций по одной скважине для `well.html`:
    - точки по количеству вбросов, вертикальные пунктирные линии событий;
    - динамическая шкала времени (автоподбор единицы измерения), zoom/pan;
    - кастомные tooltip’ы с оператором, давлением, геостатусом и описаниями.

- **Миграции и вспомогательные скрипты**  
  - `alembic/` – миграции БД: добавление каталогов реагентов, таблиц оборудования, системы документов.
  - `scripts/fill_reagent_catalog.py`, `scripts/sync_reagent_catalog.py` – наполнение/синхронизация справочника реагентов.
  - `*backup*.dump|.sql` – дампы БД (рабочие/резервные).

### Взаимодействие подсистем

- **Маршрутизация**:  
  - Базовые веб‑страницы и часть API находятся в `app.py`.  
  - Более структурированные области (документы, оборудование) вынесены в отдельные роутеры и подключены через `app.include_router(...)`.

- **Документы ↔ скважины/события**:  
  - `documents_pages.py` и `documents_well_handover.py` активно используют модели `Well`, `WellStatus`, `Event` для:
    - генерации актов по скважинам и периодам;
    - автозаполнения строк документа по событиям (особенно для расхода реагентов).
  - Генерация PDF идёт через LaTeX‑шаблоны в `templates/latex` и вызовы `xelatex` в `documents_*` роутерах.

- **Оборудование ↔ документы ↔ скважины**:  
  - `equipment_management.py` и `equipment_documents.py` совместно управляют состоянием оборудования, его привязкой к скважинам и генерацией актов монтажа/демонтажа.
  - `well_equipment_integration.py` пытается упростить/объединить работу с оборудованием из контекста страницы скважины, но вносит дублирование API.

- **Учёт реагентов**:  
  - UI (`admin_reagents.html`, `admin_reagents_inventory.html`) построен вокруг данных, формируемых в `app.py` и `ReagentBalanceService`, плюс отдельный JSON‑API (`/api/reagents`, `/api/reagents/balance`).
  - JS (`reagents.js`, `visual_timeline.js`, `well_events_chart.js`) отображает историю вбросов (timeline) и текущие остатки, используя данные, отрендеренные в шаблонах из БД.

