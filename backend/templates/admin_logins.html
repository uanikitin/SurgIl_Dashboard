{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ¬∑ –°–µ—Å—Å–∏–∏{% endblock %}

{% block content %}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<div class="admin-page">
    <div class="admin-header-row">
        <div>
            <h1>–°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h1>
            <p class="admin-meta">
                –í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π: {{ total_sessions }} ¬∑
                –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–π—á–∞—Å: {{ active_sessions_count }} ¬∑
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø–µ—Ä–∏–æ–¥: {{ unique_users_count }}
            </p>
        </div>
    </div>

    {# –í–∫–ª–∞–¥–∫–∏: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ / –°–µ—Å—Å–∏–∏ #}
    <div class="admin-tabs">
        <a href="/admin/users" class="admin-tab">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        <a href="/admin/logins" class="admin-tab admin-tab--active">–°–µ—Å—Å–∏–∏</a>
    </div>

    {# –§–∏–ª—å—Ç—Ä—ã #}
    <form method="get" class="sessions-filter">
        <div class="sessions-filter-row">
            <div class="sessions-filter-field">
                <label for="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</label>
                <select name="user" id="user">
                    <option value="">–í—Å–µ</option>
                    {% for u in filter_users %}
                        <option
                            value="{{ u.username }}"
                            {% if u.username == current_filter_user %}selected{% endif %}
                        >
                            {{ u.username }}{% if u.full_name %} ‚Äî {{ u.full_name }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="sessions-filter-field">
                <label for="date_from">–°</label>
                <input
                    type="date"
                    id="date_from"
                    name="date_from"
                    value="{{ date_from or '' }}"
                >
            </div>

            <div class="sessions-filter-field">
                <label for="date_to">–ü–æ</label>
                <input
                    type="date"
                    id="date_to"
                    name="date_to"
                    value="{{ date_to or '' }}"
                >
            </div>

            <div class="sessions-filter-field sessions-filter-field--checkbox">
                <label>
                    <input
                        type="checkbox"
                        name="only_active"
                        value="1"
                        {% if only_active %}checked{% endif %}
                    >
                    –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
                </label>
            </div>

            <div class="sessions-filter-actions">
                <button type="submit" class="admin-pill-btn admin-pill-btn--primary">
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
                <a href="/admin/logins" class="sessions-reset-link">–°–±—Ä–æ—Å–∏—Ç—å</a>
            </div>
        </div>
    </form>

    {# –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ #}
    <div class="sessions-summary-grid">
        <div class="sessions-summary-card">
            <div class="sessions-summary-title">–í—Å–µ–≥–æ —Å–µ—Å—Å–∏–π</div>
            <div class="sessions-summary-value">{{ total_sessions }}</div>
        </div>
        <div class="sessions-summary-card sessions-summary-card--green">
            <div class="sessions-summary-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</div>
            <div class="sessions-summary-value">{{ active_sessions_count }}</div>
        </div>
        <div class="sessions-summary-card sessions-summary-card--blue">
            <div class="sessions-summary-title">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            <div class="sessions-summary-value">{{ unique_users_count }}</div>
        </div>
    </div>

    {# –ì—Ä–∞—Ñ–∏–∫–∏ #}
    <div class="sessions-charts-grid">
        <div class="chart-card">
            <div class="chart-card-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Å—Å–∏–π –ø–æ –¥–Ω—è–º</div>
            <canvas id="sessionsByDateChart"></canvas>
        </div>

        <div class="chart-card">
            <div class="chart-card-title">–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –¥–Ω—è–º</div>
            <canvas id="usersByDateChart"></canvas>
        </div>
    </div>

    {# –¢–∞–±–ª–∏—Ü–∞ —Å–µ—Å—Å–∏–π #}
    <div class="card sessions-table-card">
        <table class="admin-table sessions-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                <th>–í—Ö–æ–¥</th>
                <th>–í—ã—Ö–æ–¥</th>
                <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>IP</th>
                <th>–ë—Ä–∞—É–∑–µ—Ä / –∫–ª–∏–µ–Ω—Ç</th>
            </tr>
            </thead>
            <tbody>
            {% for s in sessions %}
                <tr class="{% if s.is_active %}session-row--active{% endif %}">
                    <td>{{ s.id }}</td>
                    <td>
                        <strong>{{ s.username }}</strong>
                        {% if s.full_name %}
                            <span class="sessions-user-fullname"> ¬∑ {{ s.full_name }}</span>
                        {% endif %}
                    </td>
                    <td>{{ s.login_at }}</td>
                    <td>
                        {% if s.logout_at %}
                            {{ s.logout_at }}
                        {% else %}
                            <span class="session-status-pill session-status-pill--active">
                                –∞–∫—Ç–∏–≤–Ω–∞
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if s.duration_human %}
                            {{ s.duration_human }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        {% if s.is_active %}
                            <span class="session-status-pill session-status-pill--active">
                                –û–Ω–ª–∞–π–Ω
                            </span>
                        {% else %}
                            <span class="session-status-pill session-status-pill--ended">
                                –ó–∞–≤–µ—Ä—à–µ–Ω–∞
                            </span>
                        {% endif %}
                    </td>
                    <td>{{ s.ip_address or "‚Äî" }}</td>
                    <td class="sessions-user-agent">
                        {{ s.user_agent or "‚Äî" }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø—Ä–∏—Ö–æ–¥—è—Ç –∏–∑ –±—ç–∫–µ–Ω–¥–∞ –≤ –≤–∏–¥–µ JSON-—Å—Ç—Ä–æ–∫
    const sessionsByDate = {{ chart_sessions_by_date|safe }};
    const usersByDate    = {{ chart_users_by_date|safe }};

    function buildLineChart(canvasId, labels, values, label) {
        const ctx = document.getElementById(canvasId);
        if (!ctx) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    tension: 0.3,
                    fill: true,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { ticks: { autoSkip: true, maxTicksLimit: 7 } },
                    y: { beginAtZero: true, precision: 0 }
                }
            }
        });
    }

    if (Array.isArray(sessionsByDate)) {
        const labels = sessionsByDate.map(item => item.date);
        const values = sessionsByDate.map(item => item.count);
        buildLineChart('sessionsByDateChart', labels, values, '–°–µ—Å—Å–∏–π –∑–∞ –¥–µ–Ω—å');
    }

    if (Array.isArray(usersByDate)) {
        const labels = usersByDate.map(item => item.date);
        const values = usersByDate.map(item => item.users);
        buildLineChart('usersByDateChart', labels, values, '–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
    }
</script>
{% endblock %}