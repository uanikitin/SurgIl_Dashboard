{% extends "base.html" %}

{% block title %}–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ¬∑ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item active">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<div class="admin-page">
    <div class="admin-header-row">
        <div>
            <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
            <p class="admin-meta">–í –±–∞–∑–µ: {{ total_users }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.</p>
        </div>
    </div>

    <div class="admin-tabs">
        <a href="/admin/users" class="admin-tab admin-tab--active">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
        <a href="/admin/logins" class="admin-tab">–°–µ—Å—Å–∏–∏</a>
    </div>

    <form method="get" class="admin-search">
        <input
            id="user-search"
            type="text"
            name="q"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É –∏–ª–∏ –∏–º–µ–Ω–∏"
            value="{{ q or '' }}"
        >
    </form>

    <div class="card">
        <table id="users-table" class="admin-table">
            <thead>
            <tr>
                <th>ID</th>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–ò–º—è</th>
                <th>E-mail</th>
                <th>–†–æ–ª—å</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
            </tr>
            </thead>
            <tbody id="user-table-body">
            {% for u in users %}
                <tr class="user-row"
                 <tr class="user-row"
                        data-id="{{ u.id }}"
                        data-role="{{ 'admin' if u.is_admin else 'operator' }}"
                        data-active="{{ '1' if u.is_active else '0' }}"
                        data-can-reagents="{{ '1' if u.can_view_reagents else '0' }}">
                    <td>{{ u.id }}</td>
                    <td class="cell-username">{{ u.username }}</td>
                    <td>{{ u.full_name or "‚Äî" }}</td>
                    <td>{{ u.email or "‚Äî" }}</td>
                    <td>{{ "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" if u.is_admin else "–û–ø–µ—Ä–∞—Ç–æ—Ä" }}</td>
                    <td>{{ "–ê–∫—Ç–∏–≤–µ–Ω" if u.is_active else "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" }}</td>
                    <td>{{ u.created_at or "‚Äî" }}</td>
                    <td>{{ u.last_login_at or "‚Äî" }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {# –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π #}
    <div id="user-actions-bar" class="actions-bar hidden">
        <span id="selected-user-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –Ω–µ –≤—ã–±—Ä–∞–Ω</span>

        <form method="post" id="action-admin" action="">
            <button type="submit" class="admin-pill-btn admin-pill-btn--primary">
                –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
            </button>
        </form>

        <form method="post" id="action-active" action="">
            <button type="submit" class="admin-pill-btn admin-pill-btn--warning">
                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </form>

        <form method="post" id="action-delete" action="">
            <button type="submit" class="admin-pill-btn admin-pill-btn--danger"
                    onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?');">
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </form>

        <form method="post" id="action-reagents" action="">
            <button type="submit" class="admin-pill-btn">
                –î–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∞–≥–µ–Ω—Ç–∞–º
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const searchInput = document.getElementById('user-search');
    const table       = document.getElementById('users-table');
    const rows        = table ? Array.from(table.querySelectorAll('tbody tr')) : [];

    // --- –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É / –∏–º–µ–Ω–∏ ---
    if (searchInput && rows.length) {
        searchInput.addEventListener('input', function () {
            const q = this.value.toLowerCase();

            rows.forEach(row => {
                const username = row.querySelector('.cell-username')?.textContent.toLowerCase() || '';
                const name     = row.children[2]?.textContent.toLowerCase() || '';

                if (!q || username.includes(q) || name.includes(q)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }

    // --- –í—ã–±–æ—Ä —Å—Ç—Ä–æ–∫–∏ –∏ –ø–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π ---
        const actionBar     = document.getElementById('user-actions-bar');
    const label         = document.getElementById('selected-user-label');
    const adminForm     = document.getElementById('action-admin');
    const activeForm    = document.getElementById('action-active');
    const deleteForm    = document.getElementById('action-delete');
    const reagentsForm  = document.getElementById('action-reagents');
    const reagentsBtn   = reagentsForm ? reagentsForm.querySelector('button') : null;

    rows.forEach(row => {
        row.addEventListener('click', () => {
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
            rows.forEach(r => r.classList.remove('selected'));

            // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é
            row.classList.add('selected');

            const id       = row.dataset.id;
            const username = row.querySelector('.cell-username')?.textContent || '';
            const roleText = row.children[4].textContent.trim();
            const status   = row.children[5].textContent.trim();
            const canReagents = row.dataset.canReagents === '1';

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å
            label.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ' + username;
            actionBar.classList.remove('hidden');

            // –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º URL –¥–µ–π—Å—Ç–≤–∏–π
            adminForm.action  = `/admin/users/${id}/toggle_admin`;
            activeForm.action = `/admin/users/${id}/toggle_active`;
            deleteForm.action = `/admin/users/${id}/delete`;

            if (reagentsForm) {
                reagentsForm.action = `/admin/users/${id}/toggle-reagents`;
                if (reagentsBtn) {
                    reagentsBtn.textContent = canReagents
                        ? '–ó–∞–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∞–≥–µ–Ω—Ç–∞–º'
                        : '–î–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ–∞–≥–µ–Ω—Ç–∞–º';
                }
            }

            // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
            adminForm.querySelector('button').textContent =
                (roleText === '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä') ? '–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞' : '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º';

            activeForm.querySelector('button').textContent =
                (status === '–ê–∫—Ç–∏–≤–µ–Ω') ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
        });
    });
</script>
{% endblock %}