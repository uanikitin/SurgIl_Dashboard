{# backend/templates/admin_reagents.html - REDESIGNED #}
{% extends "base.html" %}

{% block title %}–û–±–ª—ñ–∫ —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤{% endblock %}

{% block content %}

{# ============================================================
   –ó–û–ù–ê 0: –í–ï–†–•–ù–Ø –ù–ê–í–Ü–ì–ê–¶–Ü–Ø –ü–û –°–ê–ô–¢–£
   ============================================================ #}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item">üìÑ –ê–∫—Ç–∏</a>
    <a href="/admin/reagents" class="top-nav-item active">üß™ –†–µ–∞–≥–µ–Ω—Ç–∏</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</a>
    <a href="/admin/users" class="top-nav-item">üë• –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
  </div>
</nav>

<div class="reagents-dashboard">

{# ============================================================
   HEADER
   ============================================================ #}
<header class="dashboard-header">
  <div class="header-left">
    <a href="/visual" class="back-btn">‚Üê</a>
    <h1>–û–±–ª—ñ–∫ —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤</h1>
  </div>
  <div class="header-right">
    <button class="btn-header" onclick="openImportModal()">üì• –Ü–º–ø–æ—Ä—Ç Excel</button>
    <a href="/admin/reagents/inventory" class="btn-header">üìã –Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è</a>
  </div>
</header>

{# ============================================================
   –ó–û–ù–ê 1: –ì–õ–û–ë–ê–õ–¨–ù–Ü –§–Ü–õ–¨–¢–†–ò (TOP BAR)
   ============================================================ #}
<section class="filters-bar">
  <div class="filter-group">
    <label>üìÖ –ü–µ—Ä—ñ–æ–¥</label>
    <div class="period-btns" id="global-period">
      <button class="period-btn" data-period="week">–¢–∏–∂–¥–µ–Ω—å</button>
      <button class="period-btn active" data-period="month">–ú—ñ—Å—è—Ü—å</button>
      <button class="period-btn" data-period="quarter">–ö–≤–∞—Ä—Ç–∞–ª</button>
    </div>
    <input type="date" id="filter-date-from" class="date-input">
    <span class="date-sep">‚Äî</span>
    <input type="date" id="filter-date-to" class="date-input">
  </div>

  <div class="filter-group">
    <label>üß™ –†–µ–∞–≥–µ–Ω—Ç–∏</label>
    <div class="multi-select" id="ms-reagents">
      <div class="ms-toggle"><span class="ms-text">–£—Å—ñ</span><span class="ms-arrow">‚ñº</span></div>
      <div class="ms-dropdown">
        <div class="ms-actions">
          <button onclick="msSelectAll('ms-reagents')">–£—Å—ñ</button>
          <button onclick="msClearAll('ms-reagents')">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <input type="text" class="ms-search" placeholder="–ü–æ—à—É–∫..." oninput="msFilter(this)">
        <div class="ms-items">
          {% for name in reagent_names %}
          <label><input type="checkbox" value="{{ name }}" checked> {{ name }}</label>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="filter-group">
    <label>üõ¢ –°–∫–≤–∞–∂–∏–Ω–∏</label>
    <div class="multi-select" id="ms-wells">
      <div class="ms-toggle"><span class="ms-text">–£—Å—ñ</span><span class="ms-arrow">‚ñº</span></div>
      <div class="ms-dropdown">
        <div class="ms-actions">
          <button onclick="msSelectAll('ms-wells')">–£—Å—ñ</button>
          <button onclick="msClearAll('ms-wells')">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <input type="text" class="ms-search" placeholder="–ü–æ—à—É–∫..." oninput="msFilter(this)">
        <div class="ms-items">
          {% for w in wells %}
          <label><input type="checkbox" value="{{ w }}" checked> {{ w }}</label>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="filter-group">
    <label>‚öô –°—Ç–∞—Ç—É—Å</label>
    <div class="multi-select" id="ms-statuses">
      <div class="ms-toggle"><span class="ms-text">–£—Å—ñ</span><span class="ms-arrow">‚ñº</span></div>
      <div class="ms-dropdown">
        <div class="ms-actions">
          <button onclick="msSelectAll('ms-statuses')">–£—Å—ñ</button>
          <button onclick="msClearAll('ms-statuses')">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div class="ms-items">
          {% for status in well_statuses %}
          <label><input type="checkbox" value="{{ status }}" checked> {{ status }}</label>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <button class="btn-apply" onclick="applyFilters()">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
</section>

{# ============================================================
   –ó–û–ù–ê 2: KPI –ü–õ–ò–¢–ö–ò
   ============================================================ #}
<section class="kpi-section">
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">üì¶</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ total_stock|round(0)|int }}</div>
        <div class="kpi-label">–°—É–º–∞—Ä–Ω–∏–π –∑–∞–ª–∏—à–æ–∫</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üî•</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ total_used_today|round(1) }}</div>
        <div class="kpi-label">–í–∏—Ç—Ä–∞—Ç–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">üìä</div>
      <div class="kpi-data">
        <div class="kpi-value" id="kpi-avg-daily">‚Äî</div>
        <div class="kpi-label">–°–µ—Ä. –≤–∏—Ç—Ä–∞—Ç–∞/–¥–µ–Ω—å</div>
      </div>
    </div>

    <div class="kpi-card kpi-alert">
      <div class="kpi-icon">‚ö†Ô∏è</div>
      <div class="kpi-data">
        <div class="kpi-value" id="kpi-critical">‚Äî</div>
        <div class="kpi-label">–ö—Ä–∏—Ç–∏—á–Ω–∏—Ö (&lt;7 –¥–Ω.)</div>
      </div>
    </div>

    <div class="kpi-card">
      <div class="kpi-icon">‚è≥</div>
      <div class="kpi-data">
        <div class="kpi-value" id="kpi-nearest-date">‚Äî</div>
        <div class="kpi-label">–ù–∞–π–±–ª–∏–∂—á–µ –≤–∏—á–µ—Ä–ø–∞–Ω–Ω—è</div>
      </div>
    </div>
  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 2.5: –ì–†–ê–§–Ü–ö –ü–û–¢–û–ß–ù–ò–• –ó–ê–õ–ò–®–ö–Ü–í –ù–ê –°–ö–õ–ê–î–Ü
   ============================================================ #}
<section class="stock-chart-section">
  <div class="section-header">
    <h2>üìä –ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥—ñ</h2>
  </div>
  <div class="stock-chart-container">
    <canvas id="chart-stock-current"></canvas>
  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 3: –ü–†–û–ì–ù–û–ó –í–ò–ß–ï–†–ü–ê–ù–ù–Ø (–ü–õ–ò–¢–ö–ò)
   ============================================================ #}
<section class="forecast-section">
  <div class="section-header">
    <h2>–ü—Ä–æ–≥–Ω–æ–∑ –≤–∏—á–µ—Ä–ø–∞–Ω–Ω—è</h2>
    <div class="section-controls">
      <label>Lead time:</label>
      <input type="number" id="lead-days" value="15" min="0" max="60" class="input-mini">
      <span>–¥–Ω.</span>
    </div>
  </div>

  <div class="forecast-legend">
    <span class="legend-item"><span class="dot dot-critical"></span> –ö—Ä–∏—Ç–∏—á–Ω–æ (‚â§7 –¥–Ω.)</span>
    <span class="legend-item"><span class="dot dot-warning"></span> –£–≤–∞–≥–∞ (‚â§30 –¥–Ω.)</span>
    <span class="legend-item"><span class="dot dot-ok"></span> –ù–æ—Ä–º–∞</span>
    <span class="legend-item"><span class="dot dot-nodata"></span> –ë–µ–∑ —Ä–æ–∑—Ö–æ–¥—É</span>
  </div>

  <div class="forecast-grid" id="forecast-grid">
    <div class="loading-placeholder">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 4: –ü–õ–ê–ù–£–í–ê–ù–ù–Ø –ó–ê–ö–£–ü–ö–ò
   ============================================================ #}
<section class="procurement-section">
  <div class="section-header">
    <h2>–ü–ª–∞–Ω—É–≤–∞–Ω–Ω—è –∑–∞–∫—É–ø–∫–∏</h2>
    <span class="tooltip-icon" data-tooltip="–†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ø–æ—Ç—Ä–µ–±–∏ –≤ —Ä–µ–∞–≥–µ–Ω—Ç–∞—Ö –Ω–∞ –∑–∞–¥–∞–Ω–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∑–∞–ª–∏—à–∫—É —Ç–∞ —Å–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Ä–æ–∑—Ö–æ–¥—É">‚ÑπÔ∏è</span>
  </div>

  <div class="procurement-controls">
    <div class="control-group">
      <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç:
        <span class="tooltip-icon" data-tooltip="–ù–∞ —Å–∫—ñ–ª—å–∫–∏ –¥–Ω—ñ–≤ –≤–ø–µ—Ä–µ–¥ –∑–∞–±–µ–∑–ø–µ—á–∏—Ç–∏ –∑–∞–ø–∞—Å —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤">‚ÑπÔ∏è</span>
      </label>
      <div class="horizon-btns">
        <button class="horizon-btn" data-days="30">30 –¥–Ω.</button>
        <button class="horizon-btn active" data-days="60">60 –¥–Ω.</button>
        <button class="horizon-btn" data-days="90">90 –¥–Ω.</button>
      </div>
      <input type="number" id="target-days" value="60" min="1" max="365" class="input-mini">
    </div>

    <div class="control-group">
      <label>Lead time:
        <span class="tooltip-icon" data-tooltip="–ß–∞—Å –¥–æ—Å—Ç–∞–≤–∫–∏: –∑–∞ —Å–∫—ñ–ª—å–∫–∏ –¥–Ω—ñ–≤ –¥–æ –≤–∏—á–µ—Ä–ø–∞–Ω–Ω—è –ø–æ—Ç—Ä—ñ–±–Ω–æ –∑–∞–º–æ–≤–∏—Ç–∏">‚ÑπÔ∏è</span>
      </label>
      <input type="number" id="proc-lead-days" value="15" min="0" max="60" class="input-mini">
      <span>–¥–Ω.</span>
    </div>

    <div class="control-group">
      <label>–ú–µ—Ç–æ–¥:
        <span class="tooltip-icon" data-tooltip="A: –≤—ñ–¥ –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –¥–æ 0; B: –∑–∞ –ø–æ–¥—ñ—è–º–∏ –≤–∏—Ç—Ä–∞—Ç–∏; C: –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó">‚ÑπÔ∏è</span>
      </label>
      <select id="calc-method" class="input-mini" style="width:auto;">
        <option value="events" selected>–ü–æ –≤–∏—Ç—Ä–∞—Ç–∞—Ö</option>
        <option value="supply">–ü–æ –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—é</option>
        <option value="inventory">–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è</option>
      </select>
    </div>

    <div class="control-group">
      <label>–®–≤–∏–¥–∫–∏–π –≤–∏–±—ñ—Ä:</label>
      <button class="btn-sm" onclick="selectByRisk('critical')">–ö—Ä–∏—Ç–∏—á–Ω—ñ</button>
      <button class="btn-sm" onclick="selectByRisk('warning')">–£–≤–∞–≥–∞</button>
      <button class="btn-sm" onclick="selectByRisk('all')">–£—Å—ñ</button>
    </div>

    <div class="control-group">
      <label class="checkbox-label">
        <input type="checkbox" id="include-depleted">
        –í–∫–ª—é—á–∞—Ç–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω—ñ
        <span class="tooltip-icon" data-tooltip="–ü–æ–∫–∞–∑–∞—Ç–∏ —Ä–µ–∞–≥–µ–Ω—Ç–∏ –∑ –∑–∞–ª–∏—à–∫–æ–º 0, —è–∫—â–æ —î —ñ—Å—Ç–æ—Ä—ñ—è —Å–ø–æ–∂–∏–≤–∞–Ω–Ω—è">‚ÑπÔ∏è</span>
      </label>
    </div>

    <div class="control-group control-right">
      <button class="btn-primary" onclick="calculateProcurement()">–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
      <button class="btn-secondary" onclick="exportProcurementSelected()" id="btn-export" disabled>üì• Excel (–≤–∏–±—Ä–∞–Ω—ñ)</button>
    </div>
  </div>

  <div class="procurement-table-wrap" id="procurement-wrap" style="display: none;">
    <table class="data-table" id="procurement-table">
      <thead>
        <tr>
          <th class="col-check"><input type="checkbox" id="proc-check-all" onchange="toggleAllProc(this)"></th>
          <th>–†–µ–∞–≥–µ–Ω—Ç</th>
          <th class="col-num">–ó–∞–ª–∏—à–æ–∫</th>
          <th class="col-num">–°–µ—Ä./–¥–µ–Ω—å</th>
          <th class="col-num">–î–Ω—ñ–≤</th>
          <th class="col-num">–ü–æ—Ç—Ä—ñ–±–Ω–æ</th>
          <th class="col-num">–ó–∞–º–æ–≤–∏—Ç–∏</th>
          <th class="col-date">–ó–∞–º–æ–≤–∏—Ç–∏ –¥–æ</th>
          <th class="col-status">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç</th>
          <th>–ú–µ—Ç–æ–¥</th>
        </tr>
      </thead>
      <tbody id="procurement-body"></tbody>
    </table>
  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 5: –ê–ù–ê–õ–Ü–¢–ò–ö–ê (2 –ö–û–õ–û–ù–ö–ò)
   ============================================================ #}
<section class="analytics-section">
  <div class="analytics-grid">

    {# 5.1 –î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ö—ñ–¥ #}
    <div class="analytics-card">
      <div class="card-header">
        <h3>–î–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ö—ñ–¥ –∑–∞ –ø–µ—Ä—ñ–æ–¥</h3>
        <div class="card-controls">
          <label class="toggle-label">
            <input type="checkbox" id="toggle-daily-labels" checked onchange="toggleDailyLabels()">
            <span>–ü—ñ–¥–ø–∏—Å–∏</span>
          </label>
        </div>
      </div>
      <div class="card-summary" id="details-summary" style="display: none;">
        <div class="summary-item">
          <span class="sum-label">–ó–∞–≥–∞–ª—å–Ω–∞ –≤–∏—Ç—Ä–∞—Ç–∞:</span>
          <span class="sum-value" id="sum-total-qty">0</span>
        </div>
        <div class="summary-item">
          <span class="sum-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≤–±—Ä–æ—Å—ñ–≤:</span>
          <span class="sum-value" id="sum-total-count">0</span>
        </div>
        <div class="summary-item">
          <span class="sum-label">–ú–∞–∫—Å/–¥–æ–±—É:</span>
          <span class="sum-value" id="sum-max-day">0</span>
        </div>
        <div class="summary-item">
          <span class="sum-label">–°–µ—Ä/–¥–æ–±—É:</span>
          <span class="sum-value" id="sum-avg-day">0</span>
        </div>
        <div class="summary-item">
          <span class="sum-label">–ú–µ–¥—ñ–∞–Ω–∞/–¥–æ–±—É:</span>
          <span class="sum-value" id="sum-median-day">0</span>
        </div>
      </div>
      <div class="chart-controls-bar">
        <button class="zoom-btn" onclick="zoomDailyChartX(1.2)" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–∞—Ç">+</button>
        <button class="zoom-btn" onclick="zoomDailyChartX(0.8)" title="–ó–º–µ–Ω—à–∏—Ç–∏ –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–∞—Ç">‚àí</button>
        <button class="zoom-btn" onclick="resetDailyZoom()" title="–°–∫–∏–Ω—É—Ç–∏">‚Ü∫</button>
        <span class="zoom-hint">Drag –¥–ª—è –≤–∏–±–æ—Ä—É –¥—ñ–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç</span>
      </div>
      <div class="chart-legend" id="legend-daily"></div>
      <div class="chart-container">
        <canvas id="chart-daily"></canvas>
      </div>
    </div>

    {# 5.2 –í–∏—Ç—Ä–∞—Ç–∏ –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞—Ö #}
    <div class="analytics-card">
      <div class="card-header">
        <h3>–í–∏—Ç—Ä–∞—Ç–∏ –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞—Ö</h3>
        <div class="card-controls">
          <label class="toggle-label">
            <input type="checkbox" id="toggle-wells-labels" checked onchange="toggleWellsLabels()">
            <span>–ü—ñ–¥–ø–∏—Å–∏</span>
          </label>
        </div>
      </div>
      <div class="wells-filter-panel">
        <div class="wells-filter-actions">
          <button class="btn-xs" onclick="selectAllChartWells(true)">–£—Å—ñ</button>
          <button class="btn-xs" onclick="selectAllChartWells(false)">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        </div>
        <div class="wells-checkboxes" id="wells-chart-filter">
          <!-- –±—É–¥–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–æ JS -->
        </div>
      </div>
      <div class="chart-legend" id="legend-wells"></div>
      <div class="chart-container chart-horizontal">
        <canvas id="chart-wells"></canvas>
      </div>
    </div>

  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 6: –Ü–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–Ü–Ø (–®–í–ò–î–ö–ê –§–û–†–ú–ê)
   ============================================================ #}
<section class="inventory-section">
  <div class="section-header">
    <h2>üìã –Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤</h2>
    <div class="section-header-actions">
      <span class="tooltip-icon" data-tooltip="–í–≤–µ–¥—ñ—Ç—å —Ñ–∞–∫—Ç–∏—á–Ω–∏–π –∑–∞–ª–∏—à–æ–∫ –¥–ª—è –∫–æ—Ä–µ–∫—Ü—ñ—ó –æ–±–ª—ñ–∫—É. –°–∏—Å—Ç–µ–º–∞ –ø–æ—Ä—ñ–≤–Ω—è—î –∑ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–æ–≤–∏–º —ñ –∑–±–µ—Ä–µ–∂–µ —Ä–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å.">‚ÑπÔ∏è</span>
      <button class="btn-sm btn-outline" onclick="openInventoryImportModal()">üì• –Ü–º–ø–æ—Ä—Ç –∑ Excel</button>
    </div>
  </div>

  <form id="inventory-form" class="inventory-form" onsubmit="submitInventory(event)">
    <div class="form-row">
      <div class="form-field">
        <label>–î–∞—Ç–∞/—á–∞—Å *</label>
        <input type="datetime-local" name="snapshot_at" id="inv-date" required>
      </div>
      <div class="form-field">
        <label>–†–µ–∞–≥–µ–Ω—Ç *</label>
        <select name="reagent" id="inv-reagent" required onchange="loadExpectedQty()">
          <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
          {% for r in reagent_catalog %}
          <option value="{{ r.name }}">{{ r.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field">
        <label>–§–∞–∫—Ç. –∫—ñ–ª—å–∫—ñ—Å—Ç—å *</label>
        <input type="number" step="0.001" name="qty" id="inv-qty" required>
      </div>
      <div class="form-field">
        <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
        <input type="text" name="comment" id="inv-comment" placeholder="–ü—Ä–∏—á–∏–Ω–∞ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ">
      </div>
      <div class="form-field">
        <button type="submit" class="btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      </div>
    </div>
  </form>

  <div id="inventory-result" class="inventory-result" style="display:none;">
    <div class="result-row">
      <span class="result-label">–û—á—ñ–∫—É–≤–∞–ª–æ—Å—å:</span>
      <span class="result-value" id="inv-expected">‚Äî</span>
    </div>
    <div class="result-row">
      <span class="result-label">–§–∞–∫—Ç:</span>
      <span class="result-value" id="inv-actual">‚Äî</span>
    </div>
    <div class="result-row">
      <span class="result-label">–†–æ–∑–±—ñ–∂–Ω—ñ—Å—Ç—å:</span>
      <span class="result-value" id="inv-discrepancy">‚Äî</span>
      <span class="discrepancy-badge" id="inv-badge"></span>
    </div>
  </div>
</section>

{# ============================================================
   –ó–û–ù–ê 7: –¢–ê–ë–õ–ò–¶–Ø –í–°–Ü–• –†–ï–ê–ì–ï–ù–¢–Ü–í (–í–ö–õ–Æ–ß–ù–û –ó 0)
   ============================================================ #}
<section class="all-reagents-section">
  <div class="section-header">
    <h2>üì¶ –£—Å—ñ —Ä–µ–∞–≥–µ–Ω—Ç–∏</h2>
    <span class="section-subtitle">–í–∫–ª—é—á–∞—é—á–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω—ñ</span>
  </div>

  <div class="table-controls">
    <input type="text" id="reagent-search" class="search-input" placeholder="üîç –ü–æ—à—É–∫ —Ä–µ–∞–≥–µ–Ω—Ç–∞..." oninput="filterReagentsTable()">
    <label class="checkbox-label">
      <input type="checkbox" id="show-zero-only" onchange="filterReagentsTable()">
      –¢—ñ–ª—å–∫–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω—ñ
    </label>
  </div>

  <div class="all-reagents-table-wrap">
    <table class="data-table" id="all-reagents-table">
      <thead>
        <tr>
          <th>–†–µ–∞–≥–µ–Ω—Ç</th>
          <th>–û–¥.</th>
          <th class="col-num">–ó–∞–ª–∏—à–æ–∫</th>
          <th class="col-num">–°–µ—Ä./–¥–µ–Ω—å</th>
          <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
          <th class="col-date">–î–∞—Ç–∞ –≤–∏—á–µ—Ä–ø–∞–Ω–Ω—è</th>
        </tr>
      </thead>
      <tbody id="all-reagents-body">
        {% for r in reagents %}
        <tr class="reagent-row {% if r.stock <= 0 %}depleted{% endif %}" data-name="{{ r.name|lower }}">
          <td>
            <span class="fc-color" style="background:{{ reagent_colors.get(r.name, '#999') }};display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;"></span>
            {{ r.name }}
          </td>
          <td>{{ r.unit or '—à—Ç' }}</td>
          <td class="col-num {% if r.stock <= 0 %}text-danger{% endif %}">{{ r.stock|round(2) }}</td>
          <td class="col-num">{{ r.avg_daily|round(3) }}</td>
          <td class="col-status">
            {% if r.stock > 0 %}
              <span class="status-badge status-ok">–í –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ</span>
            {% else %}
              <span class="status-badge status-depleted">–ó–∞–∫—ñ–Ω—á–∏–≤—Å—è</span>
            {% endif %}
          </td>
          <td class="col-date">
            {% if r.stock <= 0 %}
              {% if r.last_inventory_date %}
                {{ r.last_inventory_date.strftime('%d.%m.%Y') if r.last_inventory_date else '‚Äî' }}
              {% else %}
                ‚Äî
              {% endif %}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

{# ============================================================
   –§–û–†–ú–ê –î–û–î–ê–í–ê–ù–ù–Ø (—Å—Ö–æ–≤–∞–Ω–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º)
   ============================================================ #}
<section class="add-section collapsed" id="add-section">
  <div class="section-header clickable" onclick="toggleAddForm()">
    <h2>‚ûï –î–æ–¥–∞—Ç–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–Ω—è</h2>
    <span class="toggle-icon" id="add-toggle">‚ñº</span>
  </div>
  <div class="add-form-wrap" id="add-form-wrap">
    <form method="post" action="/admin/reagents/add" class="add-form">
      <div class="form-row">
        <div class="form-field">
          <label>–†–µ–∞–≥–µ–Ω—Ç *</label>
          <select name="reagent" required>
            <option value="">-- –û–±–µ—Ä—ñ—Ç—å --</option>
            {% for r in reagent_catalog %}
            <option value="{{ r.name }}" data-unit="{{ r.default_unit }}">{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label>–ö—ñ–ª—å–∫—ñ—Å—Ç—å *</label>
          <input type="number" step="0.001" name="qty" required>
        </div>
        <div class="form-field">
          <label>–û–¥–∏–Ω–∏—Ü—è</label>
          <input type="text" name="unit" value="—à—Ç">
        </div>
        <div class="form-field">
          <label>–î–∞—Ç–∞</label>
          <input type="datetime-local" name="received_at">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>–î–∂–µ—Ä–µ–ª–æ</label>
          <input type="text" name="source" placeholder="–°–∫–ª–∞–¥">
        </div>
        <div class="form-field">
          <label>–ú—ñ—Å—Ü–µ</label>
          <input type="text" name="location" placeholder="–ö—É—Å—Ç">
        </div>
        <div class="form-field wide">
          <label>–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
          <input type="text" name="comment">
        </div>
        <div class="form-field">
          <button type="submit" class="btn-primary">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        </div>
      </div>
    </form>
  </div>
</section>

</div>

{# ============================================================
   –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –Ü–ú–ü–û–†–¢–£ EXCEL
   ============================================================ #}
<div id="import-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üì• –Ü–º–ø–æ—Ä—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω—å –∑ Excel</h3>
      <button class="modal-close" onclick="closeImportModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="import-instructions">
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ Excel-—Ñ–∞–π–ª –∑ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–Ω—è–º–∏ —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤.</p>
        <p><strong>–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏:</strong> record_type, date, reagent, qty</p>
        <a href="/api/reagents/import/template/supplies" class="btn-sm">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω</a>
      </div>

      <div class="import-dropzone" id="import-dropzone">
        <input type="file" id="import-file" accept=".xlsx,.xls" onchange="handleImportFile(this)">
        <div class="dropzone-content">
          <span class="dropzone-icon">üìÅ</span>
          <span>–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É</span>
        </div>
      </div>

      <div id="import-preview" class="import-preview" style="display:none;">
        <h4>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</h4>
        <div class="preview-stats">
          <span class="stat-item stat-valid">‚úì –í–∞–ª—ñ–¥–Ω–∏—Ö: <strong id="valid-count">0</strong></span>
          <span class="stat-item stat-error">‚úó –ü–æ–º–∏–ª–æ–∫: <strong id="error-count">0</strong></span>
        </div>
        <div class="preview-errors" id="preview-errors" style="display:none;">
          <h5>–ü–æ–º–∏–ª–∫–∏:</h5>
          <ul id="error-list"></ul>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeImportModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn-primary" id="btn-import" onclick="executeImport()" disabled>–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

{# ============================================================
   –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –Ü–ú–ü–û–†–¢–£ –Ü–ù–í–ï–ù–¢–ê–†–ò–ó–ê–¶–Ü–á
   ============================================================ #}
<div id="inventory-import-modal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>üìã –Ü–º–ø–æ—Ä—Ç —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó –∑ Excel</h3>
      <button class="modal-close" onclick="closeInventoryImportModal()">√ó</button>
    </div>
    <div class="modal-body">
      <div class="import-instructions">
        <p>–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ Excel-—Ñ–∞–π–ª –∑ –¥–∞–Ω–∏–º–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó.</p>
        <p><strong>–û–±–æ–≤'—è–∑–∫–æ–≤—ñ –∫–æ–ª–æ–Ω–∫–∏:</strong> reagent, qty</p>
        <p><strong>–û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ:</strong> snapshot_at, unit, comment</p>
        <a href="/api/reagents/import/template/inventory" class="btn-sm">üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω</a>
      </div>

      <div class="import-dropzone" id="inventory-import-dropzone">
        <input type="file" id="inventory-import-file" accept=".xlsx,.xls" onchange="handleInventoryImportFile(this)">
        <div class="dropzone-content">
          <span class="dropzone-icon">üìÅ</span>
          <span>–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å —Ñ–∞–π–ª –∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É</span>
        </div>
      </div>

      <div id="inventory-import-preview" class="import-preview" style="display:none;">
        <h4>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</h4>
        <div class="preview-stats">
          <span class="stat-item stat-valid">‚úì –í–∞–ª—ñ–¥–Ω–∏—Ö: <strong id="inv-valid-count">0</strong></span>
          <span class="stat-item stat-error">‚úó –ü–æ–º–∏–ª–æ–∫: <strong id="inv-error-count">0</strong></span>
        </div>
        <div class="preview-errors" id="inv-preview-errors" style="display:none;">
          <h5>–ü–æ–º–∏–ª–∫–∏:</h5>
          <ul id="inv-error-list"></ul>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeInventoryImportModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn-primary" id="btn-inv-import" onclick="executeInventoryImport()" disabled>–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏</button>
    </div>
  </div>
</div>

{# ============================================================
   STYLES
   ============================================================ #}
<style>
/* === CSS VARIABLES (DESIGN TOKENS) === */
:root {
  /* Backgrounds */
  --bg-page: #f5f7fa;
  --bg-card: #ffffff;
  --bg-card-alt: #f8fafc;
  --bg-header: #f9fafb;

  /* Text Colors */
  --text-primary: #1a1a2e;
  --text-secondary: #475569;
  --text-muted: #64748b;
  --text-inverse: #ffffff;

  /* Accent Colors */
  --accent-primary: #3b82f6;
  --accent-primary-hover: #2563eb;
  --accent-success: #22c55e;
  --accent-warning: #f59e0b;
  --accent-danger: #ef4444;

  /* Badge Colors */
  --badge-critical-bg: #fef2f2;
  --badge-critical-text: #dc2626;
  --badge-warning-bg: #fffbeb;
  --badge-warning-text: #d97706;
  --badge-ok-bg: #f0fdf4;
  --badge-ok-text: #16a34a;
  --badge-nodata-bg: #f1f5f9;
  --badge-nodata-text: #64748b;

  /* Borders & Shadows */
  --border-light: #e5e7eb;
  --border-medium: #d1d5db;
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.08);

  /* Radii */
  --radius-sm: 4px;
  --radius-md: 6px;
  --radius-lg: 10px;
}

/* === TOP NAVIGATION === */
.top-nav {
  background: var(--bg-card);
  border-bottom: 1px solid var(--border-light);
  padding: 0;
  margin-bottom: 0;
  position: sticky;
  top: 0;
  z-index: 1000;
}

.top-nav-inner {
  max-width: 1600px;
  margin: 0 auto;
  display: flex;
  gap: 0;
  padding: 0 20px;
}

.top-nav-item {
  padding: 12px 20px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  text-decoration: none;
  border-bottom: 2px solid transparent;
  transition: all 0.15s;
}

.top-nav-item:hover {
  color: var(--accent-primary);
  background: var(--bg-card-alt);
}

.top-nav-item.active {
  color: var(--accent-primary);
  border-bottom-color: var(--accent-primary);
  background: var(--bg-card-alt);
}

/* === RESET & BASE === */
.reagents-dashboard {
  max-width: 1600px;
  margin: 0 auto;
  padding: 0 20px 40px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text-primary);
  background: var(--bg-page);
  min-height: 100vh;
}

/* === HEADER === */
.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  border-bottom: 1px solid #e0e4e8;
  margin-bottom: 20px;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.back-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  text-decoration: none;
  color: #666;
  font-size: 18px;
}

.back-btn:hover {
  background: #f0f0f0;
}

.dashboard-header h1 {
  margin: 0;
  font-size: 22px;
  font-weight: 600;
  color: #1a1a2e;
}

.btn-header {
  padding: 8px 16px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  text-decoration: none;
  color: #333;
  font-size: 13px;
}

.btn-header:hover {
  background: #f8f8f8;
}

/* === FILTERS BAR === */
.filters-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  align-items: flex-end;
  padding: 16px 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  margin-bottom: 20px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.filter-group label {
  font-size: 11px;
  font-weight: 600;
  color: #666;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.period-btns {
  display: flex;
  gap: 4px;
}

.period-btn {
  padding: 6px 12px;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s;
}

.period-btn:hover {
  border-color: #3b82f6;
  color: #3b82f6;
}

.period-btn.active {
  background: #3b82f6;
  border-color: #3b82f6;
  color: #fff;
}

.date-input {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  width: 130px;
}

.date-sep {
  color: #999;
  padding: 0 4px;
}

.btn-apply {
  padding: 8px 20px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  margin-left: auto;
}

.btn-apply:hover {
  background: #2563eb;
}

/* === MULTI-SELECT === */
.multi-select {
  position: relative;
  min-width: 140px;
}

.ms-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  min-height: 32px;
}

.ms-toggle:hover {
  border-color: #3b82f6;
}

.ms-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 100px;
}

.ms-arrow {
  font-size: 10px;
  color: #999;
}

.ms-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 100;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  margin-top: 4px;
}

.ms-dropdown.open {
  display: block;
}

.ms-actions {
  display: flex;
  gap: 4px;
  padding: 8px;
  border-bottom: 1px solid #eee;
}

.ms-actions button {
  flex: 1;
  padding: 4px 8px;
  border: 1px solid #ddd;
  background: #f8f8f8;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
}

.ms-search {
  width: calc(100% - 16px);
  margin: 8px;
  padding: 6px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 12px;
}

.ms-items {
  max-height: 200px;
  overflow-y: auto;
  padding: 4px 8px 8px;
}

.ms-items label {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 6px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  font-weight: normal;
  text-transform: none;
  letter-spacing: 0;
}

.ms-items label:hover {
  background: #f0f4f8;
}

/* === KPI SECTION === */
.kpi-section {
  margin-bottom: 20px;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
}

@media (max-width: 1200px) {
  .kpi-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.kpi-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 20px;
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.kpi-card.kpi-alert {
  background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
  border-left: 3px solid #ef4444;
}

.kpi-icon {
  font-size: 28px;
  opacity: 0.9;
}

.kpi-data {
  display: flex;
  flex-direction: column;
}

.kpi-value {
  font-size: 26px;
  font-weight: 700;
  color: #1a1a2e;
  line-height: 1.1;
}

.kpi-label {
  font-size: 12px;
  color: #666;
  margin-top: 2px;
}

/* === FORECAST SECTION === */
.forecast-section {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.section-header h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #1a1a2e;
}

.section-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: #666;
}

.input-mini {
  width: 60px;
  padding: 4px 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 13px;
  text-align: center;
}

.forecast-legend {
  display: flex;
  gap: 20px;
  margin-bottom: 16px;
  font-size: 12px;
  color: #666;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.dot-critical { background: #ef4444; }
.dot-warning { background: #f59e0b; }
.dot-ok { background: #22c55e; }
.dot-nodata { background: #94a3b8; }

.forecast-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 12px;
}

.loading-placeholder {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px;
  color: #999;
}

/* === FORECAST CARD === */
.forecast-card {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
  background: #fff;
  transition: box-shadow 0.2s;
}

.forecast-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.forecast-card.status-critical {
  border-left: 3px solid #ef4444;
}

.forecast-card.status-warning {
  border-left: 3px solid #f59e0b;
}

.forecast-card.status-ok {
  border-left: 3px solid #22c55e;
}

.forecast-card.status-nodata {
  border-left: 3px solid #94a3b8;
}

.fc-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
}

.fc-name {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 13px;
  color: #1a1a2e;
}

.fc-color {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.fc-badge {
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 500;
}

.fc-badge.critical {
  background: #fef2f2;
  color: #dc2626;
}

.fc-badge.warning {
  background: #fffbeb;
  color: #d97706;
}

.fc-badge.ok {
  background: #f0fdf4;
  color: #16a34a;
}

.fc-badge.nodata {
  background: #f1f5f9;
  color: #64748b;
}

.fc-body {
  padding: 12px;
}

.fc-row {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  padding: 4px 0;
}

.fc-row .label {
  color: #64748b;
}

.fc-row .value {
  font-weight: 500;
  color: #1a1a2e;
}

.fc-row.highlight {
  background: #f0f7ff;
  margin: 4px -12px;
  padding: 8px 12px;
}

.fc-row.highlight .value {
  font-size: 16px;
  font-weight: 700;
  color: #1e40af;
}

.fc-footer {
  padding: 8px 12px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  font-size: 11px;
  color: #64748b;
  cursor: pointer;
}

.fc-footer:hover {
  background: #f1f5f9;
}

.fc-consumers {
  display: none;
  padding: 8px 12px;
  background: #f9fafb;
  border-top: 1px solid #e5e7eb;
  font-size: 11px;
}

.fc-consumers.open {
  display: block;
}

.consumer-row {
  display: flex;
  justify-content: space-between;
  padding: 3px 0;
}

/* === PROCUREMENT SECTION === */
.procurement-section {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.procurement-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  align-items: flex-end;
  margin-bottom: 16px;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
}

.control-group label {
  color: #666;
  font-weight: 500;
}

.control-right {
  margin-left: auto;
}

.horizon-btns {
  display: flex;
  gap: 4px;
}

.horizon-btn {
  padding: 6px 12px;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

.horizon-btn.active {
  background: #3b82f6;
  border-color: #3b82f6;
  color: #fff;
}

.btn-sm {
  padding: 6px 12px;
  border: 1px solid #ddd;
  background: #fff;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
}

.btn-sm:hover {
  background: #f8f8f8;
}

.btn-primary {
  padding: 8px 18px;
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-secondary {
  padding: 8px 18px;
  background: #fff;
  color: #333;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
}

.btn-secondary:hover {
  background: #f8f8f8;
}

.btn-secondary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.procurement-table-wrap {
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.data-table th {
  background: #f8fafc;
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  color: #475569;
  border-bottom: 2px solid #e2e8f0;
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid #e2e8f0;
}

.data-table tbody tr:hover {
  background: #f8fafc;
}

.data-table .col-check { width: 40px; text-align: center; }
.data-table .col-num { text-align: right; }
.data-table .col-date { text-align: center; }
.data-table .col-status { text-align: center; }

.row-critical {
  background: #fef2f2 !important;
}

.row-warning {
  background: #fffbeb !important;
}

.priority-badge {
  display: inline-block;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 500;
}

.priority-high {
  background: #fef2f2;
  color: #dc2626;
}

.priority-medium {
  background: #fffbeb;
  color: #d97706;
}

.priority-low {
  background: #f1f5f9;
  color: #64748b;
}

/* === ANALYTICS SECTION === */
.analytics-section {
  margin-bottom: 20px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

@media (max-width: 1024px) {
  .analytics-grid {
    grid-template-columns: 1fr;
  }
}

.analytics-card {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  overflow: hidden;
}

.card-header {
  padding: 14px 18px;
  border-bottom: 1px solid #e5e7eb;
}

.card-header h3 {
  margin: 0;
  font-size: 14px;
  font-weight: 600;
  color: #1a1a2e;
}

.card-summary {
  display: flex;
  gap: 24px;
  padding: 12px 18px;
  background: #f8fafc;
  border-bottom: 1px solid #e5e7eb;
}

.summary-item {
  display: flex;
  gap: 8px;
  font-size: 13px;
}

.sum-label {
  color: #64748b;
}

.sum-value {
  font-weight: 600;
  color: #1a1a2e;
}

.chart-container {
  padding: 16px;
  height: 280px;
}

.chart-horizontal {
  height: 320px;
}

/* === ADD SECTION === */
.add-section {
  background: #fff;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  overflow: hidden;
}

.add-section .section-header {
  padding: 14px 20px;
  margin: 0;
  border-bottom: 1px solid #e5e7eb;
}

.add-section .section-header.clickable {
  cursor: pointer;
}

.add-section .section-header.clickable:hover {
  background: #f8fafc;
}

.toggle-icon {
  font-size: 12px;
  color: #999;
  transition: transform 0.2s;
}

.add-section.collapsed .toggle-icon {
  transform: rotate(-90deg);
}

.add-form-wrap {
  padding: 20px;
  display: none;
}

.add-section:not(.collapsed) .add-form-wrap {
  display: block;
}

.add-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.form-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.form-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 150px;
}

.form-field.wide {
  flex: 2;
}

.form-field label {
  font-size: 12px;
  font-weight: 500;
  color: #666;
}

.form-field input,
.form-field select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 14px;
}

.form-field input:focus,
.form-field select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* === UTILITIES === */
.text-danger { color: var(--accent-danger) !important; }
.text-bold { font-weight: 700; }

/* === STOCK CHART SECTION === */
.stock-chart-section {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.stock-chart-container {
  height: 200px;
  max-height: 250px;
}

/* === TOOLTIPS === */
.tooltip-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 18px;
  height: 18px;
  font-size: 12px;
  cursor: help;
  position: relative;
  vertical-align: middle;
  margin-left: 4px;
}

.tooltip-icon::after {
  content: attr(data-tooltip);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--text-primary);
  color: var(--text-inverse);
  padding: 8px 12px;
  border-radius: var(--radius-md);
  font-size: 11px;
  font-weight: 400;
  white-space: normal;
  width: 220px;
  text-align: left;
  line-height: 1.4;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s, visibility 0.2s;
  pointer-events: none;
  box-shadow: var(--shadow-md);
}

.tooltip-icon:hover::after {
  opacity: 1;
  visibility: visible;
}

/* === CHECKBOX LABEL === */
.checkbox-label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
}

/* === INVENTORY SECTION === */
.inventory-section {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.inventory-form {
  margin-top: 16px;
}

.inventory-result {
  margin-top: 16px;
  padding: 16px;
  background: var(--bg-card-alt);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
}

.result-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 6px 0;
}

.result-label {
  color: var(--text-muted);
  font-size: 13px;
  min-width: 100px;
}

.result-value {
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
}

.discrepancy-badge {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 500;
  margin-left: 8px;
}

.discrepancy-badge.shortage {
  background: var(--badge-critical-bg);
  color: var(--badge-critical-text);
}

.discrepancy-badge.surplus {
  background: var(--badge-ok-bg);
  color: var(--badge-ok-text);
}

.discrepancy-badge.match {
  background: var(--badge-nodata-bg);
  color: var(--badge-nodata-text);
}

/* === ALL REAGENTS SECTION === */
.all-reagents-section {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
}

.section-subtitle {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 400;
  margin-left: 8px;
}

.table-controls {
  display: flex;
  gap: 16px;
  align-items: center;
  margin-bottom: 16px;
}

.search-input {
  padding: 8px 12px;
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-md);
  font-size: 13px;
  width: 250px;
}

.search-input:focus {
  outline: none;
  border-color: var(--accent-primary);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.all-reagents-table-wrap {
  overflow-x: auto;
  max-height: 400px;
  overflow-y: auto;
}

.reagent-row.depleted {
  background: var(--badge-critical-bg) !important;
}

.reagent-row.depleted:hover {
  background: #fee2e2 !important;
}

.status-badge {
  display: inline-block;
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 12px;
  font-weight: 500;
}

.status-badge.status-ok {
  background: var(--badge-ok-bg);
  color: var(--badge-ok-text);
}

.status-badge.status-depleted {
  background: var(--badge-critical-bg);
  color: var(--badge-critical-text);
}

/* === MODAL === */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}

.modal-content {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid var(--border-light);
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.modal-close {
  width: 32px;
  height: 32px;
  border: none;
  background: none;
  font-size: 24px;
  color: var(--text-muted);
  cursor: pointer;
  border-radius: var(--radius-sm);
}

.modal-close:hover {
  background: var(--bg-card-alt);
  color: var(--text-primary);
}

.modal-body {
  padding: 20px;
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid var(--border-light);
  background: var(--bg-card-alt);
}

/* === IMPORT DROPZONE === */
.import-instructions {
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.5;
}

.import-instructions p {
  margin: 0 0 8px;
}

.import-dropzone {
  position: relative;
  border: 2px dashed var(--border-medium);
  border-radius: var(--radius-md);
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
}

.import-dropzone:hover {
  border-color: var(--accent-primary);
  background: rgba(59, 130, 246, 0.02);
}

.import-dropzone input[type="file"] {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.dropzone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  color: var(--text-muted);
  font-size: 13px;
}

.dropzone-icon {
  font-size: 32px;
}

.import-preview {
  margin-top: 20px;
  padding: 16px;
  background: var(--bg-card-alt);
  border-radius: var(--radius-md);
  border: 1px solid var(--border-light);
}

.import-preview h4 {
  margin: 0 0 12px;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-primary);
}

.preview-stats {
  display: flex;
  gap: 20px;
}

.stat-item {
  font-size: 13px;
}

.stat-item.stat-valid {
  color: var(--badge-ok-text);
}

.stat-item.stat-error {
  color: var(--badge-critical-text);
}

.preview-errors {
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border-light);
}

.preview-errors h5 {
  margin: 0 0 8px;
  font-size: 12px;
  color: var(--badge-critical-text);
}

.preview-errors ul {
  margin: 0;
  padding-left: 20px;
  font-size: 12px;
  color: var(--text-secondary);
  max-height: 100px;
  overflow-y: auto;
}

/* === HEADER UPDATES === */
.header-right {
  display: flex;
  gap: 8px;
}

.btn-header {
  padding: 8px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-md);
  text-decoration: none;
  color: var(--text-primary);
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s;
}

.btn-header:hover {
  background: var(--bg-card-alt);
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

/* === KPI CARD FIXES FOR CONTRAST === */
.kpi-card {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 18px 20px;
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-sm);
}

.kpi-icon {
  font-size: 28px;
  opacity: 1;
}

.kpi-value {
  font-size: 26px;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.1;
}

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 2px;
}

.kpi-card.kpi-alert {
  background: linear-gradient(135deg, var(--badge-critical-bg) 0%, var(--bg-card) 100%);
  border-left: 3px solid var(--accent-danger);
}

/* === BADGE CONTRAST FIXES === */
.fc-badge {
  font-size: 10px;
  padding: 3px 10px;
  border-radius: 12px;
  font-weight: 600;
}

.fc-badge.critical {
  background: var(--badge-critical-bg);
  color: var(--badge-critical-text);
}

.fc-badge.warning {
  background: var(--badge-warning-bg);
  color: var(--badge-warning-text);
}

.fc-badge.ok, .fc-badge.normal {
  background: var(--badge-ok-bg);
  color: var(--badge-ok-text);
}

.fc-badge.nodata, .fc-badge.no_data {
  background: var(--badge-nodata-bg);
  color: var(--badge-nodata-text);
}

.priority-badge {
  display: inline-block;
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 12px;
  font-weight: 600;
}

.priority-high {
  background: var(--badge-critical-bg);
  color: var(--badge-critical-text);
}

.priority-medium {
  background: var(--badge-warning-bg);
  color: var(--badge-warning-text);
}

.priority-low {
  background: var(--badge-nodata-bg);
  color: var(--badge-nodata-text);
}

/* === FORECAST LEGEND CONTRAST FIX === */
.forecast-legend {
  display: flex;
  gap: 20px;
  margin-bottom: 16px;
  font-size: 12px;
  color: var(--text-secondary);
}

.dot-critical { background: var(--accent-danger); }
.dot-warning { background: var(--accent-warning); }
.dot-ok { background: var(--accent-success); }
.dot-nodata { background: var(--text-muted); }

/* === FORECAST CARD CONTRAST FIX === */
.fc-name {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 13px;
  color: var(--text-primary);
}

.fc-row .label {
  color: var(--text-muted);
}

.fc-row .value {
  font-weight: 500;
  color: var(--text-primary);
}

.fc-row.highlight .value {
  font-size: 16px;
  font-weight: 700;
  color: var(--accent-primary);
}

/* === DATA TABLE CONTRAST FIX === */
.data-table th {
  background: var(--bg-header);
  padding: 10px 12px;
  text-align: left;
  font-weight: 600;
  color: var(--text-secondary);
  border-bottom: 2px solid var(--border-light);
}

.data-table td {
  padding: 10px 12px;
  border-bottom: 1px solid var(--border-light);
  color: var(--text-primary);
}

.row-critical {
  background: var(--badge-critical-bg) !important;
}

.row-warning {
  background: var(--badge-warning-bg) !important;
}

/* === FILTER GROUP LABEL FIX === */
.filter-group label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* === SECTION HEADER FIX === */
.section-header h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: var(--text-primary);
}

.section-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-secondary);
}

.control-group label {
  color: var(--text-secondary);
  font-weight: 500;
}

/* === SECTION HEADER ACTIONS === */
.section-header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--border-medium);
  color: var(--text-secondary);
}

.btn-outline:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
  background: rgba(59, 130, 246, 0.05);
}

/* === CARD CONTROLS === */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-light);
}

.card-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--text-secondary);
  cursor: pointer;
}

.toggle-label input[type="checkbox"] {
  width: 14px;
  height: 14px;
  cursor: pointer;
}

.toggle-label span {
  white-space: nowrap;
}

/* === CHART CONTROLS BAR === */
.chart-controls-bar {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  background: var(--bg-card-alt);
  border-bottom: 1px solid var(--border-light);
}

.zoom-btn {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-secondary);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.15s;
}

.zoom-btn:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
  background: rgba(59, 130, 246, 0.05);
}

.zoom-hint {
  font-size: 11px;
  color: var(--text-muted);
  margin-left: 8px;
}

/* === WELLS FILTER PANEL === */
.wells-filter-panel {
  padding: 12px 18px;
  background: var(--bg-card-alt);
  border-bottom: 1px solid var(--border-light);
}

.wells-filter-actions {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}

.btn-xs {
  padding: 4px 10px;
  font-size: 11px;
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  color: var(--text-secondary);
  cursor: pointer;
}

.btn-xs:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

.wells-checkboxes {
  display: flex;
  flex-wrap: wrap;
  gap: 4px 12px;
  max-height: 80px;
  overflow-y: auto;
}

.wells-checkboxes label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  white-space: nowrap;
}

/* === HTML LEGEND FOR CHARTS === */
.chart-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 6px 14px;
  padding: 10px 18px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border-light);
  min-height: 24px;
}

.chart-legend-item {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 2px 4px;
  border-radius: var(--radius-sm);
  transition: all 0.15s;
  user-select: none;
}

.chart-legend-item:hover {
  background: var(--bg-card-alt);
}

.chart-legend-item.hidden {
  opacity: 0.4;
  text-decoration: line-through;
}

.chart-legend-marker {
  width: 10px;
  height: 10px;
  border-radius: 2px;
  flex-shrink: 0;
}

.chart-legend-label {
  white-space: nowrap;
  max-width: 120px;
  overflow: hidden;
  text-overflow: ellipsis;
}

.wells-checkboxes input[type="checkbox"] {
  width: 12px;
  height: 12px;
}

/* === CONTRAST FIXES FOR LABELS/ICONS === */
.filter-group label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.period-btn {
  padding: 6px 12px;
  border: 1px solid var(--border-medium);
  background: var(--bg-card);
  border-radius: var(--radius-sm);
  font-size: 12px;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s;
}

.period-btn:hover {
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

.period-btn.active {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
  color: var(--text-inverse);
}

/* Fix checkbox labels contrast */
.checkbox-label {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: var(--text-secondary);
  cursor: pointer;
}

/* Fix multi-select toggle contrast */
.ms-toggle {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 10px;
  background: var(--bg-card);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 13px;
  color: var(--text-primary);
  min-height: 32px;
}

.ms-arrow {
  font-size: 10px;
  color: var(--text-muted);
}

/* Summary items contrast fix */
.card-summary {
  display: flex;
  flex-wrap: wrap;
  gap: 16px 24px;
  padding: 12px 18px;
  background: var(--bg-card-alt);
  border-bottom: 1px solid var(--border-light);
}

.summary-item {
  display: flex;
  gap: 6px;
  font-size: 13px;
}

.sum-label {
  color: var(--text-muted);
}

.sum-value {
  font-weight: 600;
  color: var(--text-primary);
}

/* === FIX KPI ICONS CONTRAST === */
.kpi-icon {
  font-size: 28px;
  line-height: 1;
  filter: none;
}

/* === BUTTON CONTRAST FIX === */
.btn-apply {
  padding: 8px 20px;
  background: var(--accent-primary);
  color: var(--text-inverse);
  border: none;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  margin-left: auto;
}

.btn-apply:hover {
  background: var(--accent-primary-hover);
}
</style>

{# ============================================================
   SCRIPTS
   ============================================================ #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>

<script>
// === GLOBAL STATE ===
const reagentColors = {{ reagent_colors | tojson | safe }};
let forecastData = [];
let procurementData = null;

// === HELPERS ===
function getReagentColor(name) {
  if (reagentColors[name]) return reagentColors[name];
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  return `hsl(${Math.abs(hash) % 360}, 65%, 50%)`;
}

function formatDate(d) {
  return d.toISOString().split('T')[0];
}

function getDateRange(period) {
  const today = new Date();
  let from;
  switch(period) {
    case 'week':
      from = new Date(today);
      from.setDate(today.getDate() - 7);
      break;
    case 'month':
      from = new Date(today.getFullYear(), today.getMonth(), 1);
      break;
    case 'quarter':
      from = new Date(today);
      from.setMonth(today.getMonth() - 3);
      break;
    default:
      from = new Date(today.getFullYear(), today.getMonth(), 1);
  }
  return { from: formatDate(from), to: formatDate(today) };
}

// === MULTI-SELECT ===
function initMultiSelects() {
  document.querySelectorAll('.ms-toggle').forEach(toggle => {
    toggle.addEventListener('click', e => {
      e.stopPropagation();
      const dropdown = toggle.nextElementSibling;
      document.querySelectorAll('.ms-dropdown').forEach(d => {
        if (d !== dropdown) d.classList.remove('open');
      });
      dropdown.classList.toggle('open');
    });
  });

  document.addEventListener('click', () => {
    document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('open'));
  });

  document.querySelectorAll('.ms-dropdown').forEach(d => {
    d.addEventListener('click', e => e.stopPropagation());
  });
}

function msSelectAll(id) {
  document.querySelectorAll(`#${id} .ms-items input`).forEach(cb => cb.checked = true);
  updateMsText(id);
}

function msClearAll(id) {
  document.querySelectorAll(`#${id} .ms-items input`).forEach(cb => cb.checked = false);
  updateMsText(id);
}

function msFilter(input) {
  const search = input.value.toLowerCase();
  const items = input.parentElement.querySelector('.ms-items');
  items.querySelectorAll('label').forEach(label => {
    label.style.display = label.textContent.toLowerCase().includes(search) ? '' : 'none';
  });
}

function updateMsText(id) {
  const ms = document.getElementById(id);
  const all = ms.querySelectorAll('.ms-items input');
  const checked = ms.querySelectorAll('.ms-items input:checked');
  const text = ms.querySelector('.ms-text');

  if (checked.length === 0) text.textContent = '–ù–µ –≤–∏–±—Ä–∞–Ω–æ';
  else if (checked.length === all.length) text.textContent = '–£—Å—ñ';
  else if (checked.length <= 2) text.textContent = Array.from(checked).map(c => c.value).join(', ');
  else text.textContent = `–í–∏–±—Ä–∞–Ω–æ: ${checked.length}`;
}

function getMsValues(id) {
  return Array.from(document.querySelectorAll(`#${id} .ms-items input:checked`)).map(c => c.value);
}

// === PERIOD BUTTONS ===
function initPeriodButtons() {
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.parentElement.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      const range = getDateRange(this.dataset.period);
      document.getElementById('filter-date-from').value = range.from;
      document.getElementById('filter-date-to').value = range.to;
    });
  });

  document.querySelectorAll('.horizon-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      this.parentElement.querySelectorAll('.horizon-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      document.getElementById('target-days').value = this.dataset.days;
    });
  });

  // Set initial dates
  const range = getDateRange('month');
  document.getElementById('filter-date-from').value = range.from;
  document.getElementById('filter-date-to').value = range.to;
}

// === TOGGLE ADD FORM ===
function toggleAddForm() {
  document.getElementById('add-section').classList.toggle('collapsed');
}

// === APPLY FILTERS ===
function applyFilters() {
  loadForecast();
  loadDailyChart();
  loadWellsChart();
}

// === FORECAST ===
async function loadForecast() {
  const grid = document.getElementById('forecast-grid');
  grid.innerHTML = '<div class="loading-placeholder">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';

  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;
  const leadDays = document.getElementById('lead-days').value;
  const reagents = getMsValues('ms-reagents');
  const wells = getMsValues('ms-wells');
  const statuses = getMsValues('ms-statuses');

  const params = new URLSearchParams();
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);
  params.set('lead_days', leadDays);

  const allReagents = document.querySelectorAll('#ms-reagents .ms-items input').length;
  if (reagents.length > 0 && reagents.length < allReagents) {
    params.set('reagents', reagents.join(','));
  }

  const allWells = document.querySelectorAll('#ms-wells .ms-items input').length;
  if (wells.length > 0 && wells.length < allWells) {
    params.set('wells', wells.join(','));
  }

  const allStatuses = document.querySelectorAll('#ms-statuses .ms-items input').length;
  if (statuses.length > 0 && statuses.length < allStatuses) {
    params.set('statuses', statuses.join(','));
  }

  try {
    const res = await fetch(`/api/reagents/analytics/forecast-by-reagents?${params}`);
    const json = await res.json();

    if (!json.data || json.data.length === 0) {
      grid.innerHTML = '<div class="loading-placeholder">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</div>';
      return;
    }

    forecastData = json.data;
    renderForecastCards(json.data);
    updateKPIs(json.data);
  } catch (e) {
    console.error(e);
    grid.innerHTML = '<div class="loading-placeholder" style="color:#ef4444;">–ü–æ–º–∏–ª–∫–∞</div>';
  }
}

function renderForecastCards(data) {
  const grid = document.getElementById('forecast-grid');
  grid.innerHTML = '';

  data.forEach(item => {
    const card = document.createElement('div');
    card.className = `forecast-card status-${item.risk_status}`;

    const badgeClass = item.risk_status;
    const badgeText = {
      'critical': '–ö—Ä–∏—Ç–∏—á–Ω–æ',
      'warning': '–£–≤–∞–≥–∞',
      'normal': '–ù–æ—Ä–º–∞',
      'no_data': '–ë–µ–∑ —Ä–æ–∑—Ö–æ–¥—É'
    }[item.risk_status] || '';

    const daysText = item.days_remaining !== null ? `${item.days_remaining} –¥–Ω.` : '‚Äî';
    const consumers = item.top_consumers || [];

    card.innerHTML = `
      <div class="fc-header">
        <div class="fc-name">
          <span class="fc-color" style="background:${getReagentColor(item.reagent)}"></span>
          ${item.reagent}
        </div>
        <span class="fc-badge ${badgeClass}">${badgeText}</span>
      </div>
      <div class="fc-body">
        <div class="fc-row">
          <span class="label">–ó–∞–ª–∏—à–æ–∫</span>
          <span class="value">${item.stock.toFixed(1)} ${item.unit}</span>
        </div>
        <div class="fc-row">
          <span class="label">–°–µ—Ä. –≤–∏—Ç—Ä–∞—Ç–∞/–¥–µ–Ω—å</span>
          <span class="value">${item.avg_daily.toFixed(3)}</span>
        </div>
        <div class="fc-row highlight">
          <span class="label">–•–≤–∞—Ç–∏—Ç—å –Ω–∞</span>
          <span class="value">${daysText}</span>
        </div>
        <div class="fc-row">
          <span class="label">–ó–∞–∫—ñ–Ω—á–∏—Ç—å—Å—è</span>
          <span class="value">${item.depletion_date || '‚Äî'}</span>
        </div>
        <div class="fc-row">
          <span class="label">–ó–∞–º–æ–≤–∏—Ç–∏ –¥–æ</span>
          <span class="value ${item.order_by_date === '–í–∂–µ –ø–æ—Ä–∞!' ? 'text-danger' : ''}">${item.order_by_date || '‚Äî'}</span>
        </div>
      </div>
      ${consumers.length > 0 ? `
        <div class="fc-footer" onclick="toggleConsumers(this)">
          ‚ñ∂ –°–ø–æ–∂–∏–≤–∞—á—ñ (${consumers.length})
        </div>
        <div class="fc-consumers">
          ${consumers.map(c => `
            <div class="consumer-row">
              <span>‚Ññ${c.well}</span>
              <span>${c.qty.toFixed(1)}</span>
              <span>${c.share}%</span>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `;

    grid.appendChild(card);
  });
}

function toggleConsumers(el) {
  const consumers = el.nextElementSibling;
  if (consumers) {
    consumers.classList.toggle('open');
    el.textContent = consumers.classList.contains('open') ? '‚ñº –°–ø–æ–∂–∏–≤–∞—á—ñ' : '‚ñ∂ –°–ø–æ–∂–∏–≤–∞—á—ñ';
  }
}

function updateKPIs(data) {
  const critical = data.filter(d => d.risk_status === 'critical').length;
  const totalAvg = data.reduce((sum, d) => sum + d.avg_daily, 0);
  const nearest = data.find(d => d.days_remaining !== null);

  document.getElementById('kpi-critical').textContent = critical;
  document.getElementById('kpi-avg-daily').textContent = totalAvg.toFixed(1);
  document.getElementById('kpi-nearest-date').textContent = nearest?.depletion_date || '‚Äî';
}

// === PROCUREMENT ===
async function calculateProcurement() {
  const targetDays = document.getElementById('target-days').value;
  const leadDays = document.getElementById('proc-lead-days').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;

  const includeDepleted = document.getElementById('include-depleted')?.checked || false;

  const params = new URLSearchParams({
    target_days: targetDays,
    lead_days: leadDays,
    include_depleted: includeDepleted
  });
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);

  try {
    const res = await fetch(`/api/reagents/analytics/procurement-plan?${params}`);
    procurementData = await res.json();

    if (!procurementData.items || procurementData.items.length === 0) {
      document.getElementById('procurement-wrap').style.display = 'none';
      return;
    }

    renderProcurementTable(procurementData.items);
    document.getElementById('procurement-wrap').style.display = 'block';
    document.getElementById('btn-export').disabled = false;
  } catch (e) {
    console.error(e);
  }
}

function renderProcurementTable(items) {
  const tbody = document.getElementById('procurement-body');
  tbody.innerHTML = '';

  items.forEach((item, i) => {
    const tr = document.createElement('tr');
    if (item.priority === 'high') tr.classList.add('row-critical');
    else if (item.priority === 'medium') tr.classList.add('row-warning');

    const priorityHtml = {
      'high': '<span class="priority-badge priority-high">–í–∏—Å–æ–∫–∏–π</span>',
      'medium': '<span class="priority-badge priority-medium">–°–µ—Ä–µ–¥–Ω—ñ–π</span>',
      'low': '<span class="priority-badge priority-low">–ù–∏–∑—å–∫–∏–π</span>'
    }[item.priority] || '';

    tr.innerHTML = `
      <td class="col-check"><input type="checkbox" class="proc-cb" data-idx="${i}" ${item.to_order > 0 ? 'checked' : ''}></td>
      <td><span class="fc-color" style="background:${getReagentColor(item.reagent)};display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;"></span>${item.reagent}</td>
      <td class="col-num">${item.stock.toFixed(1)}</td>
      <td class="col-num">${item.avg_daily.toFixed(3)}</td>
      <td class="col-num">${item.days_remaining !== null ? item.days_remaining : '‚Äî'}</td>
      <td class="col-num">${item.needed_total.toFixed(1)}</td>
      <td class="col-num ${item.to_order > 0 ? 'text-bold' : ''}">${item.to_order > 0 ? item.to_order.toFixed(1) : '‚Äî'}</td>
      <td class="col-date ${item.order_by_date === '–í–∂–µ –ø–æ—Ä–∞!' ? 'text-danger' : ''}">${item.order_by_date || '‚Äî'}</td>
      <td class="col-status">${priorityHtml}</td>
    `;
    tbody.appendChild(tr);
  });
}

function toggleAllProc(cb) {
  document.querySelectorAll('.proc-cb').forEach(c => c.checked = cb.checked);
}

function selectByRisk(type) {
  if (!procurementData) return;
  document.querySelectorAll('.proc-cb').forEach((cb, i) => {
    const item = procurementData.items[i];
    if (type === 'all') cb.checked = true;
    else if (type === 'critical') cb.checked = item.priority === 'high';
    else if (type === 'warning') cb.checked = item.priority === 'high' || item.priority === 'medium';
  });
}

function exportProcurement() {
  const targetDays = document.getElementById('target-days').value;
  const leadDays = document.getElementById('proc-lead-days').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;

  const params = new URLSearchParams({
    target_days: targetDays,
    lead_days: leadDays
  });
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);

  window.location.href = `/api/reagents/analytics/procurement-plan/export?${params}`;
}

// === CHARTS ===
let chartDaily = null;
let chartWells = null;

async function loadDailyChart() {
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;
  const reagents = getMsValues('ms-reagents');

  const params = new URLSearchParams({ date_from: dateFrom, date_to: dateTo });
  const allReagents = document.querySelectorAll('#ms-reagents .ms-items input').length;
  if (reagents.length > 0 && reagents.length < allReagents) {
    params.set('reagents', reagents.join(','));
  }

  try {
    const res = await fetch(`/api/reagents/analytics/daily-consumption?${params}`);
    const json = await res.json();
    renderDailyChart(json.data || []);

    // Update summary with max/avg/median per day
    let totalQty = 0, totalCount = 0;
    const dailyTotals = {};

    (json.data || []).forEach(d => {
      totalQty += d.qty;
      totalCount += d.count;
      dailyTotals[d.date] = (dailyTotals[d.date] || 0) + d.qty;
    });

    const dailyValues = Object.values(dailyTotals);
    const maxDay = dailyValues.length > 0 ? Math.max(...dailyValues) : 0;
    const avgDay = dailyValues.length > 0 ? dailyValues.reduce((a, b) => a + b, 0) / dailyValues.length : 0;

    // Median calculation
    let medianDay = 0;
    if (dailyValues.length > 0) {
      const sorted = [...dailyValues].sort((a, b) => a - b);
      const mid = Math.floor(sorted.length / 2);
      medianDay = sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    }

    document.getElementById('sum-total-qty').textContent = totalQty.toFixed(1);
    document.getElementById('sum-total-count').textContent = totalCount;
    document.getElementById('sum-max-day').textContent = maxDay.toFixed(1);
    document.getElementById('sum-avg-day').textContent = avgDay.toFixed(1);
    document.getElementById('sum-median-day').textContent = medianDay.toFixed(1);
    document.getElementById('details-summary').style.display = 'flex';
  } catch (e) {
    console.error(e);
  }
}

// === HTML LEGEND GENERATOR ===
function generateHtmlLegend(containerId, chart) {
  const container = document.getElementById(containerId);
  if (!container || !chart) return;

  container.innerHTML = '';

  chart.data.datasets.forEach((dataset, index) => {
    const item = document.createElement('div');
    item.className = 'chart-legend-item';
    item.dataset.index = index;

    const marker = document.createElement('span');
    marker.className = 'chart-legend-marker';
    marker.style.backgroundColor = dataset.backgroundColor;

    const label = document.createElement('span');
    label.className = 'chart-legend-label';
    label.textContent = dataset.label;

    item.appendChild(marker);
    item.appendChild(label);

    // Toggle visibility on click
    item.addEventListener('click', () => {
      const isVisible = chart.isDatasetVisible(index);
      if (isVisible) {
        chart.hide(index);
        item.classList.add('hidden');
      } else {
        chart.show(index);
        item.classList.remove('hidden');
      }
    });

    container.appendChild(item);
  });
}

function renderDailyChart(data) {
  const ctx = document.getElementById('chart-daily');
  if (chartDaily) chartDaily.destroy();

  const dateMap = {};
  const reagentSet = new Set();
  data.forEach(d => {
    if (!dateMap[d.date]) dateMap[d.date] = {};
    dateMap[d.date][d.reagent] = d.qty;
    reagentSet.add(d.reagent);
  });

  const dates = Object.keys(dateMap).sort();
  const reagents = Array.from(reagentSet);

  const datasets = reagents.map(r => ({
    label: r,
    data: dates.map(d => dateMap[d][r] || 0),
    backgroundColor: getReagentColor(r),
    borderColor: getReagentColor(r),
    borderWidth: 1
  }));

  chartDaily = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates.map(d => new Date(d).toLocaleDateString('uk-UA', { day: '2-digit', month: 'short' })),
      datasets
    },
    plugins: [ChartDataLabels],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          display: showDailyLabels ? (ctx => ctx.dataset.data[ctx.dataIndex] > 0.5) : false,
          color: '#1a1a2e',
          anchor: 'end',
          align: 'top',
          font: { size: 9 },
          formatter: v => v > 0 ? v.toFixed(1) : ''
        },
        legend: { display: false },
        tooltip: { filter: item => item.parsed.y > 0 },
        zoom: {
          pan: {
            enabled: true,
            mode: 'x'
          },
          zoom: {
            wheel: { enabled: false },
            pinch: { enabled: true },
            drag: {
              enabled: true,
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderColor: 'rgba(59, 130, 246, 0.5)',
              borderWidth: 1
            },
            mode: 'x'
          }
        }
      },
      scales: {
        x: { stacked: true, grid: { display: false } },
        y: { stacked: true, beginAtZero: true }
      }
    }
  });

  // Generate HTML legend
  generateHtmlLegend('legend-daily', chartDaily);
}

async function loadWellsChart() {
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;
  const reagents = getMsValues('ms-reagents');
  const wells = getMsValues('ms-wells');

  const params = new URLSearchParams({ date_from: dateFrom, date_to: dateTo });
  const allReagents = document.querySelectorAll('#ms-reagents .ms-items input').length;
  if (reagents.length > 0 && reagents.length < allReagents) {
    params.set('reagents', reagents.join(','));
  }
  const allWells = document.querySelectorAll('#ms-wells .ms-items input').length;
  if (wells.length > 0 && wells.length < allWells) {
    params.set('wells', wells.join(','));
  }

  try {
    const res = await fetch(`/api/reagents/analytics/consumption-by-wells?${params}`);
    const json = await res.json();

    // Store data for filtering
    wellsChartData = json.data || [];

    // Build filter checkboxes
    const uniqueWells = [...new Set(wellsChartData.map(d => String(d.well)))].sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
    buildWellsFilterCheckboxes(uniqueWells);

    renderWellsChart(json.data || []);
  } catch (e) {
    console.error(e);
  }
}

function renderWellsChart(data) {
  const ctx = document.getElementById('chart-wells');
  if (chartWells) chartWells.destroy();

  const wellMap = {};
  const reagentSet = new Set();
  data.forEach(d => {
    if (!wellMap[d.well]) wellMap[d.well] = { total: 0, reagents: {} };
    wellMap[d.well].total += d.qty;
    wellMap[d.well].reagents[d.reagent] = (wellMap[d.well].reagents[d.reagent] || 0) + d.qty;
    reagentSet.add(d.reagent);
  });

  const sortedWells = Object.entries(wellMap).sort((a, b) => b[1].total - a[1].total).slice(0, 15);
  const wellLabels = sortedWells.map(w => `‚Ññ${w[0]}`);
  const reagents = Array.from(reagentSet);

  const datasets = reagents.map(r => ({
    label: r,
    data: sortedWells.map(w => wellMap[w[0]]?.reagents[r] || 0),
    backgroundColor: getReagentColor(r),
    borderColor: getReagentColor(r),
    borderWidth: 1
  }));

  chartWells = new Chart(ctx, {
    type: 'bar',
    data: { labels: wellLabels, datasets },
    plugins: [ChartDataLabels],
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          display: showWellsLabels ? (ctx => ctx.dataset.data[ctx.dataIndex] > 1) : false,
          color: '#1a1a2e',
          anchor: 'end',
          align: 'right',
          font: { size: 9 },
          formatter: v => v > 0 ? v.toFixed(1) : ''
        },
        legend: { display: false },
        tooltip: { filter: item => item.parsed.x > 0 }
      },
      scales: {
        x: { stacked: true, beginAtZero: true },
        y: { stacked: true, grid: { display: false } }
      }
    }
  });

  // Generate HTML legend
  generateHtmlLegend('legend-wells', chartWells);
}

// === STOCK CHART ===
let chartStock = null;
// –°—Ç–≤–æ—Ä—é—î–º–æ JSON-safe –º–∞—Å–∏–≤ (datetime –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤–∞–Ω–æ –≤ —Å—Ç—Ä–æ–∫–∏)
const stockData = [
  {% for r in reagents %}
  {
    "name": {{ r.name | tojson | safe }},
    "unit": {{ (r.unit or '—à—Ç') | tojson | safe }},
    "stock": {{ r.stock }},
    "avg_daily": {{ r.avg_daily }},
    "consumption_today": {{ r.consumption_today }},
    "last_inventory_date": {% if r.last_inventory_date_str %}{{ r.last_inventory_date_str | tojson | safe }}{% else %}null{% endif %},
    "calculation_method": {{ r.calculation_method | tojson | safe }}
  }{% if not loop.last %},{% endif %}
  {% endfor %}
];

function loadStockChart() {
  const ctx = document.getElementById('chart-stock-current');
  if (!ctx) return;

  if (chartStock) chartStock.destroy();

  // Filter and sort by stock (descending), only show > 0
  const filtered = stockData
    .filter(r => r.stock > 0)
    .sort((a, b) => b.stock - a.stock)
    .slice(0, 20);

  if (filtered.length === 0) {
    ctx.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">–ù–µ–º–∞—î —Ä–µ–∞–≥–µ–Ω—Ç—ñ–≤ –∑ –∑–∞–ª–∏—à–∫–æ–º > 0</div>';
    return;
  }

  const labels = filtered.map(r => r.name);
  const values = filtered.map(r => r.stock);
  const colors = filtered.map(r => getReagentColor(r.name));

  chartStock = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: colors,
        borderWidth: 1,
        barThickness: 14
      }]
    },
    plugins: [ChartDataLabels],
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        datalabels: {
          display: ctx => ctx.dataset.data[ctx.dataIndex] > 0.1,
          color: 'var(--text-primary)',
          anchor: 'end',
          align: 'right',
          font: { size: 10, weight: '500' },
          formatter: v => v > 0 ? v.toFixed(1) : ''
        },
        tooltip: {
          filter: item => item.parsed.x > 0,
          callbacks: {
            label: ctx => `–ó–∞–ª–∏—à–æ–∫: ${ctx.parsed.x.toFixed(2)}`
          }
        }
      },
      scales: {
        x: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.04)' } },
        y: { grid: { display: false }, ticks: { font: { size: 11 } } }
      }
    }
  });
}

// === IMPORT MODAL ===
let importFileData = null;
let validatedData = null;

function openImportModal() {
  document.getElementById('import-modal').style.display = 'flex';
  resetImportState();
}

function closeImportModal() {
  document.getElementById('import-modal').style.display = 'none';
  resetImportState();
}

function resetImportState() {
  importFileData = null;
  validatedData = null;
  document.getElementById('import-file').value = '';
  document.getElementById('import-preview').style.display = 'none';
  document.getElementById('btn-import').disabled = true;
}

async function handleImportFile(input) {
  const file = input.files[0];
  if (!file) return;

  importFileData = file;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/reagents/import/supplies/validate', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();
    validatedData = result;

    document.getElementById('valid-count').textContent = result.valid_count || 0;
    document.getElementById('error-count').textContent = result.error_count || 0;

    const errorsDiv = document.getElementById('preview-errors');
    const errorList = document.getElementById('error-list');

    if (result.errors && result.errors.length > 0) {
      errorList.innerHTML = result.errors.slice(0, 10).map(e =>
        `<li>–†—è–¥–æ–∫ ${e.row}: ${e.message}</li>`
      ).join('');
      errorsDiv.style.display = 'block';
    } else {
      errorsDiv.style.display = 'none';
    }

    document.getElementById('import-preview').style.display = 'block';
    document.getElementById('btn-import').disabled = !(result.valid_count > 0);

  } catch (e) {
    console.error(e);
    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ñ–∞–π–ª—É');
  }
}

async function executeImport() {
  if (!importFileData) return;

  const formData = new FormData();
  formData.append('file', importFileData);

  try {
    const res = await fetch('/api/reagents/import/supplies', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();

    if (result.success) {
      alert(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${result.imported_count} –∑–∞–ø–∏—Å—ñ–≤!`);
      closeImportModal();
      location.reload();
    } else {
      alert(`–ü–æ–º–∏–ª–∫–∞: ${result.message}`);
    }
  } catch (e) {
    console.error(e);
    alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É');
  }
}

// === INVENTORY ===
async function loadExpectedQty() {
  const reagent = document.getElementById('inv-reagent').value;
  if (!reagent) return;

  // Set current datetime
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  const local = new Date(now - offset);
  document.getElementById('inv-date').value = local.toISOString().slice(0, 16);
}

async function submitInventory(event) {
  event.preventDefault();

  const form = document.getElementById('inventory-form');
  const formData = new FormData(form);

  try {
    const res = await fetch('/admin/reagents/inventory/add', {
      method: 'POST',
      body: formData
    });

    if (res.ok || res.redirected) {
      // Get expected vs actual for display
      const reagent = formData.get('reagent');
      const actualQty = parseFloat(formData.get('qty'));

      // Fetch current balance
      const balanceRes = await fetch(`/api/reagents/balance?as_of=${formData.get('snapshot_at')}`);
      const balances = await balanceRes.json();
      const reagentBalance = balances.find(b => b.reagent === reagent);
      const expectedQty = reagentBalance ? reagentBalance.current_balance : 0;

      const discrepancy = actualQty - expectedQty;

      document.getElementById('inv-expected').textContent = expectedQty.toFixed(2);
      document.getElementById('inv-actual').textContent = actualQty.toFixed(2);
      document.getElementById('inv-discrepancy').textContent = discrepancy.toFixed(2);

      const badge = document.getElementById('inv-badge');
      if (Math.abs(discrepancy) < 0.01) {
        badge.textContent = '–ó–±—ñ–≥';
        badge.className = 'discrepancy-badge match';
      } else if (discrepancy < 0) {
        badge.textContent = '–ù–µ–¥–æ—Å—Ç–∞—á–∞';
        badge.className = 'discrepancy-badge shortage';
      } else {
        badge.textContent = '–ù–∞–¥–ª–∏—à–æ–∫';
        badge.className = 'discrepancy-badge surplus';
      }

      document.getElementById('inventory-result').style.display = 'block';

      // Reset form after delay
      setTimeout(() => {
        form.reset();
        loadExpectedQty();
      }, 500);

    }
  } catch (e) {
    console.error(e);
    alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó');
  }
}

// === REAGENT TABLE FILTER ===
function filterReagentsTable() {
  const search = document.getElementById('reagent-search').value.toLowerCase();
  const showZeroOnly = document.getElementById('show-zero-only').checked;

  document.querySelectorAll('.reagent-row').forEach(row => {
    const name = row.dataset.name;
    const isDepleted = row.classList.contains('depleted');

    let show = true;
    if (search && !name.includes(search)) show = false;
    if (showZeroOnly && !isDepleted) show = false;

    row.style.display = show ? '' : 'none';
  });
}

// === PROCUREMENT ENHANCEMENTS ===
function exportProcurementSelected() {
  const targetDays = document.getElementById('target-days').value;
  const leadDays = document.getElementById('proc-lead-days').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo = document.getElementById('filter-date-to').value;

  // Get selected reagents
  const selected = [];
  document.querySelectorAll('.proc-cb:checked').forEach((cb, i) => {
    if (procurementData && procurementData.items[i]) {
      selected.push(procurementData.items[i].reagent);
    }
  });

  if (selected.length === 0) {
    alert('–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∞–≥–µ–Ω—Ç–∏ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É');
    return;
  }

  const params = new URLSearchParams({
    target_days: targetDays,
    lead_days: leadDays
  });
  if (dateFrom) params.set('date_from', dateFrom);
  if (dateTo) params.set('date_to', dateTo);
  if (selected.length < procurementData.items.length) {
    params.set('reagents', selected.join(','));
  }

  window.location.href = `/api/reagents/analytics/procurement-plan/export?${params}`;
}

// Update renderProcurementTable to include method column
const originalRenderProcurementTable = renderProcurementTable;
renderProcurementTable = function(items) {
  const tbody = document.getElementById('procurement-body');
  tbody.innerHTML = '';

  const method = document.getElementById('calc-method').value;
  const methodLabels = {
    'events': '–ü–æ –≤–∏—Ç—Ä–∞—Ç–∞—Ö',
    'supply': '–ü–æ –ø–æ—Å—Ç–∞—á–∞–Ω–Ω—é',
    'inventory': '–Ü–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—è'
  };

  items.forEach((item, i) => {
    const tr = document.createElement('tr');
    if (item.priority === 'high') tr.classList.add('row-critical');
    else if (item.priority === 'medium') tr.classList.add('row-warning');

    const priorityHtml = {
      'high': '<span class="priority-badge priority-high">–í–∏—Å–æ–∫–∏–π</span>',
      'medium': '<span class="priority-badge priority-medium">–°–µ—Ä–µ–¥–Ω—ñ–π</span>',
      'low': '<span class="priority-badge priority-low">–ù–∏–∑—å–∫–∏–π</span>'
    }[item.priority] || '';

    tr.innerHTML = `
      <td class="col-check"><input type="checkbox" class="proc-cb" data-idx="${i}" ${item.to_order > 0 ? 'checked' : ''}></td>
      <td><span class="fc-color" style="background:${getReagentColor(item.reagent)};display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;"></span>${item.reagent}</td>
      <td class="col-num">${item.stock.toFixed(1)}</td>
      <td class="col-num">${item.avg_daily.toFixed(3)}</td>
      <td class="col-num">${item.days_remaining !== null ? item.days_remaining : '‚Äî'}</td>
      <td class="col-num">${item.needed_total.toFixed(1)}</td>
      <td class="col-num ${item.to_order > 0 ? 'text-bold' : ''}">${item.to_order > 0 ? item.to_order.toFixed(1) : '‚Äî'}</td>
      <td class="col-date ${item.order_by_date === '–í–∂–µ –ø–æ—Ä–∞!' ? 'text-danger' : ''}">${item.order_by_date || '‚Äî'}</td>
      <td class="col-status">${priorityHtml}</td>
      <td style="font-size:11px;color:var(--text-muted);">${methodLabels[method] || method}</td>
    `;
    tbody.appendChild(tr);
  });
};

// === CHART TOGGLE LABELS ===
let showDailyLabels = true;
let showWellsLabels = true;

function toggleDailyLabels() {
  showDailyLabels = document.getElementById('toggle-daily-labels').checked;
  if (chartDaily) {
    chartDaily.options.plugins.datalabels.display = showDailyLabels
      ? (ctx => ctx.dataset.data[ctx.dataIndex] > 0.5)
      : false;
    chartDaily.update();
  }
}

function toggleWellsLabels() {
  showWellsLabels = document.getElementById('toggle-wells-labels').checked;
  if (chartWells) {
    chartWells.options.plugins.datalabels.display = showWellsLabels
      ? (ctx => ctx.dataset.data[ctx.dataIndex] > 1)
      : false;
    chartWells.update();
  }
}

// === DAILY CHART ZOOM (X-axis only via zoom plugin) ===
function zoomDailyChartX(factor) {
  if (!chartDaily) return;
  // Use zoom plugin API - zoom only on X axis
  chartDaily.zoom(factor, { mode: 'x' });
}

function resetDailyZoom() {
  if (!chartDaily) return;
  chartDaily.resetZoom();
}

// === WELLS CHART FILTER ===
let wellsChartData = [];
let selectedWellsForChart = new Set();

function buildWellsFilterCheckboxes(wells) {
  const container = document.getElementById('wells-chart-filter');
  if (!container) return;

  container.innerHTML = wells.map(w => `
    <label>
      <input type="checkbox" value="${w}" checked onchange="filterWellsChart()">
      ‚Ññ${w}
    </label>
  `).join('');

  selectedWellsForChart = new Set(wells);
}

function selectAllChartWells(selectAll) {
  const checkboxes = document.querySelectorAll('#wells-chart-filter input');
  checkboxes.forEach(cb => cb.checked = selectAll);

  if (selectAll) {
    selectedWellsForChart = new Set([...checkboxes].map(cb => cb.value));
  } else {
    selectedWellsForChart.clear();
  }
  filterWellsChart();
}

function filterWellsChart() {
  const checkboxes = document.querySelectorAll('#wells-chart-filter input:checked');
  selectedWellsForChart = new Set([...checkboxes].map(cb => cb.value));
  renderFilteredWellsChart();
}

function renderFilteredWellsChart() {
  if (!wellsChartData || wellsChartData.length === 0) return;

  const ctx = document.getElementById('chart-wells');
  if (chartWells) chartWells.destroy();

  // Filter data by selected wells
  const filteredData = wellsChartData.filter(d => selectedWellsForChart.has(String(d.well)));

  const wellMap = {};
  const reagentSet = new Set();
  filteredData.forEach(d => {
    if (!wellMap[d.well]) wellMap[d.well] = { total: 0, reagents: {} };
    wellMap[d.well].total += d.qty;
    wellMap[d.well].reagents[d.reagent] = (wellMap[d.well].reagents[d.reagent] || 0) + d.qty;
    reagentSet.add(d.reagent);
  });

  const sortedWells = Object.entries(wellMap).sort((a, b) => b[1].total - a[1].total);
  const wellLabels = sortedWells.map(w => `‚Ññ${w[0]}`);
  const reagents = Array.from(reagentSet);

  const datasets = reagents.map(r => ({
    label: r,
    data: sortedWells.map(w => wellMap[w[0]]?.reagents[r] || 0),
    backgroundColor: getReagentColor(r),
    borderColor: getReagentColor(r),
    borderWidth: 1
  }));

  chartWells = new Chart(ctx, {
    type: 'bar',
    data: { labels: wellLabels, datasets },
    plugins: [ChartDataLabels],
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        datalabels: {
          display: showWellsLabels ? (ctx => ctx.dataset.data[ctx.dataIndex] > 1) : false,
          color: '#1a1a2e',
          anchor: 'end',
          align: 'right',
          font: { size: 9 },
          formatter: v => v > 0 ? v.toFixed(1) : ''
        },
        legend: { display: false },
        tooltip: { filter: item => item.parsed.x > 0 }
      },
      scales: {
        x: { stacked: true, beginAtZero: true },
        y: { stacked: true, grid: { display: false } }
      }
    }
  });

  // Generate HTML legend
  generateHtmlLegend('legend-wells', chartWells);
}

// === INVENTORY IMPORT MODAL ===
let inventoryImportFile = null;
let inventoryValidatedData = null;

function openInventoryImportModal() {
  document.getElementById('inventory-import-modal').style.display = 'flex';
  resetInventoryImportState();
}

function closeInventoryImportModal() {
  document.getElementById('inventory-import-modal').style.display = 'none';
  resetInventoryImportState();
}

function resetInventoryImportState() {
  inventoryImportFile = null;
  inventoryValidatedData = null;
  document.getElementById('inventory-import-file').value = '';
  document.getElementById('inventory-import-preview').style.display = 'none';
  document.getElementById('btn-inv-import').disabled = true;
}

async function handleInventoryImportFile(input) {
  const file = input.files[0];
  if (!file) return;

  inventoryImportFile = file;

  const formData = new FormData();
  formData.append('file', file);

  try {
    const res = await fetch('/api/reagents/import/inventory/validate', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();
    inventoryValidatedData = result;

    document.getElementById('inv-valid-count').textContent = result.valid_count || 0;
    document.getElementById('inv-error-count').textContent = result.error_count || 0;

    const errorsDiv = document.getElementById('inv-preview-errors');
    const errorList = document.getElementById('inv-error-list');

    if (result.errors && result.errors.length > 0) {
      errorList.innerHTML = result.errors.slice(0, 10).map(e =>
        `<li>–†—è–¥–æ–∫ ${e.row}: ${e.message}</li>`
      ).join('');
      errorsDiv.style.display = 'block';
    } else {
      errorsDiv.style.display = 'none';
    }

    document.getElementById('inventory-import-preview').style.display = 'block';
    document.getElementById('btn-inv-import').disabled = !(result.valid_count > 0);

  } catch (e) {
    console.error(e);
    alert('–ü–æ–º–∏–ª–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó —Ñ–∞–π–ª—É');
  }
}

async function executeInventoryImport() {
  if (!inventoryImportFile) return;

  const formData = new FormData();
  formData.append('file', inventoryImportFile);

  try {
    const res = await fetch('/api/reagents/import/inventory', {
      method: 'POST',
      body: formData
    });
    const result = await res.json();

    if (result.success) {
      alert(`–Ü–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ ${result.imported_count} –∑–∞–ø–∏—Å—ñ–≤ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü—ñ—ó!`);
      closeInventoryImportModal();
      location.reload();
    } else {
      alert(`–ü–æ–º–∏–ª–∫–∞: ${result.message}`);
    }
  } catch (e) {
    console.error(e);
    alert('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É');
  }
}

// === INIT ===
document.addEventListener('DOMContentLoaded', () => {
  initMultiSelects();
  initPeriodButtons();

  // Set default inventory date
  const now = new Date();
  const offset = now.getTimezoneOffset() * 60000;
  const local = new Date(now - offset);
  const invDateInput = document.getElementById('inv-date');
  if (invDateInput) {
    invDateInput.value = local.toISOString().slice(0, 16);
  }

  // Auto-load data
  setTimeout(() => {
    loadForecast();
    loadDailyChart();
    loadWellsChart();
    loadStockChart();
  }, 300);
});
</script>

{% endblock %}
