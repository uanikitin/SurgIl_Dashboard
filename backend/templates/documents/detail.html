{% extends "base.html" %}

{% block title %}–ê–∫—Ç {{ doc.id }} ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}
<h1 style="margin: 0 0 16px 0;">
  –ê–∫—Ç #{{ doc.id }} ‚Äî {{ doc.doc_type.name_ru if doc.doc_type else "" }}
</h1>

<div class="card" style="padding:16px; margin-bottom:16px;">
  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
    <div><b>–°—Ç–∞—Ç—É—Å:</b> {{ doc.status }}</div>
    <div>
      <b>–°–∫–≤–∞–∂–∏–Ω–∞:</b>
      {% if doc.well %}{{ doc.well.number }}{% else %}<span style="opacity:.7;">‚Äî</span>{% endif %}
    </div>
    <div>
      <b>–ü–µ—Ä–∏–æ–¥:</b>
      {% if doc.period_month and doc.period_year %}
        {{ doc.period_month }}.{{ doc.period_year }}
      {% else %}
        <span style="opacity:.7;">‚Äî</span>
      {% endif %}
    </div>
    <div style="margin-left:auto;">
      <a href="/documents" class="admin-link">‚Üê –Ω–∞–∑–∞–¥</a>
    </div>
  </div>
</div>

<div class="cards-grid" style="display:grid; gap:16px;">

  <!-- EDIT NOTES + METADATA -->
  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–ü–æ–ª—è –∞–∫—Ç–∞</h2>
  <!-- KANBAN ACTIONS -->
  <div style="margin: 0 0 12px 0; padding:12px; border:1px solid #eee; border-radius:10px;">
    <div style="font-weight:600; margin-bottom:8px;">–î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –∫–∞–Ω–±–∞–Ω—É</div>

    {% if doc.status == "generated" %}
      <form method="post" action="/documents/{{ doc.id }}/sign" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="signer_name" placeholder="–§–ò–û –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä –ò–≤–∞–Ω–æ–≤ –ò.–ò.)" />
          <input name="signer_position" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä –£—á–∞—Å—Ç–∫–æ–≤—ã–π –≥–µ–æ–ª–æ–≥)" />
        </div>
        <div>
          <button type="submit" onclick="return confirm('–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Å—Ç–∞—Ç—É—Å SIGNED?');">–ü–æ–¥–ø–∏—Å–∞—Ç—å (SIGNED)</button>
        </div>
      </form>
    {% elif doc.status == "signed" %}
      <form method="post" action="/documents/{{ doc.id }}/mark-sent" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="sent_to" placeholder="–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–æ–ø—Ü.)" />
          <input name="sent_via" placeholder="–ö–∞–Ω–∞–ª (email/telegram/–±—É–º–∞–≥–∞) (–æ–ø—Ü.)" />
        </div>
        <div>
          <button type="submit" onclick="return confirm('–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ —Å—Ç–∞—Ç—É—Å SENT?');">–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º (SENT)</button>
        </div>
      </form>

      <form method="post" action="/documents/{{ doc.id }}/archive" style="margin-top:8px;">
        <button type="submit" onclick="return confirm('–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ ARCHIVED?');">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>

    {% elif doc.status == "sent" %}
      <form method="post" action="/documents/{{ doc.id }}/archive">
        <button type="submit" onclick="return confirm('–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –≤ ARCHIVED?');">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>
    {% else %}
      <div style="opacity:.75;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF –∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è.</div>
    {% endif %}
  </div>
    <form method="post" action="/documents/{{ doc.id }}/update">
      <div style="display:grid; gap:10px;">

        <label><b>Notes</b></label>
        <textarea name="notes" rows="4" style="width:100%;">{{ doc.notes or "" }}</textarea>

        <label><b>Metadata (JSON)</b></label>
        <textarea name="metadata_json" rows="10" style="width:100%;">{{ (doc.meta or {}) | tojson(indent=2) }}</textarea>

        <div style="display:flex; gap:10px;">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </form>

    <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-top:12px;">
      <form method="post" action="/documents/{{ doc.id }}/generate-pdf" style="display:inline-block;">
        <label style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input type="checkbox" name="split_tables" value="1">
          <span style="font-size:13px;">2 —Ç–∞–±–ª–∏—Ü—ã (–ø–µ–Ω–Ω—ã–µ / –∏–Ω–≥–∏–±–∏—Ä—É—é—â–∏–µ)</span>
        </label>
        <button class="btn btn-primary" type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
      </form>

      {% if doc.pdf_filename %}
        <button type="button" class="btn" onclick="togglePdfPreview()" style="display:inline-flex; align-items:center; gap:6px;">
          üìÑ <span id="previewBtnText">–ü–æ–∫–∞–∑–∞—Ç—å PDF</span>
        </button>
        <a href="/documents/{{ doc.id }}/preview-pdf" target="_blank" class="btn" style="display:inline-flex; align-items:center; gap:6px;">
          üîó –í –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
        </a>
        <a href="/static/{{ doc.pdf_filename }}" download class="btn" style="display:inline-flex; align-items:center; gap:6px;">
          ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å
        </a>
        <span style="border-left:1px solid #ddd; margin:0 8px;"></span>
        <button type="button" class="btn" onclick="openSendTelegramModal()" style="display:inline-flex; align-items:center; gap:6px;">
          üì≤ Telegram
        </button>
        <button type="button" class="btn" onclick="openSendEmailModal()" style="display:inline-flex; align-items:center; gap:6px;">
          üìß Email
        </button>
      {% else %}
        <span style="font-size:13px; color:#6b7280; padding:8px;">PDF –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</span>
      {% endif %}
    </div>

    {% if doc.pdf_filename %}
    <div id="pdfPreviewContainer" style="display:none; margin-top:16px; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">
      <div style="background:#f3f4f6; padding:8px 12px; display:flex; justify-content:space-between; align-items:center;">
        <span style="font-weight:600; font-size:13px;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF</span>
        <button type="button" onclick="togglePdfPreview()" style="background:none; border:none; cursor:pointer; font-size:18px;">&times;</button>
      </div>
      <iframe id="pdfPreviewFrame" src="" style="width:100%; height:600px; border:none;"></iframe>
    </div>
    <script>
      function togglePdfPreview() {
        const container = document.getElementById('pdfPreviewContainer');
        const frame = document.getElementById('pdfPreviewFrame');
        const btnText = document.getElementById('previewBtnText');
        if (container.style.display === 'none') {
          frame.src = '/documents/{{ doc.id }}/preview-pdf';
          container.style.display = 'block';
          btnText.textContent = '–°–∫—Ä—ã—Ç—å PDF';
        } else {
          container.style.display = 'none';
          frame.src = '';
          btnText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å PDF';
        }
      }
    </script>

    <!-- Send to Telegram Modal -->
    <div id="sendTelegramModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
      <div class="modal-content" style="background:white; padding:24px; border-radius:12px; max-width:450px; width:90%; max-height:90vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0;">üì≤ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</h3>
          <button onclick="closeSendTelegramModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="margin-bottom:16px; padding:12px; background:#f0f9ff; border-radius:8px; font-size:13px;">
          <div><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> {{ doc.doc_number }}</div>
          {% if doc.well %}<div><strong>–°–∫–≤–∞–∂–∏–Ω–∞:</strong> {{ doc.well.number }}</div>{% endif %}
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:6px;">Chat ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <input type="text" id="telegramChatId" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
          <div style="font-size:11px; color:#6b7280; margin-top:4px;">–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è TELEGRAM_DEFAULT_CHAT_ID –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>
        </div>
        <div id="telegramSendResult" style="display:none; margin-bottom:16px; padding:12px; border-radius:8px;"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button onclick="closeSendTelegramModal()" class="btn" style="background:#f3f4f6; color:#374151;">–û—Ç–º–µ–Ω–∞</button>
          <button onclick="sendToTelegram()" id="telegramSendBtn" class="btn btn-primary" style="background:#0088cc; color:white;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Send to Email Modal -->
    <div id="sendEmailModal" class="modal-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
      <div class="modal-content" style="background:white; padding:24px; border-radius:12px; max-width:450px; width:90%; max-height:90vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
          <h3 style="margin:0;">üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Email</h3>
          <button onclick="closeSendEmailModal()" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
        </div>
        <div style="margin-bottom:16px; padding:12px; background:#f0f9ff; border-radius:8px; font-size:13px;">
          <div><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> {{ doc.doc_number }}</div>
          {% if doc.well %}<div><strong>–°–∫–≤–∞–∂–∏–Ω–∞:</strong> {{ doc.well.number }}</div>{% endif %}
        </div>
        <div style="margin-bottom:12px;">
          <label style="display:block; font-weight:600; margin-bottom:6px;">Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</label>
          <input type="email" id="emailTo" placeholder="example@domain.com" required style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>
        <div style="margin-bottom:16px;">
          <label style="display:block; font-weight:600; margin-bottom:6px;">–ö–æ–ø–∏—è (CC)</label>
          <input type="email" id="emailCc" placeholder="copy@domain.com" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>
        <div id="emailSendResult" style="display:none; margin-bottom:16px; padding:12px; border-radius:8px;"></div>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
          <button onclick="closeSendEmailModal()" class="btn" style="background:#f3f4f6; color:#374151;">–û—Ç–º–µ–Ω–∞</button>
          <button onclick="sendToEmail()" id="emailSendBtn" class="btn btn-primary" style="background:#2563eb; color:white;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <script>
    // Telegram Modal
    function openSendTelegramModal() {
      document.getElementById('sendTelegramModal').style.display = 'flex';
      document.getElementById('telegramSendResult').style.display = 'none';
      document.getElementById('telegramChatId').value = '';
    }
    function closeSendTelegramModal() {
      document.getElementById('sendTelegramModal').style.display = 'none';
    }
    async function sendToTelegram() {
      const btn = document.getElementById('telegramSendBtn');
      const resultDiv = document.getElementById('telegramSendResult');
      const chatId = document.getElementById('telegramChatId').value.trim();

      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      resultDiv.style.display = 'none';

      try {
        let url = '/api/jobs/send/telegram/{{ doc.id }}';
        if (chatId) {
          url += '?chat_id=' + encodeURIComponent(chatId);
        }
        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();

        if (data.status === 'sent') {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#d1fae5';
          resultDiv.style.color = '#065f46';
          resultDiv.innerHTML = '‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!';
        } else {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#fee2e2';
          resultDiv.style.color = '#991b1b';
          resultDiv.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fee2e2';
        resultDiv.style.color = '#991b1b';
        resultDiv.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
      }
    }

    // Email Modal
    function openSendEmailModal() {
      document.getElementById('sendEmailModal').style.display = 'flex';
      document.getElementById('emailSendResult').style.display = 'none';
      document.getElementById('emailTo').value = '';
      document.getElementById('emailCc').value = '';
    }
    function closeSendEmailModal() {
      document.getElementById('sendEmailModal').style.display = 'none';
    }
    async function sendToEmail() {
      const btn = document.getElementById('emailSendBtn');
      const resultDiv = document.getElementById('emailSendResult');
      const toEmail = document.getElementById('emailTo').value.trim();
      const ccEmail = document.getElementById('emailCc').value.trim();

      if (!toEmail) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fef3c7';
        resultDiv.style.color = '#92400e';
        resultDiv.innerHTML = '‚ö†Ô∏è –£–∫–∞–∂–∏—Ç–µ email –ø–æ–ª—É—á–∞—Ç–µ–ª—è';
        return;
      }

      btn.disabled = true;
      btn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
      resultDiv.style.display = 'none';

      try {
        let url = '/api/jobs/send/email/{{ doc.id }}?to_email=' + encodeURIComponent(toEmail);
        if (ccEmail) {
          url += '&cc_email=' + encodeURIComponent(ccEmail);
        }
        const response = await fetch(url, { method: 'POST' });
        const data = await response.json();

        if (data.status === 'sent') {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#d1fae5';
          resultDiv.style.color = '#065f46';
          resultDiv.innerHTML = '‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ' + toEmail + '!';
        } else {
          resultDiv.style.display = 'block';
          resultDiv.style.background = '#fee2e2';
          resultDiv.style.color = '#991b1b';
          resultDiv.innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (err) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fee2e2';
        resultDiv.style.color = '#991b1b';
        resultDiv.innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message;
      } finally {
        btn.disabled = false;
        btn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
      }
    }

    // Close modals on overlay click
    document.getElementById('sendTelegramModal').addEventListener('click', function(e) {
      if (e.target === this) closeSendTelegramModal();
    });
    document.getElementById('sendEmailModal').addEventListener('click', function(e) {
      if (e.target === this) closeSendEmailModal();
    });
    </script>
    {% endif %}

    {% if send_history and send_history|length > 0 %}
    <div style="margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb;">
      <div style="font-weight:600; margin-bottom:8px;">–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–æ–∫</div>
      <table style="width:100%; border-collapse:collapse; font-size:13px;">
        <thead>
          <tr style="background:#f3f4f6; text-align:left;">
            <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">–ö–∞–Ω–∞–ª</th>
            <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
            <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">–°—Ç–∞—Ç—É—Å</th>
            <th style="padding:6px 8px; border-bottom:1px solid #e5e7eb;">–í—Ä–µ–º—è</th>
          </tr>
        </thead>
        <tbody>
          {% for log in send_history %}
          <tr style="border-bottom:1px solid #f3f4f6;">
            <td style="padding:6px 8px;">
              {% if log.channel == 'telegram' %}üì≤ Telegram{% elif log.channel == 'email' %}üìß Email{% else %}{{ log.channel }}{% endif %}
            </td>
            <td style="padding:6px 8px; max-width:200px; overflow:hidden; text-overflow:ellipsis;" title="{{ log.recipient }}">{{ log.recipient }}</td>
            <td style="padding:6px 8px;">
              {% if log.status == 'sent' %}
                <span style="background:#d1fae5; color:#065f46; padding:2px 6px; border-radius:4px; font-size:11px;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
              {% elif log.status == 'failed' %}
                <span style="background:#fee2e2; color:#991b1b; padding:2px 6px; border-radius:4px; font-size:11px;" title="{{ log.error_message or '' }}">–û—à–∏–±–∫–∞</span>
              {% else %}
                <span style="background:#e5e7eb; color:#374151; padding:2px 6px; border-radius:4px; font-size:11px;">{{ log.status }}</span>
              {% endif %}
            </td>
            <td style="padding:6px 8px; color:#6b7280;">
              {% if log.sent_at %}{{ log.sent_at.strftime("%d.%m.%Y %H:%M") }}{% elif log.created_at %}{{ log.created_at.strftime("%d.%m.%Y %H:%M") }}{% else %}‚Äî{% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if doc.doc_type and doc.doc_type.code == 'reagent_expense' %}
    <div style="margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb;">
      <div style="font-weight:600; margin-bottom:8px;">–ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Å—Ç—Ä–æ–∫ –∏–∑ —Å–æ–±—ã—Ç–∏–π</div>

      <form method="post" action="/documents/{{ doc.id }}/reagent-expense/refill">
        <div style="margin-bottom:10px;">
          <div style="font-size:13px; color:#6b7280; margin-bottom:6px;">–£—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å—ã:</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            {% for s in all_status_names %}
              <label style="display:inline-flex; gap:6px; align-items:center; border:1px solid #ddd; padding:4px 10px; border-radius:6px; font-size:13px; cursor:pointer;">
                <input type="checkbox" name="status_names" value="{{ s }}"
                       {% if s in saved_status_names or not saved_status_names %}checked{% endif %}>
                <span>{{ s }}</span>
              </label>
            {% endfor %}
            {% if not all_status_names %}
              <span style="opacity:.6; font-size:13px;">–°—Ç–∞—Ç—É—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ë–î</span>
            {% endif %}
          </div>
          <div style="font-size:11px; color:#9ca3af; margin-top:6px;">
            –ï—Å–ª–∏ —Å–Ω—è—Ç—å –≤—Å–µ ‚Äî –±—É–¥—É—Ç —É—á—Ç–µ–Ω—ã –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥ (fallback).
          </div>
        </div>

        <button type="submit" class="btn"
                onclick="return confirm('–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –∏–∑ events? –í—Å–µ —Ä—É—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ —Å—Ç—Ä–æ–∫ –∞–∫—Ç–∞ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.');">
          –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏–∑ events
        </button>
      </form>
    </div>
    {% endif %}

    <form method="post" action="/documents/{{ doc.id }}/soft-delete" style="display:inline;">
  <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?');">
    –£–¥–∞–ª–∏—Ç—å
  </button>
</form>

  </section>

  <!-- ITEMS -->
  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–°—Ç—Ä–æ–∫–∏ (document_items)</h2>

    <div style="margin-bottom:12px; padding:12px; border:1px solid #eee; border-radius:10px;">
      <form method="post" action="/documents/{{ doc.id }}/items/add" style="display:grid; gap:8px;">
        <div style="display:grid; grid-template-columns: 2fr 1fr 120px 1fr; gap:8px;">
          <input name="work_type" placeholder="–í–∏–¥ —Ä–∞–±–æ—Ç" />
          <input name="reagent_name" placeholder="–†–µ–∞–≥–µ–Ω—Ç" />
          <input name="quantity" type="number" value="1" />
          <input name="stage" placeholder="–≠—Ç–∞–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)" />
        </div>
        <div style="display:grid; grid-template-columns: 1fr 2fr; gap:8px;">
          <input name="event_time_str" placeholder="–í—Ä–µ–º—è (—Å—Ç—Ä–æ–∫–æ–π, –Ω–∞–ø—Ä. 01.04.2025 12:19)" />
          <input name="notes" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" />
        </div>
        <div>
          <button type="submit">–î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
        </div>
      </form>
    </div>

    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th>#</th>
          <th>–†–∞–±–æ—Ç—ã</th>
          <th>–†–µ–∞–≥–µ–Ω—Ç</th>
          <th>–ö–æ–ª-–≤–æ</th>
          <th>–≠—Ç–∞–ø</th>
          <th>–í—Ä–µ–º—è</th>
          <th style="width:60px;"></th>
          <th style="width:80px;"></th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td><b>{{ it.line_number }}</b></td>
          <td>{{ it.work_type or "" }}</td>
          <td>{{ it.reagent_name or "" }}</td>
          <td>{{ it.quantity or "" }}</td>
          <td>{{ it.stage or "" }}</td>
          <td>{{ it.event_time_str or "" }}</td>

<!-- EDIT -->
<td style="text-align:left;">
  <details>
    <summary style="cursor:pointer;">‚úèÔ∏è</summary>

    <form method="post" action="/documents/items/{{ it.id }}/update" style="margin-top:8px;">
      <div style="display:grid; gap:8px;">

        <div style="display:grid; grid-template-columns: 2fr 1fr 120px; gap:8px;">
          <input name="work_type" value="{{ it.work_type or '' }}" placeholder="–í–∏–¥ —Ä–∞–±–æ—Ç" />
          <input name="reagent_name" value="{{ it.reagent_name or '' }}" placeholder="–†–µ–∞–≥–µ–Ω—Ç" />
          <input name="quantity" type="number" value="{{ it.quantity or 1 }}" />
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="stage" value="{{ it.stage or '' }}" placeholder="–≠—Ç–∞–ø" />
          <input name="event_time_str" value="{{ it.event_time_str or '' }}" placeholder="–í—Ä–µ–º—è (—Å—Ç—Ä–æ–∫–æ–π)" />
        </div>

        <input name="notes" value="{{ it.notes or '' }}" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ" />

        <div style="display:flex; gap:8px;">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </form>
  </details>
</td>

<!-- DELETE -->
<td style="text-align:right;">
  <form method="post" action="/documents/items/{{ it.id }}/delete"
        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É?');" style="margin:0;">
    <button type="submit">–£–¥–∞–ª–∏—Ç—å</button>
  </form>
</td>
        </tr>
        {% endfor %}
        {% if items|length == 0 %}
        <tr><td colspan="8" style="opacity:.7;">–°—Ç—Ä–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</td></tr>
        {% endif %}
      </tbody>
    </table>
  </section>

</div>
{% endblock %}