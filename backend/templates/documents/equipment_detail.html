{% extends "base.html" %}
{% block title %}{{ doc.doc_number }} ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div style="margin-bottom:16px; display:flex; gap:12px; align-items:center;">
  <a href="/" class="btn" style="background:#333; color:white;">üè† –î–∞—à–±–æ—Ä–¥</a>
  <a href="/documents" class="btn-secondary">üìã –í—Å–µ –∞–∫—Ç—ã</a>
  <span style="opacity:0.5;">‚Üí</span>
  <span style="font-weight:600;">{{ doc.doc_number }}</span>
</div>

<h1>{{ doc.doc_type.name_ru if doc.doc_type else "–ê–∫—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è" }}</h1>

<div class="card" style="padding:16px; max-width:900px;">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ -->
  <div style="display:grid; grid-template-columns:1fr auto; gap:16px; margin-bottom:20px; padding-bottom:16px; border-bottom:2px solid #e0e0e0;">
    <div>
      <div style="font-size:24px; font-weight:700; margin-bottom:8px;">
        {{ doc.doc_number or "‚Äî" }}
      </div>
      <div style="font-size:14px; opacity:0.7;">
        {% if doc.well %}–°–∫–≤–∞–∂–∏–Ω–∞ {{ doc.well.number }}{% endif %}
        {% if doc.meta and doc.meta.act_date %}
          ¬∑ {{ doc.meta.act_date }}
        {% endif %}
      </div>
    </div>

    <div style="text-align:right;">
      {% if doc.status == 'draft' %}
        <span class="badge" style="background:#ffc107; color:#000;">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
      {% elif doc.status == 'generated' %}
        <span class="badge" style="background:#17a2b8; color:#fff;">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω</span>
      {% elif doc.status == 'signed' %}
        <span class="badge" style="background:#28a745; color:#fff;">–ü–æ–¥–ø–∏—Å–∞–Ω</span>
      {% elif doc.status == 'sent' %}
        <span class="badge" style="background:#6f42c1; color:#fff;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>
      {% elif doc.status == 'archived' %}
        <span class="badge" style="background:#6c757d; color:#fff;">–ê—Ä—Ö–∏–≤</span>
      {% endif %}
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div style="display:grid; gap:16px; margin-bottom:24px;">

    <!-- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ -->
    <div>
      <label style="font-weight:600; display:block; margin-bottom:4px;">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏</label>
      <div style="font-size:18px;">
        {% if doc.meta and doc.meta.kind == 'install' %}
          üì¶ <b style="color:#28a745;">–ú–æ–Ω—Ç–∞–∂</b>
        {% else %}
          üîß <b style="color:#dc3545;">–î–µ–º–æ–Ω—Ç–∞–∂</b>
        {% endif %}
      </div>
    </div>

    <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è -->
    <div>
      <label style="font-weight:600; display:block; margin-bottom:4px;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è</label>
      <div>
        {% if doc.meta and doc.meta.event_dt %}
          {{ doc.meta.event_dt[:10] }} {{ doc.meta.event_dt[11:16] }}
        {% else %}
          ‚Äî
        {% endif %}
      </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
    <div>
      <label style="font-weight:600; display:block; margin-bottom:8px;">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</label>

      {% if equipment_items and equipment_items|length > 0 %}
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#f5f5f5; border-bottom:2px solid #ddd;">
              <th style="padding:10px; text-align:left; width:50px;">‚Ññ</th>
              <th style="padding:10px; text-align:left;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th style="padding:10px; text-align:left; width:150px;">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
              <th style="padding:10px; text-align:center; width:80px;">–ö–æ–ª-–≤–æ</th>
              <th style="padding:10px; text-align:left; width:120px;">–°—Ç–∞—Ç—É—Å</th>
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_items %}
            <tr style="border-bottom:1px solid #e0e0e0;">
              <td style="padding:10px;">{{ loop.index }}</td>
              <td style="padding:10px;">
                <div style="font-weight:600;">{{ item.name }}</div>
                {% if item.equipment %}
                  <div style="font-size:12px; opacity:0.6;">
                    {{ item.equipment.manufacturer or "" }}
                  </div>
                {% endif %}
              </td>
              <td style="padding:10px; font-family:monospace;">
                {{ item.serial_number or "‚Äî" }}
              </td>
              <td style="padding:10px; text-align:center;">
                {{ item.quantity }}
              </td>
              <td style="padding:10px;">
                {% if item.equipment %}
                  {% if item.equipment.status == 'available' %}
                    <span style="color:#28a745;">‚óè</span> –î–æ—Å—Ç—É–ø–Ω–æ
                  {% elif item.equipment.status == 'installed' %}
                    <span style="color:#007bff;">‚óè</span> –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                  {% elif item.equipment.status == 'maintenance' %}
                    <span style="color:#ffc107;">‚óè</span> –ù–∞ –¢–û
                  {% elif item.equipment.status == 'broken' %}
                    <span style="color:#dc3545;">‚óè</span> –ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ
                  {% else %}
                    <span style="color:#6c757d;">‚óè</span> {{ item.equipment.status }}
                  {% endif %}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div style="padding:20px; text-align:center; opacity:0.5;">
          –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
        </div>
      {% endif %}
    </div>

    <!-- –î–∞–≤–ª–µ–Ω–∏—è -->
    <div>
      <label style="font-weight:600; display:block; margin-bottom:8px;">–ü–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏—è</label>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div style="padding:12px; border:1px solid #e0e0e0; border-radius:6px;">
          <div style="font-size:12px; opacity:0.6; margin-bottom:4px;">–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</div>
          <div style="font-size:20px; font-weight:700;">
            {% if doc.meta and doc.meta.tube_pressure %}
              {{ doc.meta.tube_pressure }} <span style="font-size:14px; font-weight:400;">–∫–≥—Å/—Å–º¬≤</span>
            {% else %}
              <span style="opacity:0.5;">‚Äî</span>
            {% endif %}
          </div>
        </div>
        <div style="padding:12px; border:1px solid #e0e0e0; border-radius:6px;">
          <div style="font-size:12px; opacity:0.6; margin-bottom:4px;">–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ</div>
          <div style="font-size:20px; font-weight:700;">
            {% if doc.meta and doc.meta.line_pressure %}
              {{ doc.meta.line_pressure }} <span style="font-size:14px; font-weight:400;">–∫–≥—Å/—Å–º¬≤</span>
            {% else %}
              <span style="opacity:0.5;">‚Äî</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- –î–æ–≥–æ–≤–æ—Ä -->
    {% if doc.meta and doc.meta.contract_number %}
    <div>
      <label style="font-weight:600; display:block; margin-bottom:4px;">–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</label>
      <div>{{ doc.meta.contract_number }}</div>
    </div>
    {% endif %}

    <!-- –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è -->
    {% if doc.meta and doc.meta.territory_state %}
    <div>
      <label style="font-weight:600; display:block; margin-bottom:4px;">–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</label>
      <div>{{ doc.meta.territory_state }}</div>
    </div>
    {% endif %}

    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
    {% if doc.meta and doc.meta.note %}
    <div>
      <label style="font-weight:600; display:block; margin-bottom:4px;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
      <div style="white-space:pre-wrap;">{{ doc.meta.note }}</div>
    </div>
    {% endif %}
  </div>

  <!-- PDF Preview Section -->
  <div style="margin-top:20px; padding:16px; background:#f0f8ff; border-radius:8px;">
    <div style="font-weight:600; margin-bottom:8px;">üìÑ PDF –¥–æ–∫—É–º–µ–Ω—Ç</div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
      {% if doc.pdf_filename %}
        <a href="/static/{{ doc.pdf_filename }}" target="_blank" class="btn btn-primary">
          –û—Ç–∫—Ä—ã—Ç—å PDF
        </a>
        <a href="/static/{{ doc.pdf_filename }}" download class="btn-secondary">
          –°–∫–∞—á–∞—Ç—å
        </a>
      {% endif %}

      {% if doc.status in ['draft', 'generated'] %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/generate-pdf" style="display:inline-block;">
          <button type="submit" class="btn" style="background:#17a2b8; color:#fff;">
            {% if doc.pdf_filename %}üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å{% else %}üìÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å{% endif %}
          </button>
        </form>
      {% endif %}
    </div>

    {% if doc.pdf_filename %}
    <div style="border:1px solid #ddd; border-radius:8px; overflow:hidden;">
      <div style="background:#f8f9fa; padding:8px 12px; font-size:13px; display:flex; justify-content:space-between; align-items:center;">
        <span>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</span>
        <a href="/static/{{ doc.pdf_filename }}" target="_blank" style="font-size:12px;">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üí</a>
      </div>
      <iframe src="/static/{{ doc.pdf_filename }}" style="width:100%; height:500px; border:none;"></iframe>
    </div>
    {% else %}
    <div style="padding:40px; text-align:center; opacity:0.5; border:2px dashed #ddd; border-radius:8px;">
      PDF –µ—â—ë –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
    </div>
    {% endif %}
  </div>

  <!-- –î–µ–π—Å—Ç–≤–∏—è -->
  <div style="margin-top:24px; padding-top:16px; border-top:2px solid #e0e0e0;">
    <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">

      <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
      {% if doc.status == 'draft' %}
        <a href="/documents/equipment/{{ doc.id }}/edit" class="btn-secondary">
          ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </a>
      {% endif %}

      <!-- –í–µ—Ä–Ω—É—Ç—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
      {% if doc.status == 'generated' %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/change-status" style="display:inline-block;">
          <input type="hidden" name="new_status" value="draft">
          <button type="submit" class="btn-secondary">
            ‚úèÔ∏è –í–µ—Ä–Ω—É—Ç—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫
          </button>
        </form>
      {% endif %}

      <!-- –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ -->
      {% if doc.status == 'generated' %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/sign" style="display:inline-block;">
          <button type="submit" class="btn" style="background:#28a745; color:#fff;">
            ‚úÖ –ü–æ–¥–ø–∏—Å–∞—Ç—å
          </button>
        </form>
      {% endif %}

      <!-- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ -->
      {% if doc.status == 'signed' %}
        <div style="display:inline-flex; gap:8px;">
          <form method="post" action="/documents/equipment/{{ doc.id }}/change-status" style="display:inline-block;">
            <input type="hidden" name="new_status" value="sent">
            <button type="submit" class="btn" style="background:#6f42c1; color:#fff;">
              üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
          </form>
          <form method="post" action="/documents/equipment/{{ doc.id }}/change-status" style="display:inline-block;">
            <input type="hidden" name="new_status" value="archived">
            <button type="submit" class="btn" style="background:#6c757d; color:#fff;">
              üì¶ –í –∞—Ä—Ö–∏–≤
            </button>
          </form>
        </div>
      {% endif %}

      {% if doc.status == 'sent' %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/change-status" style="display:inline-block;">
          <input type="hidden" name="new_status" value="archived">
          <button type="submit" class="btn" style="background:#6c757d; color:#fff;">
            üì¶ –í –∞—Ä—Ö–∏–≤
          </button>
        </form>
      {% endif %}

      {% if doc.status == 'archived' %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/change-status" style="display:inline-block;">
          <input type="hidden" name="new_status" value="signed">
          <button type="submit" class="btn" style="background:#28a745; color:#fff;">
            ‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å –≤ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ
          </button>
        </form>
      {% endif %}

      <!-- –£–¥–∞–ª–µ–Ω–∏–µ (–¥–ª—è –ª—é–±–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –∫—Ä–æ–º–µ draft) -->
      {% if doc.status in ['generated', 'signed', 'sent', 'archived'] %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/delete"
              onsubmit="return confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!');"
              style="display:inline-block;">
          <button type="submit" class="btn" style="background:#dc3545; color:#fff;">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </form>
      {% endif %}

      <!-- –£–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ -->
      {% if doc.status == 'draft' %}
        <form method="post" action="/documents/equipment/{{ doc.id }}/delete"
              onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫? –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –≤–µ—Ä–Ω—ë—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å ¬´–î–æ—Å—Ç—É–ø–Ω–æ¬ª.');"
              style="display:inline-block;">
          <button type="submit" class="btn" style="background:#dc3545; color:#fff;">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </form>
      {% endif %}

      <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
      <div style="margin-left:auto; display:flex; gap:8px;">
        <a href="/documents" class="btn-secondary">‚Üê –ö —Å–ø–∏—Å–∫—É –∞–∫—Ç–æ–≤</a>
        <a href="/" class="btn-secondary">üè† –î–∞—à–±–æ—Ä–¥</a>
      </div>
    </div>
  </div>

  <!-- –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div style="margin-top:24px; padding-top:16px; border-top:1px solid #e0e0e0; font-size:12px; opacity:0.6;">
    <div>–°–æ–∑–¥–∞–Ω: {{ doc.created_at.strftime("%d.%m.%Y %H:%M") if doc.created_at else "‚Äî" }}</div>
    {% if doc.updated_at and doc.updated_at != doc.created_at %}
      <div>–ò–∑–º–µ–Ω—ë–Ω: {{ doc.updated_at.strftime("%d.%m.%Y %H:%M") }}</div>
    {% endif %}
    {% if doc.signed_at %}
      <div>–ü–æ–¥–ø–∏—Å–∞–Ω: {{ doc.signed_at.strftime("%d.%m.%Y %H:%M") }} ({{ doc.signed_by_name or "‚Äî" }})</div>
    {% endif %}
  </div>

</div>

<style>
.badge {
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}
</style>

{% endblock %}