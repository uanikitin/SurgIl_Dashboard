{% extends "base.html" %}
{% block title %}–ê–∫—Ç {{ "–º–æ–Ω—Ç–∞–∂–∞" if kind == "install" else "–¥–µ–º–æ–Ω—Ç–∞–∂–∞" }} ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div style="margin-bottom:16px; display:flex; gap:12px; align-items:center;">
  <a href="/" class="btn" style="background:#333; color:white;">üè† –î–∞—à–±–æ—Ä–¥</a>
  <a href="/documents" class="btn-secondary">üìã –í—Å–µ –∞–∫—Ç—ã</a>
  <span style="opacity:0.5;">‚Üí</span>
  <span style="font-weight:600;">–ù–æ–≤—ã–π –∞–∫—Ç</span>
</div>

<h1>–ê–∫—Ç {{ "–º–æ–Ω—Ç–∞–∂–∞" if kind == "install" else "–¥–µ–º–æ–Ω—Ç–∞–∂–∞" }} –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h1>

<div class="card" style="padding:24px; max-width:1200px;">

  <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–æ–Ω—Ç–∞–∂/–¥–µ–º–æ–Ω—Ç–∞–∂ -->
  <div style="display:flex; gap:12px; margin-bottom:24px; padding:12px; background:#f5f5f5; border-radius:8px;">
    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 16px; border-radius:6px; background:{% if kind == 'install' %}#0066cc; color:white{% else %}white{% endif %};">
      <input type="radio" name="kind_radio" value="install" {% if kind == 'install' %}checked{% endif %} onchange="window.location.href='/documents/equipment/new?well_id={{ well_id }}&kind=install'">
      <span style="font-weight:600;">üì¶ –ú–æ–Ω—Ç–∞–∂</span>
    </label>
    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; padding:8px 16px; border-radius:6px; background:{% if kind == 'removal' %}#dc3545; color:white{% else %}white{% endif %};">
      <input type="radio" name="kind_radio" value="removal" {% if kind == 'removal' %}checked{% endif %} onchange="window.location.href='/documents/equipment/new?well_id={{ well_id }}&kind=removal'">
      <span style="font-weight:600;">üîß –î–µ–º–æ–Ω—Ç–∞–∂</span>
    </label>
  </div>

  <form method="post" action="/documents/equipment/create">
    <input type="hidden" name="kind" value="{{ kind }}">
    <input type="hidden" name="doc_type_id" value="{{ dt_install.id if kind == 'install' else dt_removal.id }}">

    <!-- –î–ª—è –º–æ–Ω—Ç–∞–∂–∞ –≤—Å–µ–≥–¥–∞ "working" -->
    {% if kind == 'install' %}
    <input type="hidden" name="equipment_condition" value="working">
    {% endif %}

    <!-- –°–∫–≤–∞–∂–∏–Ω–∞ -->
    <div style="margin-bottom:20px;">
      <label><b>–°–∫–≤–∞–∂–∏–Ω–∞</b></label>
      <select name="well_id" required onchange="window.location.href='/documents/equipment/new?well_id=' + this.value + '&kind={{ kind }}'">
        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–≤–∞–∂–∏–Ω—É</option>
        {% for w in wells %}
        <option value="{{ w.id }}" {% if well_id == w.id %}selected{% endif %}>–°–∫–≤ {{ w.number }}</option>
        {% endfor %}
      </select>
    </div>

    {% if well_id %}

    <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
    <div style="margin-bottom:20px;">
      <label><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</b></label>

      <!-- –ü–µ—Ä–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (–¥–ª—è –º–æ–Ω—Ç–∞–∂–∞) -->
      {% if first_events %}
      <div id="pick-first" class="dt-picker" style="display:none; background:#d4edda; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #28a745;">
        <div style="font-weight:600; margin-bottom:8px;">–ü–µ—Ä–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–µ:</div>
        {% for ev in first_events %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#c3e6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="dt_pick" value="{{ ev.dt_iso }}"
                 onchange="applyDt(this.value)">
          <span style="background:#e7f3ff; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ ev.label }}</span>
          <span style="white-space:nowrap;">{{ ev.dt_display }}</span>
          {% if ev.desc %}<span style="opacity:0.6; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ ev.desc }}</span>{% endif %}
        </label>
        {% endfor %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px; margin-top:4px; border-top:1px solid #b8daff;"
               onmouseover="this.style.background='#c3e6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="dt_pick" value="manual"
                 onchange="document.getElementById('event-dt').value=''; document.getElementById('event-dt').focus();">
          <span style="opacity:0.7;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
        </label>
      </div>
      {% endif %}

      <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (–¥–ª—è –¥–µ–º–æ–Ω—Ç–∞–∂–∞) -->
      {% if last_events %}
      <div id="pick-last" class="dt-picker" style="display:none; background:#fde8e8; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #dc3545;">
        <div style="font-weight:600; margin-bottom:8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–µ:</div>
        {% for ev in last_events %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#f5c6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="dt_pick" value="{{ ev.dt_iso }}"
                 onchange="applyDt(this.value)">
          <span style="background:#ffeeba; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ ev.label }}</span>
          <span style="white-space:nowrap;">{{ ev.dt_display }}</span>
          {% if ev.desc %}<span style="opacity:0.6; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ ev.desc }}</span>{% endif %}
        </label>
        {% endfor %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px; margin-top:4px; border-top:1px solid #f5c6cb;"
               onmouseover="this.style.background='#f5c6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="dt_pick" value="manual"
                 onchange="document.getElementById('event-dt').value=''; document.getElementById('event-dt').focus();">
          <span style="opacity:0.7;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
        </label>
      </div>
      {% endif %}

      <!-- –î–∞—Ç—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —É—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
      {% if install_dates %}
      <div id="pick-installs" class="dt-picker" style="display:none; background:#e7f0ff; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #0066cc;">
        <div style="font-weight:600; margin-bottom:8px;">–ò–∑ –∏—Å—Ç–æ—Ä–∏–∏ –º–æ–Ω—Ç–∞–∂–∞/–¥–µ–º–æ–Ω—Ç–∞–∂–∞:</div>
        {% for d in install_dates %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#cce0ff'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="dt_pick" value="{{ d.dt_iso }}"
                 onchange="applyDt(this.value)">
          <span style="background:{% if d.label == '–ú–æ–Ω—Ç–∞–∂' %}#d4edda{% else %}#fde8e8{% endif %}; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ d.label }}</span>
          <span style="white-space:nowrap;">{{ d.dt_display }}</span>
          <span style="opacity:0.6; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ d.desc }}</span>
        </label>
        {% endfor %}
      </div>
      {% endif %}

      <input type="datetime-local" name="event_dt" id="event-dt" required onchange="fetchPressure()">
    </div>

    <!-- –í–´–ë–û–† –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø -->
    <div style="margin-bottom:20px; border:2px solid #ddd; border-radius:8px; padding:20px; background:#fafafa;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3 style="margin:0;">–í—ã–±–æ—Ä –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
        <button type="button" onclick="showNewEquipmentModal()" class="btn-secondary">+ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å</button>
      </div>

      <!-- –°–ø–∏—Å–æ–∫ –∫–ª–∞—Å—Å–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
      <div id="equipment-classes" style="display:grid; gap:16px;">
        {% for eq_class in equipment_classes %}
        <div class="equipment-class-card" style="border:1px solid #ddd; border-radius:8px; padding:16px; background:white;">

          <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–ª–∞—Å—Å–∞ -->
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:2px solid #eee;">
            <input type="checkbox" id="class-{{ loop.index }}" onchange="toggleClass({{ loop.index }})">
            <label for="class-{{ loop.index }}" style="margin:0; font-weight:700; font-size:16px; cursor:pointer; flex:1;">
              {{ eq_class.name }}
            </label>
            <span style="opacity:0.6; font-size:13px;">{{ eq_class.available }} –¥–æ—Å—Ç—É–ø–Ω–æ / {{ eq_class.total }} –≤—Å–µ–≥–æ</span>
          </div>

          <!-- –°–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ -->
          <div id="serials-{{ loop.index }}" style="display:none; margin-left:32px;">
            {% if eq_class['items']|length > 0 %}
              {% for eq in eq_class['items'] %}
              <div style="display:flex; flex-wrap:wrap; align-items:center; gap:12px; padding:8px; margin-bottom:6px; border-radius:6px; {% if eq.status == 'available' %}background:#e7f5e7{% elif eq._installed_on_same_well %}background:#e7f0ff{% else %}background:#fff3cd{% endif %};">
                <input type="checkbox" name="equipment_ids" value="{{ eq.id }}"
                       class="eq-checkbox" data-eq-id="{{ eq.id }}"
                       {% if kind == 'install' and eq._installed_on_other_well %}disabled title="–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –¥—Ä—É–≥–æ–π —Å–∫–≤–∞–∂–∏–Ω–µ"{% endif %}
                       onchange="toggleLocationSelect(this)">
                <span style="font-family:monospace; font-weight:600;">{{ eq.serial_number }}</span>
                <span style="flex:1; opacity:0.7; font-size:13px;">{{ eq.manufacturer or '‚Äî' }}</span>

                {% if eq.status == 'installed' %}
                  {% if eq._installed_on_same_well %}
                    {# –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –≠–¢–û–ô –ñ–ï —Å–∫–≤–∞–∂–∏–Ω–µ - —Ä–∞–∑—Ä–µ—à–∞–µ–º #}
                    <span style="padding:4px 8px; background:#0066cc; color:white; border-radius:4px; font-size:12px; font-weight:600;">
                      üìç –£–∂–µ –Ω–∞ —ç—Ç–æ–π —Å–∫–≤.
                    </span>
                    {% if eq._has_existing_doc %}
                      <span style="color:#856404; font-size:12px;">‚ö†Ô∏è –ê–∫—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>
                    {% else %}
                      <span style="color:#0066cc; font-size:12px;">‚ÑπÔ∏è –ë–µ–∑ –∞–∫—Ç–∞</span>
                    {% endif %}
                  {% elif eq._installed_on_other_well %}
                    {# –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –î–†–£–ì–û–ô —Å–∫–≤–∞–∂–∏–Ω–µ - –±–ª–æ–∫–∏—Ä—É–µ–º #}
                    <span style="padding:4px 8px; background:#dc3545; color:white; border-radius:4px; font-size:12px; font-weight:600;">
                      üö´ –°–∫–≤. {{ eq._installed_well_number }}
                    </span>
                    <span style="color:#dc3545; font-size:12px;">‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –¥–µ–º–æ–Ω—Ç–∏—Ä—É–π</span>
                  {% else %}
                    <span style="padding:4px 8px; background:#ffc107; color:#000; border-radius:4px; font-size:12px; font-weight:600;">
                      üìç {{ eq.current_location }}
                    </span>
                  {% endif %}
                {% else %}
                  <span style="padding:4px 8px; background:#28a745; color:white; border-radius:4px; font-size:12px; font-weight:600;">
                    ‚úì –î–æ—Å—Ç—É–ø–Ω–æ
                  </span>
                {% endif %}

                {# –ú–µ—Å—Ç–æ –º–æ–Ω—Ç–∞–∂–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è #}
                {% if kind == 'install' and not eq._installed_on_other_well %}
                <div id="location-{{ eq.id }}" class="eq-location-row" style="display:none; width:100%; margin-top:8px; padding:8px; background:#fff; border-radius:4px; border:1px solid #0066cc;">
                  <label style="font-size:12px; font-weight:600; color:#0066cc;">üìç –ú–µ—Å—Ç–æ –º–æ–Ω—Ç–∞–∂–∞:</label>
                  <select name="location_{{ eq.id }}" class="eq-location-select" style="margin-left:8px; padding:4px 8px; font-size:13px; border-radius:4px; border:1px solid #ccc;"
                          {% if eq._installation_location %}disabled{% endif %}>
                    {% if eq._installation_location %}
                      <option value="{{ eq._installation_location }}" selected>{{ eq._installation_location }}</option>
                    {% else %}
                      <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                      <option value="–£—Å—Ç—å–µ">–£—Å—Ç—å–µ</option>
                      <option value="–ù–ö–¢">–ù–ö–¢</option>
                      <option value="–®–ª–µ–π—Ñ">–®–ª–µ–π—Ñ</option>
                      <option value="–ó–∞—Ç—Ä—É–±">–ó–∞—Ç—Ä—É–±</option>
                      <option value="–Ü–Ω—à–µ">–Ü–Ω—à–µ</option>
                    {% endif %}
                  </select>
                  {% if eq._installation_location %}
                    <span style="margin-left:8px; font-size:11px; color:#666;">(—É–∂–µ —É–∫–∞–∑–∞–Ω–æ)</span>
                  {% endif %}
                </div>
                {% elif kind == 'removal' and eq._installation_location %}
                {# –î–ª—è –¥–µ–º–æ–Ω—Ç–∞–∂–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ—Å—Ç–æ, –æ—Ç–∫—É–¥–∞ –¥–µ–º–æ–Ω—Ç–∏—Ä—É–µ–º (—Ç–æ–ª—å–∫–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ) #}
                <div style="width:100%; margin-top:8px; padding:6px 8px; background:#fff9e6; border-radius:4px; border:1px solid #ffc107;">
                  <span style="font-size:12px; color:#856404;">üìç –ú–µ—Å—Ç–æ: <b>{{ eq._installation_location }}</b></span>
                </div>
                {% endif %}
              </div>
              {% endfor %}

              <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏–π–Ω–∏–∫ -->
              <button type="button" onclick="showNewSerialModal('{{ eq_class.name }}')"
                      style="margin-top:8px; padding:6px 12px; background:#f0f0f0; border:1px dashed #999; border-radius:4px; cursor:pointer; font-size:13px;">
                + –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
              </button>
            {% else %}
              <p style="opacity:0.5; font-size:13px;">–ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞</p>
            {% endif %}
          </div>

        </div>
        {% endfor %}

        {% if equipment_classes|length == 0 %}
        <div style="text-align:center; padding:40px; opacity:0.5;">
          {% if kind == 'removal' %}
            –ù–∞ —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω–µ –Ω–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –¥–ª—è –¥–µ–º–æ–Ω—Ç–∞–∂–∞.
          {% else %}
            –ù–µ—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å.
          {% endif %}
        </div>
        {% endif %}
      </div>

      <div style="margin-top:12px; font-size:14px; font-weight:600;">
        –í—ã–±—Ä–∞–Ω–æ: <span id="count">0</span> –µ–¥–∏–Ω–∏—Ü
      </div>
    </div>

    <!-- –î–ê–í–õ–ï–ù–ò–Ø -->
    <div style="margin-bottom:20px; border:2px solid #ddd; border-radius:8px; padding:20px; background:#f0f8ff;">
      <h3 style="margin:0 0 16px 0;">üìä –ü–æ–∫–∞–∑–∞–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏—è</h3>

      <!-- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
      <div id="pressure-status" style="margin-bottom:16px; padding:12px; border-radius:6px;
           {% if pressure_source_desc %}background:#d4edda; color:#155724;{% else %}background:#fff3cd; color:#856404;{% endif %}">
        {% if pressure_source_desc %}
          ‚úì –ù–∞–π–¥–µ–Ω–æ: <b>{{ pressure_source_desc }}</b>
        {% else %}
          ‚ö†Ô∏è –î–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é
        {% endif %}
      </div>

      <!-- –ü–æ–ª—è –¥–∞–≤–ª–µ–Ω–∏–π -->
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
        <div>
          <label><b>–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–∫–≥—Å/—Å–º¬≤)</b></label>
          <input type="number" step="0.01" name="tube_pressure" id="tube-pressure"
                 placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 45.5" style="width:100%;"
                 value="{{ auto_tube_pressure or '' }}">
        </div>
        <div>
          <label><b>–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ (–∫–≥—Å/—Å–º¬≤)</b></label>
          <input type="number" step="0.01" name="line_pressure" id="line-pressure"
                 placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 32.0" style="width:100%;"
                 value="{{ auto_line_pressure or '' }}">
        </div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
        <button type="button" onclick="fetchPressure()" class="btn-secondary" style="font-size:13px;">
          üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏—è
        </button>
        <span style="font-size:12px; color:#666;">
          –î–∞–≤–ª–µ–Ω–∏—è –º–æ–∂–Ω–æ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é
        </span>
      </div>
    </div>

    <!-- –°–û–°–¢–û–Ø–ù–ò–ï –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –¥–ª—è –¥–µ–º–æ–Ω—Ç–∞–∂–∞) -->
    {% if kind == 'removal' %}
    <div style="margin-bottom:20px; border:2px solid #ffc107; border-radius:8px; padding:20px; background:#fff9e6;">
      <h3 style="margin:0 0 16px 0;">‚öôÔ∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –¥–µ–º–æ–Ω—Ç–∞–∂–µ</h3>
      <div>
        <label><b>–ù–∞ –º–æ–º–µ–Ω—Ç –¥–µ–º–æ–Ω—Ç–∞–∂–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤:</b></label>
        <select name="equipment_condition" required style="width:100%; padding:10px; font-size:15px;">
          <option value="working">‚úÖ –†–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏</option>
          <option value="not_working">‚ùå –ù–µ—Ä–∞–±–æ—á–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏</option>
        </select>
      </div>
      <div style="margin-top:12px; font-size:13px; opacity:0.7; padding:10px; background:#fff; border-radius:4px;">
        üí° –≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω–∞ –≤ –∞–∫—Ç–µ –¥–µ–º–æ–Ω—Ç–∞–∂–∞
      </div>
    </div>
    {% endif %}

    <!-- –î–æ–≥–æ–≤–æ—Ä -->
    <div style="margin-bottom:20px;">
      <label><b>–î–æ–≥–æ–≤–æ—Ä</b></label>
      <input name="contract_number" value="2/24-09 –æ—Ç 24.09.2024" required>
    </div>

    <!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ) -->
    <div style="margin-bottom:20px;">
      <label><b>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–∏</b> <span style="opacity:0.6; font-weight:400;">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
      <input name="territory_state" value="" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è —á–∏—Å—Ç–∞—è">
    </div>

    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
    <div style="margin-bottom:20px;">
      <label><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</b></label>
      <textarea name="note" rows="3"></textarea>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∏ -->
    <div style="display:flex; gap:12px; align-items:center;">
      <button type="submit" id="submit-btn" disabled class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∞–∫—Ç</button>
      <a href="/documents" class="btn-secondary">–û—Ç–º–µ–Ω–∞</a>
      <a href="/" class="btn-secondary" style="margin-left:auto;">üè† –ù–∞ –¥–∞—à–±–æ—Ä–¥</a>
    </div>

    {% endif %}
  </form>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ù–æ–≤—ã–π –∫–ª–∞—Å—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è -->
<div id="modal-new-class" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; border-radius:12px; max-width:500px; width:90%;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è</h3>
    <form onsubmit="return addNewClass(event)">
      <div style="margin-bottom:12px;">
        <label><b>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞</b></label>
        <input name="class_name" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Ä–º–æ–º–µ—Ç—Ä">
      </div>
      <div style="margin-bottom:12px;">
        <label><b>–ü–µ—Ä–≤—ã–π —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</b></label>
        <input name="serial_number" required placeholder="TH-2025-001">
      </div>
      <div style="margin-bottom:12px;">
        <label>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
        <input name="manufacturer" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: UNITOOL">
      </div>
      <div style="display:flex; gap:10px;">
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button type="button" onclick="hideModals()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞: –ù–æ–≤—ã–π —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä -->
<div id="modal-new-serial" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; padding:24px; border-radius:12px; max-width:500px; width:90%;">
    <h3>–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</h3>
    <p id="modal-class-name" style="opacity:0.7;"></p>
    <form onsubmit="return addNewSerial(event)">
      <input type="hidden" name="class_name" id="hidden-class-name">
      <div style="margin-bottom:12px;">
        <label><b>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</b></label>
        <input name="serial_number" required placeholder="SMOD-2025-005">
      </div>
      <div style="margin-bottom:12px;">
        <label>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å</label>
        <input name="manufacturer" placeholder="UNITOOL">
      </div>
      <div style="display:flex; gap:10px;">
        <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button type="button" onclick="hideModals()">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </form>
  </div>
</div>

<script>
// === –í—ã–±–æ—Ä –¥–∞—Ç—ã –∏–∑ —Å–æ–±—ã—Ç–∏–π ===
function applyDt(val) {
  const inp = document.getElementById('event-dt');
  if (inp && val !== 'manual') {
    inp.value = val;
    fetchPressure();
  }
}

function showDtPicker() {
  // –°–∫—Ä—ã—Ç—å –≤—Å–µ
  document.querySelectorAll('.dt-picker').forEach(el => el.style.display = 'none');
  document.querySelectorAll('input[name="dt_pick"]').forEach(r => r.checked = false);

  const kind = '{{ kind }}';
  const eventBlock = document.getElementById(kind === 'removal' ? 'pick-last' : 'pick-first');
  const installBlock = document.getElementById('pick-installs');

  // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ —Å–æ–±—ã—Ç–∏–π
  if (eventBlock) eventBlock.style.display = 'block';
  // –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–æ–∫ –≤—Å–µ–≥–¥–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
  if (installBlock) installBlock.style.display = 'block';

  // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ radio –∏–∑ –±–ª–æ–∫–∞ —Å–æ–±—ã—Ç–∏–π
  if (eventBlock) {
    const first = eventBlock.querySelector('input[name="dt_pick"]');
    if (first && first.value !== 'manual') {
      first.checked = true;
      applyDt(first.value);
      return;
    }
  }
  // –ò–Ω–∞—á–µ –∏–∑ —É—Å—Ç–∞–Ω–æ–≤–æ–∫
  if (installBlock) {
    const first = installBlock.querySelector('input[name="dt_pick"]');
    if (first && first.value !== 'manual') {
      first.checked = true;
      applyDt(first.value);
      return;
    }
  }
  // Fallback ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
  setNow();
}

function setNow() {
  const inp = document.getElementById('event-dt');
  if (inp) inp.value = new Date().toISOString().slice(0, 16);
}

// Init
const eventDtInput = document.getElementById('event-dt');
if (eventDtInput) {
  showDtPicker();
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
function toggleClass(index) {
  const checkbox = document.getElementById('class-' + index);
  const serialsDiv = document.getElementById('serials-' + index);
  serialsDiv.style.display = checkbox.checked ? 'block' : 'none';
  if (!checkbox.checked) {
    serialsDiv.querySelectorAll('input[name="equipment_ids"]').forEach(cb => cb.checked = false);
  }
  updateCount();
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª–µ –º–µ—Å—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
function toggleLocationSelect(checkbox) {
  const eqId = checkbox.dataset.eqId;
  const locationDiv = document.getElementById('location-' + eqId);
  if (locationDiv) {
    locationDiv.style.display = checkbox.checked ? 'block' : 'none';
  }
  updateCount();
}

// –ü–æ–¥—Å—á—ë—Ç –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è
function updateCount() {
  const checkedBoxes = document.querySelectorAll('input[name="equipment_ids"]:checked');
  const count = checkedBoxes.length;
  document.getElementById('count').textContent = count;

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–ª—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É–∫–∞–∑–∞–Ω–æ –º–µ—Å—Ç–æ –º–æ–Ω—Ç–∞–∂–∞ (–¥–ª—è –º–æ–Ω—Ç–∞–∂–∞)
  let allLocationsValid = true;
  const kind = '{{ kind }}';

  if (kind === 'install') {
    checkedBoxes.forEach(cb => {
      const eqId = cb.dataset.eqId;
      const locationSelect = document.querySelector(`select[name="location_${eqId}"]`);
      if (locationSelect && !locationSelect.disabled && !locationSelect.value) {
        allLocationsValid = false;
      }
    });
  }

  document.getElementById('submit-btn').disabled = count === 0 || !allLocationsValid;
}

document.querySelectorAll('input[name="equipment_ids"]').forEach(cb => {
  cb.addEventListener('change', updateCount);
});

// –û–±–Ω–æ–≤–ª—è—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–µ—Å—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞
document.querySelectorAll('.eq-location-select').forEach(sel => {
  sel.addEventListener('change', updateCount);
});

// –ú–æ–¥–∞–ª–∫–∏
function showNewEquipmentModal() {
  document.getElementById('modal-new-class').style.display = 'flex';
}

function showNewSerialModal(className) {
  document.getElementById('modal-class-name').textContent = '–ö–ª–∞—Å—Å: ' + className;
  document.getElementById('hidden-class-name').value = className;
  document.getElementById('modal-new-serial').style.display = 'flex';
}

function hideModals() {
  document.getElementById('modal-new-class').style.display = 'none';
  document.getElementById('modal-new-serial').style.display = 'none';
}

// –ó–∞–ø—Ä–æ—Å –¥–∞–≤–ª–µ–Ω–∏–π —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchPressure() {
  const wellId = {{ well_id or 'null' }};
  const eventDt = document.getElementById('event-dt')?.value;
  const statusDiv = document.getElementById('pressure-status');

  if (!wellId || !eventDt) {
    return;
  }

  try {
    statusDiv.innerHTML = '‚è≥ –ü–æ–∏—Å–∫ –¥–∞–≤–ª–µ–Ω–∏–π...';
    statusDiv.style.background = '#e2e3e5';
    statusDiv.style.color = '#383d41';

    const response = await fetch(`/api/equipment/pressure?well_id=${wellId}&event_dt=${encodeURIComponent(eventDt)}`);
    const data = await response.json();

    if (data.tube_pressure !== null || data.line_pressure !== null) {
      document.getElementById('tube-pressure').value = data.tube_pressure || '';
      document.getElementById('line-pressure').value = data.line_pressure || '';
      statusDiv.innerHTML = `‚úì –ù–∞–π–¥–µ–Ω–æ: <b>${data.source_desc || '—Å–æ–±—ã—Ç–∏–µ'}</b>`;
      statusDiv.style.background = '#d4edda';
      statusDiv.style.color = '#155724';
    } else {
      statusDiv.innerHTML = '‚ö†Ô∏è –î–∞–≤–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã ‚Äî –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
    }
  } catch (e) {
    console.error('Pressure fetch error:', e);
    statusDiv.innerHTML = '‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é';
    statusDiv.style.background = '#f8d7da';
    statusDiv.style.color = '#721c24';
  }
}

// –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å
async function addNewClass(e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);

  const response = await fetch('/api/equipment/add', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      name: data.get('class_name'),
      serial_number: data.get('serial_number'),
      manufacturer: data.get('manufacturer'),
      status: 'available'
    })
  });

  if (response.ok) {
    location.reload();
  } else {
    const err = await response.json();
    alert('–û—à–∏–±–∫–∞: ' + (err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
  }
  return false;
}

// –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏–π–Ω–∏–∫
async function addNewSerial(e) {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);

  const response = await fetch('/api/equipment/add', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      name: data.get('class_name'),
      serial_number: data.get('serial_number'),
      manufacturer: data.get('manufacturer'),
      status: 'available'
    })
  });

  if (response.ok) {
    location.reload();
  } else {
    const err = await response.json();
    alert('–û—à–∏–±–∫–∞: ' + (err.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
  }
  return false;
}
</script>

{% endblock %}