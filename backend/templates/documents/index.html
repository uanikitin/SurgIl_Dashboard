{% extends "base.html" %}

{% block title %}–ê–∫—Ç—ã ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}

{# ============================================================
   –ó–û–ù–ê 0: –í–ï–†–•–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø –ü–û –°–ê–ô–¢–£
   ============================================================ #}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item active">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<div class="page-dashboard">

{# ============================================================
   HEADER
   ============================================================ #}
<header class="dashboard-header">
  <div class="header-left">
    <a href="/visual" class="back-btn">‚Üê</a>
    <h1>–ê–∫—Ç—ã –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
  </div>
</header>

{# ============================================================
   FLASH MESSAGE
   ============================================================ #}
{% if flash_msg %}
<div class="flash-message flash-{{ flash_msg_type }}" style="
  padding: 12px 16px;
  margin-bottom: 16px;
  border-radius: 8px;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 10px;
  {% if flash_msg_type == 'success' %}
    background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0;
  {% elif flash_msg_type == 'warning' %}
    background: #fef3c7; color: #92400e; border: 1px solid #fcd34d;
  {% elif flash_msg_type == 'error' %}
    background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;
  {% else %}
    background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;
  {% endif %}
">
  <span style="flex:1;">
    {% if flash_msg_type == 'success' %}‚úÖ{% elif flash_msg_type == 'warning' %}‚ö†Ô∏è{% elif flash_msg_type == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
    {{ flash_msg }}
  </span>
  <button onclick="this.parentElement.remove()" style="background:none; border:none; cursor:pointer; font-size:18px; opacity:0.6;">&times;</button>
</div>
{% endif %}

{# ============================================================
   KPI –°–ï–ö–¶–ò–Ø
   ============================================================ #}
<section class="kpi-section">
  <div class="kpi-grid kpi-grid-4">
    <div class="kpi-card">
      <div class="kpi-icon" style="background:#e0e7ff; color:#3730a3;">üìù</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ board.get('draft', [])|length }}</div>
        <div class="kpi-label">–ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:#dbeafe; color:#1d4ed8;">üìÑ</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ board.get('generated', [])|length }}</div>
        <div class="kpi-label">–°–æ–∑–¥–∞–Ω–æ</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:#d1fae5; color:#059669;">‚úÖ</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ board.get('signed', [])|length }}</div>
        <div class="kpi-label">–ü–æ–¥–ø–∏—Å–∞–Ω–æ</div>
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon" style="background:#fef3c7; color:#d97706;">üì¶</div>
      <div class="kpi-data">
        <div class="kpi-value">{{ archive_total }}</div>
        <div class="kpi-label">–í –∞—Ä—Ö–∏–≤–µ</div>
      </div>
    </div>
  </div>
</section>

<div class="cards-grid">

  <!-- KANBAN -->
  <section class="analytics-card">
    <div class="section-header">
      <h2>–ö–∞–Ω–±–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h2>
    </div>

    <div class="kanban-grid">
      {# ‚îÄ‚îÄ Active columns: draft, generated, signed, sent ‚îÄ‚îÄ #}
      {% for s in ["draft","generated","signed","sent"] %}
      {% set col_docs = board.get(s, []) %}
      <div class="kanban-col" data-status="{{ s }}"
           ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event)"
           ondragleave="kanbanDragLeave(event)">

        <div class="kanban-col-header">
          <span>
          {% if s == 'draft' %}üìù –ß–µ—Ä–Ω–æ–≤–∏–∫
          {% elif s == 'generated' %}üìÑ –°–æ–∑–¥–∞–Ω
          {% elif s == 'signed' %}‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω
          {% elif s == 'sent' %}üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
          {% endif %}
          </span>
          {% if col_docs %}
            <span class="kanban-count">({{ col_docs|length }})</span>
          {% endif %}
          {% if s in ('generated', 'signed', 'sent') %}
            <label style="margin-left:auto; cursor:pointer; font-size:11px; font-weight:400; display:flex; align-items:center; gap:3px;" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ">
              <input type="checkbox" class="col-select-all" data-col="{{ s }}" onchange="toggleColumnAll('{{ s }}', this.checked)">
              –≤—Å–µ
            </label>
          {% endif %}
        </div>

        {# ‚îÄ‚îÄ Summary: doc types + wells ‚îÄ‚îÄ #}
        {% if col_docs %}
        <div class="kanban-summary">
          {%- set ns = namespace(types={}, wells=[]) -%}
          {%- for d in col_docs -%}
            {%- set tname = d.doc_type.name_ru if d.doc_type else "–î—Ä—É–≥–æ–µ" -%}
            {%- if ns.types.update({tname: ns.types.get(tname, 0) + 1}) -%}{%- endif -%}
            {%- if d.well and d.well.number|string not in ns.wells -%}
              {%- if ns.wells.append(d.well.number|string) -%}{%- endif -%}
            {%- endif -%}
          {%- endfor -%}
          <span>
          {%- for tname, cnt in ns.types.items() -%}
            {{ tname }}{% if cnt > 1 %}&nbsp;({{ cnt }}){% endif %}{% if not loop.last %}, {% endif %}
          {%- endfor -%}
          </span>
          {% if ns.wells %}
          <br><span>–°–∫–≤: {{ ns.wells[:6]|join(", ") }}{% if ns.wells|length > 6 %} +{{ ns.wells|length - 6 }}{% endif %}</span>
          {% endif %}
        </div>
        {% endif %}

        {# ‚îÄ‚îÄ Cards ‚îÄ‚îÄ #}
        {% for d in col_docs %}
          {% set is_handover = d.doc_type and d.doc_type.code in ["well_acceptance", "well_transfer", "well_stage_accept", "well_stage_return"] %}
          {% set is_equipment = d.doc_type and d.doc_type.code in ["equipment_install", "equipment_remove"] %}
          {% if is_handover %}
            {% set detail_url = "/documents/well-handover/" ~ d.id %}
          {% elif is_equipment %}
            {% set detail_url = "/documents/equipment/" ~ d.id %}
          {% else %}
            {% set detail_url = "/documents/" ~ d.id %}
          {% endif %}

          <div class="kanban-card{% if loop.index > 3 %} kanban-card-hidden{% endif %}"
               draggable="true" data-doc-id="{{ d.id }}" data-status="{{ s }}"
               ondragstart="kanbanDragStart(event)" ondragend="kanbanDragEnd(event)"
               data-kanban-col="{{ s }}">
            {% if d.pdf_filename %}
              <input type="checkbox" class="doc-select-cb" data-doc-id="{{ d.id }}"
                     data-doc-label="{{ d.doc_number or d.id }}"
                     onchange="updateBatchBar()"
                     style="position:absolute; top:8px; right:8px; cursor:pointer;">
            {% endif %}
            <div><strong>{{ d.doc_number or "‚Äî" }}</strong></div>

            <div style="font-size:12px; opacity:0.8;">
              {{ d.doc_type.name_ru if d.doc_type else "" }}
              {% if d.well %} ¬∑ –°–∫–≤ {{ d.well.number }}{% endif %}
            </div>

            <div style="font-size:12px; opacity:0.8;">
              {% if d.period_month and d.period_year %}
                {{ "%02d"|format(d.period_month) }}.{{ d.period_year }}
              {% endif %}
            </div>

            <div style="margin-top:6px; display:flex; gap:10px; align-items:center;">
              <a href="{{ detail_url }}" class="admin-link" draggable="false">–û—Ç–∫—Ä—ã—Ç—å</a>

              {% if d.status == "draft" %}
                {% if is_equipment %}
                  <form method="post" action="/documents/equipment/{{ d.id }}/delete"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?');"
                        style="margin:0;">
                    <button type="submit" style="font-size:11px; padding:2px 6px;">√ó</button>
                  </form>
                {% else %}
                  <form method="post" action="/documents/{{ d.id }}/delete"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?');"
                        style="margin:0;">
                    <button type="submit" style="font-size:11px; padding:2px 6px;">√ó</button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}

        {% if col_docs|length > 3 %}
          <button class="kanban-expand-btn" data-expanded="0"
                  onclick="toggleColumnExpand(this, '{{ s }}')">
            +{{ col_docs|length - 3 }} –µ—â—ë
          </button>
        {% endif %}

        {% if col_docs|length == 0 %}
          <div style="opacity:0.4; font-size:12px; text-align:center; padding:8px;">–ø—É—Å—Ç–æ</div>
        {% endif %}
      </div>
      {% endfor %}

      {# ‚îÄ‚îÄ Archive column: accordion by well, AJAX-loaded ‚îÄ‚îÄ #}
      <div class="kanban-col kanban-col-terminal" data-status="archived"
           ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event)"
           ondragleave="kanbanDragLeave(event)">

        <div class="kanban-col-header">
          <span>üì¶ –ê—Ä—Ö–∏–≤</span>
          {% if archive_total %}
            <span class="kanban-count">({{ archive_total }})</span>
          {% endif %}
        </div>

        {% if archive_summary %}
        <div id="archiveAccordion">
          {% for row in archive_summary %}
          <details class="archive-well-group" data-well-id="{{ row.well_id }}">
            <summary class="archive-well-header">
              <span class="archive-arrow">‚ñ∫</span>
              –°–∫–≤ {{ row.well_number or '‚Äî' }}
              <span class="archive-count">{{ row.cnt }}</span>
            </summary>
            <div class="archive-well-docs" id="archiveDocs-{{ row.well_id }}">
              <div style="padding:8px; color:#9ca3af; font-size:12px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </details>
          {% endfor %}
        </div>
        {% else %}
        <div style="opacity:0.4; font-size:12px; text-align:center; padding:8px;">–ø—É—Å—Ç–æ</div>
        {% endif %}
      </div>

      {# ‚îÄ‚îÄ Cancelled column: compact list ‚îÄ‚îÄ #}
      <div class="kanban-col kanban-col-terminal" data-status="cancelled"
           ondragover="kanbanDragOver(event)" ondrop="kanbanDrop(event)"
           ondragleave="kanbanDragLeave(event)">

        <div class="kanban-col-header">
          <span>‚ùå –û—Ç–º–µ–Ω—ë–Ω</span>
          {% if cancelled_docs %}
            <span class="kanban-count">({{ cancelled_docs|length }})</span>
          {% endif %}
        </div>

        {% for cd in cancelled_docs[:5] %}
        <div class="cancelled-row">
          <a href="/documents/{{ cd.id }}">{{ cd.doc_number or '‚Äî' }}</a>
          <span>{{ cd.type_name or '' }}</span>
          {% if cd.well_number %}<span>–°–∫–≤ {{ cd.well_number }}</span>{% endif %}
        </div>
        {% endfor %}
        {% if cancelled_docs|length > 5 %}
          <button class="kanban-expand-btn" data-expanded="0"
                  onclick="toggleCancelledExpand(this)">
            +{{ cancelled_docs|length - 5 }} –µ—â—ë
          </button>
          {% for cd in cancelled_docs[5:] %}
          <div class="cancelled-row cancelled-row-hidden" style="display:none;">
            <a href="/documents/{{ cd.id }}">{{ cd.doc_number or '‚Äî' }}</a>
            <span>{{ cd.type_name or '' }}</span>
            {% if cd.well_number %}<span>–°–∫–≤ {{ cd.well_number }}</span>{% endif %}
          </div>
          {% endfor %}
        {% endif %}
        {% if cancelled_docs|length == 0 %}
          <div style="opacity:0.4; font-size:12px; text-align:center; padding:8px;">–ø—É—Å—Ç–æ</div>
        {% endif %}
      </div>
    </div>
  </section>

  {# ============================================================
     BATCH ACTION BAR (sticky, appears when documents selected)
     ============================================================ #}
  <div id="batchBar" style="
    display:none; position:sticky; bottom:16px; z-index:50;
    background:#1e293b; color:#fff; border-radius:10px; padding:10px 20px;
    align-items:center; gap:12px;
    box-shadow:0 4px 16px rgba(0,0,0,0.2); margin:8px 0;">
    <span id="batchCount" style="font-weight:600; font-size:14px;">0 –≤—ã–±—Ä–∞–Ω–æ</span>
    <div style="flex:1;"></div>
    <button onclick="openBatchSendModal('telegram')" style="
      background:#0088cc; color:#fff; border:none; border-radius:6px;
      padding:6px 14px; font-size:13px; font-weight:600; cursor:pointer;">
      Telegram
    </button>
    <button onclick="openBatchSendModal('email')" style="
      background:#059669; color:#fff; border:none; border-radius:6px;
      padding:6px 14px; font-size:13px; font-weight:600; cursor:pointer;">
      Email
    </button>
    <button onclick="clearDocSelection()" style="
      background:transparent; color:#94a3b8; border:1px solid #475569; border-radius:6px;
      padding:6px 14px; font-size:13px; cursor:pointer;">
      –°–±—Ä–æ—Å–∏—Ç—å
    </button>
  </div>

  <!-- REAGENT EXPENSE SECTION -->
  <section class="analytics-card">
    <div class="section-header">
      <div>
        <h3 style="margin:0;">–ê–∫—Ç—ã —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤</h3>
        <p class="text-secondary" style="margin:4px 0 0 0; font-size:13px;">–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∞–∫—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥—É —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–∫–≤–∞–∂–∏–Ω</p>
      </div>
      <div class="section-controls" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <button type="button" class="btn-secondary" onclick="openAutoCreateModal()">
          ü§ñ –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ
        </button>
        <a class="btn-apply" href="/documents/reagent-expense/new">+ –°–æ–∑–¥–∞—Ç—å –∞–∫—Ç</a>
        <a href="/documents/jobs" class="text-secondary" style="font-size:12px; margin-left:8px;">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á</a>
      </div>
    </div>

    {# –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è #}
    <div id="autoCreateResult" style="display:none; margin-top:12px; padding:12px 16px; border-radius:8px; font-size:13px;"></div>

    {# KPI –∫–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Ä–µ–∞–≥–µ–Ω—Ç–Ω—ã—Ö –∞–∫—Ç–æ–≤ #}
    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:16px;">
      <div class="kpi-card" style="padding:12px;">
        <div class="kpi-icon" style="background:#e0e7ff; color:#3730a3; width:36px; height:36px; font-size:16px;">üìÑ</div>
        <div class="kpi-data">
          <div class="kpi-value" style="font-size:20px;">{{ reagent_expense_stats.total }}</div>
          <div class="kpi-label" style="font-size:12px;">–í—Å–µ–≥–æ –∞–∫—Ç–æ–≤</div>
        </div>
      </div>
      <div class="kpi-card" style="padding:12px;">
        <div class="kpi-icon" style="background:#dbeafe; color:#1d4ed8; width:36px; height:36px; font-size:16px;">üìÖ</div>
        <div class="kpi-data">
          <div class="kpi-value" style="font-size:20px;">{{ reagent_expense_stats.current_month }}</div>
          <div class="kpi-label" style="font-size:12px;">–ó–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</div>
        </div>
      </div>
      <div class="kpi-card" style="padding:12px;">
        <div class="kpi-icon" style="background:#fef3c7; color:#d97706; width:36px; height:36px; font-size:16px;">üìù</div>
        <div class="kpi-data">
          <div class="kpi-value" style="font-size:20px;">{{ reagent_expense_stats.drafts }}</div>
          <div class="kpi-label" style="font-size:12px;">–ß–µ—Ä–Ω–æ–≤–∏–∫–æ–≤</div>
        </div>
      </div>
    </div>

    {# Accordion –∞–∫—Ç–æ–≤ –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º #}
    <div style="margin-top:16px;">
      {% if reagent_expense_groups|length > 0 %}
        <div class="reagent-accordion">
          {% for group in reagent_expense_groups %}
            <details class="reagent-well-group" {% if group.drafts > 0 %}open{% endif %}>
              <summary class="reagent-well-header">
                <div style="display:flex; align-items:center; gap:12px; flex:1;">
                  <span class="reagent-arrow">‚ñ∫</span>
                  <span style="font-weight:700; font-size:14px;">–°–∫–≤ {{ group.well_number }}</span>
                  <div style="display:flex; gap:8px; margin-left:auto;">
                    <span style="background:#e5e7eb; color:#374151; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">
                      {{ group.total }} –∞–∫—Ç{{ '–æ–≤' if group.total > 4 or group.total == 0 else ('–∞' if group.total > 1 else '') }}
                    </span>
                    {% if group.drafts > 0 %}
                      <span style="background:#fef3c7; color:#92400e; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">
                        {{ group.drafts }} —á–µ—Ä–Ω–æ–≤–∏–∫{{ '–æ–≤' if group.drafts > 4 else ('–∞' if group.drafts > 1 else '') }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </summary>
              <div class="reagent-well-content">
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                  <thead>
                    <tr style="background:#f8f9fa; text-align:left;">
                      <th style="padding:8px 12px; border-bottom:1px solid #dee2e6;">‚Ññ –¥–æ–∫—É–º–µ–Ω—Ç–∞</th>
                      <th style="padding:8px 12px; border-bottom:1px solid #dee2e6;">–ü–µ—Ä–∏–æ–¥</th>
                      <th style="padding:8px 12px; border-bottom:1px solid #dee2e6;">–°—Ç–∞—Ç—É—Å</th>
                      <th style="padding:8px 12px; border-bottom:1px solid #dee2e6;">–î–∞—Ç–∞</th>
                      <th style="padding:8px 12px; border-bottom:1px solid #dee2e6; text-align:center;">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for doc in group.docs %}
                    <tr style="border-bottom:1px solid #f0f0f0;">
                      <td style="padding:8px 12px; font-weight:600;">{{ doc.doc_number or "‚Äî" }}</td>
                      <td style="padding:8px 12px;">
                        {% if doc.period_year and doc.period_month %}
                          {{ doc.period_year }}-{{ "%02d"|format(doc.period_month) }}
                        {% else %}‚Äî{% endif %}
                      </td>
                      <td style="padding:8px 12px;">
                        {% if doc.status == 'draft' %}
                          <span style="background:#fef3c7; color:#92400e; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:600;">–ß–µ—Ä–Ω–æ–≤–∏–∫</span>
                        {% elif doc.status == 'generated' %}
                          <span style="background:#dbeafe; color:#1e40af; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:600;">–°–æ–∑–¥–∞–Ω</span>
                        {% elif doc.status == 'signed' %}
                          <span style="background:#d1fae5; color:#065f46; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:600;">–ü–æ–¥–ø–∏—Å–∞–Ω</span>
                        {% elif doc.status == 'sent' %}
                          <span style="background:#e0e7ff; color:#3730a3; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:600;">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>
                        {% elif doc.status == 'archived' %}
                          <span style="background:#e5e7eb; color:#374151; padding:3px 6px; border-radius:4px; font-size:11px; font-weight:600;">–ê—Ä—Ö–∏–≤</span>
                        {% else %}
                          <span style="background:#f3f4f6; color:#6b7280; padding:3px 6px; border-radius:4px; font-size:11px;">{{ doc.status }}</span>
                        {% endif %}
                      </td>
                      <td style="padding:8px 12px; color:#6b7280; font-size:12px;">
                        {% if doc.created_at %}{{ doc.created_at.strftime("%d.%m.%Y") }}{% else %}‚Äî{% endif %}
                      </td>
                      <td style="padding:8px 12px; text-align:center;">
                        <a href="/documents/{{ doc.id }}" class="admin-link" style="font-weight:600;">–û—Ç–∫—Ä—ã—Ç—å</a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </details>
          {% endfor %}
        </div>
        {% if reagent_expense_stats.total > 20 %}
          <div style="margin-top:12px; font-size:12px; color:#6b7280; text-align:center;">
            –ü–æ–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∏–∑ {{ reagent_expense_stats.total }} –∞–∫—Ç–æ–≤
          </div>
        {% endif %}
      {% else %}
        {# –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ #}
        <div style="padding:40px; text-align:center; background:#f9fafb; border-radius:8px; border:1px dashed #d1d5db;">
          <div style="font-size:32px; margin-bottom:12px;">üìã</div>
          <div style="font-size:15px; font-weight:600; color:#374151; margin-bottom:4px;">–ê–∫—Ç–æ–≤ —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
          <div style="font-size:13px; color:#6b7280; margin-bottom:16px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∞–∫—Ç –¥–ª—è —É—á—ë—Ç–∞ —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º</div>
          <a href="/documents/reagent-expense/new" class="btn-apply" style="display:inline-block;">+ –°–æ–∑–¥–∞—Ç—å –∞–∫—Ç</a>
        </div>
      {% endif %}
    </div>
  </section>

  <!-- WELLS SECTION WITH MULTI-SELECT STATUS FILTER -->
  <section class="analytics-card">
    <div class="section-header" style="flex-wrap:wrap; gap:16px;">
      <h2 style="margin:0;">–°–∫–≤–∞–∂–∏–Ω—ã</h2>

      <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä) -->
      <div style="flex:1; max-width:600px;">
        <div class="filter-label" style="margin-bottom:8px;">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:</div>

        <div class="status-filter-grid">
          {% for css, name in available_statuses %}
          <label class="status-filter-checkbox {{ css }}" style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;">
            <input
              type="checkbox"
              class="status-checkbox"
              data-status="{{ css }}"
              {% if css in selected_statuses %}checked{% endif %}
              style="cursor:pointer;"
            >
            <span style="font-weight:600; font-size:13px;">{{ name }}</span>
          </label>
          {% endfor %}

          {% if wells_without_status > 0 %}
          <label class="status-filter-checkbox" style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.2s; border:2px solid #ddd; background:#f8f9fa;">
            <input
              type="checkbox"
              class="status-checkbox"
              data-status="no-status"
              {% if 'no-status' in selected_statuses %}checked{% endif %}
              style="cursor:pointer;"
            >
            <span style="font-weight:600; font-size:13px; color:#666;">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</span>
          </label>
          {% endif %}
        </div>

        <div class="filter-actions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button onclick="selectAllStatuses()" class="btn-secondary">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
          <button onclick="clearAllStatuses()" class="btn-secondary">–°–Ω—è—Ç—å –≤—Å–µ</button>
          <span class="text-secondary" style="margin-left:auto;">
            –ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="visible-count">{{ wells|length }}</strong> –∏–∑ <strong>{{ total_wells }}</strong>
          </span>
        </div>
      </div>

      <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
      <div class="filter-group">
        <label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
        <select id="sort-select" onchange="sortWells()" class="filter-select">
          <option value="number-asc">–ù–æ–º–µ—Ä ‚Üë</option>
          <option value="number-desc">–ù–æ–º–µ—Ä ‚Üì</option>
          <option value="status-asc">–°—Ç–∞—Ç—É—Å –ê-–Ø</option>
          <option value="status-desc">–°—Ç–∞—Ç—É—Å –Ø-–ê</option>
          <option value="docs-desc">–ê–∫—Ç–æ–≤ (–±–æ–ª—å—à–µ)</option>
          <option value="docs-asc">–ê–∫—Ç–æ–≤ (–º–µ–Ω—å—à–µ)</option>
          <option value="days-desc">–î–Ω–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ (–±–æ–ª—å—à–µ)</option>
          <option value="days-asc">–î–Ω–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ (–º–µ–Ω—å—à–µ)</option>
        </select>
      </div>
    </div>

    <div id="wells-container">
      {% for w in wells %}
        <details
          class="well-details"
          data-well-number="{{ w.number }}"
          data-status-css="{{ w.current_status_css or 'no-status' }}"
          data-status-name="{{ w.current_status or '' }}"
          data-docs-total="{{ well_total_stats.get(w.id, {'total': 0}).total }}"
          data-status-days="{{ w.current_status_days or 0 }}"
          style="border:1px solid #e5e5e5; border-radius:10px; margin-bottom:10px; overflow:hidden; {% if w.current_status_css not in selected_statuses and (w.current_status_css or 'no-status') != 'no-status' %}display:none;{% endif %} {% if not w.current_status and 'no-status' not in selected_statuses %}display:none;{% endif %}"
        >
          <summary style="list-style:none; cursor:pointer;">
            <div class="well-header" style="display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px; padding:12px 16px; background:#fafafa;">

              <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã -->
              <div style="display:flex; align-items:center; gap:8px; font-weight:700; font-size:15px;">
                <span class="well-arrow" style="font-size:12px; transition:transform 0.2s;">‚ñ∫</span>
                –°–∫–≤ {{ w.number }}
              </div>

              <!-- –°—Ç–∞—Ç—É—Å -->
              <div style="display:flex; align-items:center; gap:16px;">
                {% if w.current_status %}
                  <div class="status-badge {{ w.current_status_css }}" style="padding:6px 16px; border-radius:6px; font-weight:600; font-size:13px; white-space:nowrap;">
                    {{ w.current_status }}
                  </div>
                  <div style="font-size:12px; color:#666;">
                    {% if w.current_status_start %}
                      —Å {{ w.current_status_start.strftime("%d.%m.%Y") }}
                    {% endif %}
                    {% if w.current_status_days is not none %}
                      ¬∑ <strong>{{ "%.1f"|format(w.current_status_days) }}</strong> —Å—É—Ç.
                    {% endif %}
                  </div>
                {% else %}
                  <div style="padding:6px 16px; border-radius:6px; font-weight:600; font-size:13px; background:#f0f0f0; color:#666;">
                    –°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                  </div>
                {% endif %}
              </div>

              <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–æ–≤ -->
              {% set stats = well_total_stats.get(w.id, {"total": 0, "by_group": {}}) %}
              <div style="display:flex; gap:20px; font-size:13px;">
                <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                  <div style="font-weight:700; font-size:16px; color:#0066cc;">{{ stats.total }}</div>
                  <div style="color:#666; font-size:11px; text-transform:uppercase;">–í—Å–µ–≥–æ</div>
                </div>
              </div>

            </div>
          </summary>

          <div style="padding:16px; display:grid; gap:12px;">

            {# ========== –ë–õ–û–ö 1: –ê–∫—Ç—ã –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ ========== #}
            <div style="border:1px solid #e0e7ff; border-radius:10px; overflow:hidden;">
              <div style="background:#e0e7ff; padding:10px 14px; font-weight:700; display:flex; align-items:center; gap:8px;">
                <span style="font-size:18px;">üìã</span>
                –ê–∫—Ç—ã –ø—Ä–∏—ë–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏ —Å–∫–≤–∞–∂–∏–Ω—ã
              </div>
              <div style="padding:12px 14px;">
                {# –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç—ã –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ #}
                {% set well_handover_codes = ["well_acceptance", "well_transfer", "well_stage_accept", "well_stage_return"] %}
                {% set well_docs = [] %}
                {% for dt in doc_types_one_time %}
                  {% if dt.code in well_handover_codes %}
                    {% set st = well_stats.get((w.id, dt.id)) %}
                    {% if st and st.docs %}
                      {% for x in st.docs %}
                        {% set _ = well_docs.append({"id": x.id, "doc_number": x.doc_number, "status": x.status, "code": dt.code}) %}
                      {% endfor %}
                    {% endif %}
                  {% endif %}
                {% endfor %}

                {% if well_docs|length > 0 %}
                  <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:13px; margin-bottom:10px;">
                    {% for x in well_docs[:10] %}
                      <a href="/documents/well-handover/{{ x.id }}"
                         style="padding:4px 10px; background:{% if x.code in ['well_acceptance', 'well_stage_accept'] %}#d4edda{% else %}#fff3cd{% endif %}; border-radius:6px; text-decoration:none; display:flex; align-items:center; gap:4px;">
                        {% if x.code in ['well_acceptance', 'well_stage_accept'] %}üì•{% else %}üì§{% endif %}
                        {{ x.doc_number or ("#" ~ x.id) }}
                        <span style="font-size:10px; opacity:0.7;">({{ x.status }})</span>
                      </a>
                    {% endfor %}
                    {% if well_docs|length > 10 %}
                      <span style="padding:4px 10px; opacity:0.6;">+{{ well_docs|length - 10 }} –µ—â—ë...</span>
                    {% endif %}
                  </div>
                {% else %}
                  <div style="opacity:0.6; font-size:13px; margin-bottom:10px;">–ê–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                {% endif %}

                <a class="btn btn-primary" style="font-size:13px; padding:8px 14px;" href="/documents/well-handover/new?well_id={{ w.id }}">
                  + –°–æ–∑–¥–∞—Ç—å –∞–∫—Ç –ø—Ä–∏—ë–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏
                </a>
              </div>
            </div>

            {# ========== –ë–õ–û–ö 2: –ê–∫—Ç—ã –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é ========== #}
            <div style="border:1px solid #ffeeba; border-radius:10px; overflow:hidden;">
              <div style="background:#ffeeba; padding:10px 14px; font-weight:700; display:flex; align-items:center; gap:8px;">
                <span style="font-size:18px;">üì¶</span>
                –ê–∫—Ç—ã –º–æ–Ω—Ç–∞–∂–∞/–¥–µ–º–æ–Ω—Ç–∞–∂–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
              </div>
              <div style="padding:12px 14px;">
                {# –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç—ã –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é #}
                {% set equipment_codes = ["equipment_install", "equipment_remove"] %}
                {% set equip_docs = [] %}
                {% for dt in doc_types_one_time %}
                  {% if dt.code in equipment_codes %}
                    {% set st = well_stats.get((w.id, dt.id)) %}
                    {% if st and st.docs %}
                      {% for x in st.docs %}
                        {% set _ = equip_docs.append({"id": x.id, "doc_number": x.doc_number, "status": x.status, "code": dt.code}) %}
                      {% endfor %}
                    {% endif %}
                  {% endif %}
                {% endfor %}

                {% if equip_docs|length > 0 %}
                  <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:13px; margin-bottom:10px;">
                    {% for x in equip_docs[:10] %}
                      <a href="/documents/equipment/{{ x.id }}"
                         style="padding:4px 10px; background:{% if x.code == 'equipment_install' %}#d4edda{% else %}#f8d7da{% endif %}; border-radius:6px; text-decoration:none; display:flex; align-items:center; gap:4px;">
                        {% if x.code == 'equipment_install' %}üì¶{% else %}üîß{% endif %}
                        {{ x.doc_number or ("#" ~ x.id) }}
                        <span style="font-size:10px; opacity:0.7;">({{ x.status }})</span>
                      </a>
                    {% endfor %}
                    {% if equip_docs|length > 10 %}
                      <span style="padding:4px 10px; opacity:0.6;">+{{ equip_docs|length - 10 }} –µ—â—ë...</span>
                    {% endif %}
                  </div>
                {% else %}
                  <div style="opacity:0.6; font-size:13px; margin-bottom:10px;">–ê–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
                {% endif %}

                <a class="btn btn-primary" style="font-size:13px; padding:8px 14px;" href="/documents/equipment/new?well_id={{ w.id }}">
                  + –°–æ–∑–¥–∞—Ç—å –∞–∫—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                </a>
              </div>
            </div>

            {# ========== –°—Å—ã–ª–∫–∞ –Ω–∞ –≤—Å–µ –∞–∫—Ç—ã ========== #}
            <div style="margin-top:4px; font-size:13px;">
              <a href="/documents?well_id={{ w.id }}" style="opacity:0.7;">–í—Å–µ –∞–∫—Ç—ã –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ ‚Üí</a>
            </div>

          </div>
        </details>
      {% endfor %}
    </div>

    {% if wells|length == 0 %}
      <div style="padding:40px; text-align:center; opacity:0.6;">
        –ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
      </div>
    {% endif %}
  </section>

  <!-- FINANCE -->
  <section class="analytics-card">
    <div class="section-header">
      <h2 style="margin:0;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∞–∫—Ç—ã</h2>
    </div>
    <p class="text-secondary">–°—á–µ—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã, –∞–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç ‚Äî –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —ç—Ç–∞–ø–æ–º.</p>
  </section>

</div>
</div><!-- /.page-dashboard -->

{# ============================================================
   –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ê–í–¢–û–°–û–ó–î–ê–ù–ò–Ø
   ============================================================ #}
<div id="autoCreateModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3 style="margin:0;">ü§ñ –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–æ–≤</h3>
      <button type="button" onclick="closeAutoCreateModal()" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      <p style="margin:0 0 16px 0; color:#6b7280; font-size:13px;">
        –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Ç—å –∞–∫—Ç—ã —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∫–≤–∞–∂–∏–Ω —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.
      </p>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
        <div>
          <label style="display:block; font-weight:600; margin-bottom:6px; font-size:13px;">–ì–æ–¥</label>
          <input type="number" id="autoCreateYear" class="form-input" min="2020" max="2100" style="width:100%;">
        </div>
        <div>
          <label style="display:block; font-weight:600; margin-bottom:6px; font-size:13px;">–ú–µ—Å—è—Ü</label>
          <select id="autoCreateMonth" class="form-input" style="width:100%;">
            <option value="1">–Ø–Ω–≤–∞—Ä—å</option>
            <option value="2">–§–µ–≤—Ä–∞–ª—å</option>
            <option value="3">–ú–∞—Ä—Ç</option>
            <option value="4">–ê–ø—Ä–µ–ª—å</option>
            <option value="5">–ú–∞–π</option>
            <option value="6">–ò—é–Ω—å</option>
            <option value="7">–ò—é–ª—å</option>
            <option value="8">–ê–≤–≥—É—Å—Ç</option>
            <option value="9">–°–µ–Ω—Ç—è–±—Ä—å</option>
            <option value="10">–û–∫—Ç—è–±—Ä—å</option>
            <option value="11">–ù–æ—è–±—Ä—å</option>
            <option value="12">–î–µ–∫–∞–±—Ä—å</option>
          </select>
        </div>
      </div>

      <div style="background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px; padding:12px; margin-bottom:16px;">
        <div style="font-size:12px; color:#0369a1;">
          <strong>–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç:</strong>
          <ul style="margin:8px 0 0 0; padding-left:20px;">
            <li>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–π–¥—ë—Ç –≤—Å–µ —Å–∫–≤–∞–∂–∏–Ω—ã —Å —Ä–µ–∞–≥–µ–Ω—Ç–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥</li>
            <li>–î–ª—è –∫–∞–∂–¥–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã —Å–æ–∑–¥–∞—Å—Ç –∞–∫—Ç (—á–µ—Ä–Ω–æ–≤–∏–∫)</li>
            <li>–î—É–±–ª–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–ø—É—â–µ–Ω—ã</li>
          </ul>
        </div>
      </div>

      <div id="autoCreateSpinner" style="display:none; text-align:center; padding:20px;">
        <div style="font-size:24px; animation:spin 1s linear infinite;">‚è≥</div>
        <div style="margin-top:8px; color:#6b7280;">–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–æ–≤...</div>
      </div>

      <div id="autoCreateResultModal" style="display:none;"></div>
    </div>
    <div class="modal-footer" id="autoCreateFooter">
      <button type="button" class="btn-secondary" onclick="closeAutoCreateModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" class="btn-apply" onclick="runAutoCreate()">–°–æ–∑–¥–∞—Ç—å –∞–∫—Ç—ã</button>
    </div>
  </div>
</div>

{# ============================================================
   –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ê–ö–ï–¢–ù–û–ô –û–¢–ü–†–ê–í–ö–ò
   ============================================================ #}
<div id="batchSendModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width:520px;">
    <div class="modal-header">
      <h3 style="margin:0;" id="batchSendTitle">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã</h3>
      <button type="button" onclick="closeBatchSendModal()" class="modal-close">&times;</button>
    </div>
    <div class="modal-body">
      {# –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ #}
      <div id="batchDocsList" style="margin-bottom:12px; max-height:120px; overflow:auto;
           background:#f8fafc; border:1px solid #e2e8f0; border-radius:6px; padding:8px; font-size:12px;">
      </div>

      {# –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∫–∞–Ω–∞–ª–∞ (–ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏) #}
      <div id="batchChannelPicker" style="display:none; margin-bottom:12px;">
        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">–°–ø–æ—Å–æ–± –æ—Ç–ø—Ä–∞–≤–∫–∏:</div>
        <div style="display:flex; gap:8px;">
          <button type="button" class="channel-btn" data-ch="telegram"
                  onclick="switchBatchChannel('telegram')"
                  style="flex:1; padding:8px; border:2px solid #0088cc; border-radius:8px; background:#e0f2fe;
                         font-size:13px; font-weight:600; cursor:pointer; color:#0369a1;">
            Telegram
          </button>
          <button type="button" class="channel-btn" data-ch="email"
                  onclick="switchBatchChannel('email')"
                  style="flex:1; padding:8px; border:2px solid #d1d5db; border-radius:8px; background:#fff;
                         font-size:13px; font-weight:600; cursor:pointer; color:#6b7280;">
            Email
          </button>
        </div>
      </div>

      {# Telegram: –≤—ã–±–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è #}
      <div id="batchTgSection" style="display:none;">
        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">–ü–æ–ª—É—á–∞—Ç–µ–ª—å Telegram:</div>
        <div id="batchTgLoading" style="text-align:center; padding:12px; color:#6b7280;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <div id="batchTgList" style="max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:6px;"></div>
      </div>

      {# Email: –≤–≤–æ–¥ –∞–¥—Ä–µ—Å–æ–≤ #}
      <div id="batchEmailSection" style="display:none;">
        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">Email –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</div>
        <input type="text" id="batchEmailInput" placeholder="name@example.com, other@example.com"
               style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px; font-size:14px; box-sizing:border-box;">
        <div style="font-size:11px; color:#9ca3af; margin-top:4px;">–ù–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
      </div>

      {# –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ #}
      <div id="batchCommentSection" style="margin-top:12px;">
        <div style="font-weight:600; font-size:13px; margin-bottom:6px;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</div>
        <textarea id="batchCommentInput" rows="3" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                  style="width:100%; padding:8px 12px; border:1px solid #d1d5db; border-radius:6px;
                         font-size:13px; resize:vertical; box-sizing:border-box; font-family:inherit;"></textarea>
      </div>

      {# –ü—Ä–æ–≥—Ä–µ—Å—Å / —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã #}
      <div id="batchSendProgress" style="display:none; text-align:center; padding:16px;">
        <div style="font-size:24px; animation:spin 1s linear infinite;">‚è≥</div>
        <div style="margin-top:8px; color:#6b7280;">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...</div>
      </div>
      <div id="batchSendResults" style="display:none; margin-top:12px;"></div>
    </div>
    <div class="modal-footer" id="batchSendFooter">
      <button type="button" class="btn-secondary" onclick="closeBatchSendModal()">–û—Ç–º–µ–Ω–∞</button>
      <button type="button" class="btn-apply" id="batchSendBtn" onclick="executeBatchSend()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<style>
/* Kanban grid & columns */
.kanban-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
  overflow: auto;
}
.kanban-col {
  min-width: 220px;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px;
  transition: background 0.15s, border-color 0.15s;
}
.kanban-col-header {
  font-weight: 600;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.kanban-count {
  font-size: 12px;
  font-weight: 400;
  color: #6b7280;
}
.kanban-summary {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 8px;
  padding: 4px 6px;
  background: #f9fafb;
  border-radius: 4px;
  line-height: 1.5;
}

/* Kanban cards */
.kanban-card {
  border: 1px solid #eee;
  border-radius: 8px;
  padding: 8px;
  margin-bottom: 8px;
  position: relative;
  cursor: grab;
  transition: opacity 0.15s, box-shadow 0.15s;
  background: #fff;
}
.kanban-card:active { cursor: grabbing; }
.kanban-card.kanban-dragging {
  opacity: 0.35;
  box-shadow: none;
}

/* Drag-over highlight */
.kanban-col.kanban-col-over {
  background: #e0f2fe;
  border-color: #38bdf8;
}

/* Collapsed cards */
.kanban-card-hidden { display: none; }
.kanban-expand-btn {
  width: 100%;
  border: 1px dashed #cbd5e1;
  background: #f8fafc;
  border-radius: 6px;
  padding: 6px;
  font-size: 12px;
  color: #64748b;
  cursor: pointer;
  margin-top: 4px;
}
.kanban-expand-btn:hover { background: #f1f5f9; }

/* Terminal columns (archive, cancelled) */
.kanban-col-terminal { background: #fafafa; }

/* Archive accordion */
.archive-well-group { border-bottom: 1px solid #f0f0f0; }
.archive-well-header {
  list-style: none;
  cursor: pointer;
  padding: 6px 8px;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}
.archive-well-header::-webkit-details-marker { display: none; }
.archive-well-header:hover { background: #f3f4f6; }
.archive-arrow {
  font-size: 9px;
  color: #9ca3af;
  transition: transform 0.2s;
}
.archive-well-group[open] .archive-arrow { transform: rotate(90deg); }
.archive-count {
  margin-left: auto;
  background: #e5e7eb;
  padding: 1px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 400;
  color: #6b7280;
}
.archive-doc-row {
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 4px 8px 4px 24px;
  border-bottom: 1px solid #f8f8f8;
  font-size: 12px;
}
.archive-doc-row:hover { background: #f0f9ff; }
.archive-doc-row a { font-weight: 600; text-decoration: none; color: #1d4ed8; }

/* Cancelled compact rows */
.cancelled-row {
  display: flex;
  gap: 6px;
  align-items: center;
  flex-wrap: wrap;
  padding: 4px 8px;
  border-bottom: 1px solid #f0f0f0;
  font-size: 12px;
}
.cancelled-row a { font-weight: 600; text-decoration: none; color: #6b7280; }
.cancelled-row span { color: #9ca3af; font-size: 11px; }

/* Toast */
.kanban-toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #1e293b;
  color: #fff;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 13px;
  z-index: 200;
  animation: toastIn 0.3s ease;
  pointer-events: none;
}
.kanban-toast.error { background: #991b1b; }
@keyframes toastIn {
  from { opacity: 0; transform: translateX(-50%) translateY(10px); }
  to { opacity: 1; transform: translateX(-50%) translateY(0); }
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Modal styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
  width: 90%;
  max-height: 90vh;
  overflow: auto;
}
.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
}
.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #6b7280;
  padding: 0;
  line-height: 1;
}
.modal-close:hover { color: #111827; }
.modal-body {
  padding: 20px;
}
.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid #e5e7eb;
  background: #f9fafb;
  border-radius: 0 0 12px 12px;
}
.form-input {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
}
.form-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}

<style>
/* –°—Ç–∞—Ç—É—Å—ã —Å–∫–≤–∞–∂–∏–Ω ‚Äî —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ü–≤–µ—Ç–∞ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
:root {
  --status-watch-color: #0c5460;
  --status-watch-bg: #d1ecf1;
  --status-adapt-color: #856404;
  --status-adapt-bg: #fff3cd;
  --status-opt-color: #155724;
  --status-opt-bg: #d4edda;
  --status-dev-color: #004085;
  --status-dev-bg: #cce5ff;
  --status-off-color: #721c24;
  --status-off-bg: #f8d7da;
  --status-idle-color: #383d41;
  --status-idle-bg: #e2e3e5;
  --status-other-color: #333;
  --status-other-bg: #e7e7e7;
}

/* Status badges */
.status-badge.status-watch { background: var(--status-watch-bg); color: var(--status-watch-color); }
.status-badge.status-adapt { background: var(--status-adapt-bg); color: var(--status-adapt-color); }
.status-badge.status-opt   { background: var(--status-opt-bg);   color: var(--status-opt-color); }
.status-badge.status-dev   { background: var(--status-dev-bg);   color: var(--status-dev-color); }
.status-badge.status-off   { background: var(--status-off-bg);   color: var(--status-off-color); }
.status-badge.status-idle  { background: var(--status-idle-bg);  color: var(--status-idle-color); }
.status-badge.status-other { background: var(--status-other-bg); color: var(--status-other-color); }

/* Status filter checkboxes */
.status-filter-checkbox.status-watch { background: var(--status-watch-bg); color: var(--status-watch-color); border-color: var(--status-watch-bg); }
.status-filter-checkbox.status-adapt { background: var(--status-adapt-bg); color: var(--status-adapt-color); border-color: var(--status-adapt-bg); }
.status-filter-checkbox.status-opt   { background: var(--status-opt-bg);   color: var(--status-opt-color);   border-color: var(--status-opt-bg); }
.status-filter-checkbox.status-dev   { background: var(--status-dev-bg);   color: var(--status-dev-color);   border-color: var(--status-dev-bg); }
.status-filter-checkbox.status-off   { background: var(--status-off-bg);   color: var(--status-off-color);   border-color: var(--status-off-bg); }
.status-filter-checkbox.status-idle  { background: var(--status-idle-bg);  color: var(--status-idle-color);  border-color: var(--status-idle-bg); }
.status-filter-checkbox.status-other { background: var(--status-other-bg); color: var(--status-other-color); border-color: var(--status-other-bg); }

/* Well accordion */
.well-details[open] .well-arrow { transform: rotate(90deg); }
.well-header:hover { background: #f0f0f0; }

/* Reagent expense accordion */
.reagent-accordion {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.reagent-well-group {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
}
.reagent-well-header {
  list-style: none;
  cursor: pointer;
  padding: 12px 16px;
  background: #f9fafb;
  display: flex;
  align-items: center;
}
.reagent-well-header:hover {
  background: #f3f4f6;
}
.reagent-well-header::-webkit-details-marker {
  display: none;
}
.reagent-arrow {
  font-size: 10px;
  transition: transform 0.2s;
  color: #6b7280;
}
.reagent-well-group[open] .reagent-arrow {
  transform: rotate(90deg);
}
.reagent-well-content {
  padding: 0;
  border-top: 1px solid #e5e7eb;
}
</style>

<script>
const STORAGE_KEY_STATUSES = 'documents_selected_statuses';
const STORAGE_KEY_SORT = 'documents_sort_order';

// ========== –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º ==========
function filterWells() {
  const checkboxes = document.querySelectorAll('.status-checkbox:checked');
  const selectedStatuses = Array.from(checkboxes).map(cb => cb.dataset.status);

  localStorage.setItem(STORAGE_KEY_STATUSES, JSON.stringify(selectedStatuses));

  const wells = document.querySelectorAll('.well-details');
  let visibleCount = 0;

  wells.forEach(well => {
    const wellStatus = well.dataset.statusCss || 'no-status';
    const shouldShow = selectedStatuses.length === 0 || selectedStatuses.includes(wellStatus);

    well.style.display = shouldShow ? '' : 'none';
    if (shouldShow) visibleCount++;
  });

  const counter = document.getElementById('visible-count');
  if (counter) counter.textContent = visibleCount;
}

function selectAllStatuses() {
  document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
  filterWells();
}

function clearAllStatuses() {
  document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = false);
  filterWells();
}

// ========== –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ==========
function sortWells() {
  const sortValue = document.getElementById('sort-select').value;
  const container = document.getElementById('wells-container');
  const wells = Array.from(document.querySelectorAll('.well-details'));

  localStorage.setItem(STORAGE_KEY_SORT, sortValue);

  wells.sort((a, b) => {
    const aNum = parseInt(a.dataset.wellNumber) || 0;
    const bNum = parseInt(b.dataset.wellNumber) || 0;
    const aStatus = a.dataset.statusName || '';
    const bStatus = b.dataset.statusName || '';
    const aDocs = parseInt(a.dataset.docsTotal) || 0;
    const bDocs = parseInt(b.dataset.docsTotal) || 0;
    const aDays = parseFloat(a.dataset.statusDays) || 0;
    const bDays = parseFloat(b.dataset.statusDays) || 0;

    switch(sortValue) {
      case 'number-asc': return aNum - bNum;
      case 'number-desc': return bNum - aNum;
      case 'status-asc': return aStatus.localeCompare(bStatus, 'ru');
      case 'status-desc': return bStatus.localeCompare(aStatus, 'ru');
      case 'docs-desc': return bDocs - aDocs;
      case 'docs-asc': return aDocs - bDocs;
      case 'days-desc': return bDays - aDays;
      case 'days-asc': return aDays - bDays;
      default: return aNum - bNum;
    }
  });

  wells.forEach(well => container.appendChild(well));
}

// ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========
document.addEventListener('DOMContentLoaded', function() {
  const savedStatuses = localStorage.getItem(STORAGE_KEY_STATUSES);
  if (savedStatuses) {
    try {
      const statuses = JSON.parse(savedStatuses);
      document.querySelectorAll('.status-checkbox').forEach(cb => {
        cb.checked = statuses.includes(cb.dataset.status);
      });
      filterWells();
    } catch (e) {}
  }

  const savedSort = localStorage.getItem(STORAGE_KEY_SORT);
  if (savedSort) {
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.value = savedSort;
      sortWells();
    }
  }

  document.querySelectorAll('.status-checkbox').forEach(cb => {
    cb.addEventListener('change', filterWells);
  });
});

// ========== –ê–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–æ–≤ ==========
function openAutoCreateModal() {
  const modal = document.getElementById('autoCreateModal');
  const yearInput = document.getElementById('autoCreateYear');
  const monthSelect = document.getElementById('autoCreateMonth');

  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  const now = new Date();
  let year = now.getFullYear();
  let month = now.getMonth(); // 0-11, —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
  if (month === 0) {
    month = 12;
    year--;
  }

  yearInput.value = year;
  monthSelect.value = month;

  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  document.getElementById('autoCreateSpinner').style.display = 'none';
  document.getElementById('autoCreateResultModal').style.display = 'none';
  document.getElementById('autoCreateResultModal').innerHTML = '';
  document.getElementById('autoCreateFooter').style.display = 'flex';

  modal.style.display = 'flex';
}

function closeAutoCreateModal() {
  document.getElementById('autoCreateModal').style.display = 'none';
}

async function runAutoCreate() {
  const year = document.getElementById('autoCreateYear').value;
  const month = document.getElementById('autoCreateMonth').value;

  if (!year || !month) {
    alert('–£–∫–∞–∂–∏—Ç–µ –≥–æ–¥ –∏ –º–µ—Å—è—Ü');
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
  document.getElementById('autoCreateSpinner').style.display = 'block';
  document.getElementById('autoCreateFooter').style.display = 'none';
  document.getElementById('autoCreateResultModal').style.display = 'none';

  try {
    const response = await fetch(`/api/jobs/reagent-expense/auto-create?year=${year}&month=${month}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    const data = await response.json();

    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
    document.getElementById('autoCreateSpinner').style.display = 'none';

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    const resultDiv = document.getElementById('autoCreateResultModal');
    resultDiv.style.display = 'block';

    const isSuccess = data.status === 'success' || data.status === 'skipped';
    const bgColor = isSuccess ? '#d1fae5' : (data.status === 'partial' ? '#fef3c7' : '#fee2e2');
    const borderColor = isSuccess ? '#a7f3d0' : (data.status === 'partial' ? '#fcd34d' : '#fca5a5');
    const textColor = isSuccess ? '#065f46' : (data.status === 'partial' ? '#92400e' : '#991b1b');

    let html = `
      <div style="background:${bgColor}; border:1px solid ${borderColor}; color:${textColor}; padding:16px; border-radius:8px;">
        <div style="font-weight:700; margin-bottom:8px;">
          ${isSuccess ? '‚úÖ' : (data.status === 'partial' ? '‚ö†Ô∏è' : '‚ùå')}
          –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ ${String(month).padStart(2,'0')}.${year}
        </div>
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; font-size:13px;">
          <div>–í—Å–µ–≥–æ —Å–∫–≤–∞–∂–∏–Ω: <strong>${data.summary?.total_wells || 0}</strong></div>
          <div>–°–æ–∑–¥–∞–Ω–æ –∞–∫—Ç–æ–≤: <strong>${data.summary?.created || 0}</strong></div>
          <div>–ü—Ä–æ–ø—É—â–µ–Ω–æ (–¥—É–±–ª–∏): <strong>${data.summary?.skipped_duplicate || 0}</strong></div>
          <div>–ü—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π): <strong>${data.summary?.skipped_no_events || 0}</strong></div>
          ${data.summary?.errors > 0 ? `<div style="grid-column:span 2; color:#991b1b;">–û—à–∏–±–æ–∫: <strong>${data.summary.errors}</strong></div>` : ''}
        </div>
      </div>
    `;

    // –î–µ—Ç–∞–ª–∏ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–æ–≤
    if (data.details && data.details.length > 0) {
      const created = data.details.filter(d => d.status === 'created');
      if (created.length > 0) {
        html += `<div style="margin-top:12px; font-size:13px;"><strong>–°–æ–∑–¥–∞–Ω–Ω—ã–µ –∞–∫—Ç—ã:</strong></div>`;
        html += `<div style="max-height:200px; overflow:auto; margin-top:8px;">`;
        created.forEach(d => {
          html += `<div style="padding:6px 0; border-bottom:1px solid #e5e7eb;">
            <a href="/documents/${d.document_id}" target="_blank">${d.doc_number}</a>
            ‚Äî –°–∫–≤ ${d.well_number} (${d.items_count} —Å—Ç—Ä–æ–∫)
          </div>`;
        });
        html += `</div>`;
      }
    }

    resultDiv.innerHTML = html;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è
    document.getElementById('autoCreateFooter').innerHTML = `
      <button type="button" class="btn-secondary" onclick="closeAutoCreateModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button type="button" class="btn-apply" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
    `;
    document.getElementById('autoCreateFooter').style.display = 'flex';

  } catch (error) {
    document.getElementById('autoCreateSpinner').style.display = 'none';
    document.getElementById('autoCreateResultModal').style.display = 'block';
    document.getElementById('autoCreateResultModal').innerHTML = `
      <div style="background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; padding:16px; border-radius:8px;">
        <strong>‚ùå –û—à–∏–±–∫–∞:</strong> ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å'}
      </div>
    `;
    document.getElementById('autoCreateFooter').innerHTML = `
      <button type="button" class="btn-secondary" onclick="closeAutoCreateModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    `;
    document.getElementById('autoCreateFooter').style.display = 'flex';
  }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
document.getElementById('autoCreateModal')?.addEventListener('click', function(e) {
  if (e.target === this) closeAutoCreateModal();
});

// ========== Kanban drag-and-drop ==========

var dragDocId = null;
var dragSourceStatus = null;

function kanbanDragStart(e) {
  var card = e.target.closest('.kanban-card');
  if (!card) return;
  dragDocId = card.dataset.docId;
  dragSourceStatus = card.dataset.status;
  card.classList.add('kanban-dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', dragDocId);
}

function kanbanDragEnd(e) {
  var card = e.target.closest('.kanban-card');
  if (card) card.classList.remove('kanban-dragging');
}

function kanbanDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  var col = e.currentTarget;
  if (!col.classList.contains('kanban-col-over')) {
    col.classList.add('kanban-col-over');
  }
}

function kanbanDragLeave(e) {
  var col = e.currentTarget;
  // Only remove highlight if leaving the column entirely
  if (!col.contains(e.relatedTarget)) {
    col.classList.remove('kanban-col-over');
  }
}

async function kanbanDrop(e) {
  e.preventDefault();
  var col = e.currentTarget;
  col.classList.remove('kanban-col-over');

  var newStatus = col.dataset.status;
  if (!dragDocId || newStatus === dragSourceStatus) return;

  // ¬´–û—Ç–ø—Ä–∞–≤–ª–µ–Ω¬ª ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É (Telegram/Email)
  if (newStatus === 'sent') {
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å–∞–º–∏ + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π
    var docsList = [];
    var seenIds = {};
    document.querySelectorAll('.doc-select-cb:checked').forEach(function(cb) {
      var did = parseInt(cb.dataset.docId);
      if (!seenIds[did]) {
        seenIds[did] = true;
        docsList.push({id: did, label: cb.dataset.docLabel || String(did)});
      }
    });
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º—ã–π, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –≤ —Å–ø–∏—Å–∫–µ
    var dragId = parseInt(dragDocId);
    if (!seenIds[dragId]) {
      var card = document.querySelector('.kanban-card[data-doc-id="' + dragDocId + '"]');
      var label = card ? (card.querySelector('strong')?.textContent || dragDocId) : dragDocId;
      docsList.push({id: dragId, label: label});
    }
    openBatchSendModal('telegram', docsList);
    return;
  }

  try {
    var resp = await fetch('/api/documents/' + dragDocId + '/status', {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({status: newStatus}),
    });
    var data = await resp.json();
    if (data.ok) {
      location.reload();
    } else {
      showKanbanToast(data.error || '–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å', 'error');
    }
  } catch (err) {
    showKanbanToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
  }
}

// ========== Kanban collapse/expand ==========

function toggleColumnExpand(btn, status) {
  var col = document.querySelector('.kanban-col[data-status="' + status + '"]');
  var hidden = col.querySelectorAll('.kanban-card-hidden');
  var isExpanded = btn.dataset.expanded === '1';
  hidden.forEach(function(card) {
    card.style.display = isExpanded ? 'none' : 'block';
  });
  btn.dataset.expanded = isExpanded ? '0' : '1';
  btn.textContent = isExpanded ? ('+' + hidden.length + ' –µ—â—ë') : '–°–≤–µ—Ä–Ω—É—Ç—å';
}

// ========== Toast ==========

function showKanbanToast(msg, type) {
  var toast = document.createElement('div');
  toast.className = 'kanban-toast' + (type ? ' ' + type : '');
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(function() { toast.remove(); }, 3000);
}

// ========== –ü–∞–∫–µ—Ç–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ==========

var batchChannel = '';
var recipientsCache = null;
var overrideDocIds = null;  // set by drag-to-sent

function getSelectedDocIds() {
  if (overrideDocIds) return overrideDocIds;
  var ids = [];
  document.querySelectorAll('.doc-select-cb:checked').forEach(function(cb) {
    ids.push(parseInt(cb.dataset.docId));
  });
  return ids;
}

function updateBatchBar() {
  var ids = getSelectedDocIds();
  var bar = document.getElementById('batchBar');
  if (ids.length > 0) {
    bar.style.display = 'flex';
    document.getElementById('batchCount').textContent = ids.length + ' –≤—ã–±—Ä–∞–Ω–æ';
  } else {
    bar.style.display = 'none';
  }
  // Sync column "select all" checkboxes
  document.querySelectorAll('.col-select-all').forEach(function(colCb) {
    var col = colCb.dataset.col;
    var all = document.querySelectorAll('.doc-select-cb[data-doc-id]');
    var colCbs = [];
    all.forEach(function(cb) {
      if (cb.closest('[data-kanban-col="' + col + '"]')) colCbs.push(cb);
    });
    if (colCbs.length === 0) { colCb.checked = false; return; }
    colCb.checked = colCbs.every(function(cb) { return cb.checked; });
  });
}

function clearDocSelection() {
  document.querySelectorAll('.doc-select-cb').forEach(function(cb) { cb.checked = false; });
  document.querySelectorAll('.col-select-all').forEach(function(cb) { cb.checked = false; });
  updateBatchBar();
}

function toggleColumnAll(status, checked) {
  document.querySelectorAll('[data-kanban-col="' + status + '"] .doc-select-cb').forEach(function(cb) {
    cb.checked = checked;
  });
  updateBatchBar();
}

async function openBatchSendModal(channel, docsList) {
  batchChannel = channel;

  // docsList: optional [{id, label}] from drag-to-sent
  if (docsList && docsList.length) {
    overrideDocIds = docsList.map(function(d) { return d.id; });
    var labels = docsList.map(function(d) { return d.label; });
    var ids = overrideDocIds;
  } else {
    overrideDocIds = null;
    var ids = getSelectedDocIds();
    if (!ids.length) return;
    var labels = [];
    document.querySelectorAll('.doc-select-cb:checked').forEach(function(cb) {
      labels.push(cb.dataset.docLabel || cb.dataset.docId);
    });
  }

  // Show selected docs
  document.getElementById('batchDocsList').innerHTML =
    '<strong>' + ids.length + ' –¥–æ–∫—É–º–µ–Ω—Ç(–æ–≤):</strong> ' +
    labels.map(function(l) { return '<span style="background:#e0e7ff; padding:2px 6px; border-radius:4px; margin:2px; display:inline-block;">' + l + '</span>'; }).join(' ');

  // Reset state
  document.getElementById('batchSendProgress').style.display = 'none';
  document.getElementById('batchSendResults').style.display = 'none';
  document.getElementById('batchSendResults').innerHTML = '';
  document.getElementById('batchSendFooter').style.display = 'flex';
  document.getElementById('batchSendBtn').disabled = false;

  // Show channel picker when opened from drag (no pre-set channel)
  var showPicker = !!docsList;
  document.getElementById('batchChannelPicker').style.display = showPicker ? 'block' : 'none';

  document.getElementById('batchSendTitle').textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç';
  _applyBatchChannel(channel);

  document.getElementById('batchSendModal').style.display = 'flex';
}

function _applyBatchChannel(channel) {
  batchChannel = channel;
  // Update channel picker highlight
  document.querySelectorAll('.channel-btn').forEach(function(btn) {
    var active = btn.dataset.ch === channel;
    btn.style.borderColor = active ? (channel === 'telegram' ? '#0088cc' : '#059669') : '#d1d5db';
    btn.style.background = active ? (channel === 'telegram' ? '#e0f2fe' : '#d1fae5') : '#fff';
    btn.style.color = active ? (channel === 'telegram' ? '#0369a1' : '#065f46') : '#6b7280';
  });

  if (channel === 'telegram') {
    document.getElementById('batchTgSection').style.display = 'block';
    document.getElementById('batchEmailSection').style.display = 'none';
    loadRecipients();
  } else {
    document.getElementById('batchTgSection').style.display = 'none';
    document.getElementById('batchEmailSection').style.display = 'block';
    document.getElementById('batchEmailInput').value = '';
  }
}

function switchBatchChannel(channel) {
  _applyBatchChannel(channel);
}

function closeBatchSendModal() {
  document.getElementById('batchSendModal').style.display = 'none';
  document.getElementById('batchCommentInput').value = '';
  overrideDocIds = null;
}

async function loadRecipients() {
  var listEl = document.getElementById('batchTgList');
  var loadingEl = document.getElementById('batchTgLoading');

  if (recipientsCache) {
    renderRecipients(recipientsCache);
    return;
  }

  loadingEl.style.display = 'block';
  listEl.innerHTML = '';

  try {
    var resp = await fetch('/api/chat/recipients');
    var data = await resp.json();
    recipientsCache = data;
    loadingEl.style.display = 'none';
    renderRecipients(data);
  } catch (e) {
    loadingEl.style.display = 'none';
    listEl.innerHTML = '<div style="padding:8px; color:#991b1b;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>';
  }
}

function renderRecipients(data) {
  var listEl = document.getElementById('batchTgList');
  var html = '';

  if (data.subgroups && data.subgroups.length) {
    html += '<div style="padding:6px 10px; font-size:11px; font-weight:600; color:#6b7280; background:#f3f4f6;">–ü–æ–¥–≥—Ä—É–ø–ø—ã</div>';
    data.subgroups.forEach(function(sg) {
      var memberIds = (sg.user_ids || []).join(',');
      html += '<label style="display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid #f0f0f0; cursor:pointer;">' +
        '<input type="checkbox" class="batch-recipient-cb" value="subgroup:' + memberIds + '" data-type="subgroup"> ' +
        '<span style="font-size:13px;">' + sg.name + ' <span style="color:#9ca3af;">(' + (sg.user_ids || []).length + ')</span></span></label>';
    });
  }

  if (data.groups && data.groups.length) {
    html += '<div style="padding:6px 10px; font-size:11px; font-weight:600; color:#6b7280; background:#f3f4f6;">–ì—Ä—É–ø–ø—ã</div>';
    data.groups.forEach(function(g) {
      html += '<label style="display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid #f0f0f0; cursor:pointer;">' +
        '<input type="checkbox" class="batch-recipient-cb" value="' + g.chat_id + '" data-type="group"> ' +
        '<span style="font-size:13px;">' + (g.title || g.chat_id) + '</span></label>';
    });
  }

  if (data.users && data.users.length) {
    html += '<div style="padding:6px 10px; font-size:11px; font-weight:600; color:#6b7280; background:#f3f4f6;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>';
    data.users.forEach(function(u) {
      html += '<label style="display:flex; align-items:center; gap:8px; padding:8px 10px; border-bottom:1px solid #f0f0f0; cursor:pointer;">' +
        '<input type="checkbox" class="batch-recipient-cb" value="' + u.chat_id + '" data-type="user"> ' +
        '<span style="font-size:13px;">' + (u.full_name || u.username || u.chat_id) + '</span></label>';
    });
  }

  if (!html) {
    html = '<div style="padding:12px; color:#6b7280; text-align:center;">–ù–µ—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π. –î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–ª–∏ –≥—Ä—É–ø–ø—ã.</div>';
  }

  listEl.innerHTML = html;
}

function _collectRecipients() {
  // Collect unique chat_ids from checked checkboxes (expand subgroups)
  var chatIds = [];
  var seen = {};
  document.querySelectorAll('.batch-recipient-cb:checked').forEach(function(cb) {
    if (cb.dataset.type === 'subgroup') {
      // value = "subgroup:id1,id2,id3"
      var memberStr = cb.value.replace('subgroup:', '');
      if (memberStr) {
        memberStr.split(',').forEach(function(id) {
          if (id && !seen[id]) { seen[id] = true; chatIds.push(id); }
        });
      }
    } else {
      var v = cb.value;
      if (v && !seen[v]) { seen[v] = true; chatIds.push(v); }
    }
  });
  return chatIds;
}

async function executeBatchSend() {
  var ids = getSelectedDocIds();
  if (!ids.length) return;

  var comment = document.getElementById('batchCommentInput').value.trim();
  var recipients = [];

  if (batchChannel === 'telegram') {
    recipients = _collectRecipients();
    if (!recipients.length) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π'); return; }
  } else {
    var emailStr = document.getElementById('batchEmailInput').value.trim();
    if (!emailStr) { alert('–í–≤–µ–¥–∏—Ç–µ email'); return; }
    recipients = emailStr.split(/[,;\s]+/).filter(Boolean);
  }

  // Show progress
  document.getElementById('batchSendBtn').disabled = true;
  document.getElementById('batchSendProgress').style.display = 'block';

  var totalSent = 0, totalFailed = 0, allResults = [];

  try {
    for (var i = 0; i < recipients.length; i++) {
      var payload = { document_ids: ids, channel: batchChannel };
      if (batchChannel === 'telegram') {
        payload.chat_id = recipients[i];
      } else {
        payload.to_email = recipients[i];
      }
      if (comment) payload.comment = comment;

      var resp = await fetch('/api/jobs/send/batch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      var data = await resp.json();
      totalSent += data.sent || 0;
      totalFailed += data.failed || 0;
      if (data.results) allResults = allResults.concat(data.results);

      // Small delay between recipients
      if (recipients.length > 1 && i < recipients.length - 1) {
        await new Promise(function(r) { setTimeout(r, 100); });
      }
    }

    document.getElementById('batchSendProgress').style.display = 'none';

    var resultsEl = document.getElementById('batchSendResults');
    resultsEl.style.display = 'block';

    var isOk = totalFailed === 0;
    var bgColor = isOk ? '#d1fae5' : '#fef3c7';
    var borderColor = isOk ? '#a7f3d0' : '#fcd34d';
    var textColor = isOk ? '#065f46' : '#92400e';

    var summary = '–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ' + totalSent + ' –∏–∑ ' + (totalSent + totalFailed);
    if (recipients.length > 1) summary += ' (–ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ' + recipients.length + ')';

    var html = '<div style="background:' + bgColor + '; border:1px solid ' + borderColor + '; color:' + textColor +
      '; padding:12px; border-radius:8px; font-size:13px;">' +
      '<strong>' + (isOk ? '‚úÖ' : '‚ö†Ô∏è') + ' –†–µ–∑—É–ª—å—Ç–∞—Ç:</strong> ' + summary + '</div>';

    if (allResults.length) {
      html += '<div style="margin-top:8px; max-height:150px; overflow:auto; font-size:12px;">';
      allResults.forEach(function(r) {
        var icon = r.status === 'sent' ? '‚úÖ' : '‚ùå';
        html += '<div style="padding:4px 0; border-bottom:1px solid #f0f0f0;">' +
          icon + ' ' + (r.doc_number || r.document_id) +
          (r.error ? ' ‚Äî <span style="color:#991b1b;">' + r.error + '</span>' : '') + '</div>';
      });
      html += '</div>';
    }

    resultsEl.innerHTML = html;

    document.getElementById('batchSendFooter').innerHTML =
      '<button type="button" class="btn-secondary" onclick="closeBatchSendModal()">–ó–∞–∫—Ä—ã—Ç—å</button>' +
      '<button type="button" class="btn-apply" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>';

  } catch (error) {
    document.getElementById('batchSendProgress').style.display = 'none';
    var resultsEl = document.getElementById('batchSendResults');
    resultsEl.style.display = 'block';
    resultsEl.innerHTML = '<div style="background:#fee2e2; border:1px solid #fca5a5; color:#991b1b; padding:12px; border-radius:8px;">' +
      '<strong>‚ùå –û—à–∏–±–∫–∞:</strong> ' + (error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å') + '</div>';
    document.getElementById('batchSendFooter').innerHTML =
      '<button type="button" class="btn-secondary" onclick="closeBatchSendModal()">–ó–∞–∫—Ä—ã—Ç—å</button>';
  }
}

// ========== Archive accordion: lazy-load docs per well ==========

document.querySelectorAll('.archive-well-group').forEach(function(details) {
  details.addEventListener('toggle', function() {
    if (!details.open) return;
    var wellId = details.dataset.wellId;
    var container = document.getElementById('archiveDocs-' + wellId);
    if (container.dataset.loaded === '1') return;

    fetch('/api/documents/archive-well/' + wellId)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        container.dataset.loaded = '1';
        if (!data.docs || !data.docs.length) {
          container.innerHTML = '<div style="padding:8px; color:#9ca3af; font-size:12px;">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>';
          return;
        }
        var html = '';
        data.docs.forEach(function(d) {
          html += '<div class="archive-doc-row">' +
            '<a href="/documents/' + d.id + '">' + (d.doc_number || '‚Äî') + '</a> ' +
            '<span style="color:#6b7280;">' + d.type_name + '</span> ' +
            (d.period ? '<span style="color:#9ca3af;">' + d.period + '</span>' : '') +
            (d.has_pdf ? ' <span style="font-size:10px;">üìÑ</span>' : '') +
            '</div>';
        });
        container.innerHTML = html;
      })
      .catch(function() {
        container.innerHTML = '<div style="color:#991b1b; padding:8px; font-size:12px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
      });
  });
});

// ========== Cancelled column expand ==========

function toggleCancelledExpand(btn) {
  var col = btn.closest('.kanban-col');
  var hidden = col.querySelectorAll('.cancelled-row-hidden');
  var isExpanded = btn.dataset.expanded === '1';
  hidden.forEach(function(row) {
    row.style.display = isExpanded ? 'none' : 'flex';
  });
  btn.dataset.expanded = isExpanded ? '0' : '1';
  btn.textContent = isExpanded ? ('+' + hidden.length + ' –µ—â—ë') : '–°–≤–µ—Ä–Ω—É—Ç—å';
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∞ –ø–∞–∫–µ—Ç–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –µ–≥–æ
document.getElementById('batchSendModal')?.addEventListener('click', function(e) {
  if (e.target === this) closeBatchSendModal();
});
</script>

{% endblock %}