{% extends "base.html" %}

{% block title %}–ê–∫—Ç—ã ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}

<!-- –ë–û–õ–¨–®–ê–Ø –ü–õ–ò–¢–ö–ê –î–ê–®–ë–û–†–î–ê -->
<a href="/" style="display:block; margin-bottom:20px; text-decoration:none;">
  <div style="background:linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); color:white; padding:24px 32px; border-radius:12px; display:flex; align-items:center; gap:20px; transition:transform 0.2s, box-shadow 0.2s;"
       onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0,0,0,0.2)';"
       onmouseout="this.style.transform=''; this.style.boxShadow='';">
    <div style="font-size:48px;">üè†</div>
    <div>
      <div style="font-size:24px; font-weight:700;">–î–∞—à–±–æ—Ä–¥</div>
      <div style="opacity:0.8; font-size:14px;">–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∏—Å—Ç–µ–º—ã –°–£–†–ì–ò–õ</div>
    </div>
    <div style="margin-left:auto; font-size:32px; opacity:0.5;">‚Üí</div>
  </div>
</a>

<h1 style="margin: 0 0 16px 0;">–ê–∫—Ç—ã</h1>

<div class="cards-grid" style="display:grid; gap:16px;">

  <!-- KANBAN -->
  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–ö–∞–Ω–±–∞–Ω</h2>

    <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; overflow:auto;">
      {% for s in ["draft","generated","signed","sent","archived","cancelled"] %}
      <div style="min-width:220px; border:1px solid #ddd; border-radius:8px; padding:10px;">
        <div style="font-weight:600; margin-bottom:8px;">
          {% if s == 'draft' %}üìù –ß–µ—Ä–Ω–æ–≤–∏–∫
          {% elif s == 'generated' %}üìÑ –°–æ–∑–¥–∞–Ω
          {% elif s == 'signed' %}‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω
          {% elif s == 'sent' %}üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω
          {% elif s == 'archived' %}üì¶ –ê—Ä—Ö–∏–≤
          {% elif s == 'cancelled' %}‚ùå –û—Ç–º–µ–Ω—ë–Ω
          {% else %}{{ s }}{% endif %}
        </div>

        {% for d in board.get(s, []) %}
          {% set is_handover = d.doc_type and d.doc_type.code in ["well_acceptance", "well_transfer"] %}
          {% set is_equipment = d.doc_type and d.doc_type.code in ["equipment_install", "equipment_remove"] %}
          {% if is_handover %}
            {% set detail_url = "/documents/well-handover/" ~ d.id %}
          {% elif is_equipment %}
            {% set detail_url = "/documents/equipment/" ~ d.id %}
          {% else %}
            {% set detail_url = "/documents/" ~ d.id %}
          {% endif %}

          <div style="border:1px solid #eee; border-radius:8px; padding:8px; margin-bottom:8px;">
            <div><strong>{{ d.doc_number or "‚Äî" }}</strong></div>

            <div style="font-size:12px; opacity:0.8;">
              {{ d.doc_type.name_ru if d.doc_type else "" }}
              {% if d.well %} ¬∑ –°–∫–≤ {{ d.well.number }}{% endif %}
            </div>

            <div style="font-size:12px; opacity:0.8;">
              {% if d.period_month and d.period_year %}
                {{ "%02d"|format(d.period_month) }}.{{ d.period_year }}
              {% endif %}
            </div>

            <div style="margin-top:6px; display:flex; gap:10px; align-items:center;">
              <a href="{{ detail_url }}" class="admin-link">–û—Ç–∫—Ä—ã—Ç—å</a>

              {% if d.status == "draft" %}
                {% if is_equipment %}
                  <form method="post" action="/documents/equipment/{{ d.id }}/delete"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?');"
                        style="margin:0;">
                    <button type="submit" style="font-size:11px; padding:2px 6px;">√ó</button>
                  </form>
                {% else %}
                  <form method="post" action="/documents/{{ d.id }}/delete"
                        onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫?');"
                        style="margin:0;">
                    <button type="submit" style="font-size:11px; padding:2px 6px;">√ó</button>
                  </form>
                {% endif %}
              {% endif %}
            </div>
          </div>
        {% endfor %}

        {% if board.get(s, [])|length == 0 %}
          <div style="opacity:0.4; font-size:12px; text-align:center; padding:8px;">–ø—É—Å—Ç–æ</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- MASS ACTIONS -->
  <section class="card" style="padding:16px; margin: 0 0 16px 0;">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;">
      <div>
        <div style="font-weight:700;">–ú–∞—Å—Å–æ–≤—ã–µ –∞–∫—Ç—ã</div>
        <div style="opacity:.7; font-size:13px;">
          –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–æ–≤ —Å –≤—ã–±–æ—Ä–æ–º —Å–∫–≤–∞–∂–∏–Ω –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
        </div>
      </div>
    </div>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
      <a class="btn btn-primary" href="/documents/reagent-expense/new" style="display:inline-flex; align-items:center; gap:8px;">
        + –ê–∫—Ç —Ä–∞—Å—Ö–æ–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ (–º–∞—Å—Å–æ–≤–æ)
      </a>
    </div>
  </section>

  <!-- WELLS SECTION WITH MULTI-SELECT STATUS FILTER -->
  <section class="card" style="padding:16px;">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:16px; gap:20px;">
      <h2 style="margin:0;">–°–∫–≤–∞–∂–∏–Ω—ã</h2>

      <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä) -->
      <div style="flex:1; max-width:600px;">
        <div style="font-weight:600; margin-bottom:8px; font-size:14px;">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º:</div>

        <div class="status-filter-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:8px; margin-bottom:12px;">
          {% for css, name in available_statuses %}
          <label class="status-filter-checkbox {{ css }}" style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.2s; border:2px solid transparent;">
            <input
              type="checkbox"
              class="status-checkbox"
              data-status="{{ css }}"
              {% if css in selected_statuses %}checked{% endif %}
              style="cursor:pointer;"
            >
            <span style="font-weight:600; font-size:13px;">{{ name }}</span>
          </label>
          {% endfor %}

          {% if wells_without_status > 0 %}
          <label class="status-filter-checkbox" style="display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:6px; cursor:pointer; transition:all 0.2s; border:2px solid #ddd; background:#f8f9fa;">
            <input
              type="checkbox"
              class="status-checkbox"
              data-status="no-status"
              {% if 'no-status' in selected_statuses %}checked{% endif %}
              style="cursor:pointer;"
            >
            <span style="font-weight:600; font-size:13px; color:#666;">–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞</span>
          </label>
          {% endif %}
        </div>

        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <button
            onclick="selectAllStatuses()"
            class="btn-secondary"
            style="padding:6px 12px; font-size:13px;"
          >
            –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
          </button>
          <button
            onclick="clearAllStatuses()"
            class="btn-secondary"
            style="padding:6px 12px; font-size:13px;"
          >
            –°–Ω—è—Ç—å –≤—Å–µ
          </button>
          <span style="color:#666; font-size:13px; margin-left:auto;">
            –ü–æ–∫–∞–∑–∞–Ω–æ: <strong id="visible-count">{{ wells|length }}</strong> –∏–∑ <strong>{{ total_wells }}</strong>
          </span>
        </div>
      </div>

      <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
      <div>
        <div style="font-weight:600; margin-bottom:8px; font-size:14px;">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</div>
        <select
          id="sort-select"
          onchange="sortWells()"
          style="padding:8px 12px; border:1px solid #ddd; border-radius:6px; font-size:14px;"
        >
          <option value="number-asc">–ù–æ–º–µ—Ä ‚Üë</option>
          <option value="number-desc">–ù–æ–º–µ—Ä ‚Üì</option>
          <option value="status-asc">–°—Ç–∞—Ç—É—Å –ê-–Ø</option>
          <option value="status-desc">–°—Ç–∞—Ç—É—Å –Ø-–ê</option>
          <option value="docs-desc">–ê–∫—Ç–æ–≤ (–±–æ–ª—å—à–µ)</option>
          <option value="docs-asc">–ê–∫—Ç–æ–≤ (–º–µ–Ω—å—à–µ)</option>
          <option value="days-desc">–î–Ω–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ (–±–æ–ª—å—à–µ)</option>
          <option value="days-asc">–î–Ω–µ–π –≤ —Å—Ç–∞—Ç—É—Å–µ (–º–µ–Ω—å—à–µ)</option>
        </select>
      </div>
    </div>

    <div id="wells-container">
      {% for w in wells %}
        <details
          class="well-details"
          data-well-number="{{ w.number }}"
          data-status-css="{{ w.current_status_css or 'no-status' }}"
          data-status-name="{{ w.current_status or '' }}"
          data-docs-total="{{ well_total_stats.get(w.id, {'total': 0}).total }}"
          data-status-days="{{ w.current_status_days or 0 }}"
          style="border:1px solid #e5e5e5; border-radius:10px; margin-bottom:10px; overflow:hidden; {% if w.current_status_css not in selected_statuses and (w.current_status_css or 'no-status') != 'no-status' %}display:none;{% endif %} {% if not w.current_status and 'no-status' not in selected_statuses %}display:none;{% endif %}"
        >
          <summary style="list-style:none; cursor:pointer;">
            <div class="well-header" style="display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px; padding:12px 16px; background:#fafafa;">

              <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã -->
              <div style="display:flex; align-items:center; gap:8px; font-weight:700; font-size:15px;">
                <span class="well-arrow" style="font-size:12px; transition:transform 0.2s;">‚ñ∫</span>
                –°–∫–≤ {{ w.number }}
              </div>

              <!-- –°—Ç–∞—Ç—É—Å -->
              <div style="display:flex; align-items:center; gap:16px;">
                {% if w.current_status %}
                  <div class="status-badge {{ w.current_status_css }}" style="padding:6px 16px; border-radius:6px; font-weight:600; font-size:13px; white-space:nowrap;">
                    {{ w.current_status }}
                  </div>
                  <div style="font-size:12px; color:#666;">
                    {% if w.current_status_start %}
                      —Å {{ w.current_status_start.strftime("%d.%m.%Y") }}
                    {% endif %}
                    {% if w.current_status_days is not none %}
                      ¬∑ <strong>{{ "%.1f"|format(w.current_status_days) }}</strong> —Å—É—Ç.
                    {% endif %}
                  </div>
                {% else %}
                  <div style="padding:6px 16px; border-radius:6px; font-weight:600; font-size:13px; background:#f0f0f0; color:#666;">
                    –°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                  </div>
                {% endif %}
              </div>

              <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–æ–≤ -->
              {% set stats = well_total_stats.get(w.id, {"total": 0, "by_group": {}}) %}
              <div style="display:flex; gap:20px; font-size:13px;">
                <div style="display:flex; flex-direction:column; align-items:center; gap:2px;">
                  <div style="font-weight:700; font-size:16px; color:#0066cc;">{{ stats.total }}</div>
                  <div style="color:#666; font-size:11px; text-transform:uppercase;">–í—Å–µ–≥–æ</div>
                </div>
              </div>

            </div>
          </summary>

          <div style="padding:16px; display:grid; gap:8px;">

            <div style="font-weight:600; margin-top:6px;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–∑–æ–≤—ã–µ</div>

            {% for dt in doc_types_one_time %}
              {# –ü—Ä–æ–ø—É—Å–∫–∞–µ–º equipment_remove - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–¥–∏–Ω—É—é —Å—Ç—Ä–æ–∫—É #}
              {% if dt.code != "equipment_remove" %}

              {% set st = well_stats.get((w.id, dt.id)) %}
              <div style="display:flex; gap:12px; align-items:center; padding:8px; border:1px solid #f0f0f0; border-radius:8px;">
                <div style="min-width:320px;">
                  {# –î–ª—è equipment_install –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ #}
                  {% if dt.code == "equipment_install" %}
                    üì¶ –ê–∫—Ç –º–æ–Ω—Ç–∞–∂–∞/–¥–µ–º–æ–Ω—Ç–∞–∂–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
                  {% else %}
                    {{ dt.name_ru }}
                  {% endif %}
                </div>

                {# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ #}
                {% if dt.code == "equipment_install" %}
                  {% set st_install = well_stats.get((w.id, dt.id)) %}
                  {% set dt_remove_list = doc_types_one_time|selectattr("code", "equalto", "equipment_remove")|list %}
                  {% set dt_remove = dt_remove_list[0] if dt_remove_list else none %}
                  {% set st_remove = well_stats.get((w.id, dt_remove.id)) if dt_remove else none %}

                  {% if (st_install and st_install.docs) or (st_remove and st_remove.docs) %}
                    <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:13px;">
                      {% if st_install and st_install.docs %}
                        {% for x in st_install.docs %}
                          <a href="/documents/equipment/{{ x.id }}" style="padding:2px 8px; background:#e7f5e7; border-radius:4px; text-decoration:none;">
                            üì¶ {{ x.doc_number or ("#" ~ x.id) }}
                          </a>
                        {% endfor %}
                      {% endif %}
                      {% if st_remove and st_remove.docs %}
                        {% for x in st_remove.docs %}
                          <a href="/documents/equipment/{{ x.id }}" style="padding:2px 8px; background:#fff3cd; border-radius:4px; text-decoration:none;">
                            üîß {{ x.doc_number or ("#" ~ x.id) }}
                          </a>
                        {% endfor %}
                      {% endif %}
                    </div>
                  {% else %}
                    <span style="opacity:.7;">–Ω–µ—Ç</span>
                  {% endif %}
                {% else %}
                  {% if st and st.docs and (st.docs|length) > 0 %}
                    <div style="display:flex; gap:8px; flex-wrap:wrap; font-size:13px;">
                      {% for x in st.docs %}
                        {% set is_handover = dt.code in ["well_acceptance", "well_transfer"] %}
                        <a href="{{ ("/documents/well-handover/" ~ x.id) if is_handover else ("/documents/" ~ x.id) }}"
                           style="padding:2px 8px; background:#e0e0e0; border-radius:4px; text-decoration:none;">
                          {{ x.doc_number or ("#" ~ x.id) }}
                        </a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span style="opacity:.7;">–Ω–µ—Ç</span>
                  {% endif %}
                {% endif %}

                {# –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è #}
                {% if dt.code == "equipment_install" %}
                  <a class="btn btn-primary" style="margin-left:auto; font-size:13px; padding:6px 12px;" href="/documents/equipment/new?well_id={{ w.id }}&kind=install">
                    + –°–æ–∑–¥–∞—Ç—å
                  </a>
                {% elif dt.code in ["well_acceptance", "well_transfer"] %}
                  <a class="btn btn-primary" style="margin-left:auto; font-size:13px; padding:6px 12px;" href="/documents/well-handover/new?well_id={{ w.id }}&kind={{ dt.code }}">
                    + –°–æ–∑–¥–∞—Ç—å
                  </a>
                {% else %}
                  <form method="post" action="/documents/create" style="margin-left:auto;">
                    <input type="hidden" name="doc_type_id" value="{{ dt.id }}">
                    <input type="hidden" name="well_id" value="{{ w.id }}">
                    <button type="submit" style="font-size:13px; padding:6px 12px;">+ –°–æ–∑–¥–∞—Ç—å</button>
                  </form>
                {% endif %}
              </div>
              {% endif %}
            {% endfor %}

            <div style="font-weight:600; margin-top:10px;">–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ</div>
            <div style="opacity:.75; font-size:13px;">
              –î–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º: –≤—ã–±–æ—Ä –º–µ—Å—è—Ü–∞/–≥–æ–¥–∞ + –∞–≤—Ç–æ—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö.
            </div>

            <div style="margin-top:6px;">
              <a href="/documents?well_id={{ w.id }}">–í—Å–µ –∞–∫—Ç—ã –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ</a>
            </div>

          </div>
        </details>
      {% endfor %}
    </div>

    {% if wells|length == 0 %}
      <div style="padding:40px; text-align:center; opacity:0.6;">
        –ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
      </div>
    {% endif %}
  </section>

  <!-- FINANCE -->
  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∞–∫—Ç—ã</h2>
    <div style="opacity:0.8;">–°—á–µ—Ç–∞-—Ñ–∞–∫—Ç—É—Ä—ã, –∞–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç ‚Äî –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–º —ç—Ç–∞–ø–æ–º.</div>
  </section>

</div>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ */
:root {
  --status-watch-color: #0c5460;
  --status-watch-bg: #d1ecf1;
  --status-adapt-color: #856404;
  --status-adapt-bg: #fff3cd;
  --status-opt-color: #155724;
  --status-opt-bg: #d4edda;
  --status-dev-color: #004085;
  --status-dev-bg: #cce5ff;
  --status-off-color: #721c24;
  --status-off-bg: #f8d7da;
  --status-idle-color: #383d41;
  --status-idle-bg: #e2e3e5;
  --status-other-color: #333;
  --status-other-bg: #e7e7e7;
}

.status-badge.status-watch { background: var(--status-watch-bg); color: var(--status-watch-color); }
.status-badge.status-adapt { background: var(--status-adapt-bg); color: var(--status-adapt-color); }
.status-badge.status-opt { background: var(--status-opt-bg); color: var(--status-opt-color); }
.status-badge.status-dev { background: var(--status-dev-bg); color: var(--status-dev-color); }
.status-badge.status-off { background: var(--status-off-bg); color: var(--status-off-color); }
.status-badge.status-idle { background: var(--status-idle-bg); color: var(--status-idle-color); }
.status-badge.status-other { background: var(--status-other-bg); color: var(--status-other-color); }

/* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
.status-filter-checkbox.status-watch { background: var(--status-watch-bg); color: var(--status-watch-color); border-color: var(--status-watch-bg); }
.status-filter-checkbox.status-adapt { background: var(--status-adapt-bg); color: var(--status-adapt-color); border-color: var(--status-adapt-bg); }
.status-filter-checkbox.status-opt { background: var(--status-opt-bg); color: var(--status-opt-color); border-color: var(--status-opt-bg); }
.status-filter-checkbox.status-dev { background: var(--status-dev-bg); color: var(--status-dev-color); border-color: var(--status-dev-bg); }
.status-filter-checkbox.status-off { background: var(--status-off-bg); color: var(--status-off-color); border-color: var(--status-off-bg); }
.status-filter-checkbox.status-idle { background: var(--status-idle-bg); color: var(--status-idle-color); border-color: var(--status-idle-bg); }
.status-filter-checkbox.status-other { background: var(--status-other-bg); color: var(--status-other-color); border-color: var(--status-other-bg); }

.status-filter-checkbox input:checked ~ span {
  font-weight: 700;
}

.status-filter-checkbox:has(input:checked) {
  border-color: currentColor;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-filter-checkbox:hover {
  opacity: 0.8;
  transform: translateY(-1px);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è */
.well-details[open] .well-arrow {
  transform: rotate(90deg);
}

.well-header:hover {
  background: #f0f0f0;
}
</style>

<script>
const STORAGE_KEY_STATUSES = 'documents_selected_statuses';
const STORAGE_KEY_SORT = 'documents_sort_order';

// ========== –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º ==========
function filterWells() {
  const checkboxes = document.querySelectorAll('.status-checkbox:checked');
  const selectedStatuses = Array.from(checkboxes).map(cb => cb.dataset.status);

  localStorage.setItem(STORAGE_KEY_STATUSES, JSON.stringify(selectedStatuses));

  const wells = document.querySelectorAll('.well-details');
  let visibleCount = 0;

  wells.forEach(well => {
    const wellStatus = well.dataset.statusCss || 'no-status';
    const shouldShow = selectedStatuses.length === 0 || selectedStatuses.includes(wellStatus);

    well.style.display = shouldShow ? '' : 'none';
    if (shouldShow) visibleCount++;
  });

  const counter = document.getElementById('visible-count');
  if (counter) counter.textContent = visibleCount;
}

function selectAllStatuses() {
  document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = true);
  filterWells();
}

function clearAllStatuses() {
  document.querySelectorAll('.status-checkbox').forEach(cb => cb.checked = false);
  filterWells();
}

// ========== –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ ==========
function sortWells() {
  const sortValue = document.getElementById('sort-select').value;
  const container = document.getElementById('wells-container');
  const wells = Array.from(document.querySelectorAll('.well-details'));

  localStorage.setItem(STORAGE_KEY_SORT, sortValue);

  wells.sort((a, b) => {
    const aNum = parseInt(a.dataset.wellNumber) || 0;
    const bNum = parseInt(b.dataset.wellNumber) || 0;
    const aStatus = a.dataset.statusName || '';
    const bStatus = b.dataset.statusName || '';
    const aDocs = parseInt(a.dataset.docsTotal) || 0;
    const bDocs = parseInt(b.dataset.docsTotal) || 0;
    const aDays = parseFloat(a.dataset.statusDays) || 0;
    const bDays = parseFloat(b.dataset.statusDays) || 0;

    switch(sortValue) {
      case 'number-asc': return aNum - bNum;
      case 'number-desc': return bNum - aNum;
      case 'status-asc': return aStatus.localeCompare(bStatus, 'ru');
      case 'status-desc': return bStatus.localeCompare(aStatus, 'ru');
      case 'docs-desc': return bDocs - aDocs;
      case 'docs-asc': return aDocs - bDocs;
      case 'days-desc': return bDays - aDays;
      case 'days-asc': return aDays - bDays;
      default: return aNum - bNum;
    }
  });

  wells.forEach(well => container.appendChild(well));
}

// ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ==========
document.addEventListener('DOMContentLoaded', function() {
  const savedStatuses = localStorage.getItem(STORAGE_KEY_STATUSES);
  if (savedStatuses) {
    try {
      const statuses = JSON.parse(savedStatuses);
      document.querySelectorAll('.status-checkbox').forEach(cb => {
        cb.checked = statuses.includes(cb.dataset.status);
      });
      filterWells();
    } catch (e) {}
  }

  const savedSort = localStorage.getItem(STORAGE_KEY_SORT);
  if (savedSort) {
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
      sortSelect.value = savedSort;
      sortWells();
    }
  }

  document.querySelectorAll('.status-checkbox').forEach(cb => {
    cb.addEventListener('change', filterWells);
  });
});
</script>

{% endblock %}