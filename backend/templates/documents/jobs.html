{% extends "base.html" %}
{% block title %}–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item active">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<div class="page-dashboard">

<header class="dashboard-header">
  <div class="header-left">
    <a href="/documents" class="back-btn">‚Üê</a>
    <h1>–ò—Å—Ç–æ—Ä–∏—è –∞–≤—Ç–æ–∑–∞–¥–∞—á</h1>
  </div>
</header>

<section class="analytics-card">
  <div class="section-header">
    <h2 style="margin:0;">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏</h2>
    <div style="font-size:13px; color:#6b7280;">
      –ü–æ—Å–ª–µ–¥–Ω–∏–µ {{ jobs|length }} –∏–∑ {{ total }} –∑–∞–¥–∞—á
    </div>
  </div>

  {% if jobs|length > 0 %}
  <table style="width:100%; border-collapse:collapse; font-size:13px; margin-top:16px;">
    <thead>
      <tr style="background:#f8f9fa; text-align:left;">
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">ID</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–¢–∏–ø</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–°—Ç–∞—Ç—É—Å</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–ù–∞—á–∞–ª–æ</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
        <th style="padding:10px 12px; border-bottom:2px solid #dee2e6;">–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
      </tr>
    </thead>
    <tbody>
      {% for job in jobs %}
      <tr style="border-bottom:1px solid #e5e7eb;">
        <td style="padding:10px 12px; font-weight:600;">#{{ job.id }}</td>
        <td style="padding:10px 12px;">
          {% if job.job_type == 'reagent_expense_auto_create' %}
            üìÑ –ê–∫—Ç—ã —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤
          {% else %}
            {{ job.job_type }}
          {% endif %}
        </td>
        <td style="padding:10px 12px;">
          {% if job.status == 'success' %}
            <span style="background:#d1fae5; color:#065f46; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">–£—Å–ø–µ—à–Ω–æ</span>
          {% elif job.status == 'partial' %}
            <span style="background:#fef3c7; color:#92400e; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">–ß–∞—Å—Ç–∏—á–Ω–æ</span>
          {% elif job.status == 'failed' %}
            <span style="background:#fee2e2; color:#991b1b; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">–û—à–∏–±–∫–∞</span>
          {% elif job.status == 'skipped' %}
            <span style="background:#e5e7eb; color:#374151; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">–ü—Ä–æ–ø—É—â–µ–Ω–æ</span>
          {% elif job.status == 'running' %}
            <span style="background:#dbeafe; color:#1e40af; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600;">–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...</span>
          {% else %}
            <span style="background:#f3f4f6; color:#6b7280; padding:3px 8px; border-radius:4px; font-size:11px;">{{ job.status }}</span>
          {% endif %}
        </td>
        <td style="padding:10px 12px; color:#6b7280;">
          {% if job.started_at %}{{ job.started_at.strftime("%d.%m.%Y %H:%M") }}{% else %}‚Äî{% endif %}
        </td>
        <td style="padding:10px 12px; color:#6b7280;">
          {% if job.finished_at %}{{ job.finished_at.strftime("%d.%m.%Y %H:%M") }}{% else %}‚Äî{% endif %}
        </td>
        <td style="padding:10px 12px;">
          {% if job.triggered_by == 'cron' %}
            ü§ñ Cron
          {% elif job.triggered_by == 'manual' %}
            üë§ –í—Ä—É—á–Ω—É—é
          {% elif job.triggered_by == 'api' %}
            üîå API
          {% else %}
            {{ job.triggered_by or '‚Äî' }}
          {% endif %}
        </td>
        <td style="padding:10px 12px;">
          {% if job.result_summary %}
            {% set s = job.result_summary %}
            <span title="–í—Å–µ–≥–æ: {{ s.total_wells or 0 }}, –°–æ–∑–¥–∞–Ω–æ: {{ s.created or 0 }}, –ü—Ä–æ–ø—É—â–µ–Ω–æ: {{ (s.skipped_duplicate or 0) + (s.skipped_no_events or 0) }}, –û—à–∏–±–æ–∫: {{ s.errors or 0 }}">
              ‚úÖ{{ s.created or 0 }}
              {% if s.skipped_duplicate or s.skipped_no_events %}
                ‚è≠Ô∏è{{ (s.skipped_duplicate or 0) + (s.skipped_no_events or 0) }}
              {% endif %}
              {% if s.errors %}
                ‚ùå{{ s.errors }}
              {% endif %}
            </span>
          {% else %}
            ‚Äî
          {% endif %}
        </td>
      </tr>
      {% if job.result_summary and job.result_summary.details %}
      <tr style="background:#f9fafb;">
        <td colspan="7" style="padding:8px 12px 12px 40px;">
          <details style="font-size:12px;">
            <summary style="cursor:pointer; color:#6b7280;">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ({{ job.result_summary.details|length }} –∑–∞–ø–∏—Å–µ–π)</summary>
            <div style="margin-top:8px; max-height:200px; overflow:auto;">
              {% for d in job.result_summary.details %}
                <div style="padding:4px 0; border-bottom:1px solid #e5e7eb;">
                  {% if d.status == 'created' %}
                    ‚úÖ <a href="/documents/{{ d.document_id }}">{{ d.doc_number }}</a> ‚Äî –°–∫–≤ {{ d.well_number }} ({{ d.items_count }} —Å—Ç—Ä–æ–∫)
                  {% elif d.status == 'skipped' %}
                    ‚è≠Ô∏è –°–∫–≤ {{ d.well_number }} ‚Äî {{ d.reason }}
                  {% elif d.status == 'error' %}
                    ‚ùå –°–∫–≤ {{ d.well_number or d.well_id }} ‚Äî {{ d.error }}
                  {% else %}
                    {{ d }}
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </details>
        </td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div style="padding:40px; text-align:center; background:#f9fafb; border-radius:8px; margin-top:16px;">
    <div style="font-size:32px; margin-bottom:12px;">üìã</div>
    <div style="font-size:15px; font-weight:600; color:#374151;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á –ø—É—Å—Ç–∞</div>
    <div style="font-size:13px; color:#6b7280; margin-top:4px;">
      –ó–∞–¥–∞—á–∏ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏—è –∞–∫—Ç–æ–≤
    </div>
  </div>
  {% endif %}
</section>

</div>
{% endblock %}
