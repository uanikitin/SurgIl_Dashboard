{% extends "base.html" %}
{% block title %}{{ doc.doc_number }} ¬∑ –ê–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏{% endblock %}

{% block content %}
<h1 style="margin:0 0 16px 0;">
  {{ doc.doc_type.name_ru }} ‚Äî {{ doc.doc_number }}
</h1>

<div class="card" style="padding:16px; margin-bottom:16px;">
  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
    <div><b>–°—Ç–∞—Ç—É—Å:</b> {{ doc.status }}</div>
    <div><b>–°–∫–≤–∞–∂–∏–Ω–∞:</b> {{ doc.well.number if doc.well else "‚Äî" }}</div>
    <div style="margin-left:auto;"><a href="/documents" class="admin-link">‚Üê –Ω–∞–∑–∞–¥</a></div>
  </div>
</div>

<div class="cards-grid" style="display:grid; gap:16px; max-width:980px;">

<section class="card" style="padding:16px;">
  <h2 style="margin:0 0 12px 0;">–ü–æ–ª—è –∞–∫—Ç–∞</h2>

  {% set m = doc.meta or {} %}

  {% if is_stage_doc and stage_status %}
  <div style="background:#fff3cd; padding:12px; border-radius:6px; margin-bottom:16px; border-left:4px solid #ffc107;">
    <div style="font-weight:600;">üìã –≠—Ç–∞–ø–Ω—ã–π –∞–∫—Ç</div>
    <div style="font-size:15px; margin-top:4px;">
      –≠—Ç–∞–ø: <b>{{ stage_status }}</b>
      {% if well_status_id %}
        <span style="opacity:0.6; font-size:12px;">(ID: {{ well_status_id }})</span>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <form method="post" action="/documents/well-handover/{{ doc.id }}/update" style="display:grid; gap:10px;">

    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border-left:3px solid #0d6efd;">
      <div style="font-weight:600; margin-bottom:8px;">üìÖ –î–∞—Ç—ã</div>

      <label><b>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–≤–µ—Ä—Ö—É –∞–∫—Ç–∞)</b></label>
      <input type="date" name="act_date"
             value="{{ m.get('act_date','') }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px; margin-bottom:12px;">
        –î–∞—Ç–∞ –≤ —à–∞–ø–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî —Å—Ç—Ä–æ–∫–∞ ¬´–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: –î–î.–ú–ú.–ì–ì–ì–ì¬ª
      </div>

      <label><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏</b></label>
      <input type="datetime-local" name="handover_dt"
             value="{{ (m.get('handover_dt','')[:16]) if m.get('handover_dt') else '' }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px; margin-bottom:12px;">
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî ¬´...–î–î.–ú–ú.–ì–ì–ì–ì –≥. –≤ –ß–ß:–ú–ú:–°–° —á–∞—Å–æ–≤ —Å–∫–≤–∞–∂–∏–Ω–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞...¬ª
      </div>

      <label><b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</b></label>
      <input type="datetime-local" name="event_dt"
             value="{{ (m.get('event_dt','')[:16]) if m.get('event_dt') else '' }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px;">
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–≤–ª–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã —Å–æ–±—ã—Ç–∏–π (–æ–±—ã—á–Ω–æ = –¥–∞—Ç–µ –ø–µ—Ä–µ–¥–∞—á–∏)
      </div>
    </div>

    <label><b>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</b></label>
    <input name="contract_number" value="{{ m.get('contract_number','') }}"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, –∫–≥—Å/—Å–º¬≤</b></label>
    <input name="tube_pressure"
           value="{{ m.get('tube_pressure','') }}"
           placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 17.12"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, –∫–≥—Å/—Å–º¬≤</b></label>
    <input name="line_pressure"
           value="{{ m.get('line_pressure','') }}"
           placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 16.60"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    {% if m.get('pressure_source') %}
    <div style="font-size:12px; opacity:0.7; background:#f0f0f0; padding:6px 10px; border-radius:4px; margin-top:-4px;">
      üìä –ò—Å—Ç–æ—á–Ω–∏–∫: {{ m.get('pressure_source') }}
    </div>
    {% endif %}

    <label><b>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤–æ–∫—Ä—É–≥ —Å–∫–≤–∞–∂–∏–Ω—ã</b></label>
    <input name="territory_state" value="{{ m.get('territory_state','') }}"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</b></label>
    <textarea name="note" rows="3"
              {% if doc.status != 'draft' %}disabled{% endif %}>{{ m.get('note','') }}</textarea>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      {% if doc.status == 'draft' %}
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      {% else %}
        <span style="opacity:.7;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Å—Ç–∞—Ç—É—Å–µ draft</span>
      {% endif %}
    </div>
  </form>

  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
    <form method="post" action="/documents/well-handover/{{ doc.id }}/generate-pdf">
      <button type="submit">{% if doc.pdf_filename %}–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF{% else %}–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF{% endif %}</button>
    </form>

    {% if doc.pdf_filename %}
      <a href="/static/{{ doc.pdf_filename }}" target="_blank" class="btn btn-secondary" style="padding:8px 16px; text-decoration:none;">
        üìÑ –û—Ç–∫—Ä—ã—Ç—å PDF
      </a>
    {% endif %}
  </div>

  {% if doc.pdf_filename %}
  <div style="margin-top:16px; border:1px solid #ddd; border-radius:8px; overflow:hidden;">
    <div style="background:#f8f9fa; padding:8px 12px; font-weight:600; display:flex; justify-content:space-between; align-items:center;">
      <span>üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä PDF</span>
      <a href="/static/{{ doc.pdf_filename }}" target="_blank" style="font-size:13px;">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ ‚Üí</a>
    </div>
    <iframe src="/static/{{ doc.pdf_filename }}" style="width:100%; height:500px; border:none;"></iframe>
  </div>
  {% endif %}

  {% if doc.status == 'draft' %}
    <form method="post" action="/documents/well-handover/{{ doc.id }}/rebuild-from-events" style="margin-top:8px;">
      <button type="submit">–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã</button>
    </form>
  {% endif %}

  <form method="post" action="/documents/{{ doc.id }}/soft-delete" style="margin-top:10px;">
    <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?');">–£–¥–∞–ª–∏—Ç—å</button>
  </form>
</section>

  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è</h2>
    <div style="display:grid; gap:8px; font-size:14px;">
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</div>
        <div><b>{{ m.get('act_date','‚Äî') }}</b></div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–î–∞—Ç–∞/–≤—Ä–µ–º—è –ø–µ—Ä–µ–¥–∞—á–∏:</div>
        <div><b>{{ m.get('handover_dt','‚Äî') }}</b></div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞:</div>
        <div><b>{{ m.get('event_dt','‚Äî') }}</b></div>
      </div>
      <div style="border-top:1px solid #e5e5e5; margin:8px 0;"></div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:</div>
        <div>
          {% if m.get('tube_pressure') is not none %}
            <b>{{ "%.2f"|format(m.get('tube_pressure')|float) }}</b> –∫–≥—Å/—Å–º¬≤
          {% else %}
            <span style="opacity:0.5;">‚Äî</span>
          {% endif %}
        </div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:</div>
        <div>
          {% if m.get('line_pressure') is not none %}
            <b>{{ "%.2f"|format(m.get('line_pressure')|float) }}</b> –∫–≥—Å/—Å–º¬≤
          {% else %}
            <span style="opacity:0.5;">‚Äî</span>
          {% endif %}
        </div>
      </div>
      {% if m.get('pressure_source') or m.get('pressure_source_type') %}
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–≤–ª–µ–Ω–∏–π:</div>
        <div style="font-size:13px;">
          {% if m.get('pressure_source_type') %}
            <span style="background:#e7f3ff; padding:2px 6px; border-radius:3px; font-size:11px; margin-right:4px;">
              {{ m.get('pressure_source_type') }}
            </span>
          {% endif %}
          {{ m.get('pressure_source', '‚Äî') }}
        </div>
      </div>
      {% endif %}
      {% if m.get('stage_status') %}
      <div style="border-top:1px solid #e5e5e5; margin:8px 0;"></div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–≠—Ç–∞–ø —Ä–∞–±–æ—Ç:</div>
        <div><b>{{ m.get('stage_status') }}</b></div>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –∫–∞–Ω–±–∞–Ω—É</h2>

    {% if doc.status == "generated" %}
      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
        <form method="post" action="/documents/well-handover/{{ doc.id }}/revert-to-draft" style="display:inline;">
          <button type="submit" class="btn-secondary">‚úèÔ∏è –í–µ—Ä–Ω—É—Ç—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫</button>
        </form>
      </div>

      <form method="post" action="/documents/{{ doc.id }}/sign" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="signer_name" placeholder="–§–ò–û –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ (–æ–ø—Ü.)" />
          <input name="signer_position" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å (–æ–ø—Ü.)" />
        </div>
        <button type="submit">–ü–æ–¥–ø–∏—Å–∞—Ç—å (SIGNED)</button>
      </form>
    {% elif doc.status == "signed" %}
      <form method="post" action="/documents/{{ doc.id }}/mark-sent" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="sent_to" placeholder="–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–æ–ø—Ü.)" />
          <input name="sent_via" placeholder="–ö–∞–Ω–∞–ª (–æ–ø—Ü.)" />
        </div>
        <button type="submit">–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º (SENT)</button>
      </form>

      <form method="post" action="/documents/{{ doc.id }}/archive" style="margin-top:8px;">
        <button type="submit">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>
    {% elif doc.status == "sent" %}
      <form method="post" action="/documents/{{ doc.id }}/archive">
        <button type="submit">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>
    {% else %}
      <div style="opacity:.75;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF.</div>
    {% endif %}
  </section>

</div>
{% endblock %}