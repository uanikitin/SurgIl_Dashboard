{% extends "base.html" %}
{% block title %}{{ doc.doc_number }} ¬∑ –ê–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏{% endblock %}

{% block content %}
<h1 style="margin:0 0 16px 0;">
  {{ doc.doc_type.name_ru }} ‚Äî {{ doc.doc_number }}
</h1>

<div class="card" style="padding:16px; margin-bottom:16px;">
  <div style="display:flex; gap:16px; flex-wrap:wrap; align-items:center;">
    <div><b>–°—Ç–∞—Ç—É—Å:</b> {{ doc.status }}</div>
    <div><b>–°–∫–≤–∞–∂–∏–Ω–∞:</b> {{ doc.well.number if doc.well else "‚Äî" }}</div>
    <div style="margin-left:auto;"><a href="/documents" class="admin-link">‚Üê –Ω–∞–∑–∞–¥</a></div>
  </div>
</div>

<div class="cards-grid" style="display:grid; gap:16px; max-width:980px;">

<section class="card" style="padding:16px;">
  <h2 style="margin:0 0 12px 0;">–ü–æ–ª—è –∞–∫—Ç–∞</h2>

  {% set m = doc.meta or {} %}

  <form method="post" action="/documents/well-handover/{{ doc.id }}/update" style="display:grid; gap:10px;">

    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border-left:3px solid #0d6efd;">
      <div style="font-weight:600; margin-bottom:8px;">üìÖ –î–∞—Ç—ã</div>

      <label><b>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–≤–µ—Ä—Ö—É –∞–∫—Ç–∞)</b></label>
      <input type="date" name="act_date"
             value="{{ m.get('act_date','') }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px; margin-bottom:12px;">
        –î–∞—Ç–∞ –≤ —à–∞–ø–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî —Å—Ç—Ä–æ–∫–∞ ¬´–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞: –î–î.–ú–ú.–ì–ì–ì–ì¬ª
      </div>

      <label><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏</b></label>
      <input type="datetime-local" name="handover_dt"
             value="{{ (m.get('handover_dt','')[:16]) if m.get('handover_dt') else '' }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px; margin-bottom:12px;">
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî ¬´...–î–î.–ú–ú.–ì–ì–ì–ì –≥. –≤ –ß–ß:–ú–ú:–°–° —á–∞—Å–æ–≤ —Å–∫–≤–∞–∂–∏–Ω–∞ –±—ã–ª–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞...¬ª
      </div>

      <label><b>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</b></label>
      <input type="datetime-local" name="event_dt"
             value="{{ (m.get('event_dt','')[:16]) if m.get('event_dt') else '' }}"
             {% if doc.status != 'draft' %}disabled{% endif %}>
      <div style="font-size:12px; opacity:0.7; margin-top:4px;">
        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –¥–∞–≤–ª–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã —Å–æ–±—ã—Ç–∏–π (–æ–±—ã—á–Ω–æ = –¥–∞—Ç–µ –ø–µ—Ä–µ–¥–∞—á–∏)
      </div>
    </div>

    <label><b>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</b></label>
    <input name="contract_number" value="{{ m.get('contract_number','') }}"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, –∫–≥—Å/—Å–º¬≤</b></label>
    <input name="tube_pressure"
           value="{{ m.get('tube_pressure','') }}"
           placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 17.12"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ, –∫–≥—Å/—Å–º¬≤</b></label>
    <input name="line_pressure"
           value="{{ m.get('line_pressure','') }}"
           placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 16.60"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤–æ–∫—Ä—É–≥ —Å–∫–≤–∞–∂–∏–Ω—ã</b></label>
    <input name="territory_state" value="{{ m.get('territory_state','') }}"
           {% if doc.status != 'draft' %}disabled{% endif %}>

    <label><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</b></label>
    <textarea name="note" rows="3"
              {% if doc.status != 'draft' %}disabled{% endif %}>{{ m.get('note','') }}</textarea>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      {% if doc.status == 'draft' %}
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
      {% else %}
        <span style="opacity:.7;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Å—Ç–∞—Ç—É—Å–µ draft</span>
      {% endif %}
    </div>
  </form>

  <form method="post" action="/documents/well-handover/{{ doc.id }}/generate-pdf" style="margin-top:12px;">
    <button type="submit">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF</button>
  </form>

  {% if doc.status == 'draft' %}
    <form method="post" action="/documents/well-handover/{{ doc.id }}/rebuild-from-events" style="margin-top:8px;">
      <button type="submit">–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –¥–∞–≤–ª–µ–Ω–∏—è –∏–∑ –±–∞–∑—ã</button>
    </form>
  {% endif %}

  <form method="post" action="/documents/{{ doc.id }}/soft-delete" style="margin-top:10px;">
    <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?');">–£–¥–∞–ª–∏—Ç—å</button>
  </form>
</section>

  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è</h2>
    <div style="display:grid; gap:8px; font-size:14px;">
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</div>
        <div><b>{{ m.get('act_date','‚Äî') }}</b></div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–î–∞—Ç–∞/–≤—Ä–µ–º—è –ø–µ—Ä–µ–¥–∞—á–∏:</div>
        <div><b>{{ m.get('handover_dt','‚Äî') }}</b></div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–∞—Ç–∞:</div>
        <div><b>{{ m.get('event_dt','‚Äî') }}</b></div>
      </div>
      <div style="border-top:1px solid #e5e5e5; margin:8px 0;"></div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–¢—Ä—É–±–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:</div>
        <div><b>{{ m.get('tube_pressure','‚Äî') }}</b> –∫–≥—Å/—Å–º¬≤</div>
      </div>
      <div style="display:grid; grid-template-columns:200px 1fr; gap:8px;">
        <div style="opacity:0.7;">–®–ª–µ–π—Ñ–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ:</div>
        <div><b>{{ m.get('line_pressure','‚Äî') }}</b> –∫–≥—Å/—Å–º¬≤</div>
      </div>
    </div>
  </section>

  <section class="card" style="padding:16px;">
    <h2 style="margin:0 0 12px 0;">–î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –∫–∞–Ω–±–∞–Ω—É</h2>

    {% if doc.status == "generated" %}
      <form method="post" action="/documents/{{ doc.id }}/sign" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="signer_name" placeholder="–§–ò–û –ø–æ–¥–ø–∏—Å–∞–Ω—Ç–∞ (–æ–ø—Ü.)" />
          <input name="signer_position" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å (–æ–ø—Ü.)" />
        </div>
        <button type="submit">–ü–æ–¥–ø–∏—Å–∞—Ç—å (SIGNED)</button>
      </form>
    {% elif doc.status == "signed" %}
      <form method="post" action="/documents/{{ doc.id }}/mark-sent" style="display:grid; gap:8px; max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <input name="sent_to" placeholder="–ö–æ–º—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (–æ–ø—Ü.)" />
          <input name="sent_via" placeholder="–ö–∞–Ω–∞–ª (–æ–ø—Ü.)" />
        </div>
        <button type="submit">–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º (SENT)</button>
      </form>

      <form method="post" action="/documents/{{ doc.id }}/archive" style="margin-top:8px;">
        <button type="submit">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>
    {% elif doc.status == "sent" %}
      <form method="post" action="/documents/{{ doc.id }}/archive">
        <button type="submit">–í –∞—Ä—Ö–∏–≤ (ARCHIVED)</button>
      </form>
    {% else %}
      <div style="opacity:.75;">–î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF.</div>
    {% endif %}
  </section>

</div>
{% endblock %}