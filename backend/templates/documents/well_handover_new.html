{% extends "base.html" %}
{% block title %}–ù–æ–≤—ã–π –∞–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏ ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}
<h1>–ù–æ–≤—ã–π –∞–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏ —Å–∫–≤–∞–∂–∏–Ω—ã</h1>

<div class="card" style="padding:16px; max-width:820px;">
  <form method="post" action="/documents/well-handover/create" style="display:grid; gap:12px;">

    <!-- –¢–ò–ü –ê–ö–¢–ê -->
    <div style="background:#e7f3ff; padding:16px; border-radius:8px; border-left:4px solid #0066cc;">
      <label style="font-weight:700; font-size:16px; margin-bottom:12px; display:block;">–¢–∏–ø –∞–∫—Ç–∞</label>

      <div style="display:grid; gap:8px;">
        <!-- –û–±—â–∏–µ –∞–∫—Ç—ã -->
        <div style="font-weight:600; opacity:0.7; font-size:13px; margin-top:4px;">–û–±—â–∏–µ –∞–∫—Ç—ã:</div>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_acceptance.id }}"
                 onchange="toggleStageFields(this)" data-is-stage="false" checked>
          <span>üì• <b>–ê–∫—Ç –ø—Ä–∏—ë–º–∞ —Å–∫–≤–∞–∂–∏–Ω—ã</b> ‚Äî —Å–∫–≤–∞–∂–∏–Ω–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ü–æ–¥—Ä—è–¥—á–∏–∫—É</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_transfer.id }}"
                 onchange="toggleStageFields(this)" data-is-stage="false">
          <span>üì§ <b>–ê–∫—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–∫–≤–∞–∂–∏–Ω—ã</b> ‚Äî —Å–∫–≤–∞–∂–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ó–∞–∫–∞–∑—á–∏–∫—É</span>
        </label>

        <!-- –≠—Ç–∞–ø–Ω—ã–µ –∞–∫—Ç—ã -->
        <div style="font-weight:600; opacity:0.7; font-size:13px; margin-top:12px;">–ê–∫—Ç—ã –ø–æ —ç—Ç–∞–ø–∞–º —Ä–∞–±–æ—Ç:</div>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_stage_accept.id }}"
                 onchange="toggleStageFields(this)" data-is-stage="true">
          <span>üì• <b>–ê–∫—Ç –ø—Ä–∏—ë–º–∞ –Ω–∞ —ç—Ç–∞–ø</b> ‚Äî –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —ç—Ç–∞–ø—É</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_stage_return.id }}"
                 onchange="toggleStageFields(this)" data-is-stage="true">
          <span>üì§ <b>–ê–∫—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞</b> ‚Äî –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ —ç—Ç–∞–ø—É</span>
        </label>
      </div>
    </div>

    <!-- –í–´–ë–û–† –≠–¢–ê–ü–ê (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–∞–ø–Ω—ã—Ö –∞–∫—Ç–æ–≤) -->
    <div id="stage-fields" style="display:none; background:#fff3cd; padding:16px; border-radius:8px; border-left:4px solid #ffc107;">
      <label style="font-weight:700; margin-bottom:8px; display:block;">üìã –≠—Ç–∞–ø —Ä–∞–±–æ—Ç</label>
      <select name="stage_status" id="stage-status" style="width:100%; padding:10px; font-size:15px;">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
        {% for status in allowed_statuses %}
        <option value="{{ status }}">{{ status }}</option>
        {% endfor %}
      </select>
      <div style="font-size:12px; opacity:0.7; margin-top:8px;">
        –≠—Ç–∞–ø –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω –≤ —Ç–µ–∫—Å—Ç–µ –∞–∫—Ç–∞
      </div>

      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è well_status_id (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏) -->
      <input type="hidden" name="well_status_id" id="well-status-id" value="">

      {% if well_statuses %}
      <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5c07b;">
        <div style="font-size:13px; font-weight:600; margin-bottom:8px;">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã:</div>
        {% for ws in well_statuses[:5] %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px; cursor:pointer; font-size:13px;">
          <input type="radio" name="history_status" value="{{ ws.id }}"
                 onchange="selectHistoryStatus('{{ ws.status }}', {{ ws.id }})">
          <span>{{ ws.status }} ({{ ws.dt_start.strftime('%d.%m.%Y') }}{% if ws.dt_end %} ‚Äî {{ ws.dt_end.strftime('%d.%m.%Y') }}{% endif %})</span>
        </label>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <label><b>–°–∫–≤–∞–∂–∏–Ω–∞</b></label>
    <select name="well_id" required onchange="reloadWithWell(this.value)">
      {% for w in wells %}
        <option value="{{ w.id }}"{% if selected_well_id == w.id %} selected{% endif %}>{{ w.number }}</option>
      {% endfor %}
    </select>

    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border-left:3px solid #0d6efd;">
      <div style="font-weight:600; margin-bottom:8px;">üìÖ –î–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
      <div style="font-size:13px; opacity:0.8; margin-bottom:12px;">
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–µ –¥–∞—Ç—ã –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–µ–∫—É—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è.
      </div>

      <label><b>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–≤–µ—Ä—Ö—É –∞–∫—Ç–∞)</b></label>
      <input type="date" name="act_date" style="margin-bottom:12px;">
      <div style="font-size:12px; opacity:0.7; margin-top:-8px; margin-bottom:12px;">
        –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏
      </div>

      <label><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏</b></label>
      <input type="datetime-local" name="handover_dt" required>
      <div style="font-size:12px; opacity:0.7; margin-top:-8px;">
        –ö–æ–≥–¥–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Å–∫–≤–∞–∂–∏–Ω—É
      </div>
    </div>

    <label><b>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</b></label>
    <input name="contract_number" value="{{ default_contract }}" />

    <label><b>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤–æ–∫—Ä—É–≥ —Å–∫–≤–∞–∂–∏–Ω—ã</b></label>
    <input name="territory_state" value="{{ default_territory }}" />

    <label><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</b></label>
    <textarea name="note" rows="3"></textarea>

    <div style="display:flex; gap:10px;">
      <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
      <a href="/documents" class="admin-link">‚Üê –Ω–∞–∑–∞–¥</a>
    </div>
  </form>
</div>

<script>
// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏–º –≤—Ä–µ–º–µ–Ω–µ–º
document.addEventListener('DOMContentLoaded', function() {
  const handoverInput = document.querySelector('input[name="handover_dt"]');
  if (handoverInput && !handoverInput.value) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    handoverInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
  }
});

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è —ç—Ç–∞–ø–∞
function toggleStageFields(radio) {
  const isStage = radio.dataset.isStage === 'true';
  const stageFields = document.getElementById('stage-fields');
  const stageSelect = document.getElementById('stage-status');

  stageFields.style.display = isStage ? 'block' : 'none';
  stageSelect.required = isStage;

  if (!isStage) {
    stageSelect.value = '';
    document.getElementById('well-status-id').value = '';
  }
}

// –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
function selectHistoryStatus(status, statusId) {
  document.getElementById('stage-status').value = status;
  document.getElementById('well-status-id').value = statusId;
}

// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–≤–∞–∂–∏–Ω—ã
function reloadWithWell(wellId) {
  const currentType = document.querySelector('input[name="doc_type_id"]:checked');
  const kind = currentType ? getKindFromTypeId(currentType.value) : '';
  window.location.href = `/documents/well-handover/new?well_id=${wellId}&kind=${kind}`;
}

function getKindFromTypeId(typeId) {
  // Simplified - just reload without kind
  return '';
}
</script>
{% endblock %}
