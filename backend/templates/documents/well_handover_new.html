{% extends "base.html" %}
{% block title %}–ù–æ–≤—ã–π –∞–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏ ¬∑ –°–£–†–ì–ò–õ{% endblock %}

{% block content %}
<h1>–ù–æ–≤—ã–π –∞–∫—Ç –ø—Ä–∏–µ–º–∞/–ø–µ—Ä–µ–¥–∞—á–∏ —Å–∫–≤–∞–∂–∏–Ω—ã</h1>

<div class="card" style="padding:16px; max-width:820px;">
  <form method="post" action="/documents/well-handover/create" style="display:grid; gap:12px;">

    <!-- –¢–ò–ü –ê–ö–¢–ê -->
    <div style="background:#e7f3ff; padding:16px; border-radius:8px; border-left:4px solid #0066cc;">
      <label style="font-weight:700; font-size:16px; margin-bottom:12px; display:block;">–¢–∏–ø –∞–∫—Ç–∞</label>

      <div style="display:grid; gap:8px;">
        <!-- –û–±—â–∏–µ –∞–∫—Ç—ã -->
        <div style="font-weight:600; opacity:0.7; font-size:13px; margin-top:4px;">–û–±—â–∏–µ –∞–∫—Ç—ã:</div>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_acceptance.id }}"
                 onchange="onDocTypeChange(this)" data-is-stage="false" data-picker="first" checked>
          <span>üì• <b>–ê–∫—Ç –ø—Ä–∏—ë–º–∞ —Å–∫–≤–∞–∂–∏–Ω—ã</b> ‚Äî —Å–∫–≤–∞–∂–∏–Ω–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ü–æ–¥—Ä—è–¥—á–∏–∫—É</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_transfer.id }}"
                 onchange="onDocTypeChange(this)" data-is-stage="false" data-picker="last">
          <span>üì§ <b>–ê–∫—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–∫–≤–∞–∂–∏–Ω—ã</b> ‚Äî —Å–∫–≤–∞–∂–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ó–∞–∫–∞–∑—á–∏–∫—É</span>
        </label>

        <!-- –≠—Ç–∞–ø–Ω—ã–µ –∞–∫—Ç—ã -->
        <div style="font-weight:600; opacity:0.7; font-size:13px; margin-top:12px;">–ê–∫—Ç—ã –ø–æ —ç—Ç–∞–ø–∞–º —Ä–∞–±–æ—Ç:</div>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_stage_accept.id }}"
                 onchange="onDocTypeChange(this)" data-is-stage="true" data-picker="stage">
          <span>üì• <b>–ê–∫—Ç –ø—Ä–∏—ë–º–∞ –Ω–∞ —ç—Ç–∞–ø</b> ‚Äî –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —ç—Ç–∞–ø—É</span>
        </label>
        <label style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:white; border-radius:6px; cursor:pointer;">
          <input type="radio" name="doc_type_id" value="{{ doc_types.well_stage_return.id }}"
                 onchange="onDocTypeChange(this)" data-is-stage="true" data-picker="last">
          <span>üì§ <b>–ê–∫—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ —ç—Ç–∞–ø–∞</b> ‚Äî –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç –ø–æ —ç—Ç–∞–ø—É</span>
        </label>
      </div>
    </div>

    <!-- –í–´–ë–û–† –≠–¢–ê–ü–ê (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–∞–ø–Ω—ã—Ö –∞–∫—Ç–æ–≤) -->
    <div id="stage-fields" style="display:none; background:#fff3cd; padding:16px; border-radius:8px; border-left:4px solid #ffc107;">
      <label style="font-weight:700; margin-bottom:8px; display:block;">üìã –≠—Ç–∞–ø —Ä–∞–±–æ—Ç</label>
      <select name="stage_status" id="stage-status" style="width:100%; padding:10px; font-size:15px;">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ç–∞–ø --</option>
        {% for status in allowed_statuses %}
        <option value="{{ status }}">{{ status }}</option>
        {% endfor %}
      </select>
      <div style="font-size:12px; opacity:0.7; margin-top:8px;">
        –≠—Ç–∞–ø –±—É–¥–µ—Ç —É–∫–∞–∑–∞–Ω –≤ —Ç–µ–∫—Å—Ç–µ –∞–∫—Ç–∞
      </div>

      <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è well_status_id (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏) -->
      <input type="hidden" name="well_status_id" id="well-status-id" value="">

      {% if well_statuses %}
      <div style="margin-top:12px; padding-top:12px; border-top:1px solid #e5c07b;">
        <div style="font-size:13px; font-weight:600; margin-bottom:8px;">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å–∫–≤–∞–∂–∏–Ω—ã:</div>
        {% for ws in well_statuses[:5] %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px; cursor:pointer; font-size:13px;">
          <input type="radio" name="history_status" value="{{ ws.id }}"
                 onchange="selectHistoryStatus('{{ ws.status }}', {{ ws.id }})">
          <span>{{ ws.status }} ({{ ws.dt_start.strftime('%d.%m.%Y') }}{% if ws.dt_end %} ‚Äî {{ ws.dt_end.strftime('%d.%m.%Y') }}{% endif %})</span>
        </label>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <label><b>–°–∫–≤–∞–∂–∏–Ω–∞</b></label>
    <select name="well_id" required onchange="reloadWithWell(this.value)">
      {% for w in wells %}
        <option value="{{ w.id }}"{% if selected_well_id == w.id %} selected{% endif %}>{{ w.number }}</option>
      {% endfor %}
    </select>

    <div style="background:#f8f9fa; padding:12px; border-radius:6px; border-left:3px solid #0d6efd;">
      <div style="font-weight:600; margin-bottom:8px;">üìÖ –î–∞—Ç—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
      <div style="font-size:13px; opacity:0.8; margin-bottom:12px;">
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ–±–µ –¥–∞—Ç—ã –∑–∞–ø–æ–ª–Ω—è—é—Ç—Å—è —Ç–µ–∫—É—â–∏–º –º–æ–º–µ–Ω—Ç–æ–º. –í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è.
      </div>

      <label><b>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–≤–≤–µ—Ä—Ö—É –∞–∫—Ç–∞)</b></label>
      <input type="date" name="act_date" style="margin-bottom:12px;">
      <div style="font-size:12px; opacity:0.7; margin-top:-8px; margin-bottom:12px;">
        –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–∞—Ç–∞ –ø–µ—Ä–µ–¥–∞—á–∏
      </div>

      <label><b>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø–µ—Ä–µ–¥–∞—á–∏</b></label>

      <!-- –ü–µ—Ä–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (–∞–∫—Ç—ã –ø—Ä–∏—ë–º–∞: well_acceptance) -->
      {% if first_events %}
      <div id="events-first" class="event-picker" style="display:none; background:#d4edda; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #28a745;">
        <div style="font-weight:600; margin-bottom:8px;">–ü–µ—Ä–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–µ:</div>
        {% for ev in first_events %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#c3e6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="{{ ev.event_time_iso }}"
                 onchange="document.getElementById('handover-dt').value=this.value">
          <span style="background:#e7f3ff; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ ev.type_label }}</span>
          <span style="white-space:nowrap;">{{ ev.event_time_display }}</span>
          {% if ev.description %}<span style="opacity:0.6; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ ev.description }}</span>{% endif %}
        </label>
        {% endfor %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px; margin-top:4px; border-top:1px solid #b8daff;"
               onmouseover="this.style.background='#c3e6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="manual"
                 onchange="document.getElementById('handover-dt').value=''; document.getElementById('handover-dt').focus();">
          <span style="opacity:0.7;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
        </label>
      </div>
      {% endif %}

      <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è (–∞–∫—Ç—ã –≤–æ–∑–≤—Ä–∞—Ç–∞/–¥–µ–º–æ–Ω—Ç–∞–∂–∞: well_transfer, well_stage_return) -->
      {% if last_events %}
      <div id="events-last" class="event-picker" style="display:none; background:#fde8e8; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #dc3545;">
        <div style="font-weight:600; margin-bottom:8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–µ:</div>
        {% for ev in last_events %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#f5c6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="{{ ev.event_time_iso }}"
                 onchange="document.getElementById('handover-dt').value=this.value">
          <span style="background:#ffeeba; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ ev.type_label }}</span>
          <span style="white-space:nowrap;">{{ ev.event_time_display }}</span>
          {% if ev.description %}<span style="opacity:0.6; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">{{ ev.description }}</span>{% endif %}
        </label>
        {% endfor %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px; margin-top:4px; border-top:1px solid #f5c6cb;"
               onmouseover="this.style.background='#f5c6cb'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="manual"
                 onchange="document.getElementById('handover-dt').value=''; document.getElementById('handover-dt').focus();">
          <span style="opacity:0.7;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
        </label>
      </div>
      {% endif %}

      <!-- –î–∞—Ç—ã –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ (—ç—Ç–∞–ø–Ω—ã–π –∞–∫—Ç –ø—Ä–∏—ë–º–∞: well_stage_accept) -->
      {% if stage_dates %}
      <div id="events-stage" class="event-picker" style="display:none; background:#fff3cd; padding:12px; border-radius:6px; margin-bottom:8px; font-size:13px; border-left:3px solid #ffc107;">
        <div style="font-weight:600; margin-bottom:8px;">–î–∞—Ç—ã –ø—Ä–∏—ë–º–∞ –Ω–∞ —ç—Ç–∞–ø (–∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤):</div>
        {% for sd in stage_dates %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px;"
               onmouseover="this.style.background='#ffeeba'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="{{ sd.dt_start_iso }}"
                 onchange="document.getElementById('handover-dt').value=this.value">
          <span style="background:#d4edda; padding:2px 8px; border-radius:4px; font-size:11px; font-weight:600; white-space:nowrap;">{{ sd.status }}</span>
          <span style="white-space:nowrap;">{{ sd.dt_start_display }}</span>
          {% if sd.dt_end_iso %}
            <span style="opacity:0.6; font-size:12px;">‚Üí {{ sd.dt_end_display }}</span>
          {% endif %}
        </label>
        {% endfor %}
        <label style="display:flex; align-items:center; gap:8px; padding:6px 8px; cursor:pointer; border-radius:4px; margin-top:4px; border-top:1px solid #ffeeba;"
               onmouseover="this.style.background='#ffeeba'" onmouseout="this.style.background='transparent'">
          <input type="radio" name="event_pick" value="manual"
                 onchange="document.getElementById('handover-dt').value=''; document.getElementById('handover-dt').focus();">
          <span style="opacity:0.7;">–í–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é</span>
        </label>
      </div>
      {% endif %}

      <input type="datetime-local" name="handover_dt" id="handover-dt" required>
      <div style="font-size:12px; opacity:0.7; margin-top:-8px;">
        –ö–æ–≥–¥–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Å–∫–≤–∞–∂–∏–Ω—É
      </div>
    </div>

    <label><b>–ù–æ–º–µ—Ä –¥–æ–≥–æ–≤–æ—Ä–∞</b></label>
    <input name="contract_number" value="{{ default_contract }}" />

    <label><b>–¢–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è –≤–æ–∫—Ä—É–≥ —Å–∫–≤–∞–∂–∏–Ω—ã</b></label>
    <input name="territory_state" value="{{ default_territory }}" />

    <label><b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</b></label>
    <textarea name="note" rows="3"></textarea>

    <div style="display:flex; gap:10px;">
      <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
      <a href="/documents" class="admin-link">‚Üê –Ω–∞–∑–∞–¥</a>
    </div>
  </form>
</div>

<script>
// === –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–ª–æ–∫–∞ —Å–æ–±—ã—Ç–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–∫—Ç–∞ ===
function showPicker(pickerName) {
  // –°–∫—Ä—ã—Ç—å –≤—Å–µ –±–ª–æ–∫–∏
  document.querySelectorAll('.event-picker').forEach(el => el.style.display = 'none');
  // –°–±—Ä–æ—Å–∏—Ç—å radio
  document.querySelectorAll('input[name="event_pick"]').forEach(r => r.checked = false);

  const map = { first: 'events-first', last: 'events-last', stage: 'events-stage' };
  const block = document.getElementById(map[pickerName]);
  if (block) {
    block.style.display = 'block';
    // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ radio –≤ –±–ª–æ–∫–µ
    const first = block.querySelector('input[name="event_pick"]');
    if (first && first.value !== 'manual') {
      first.checked = true;
      document.getElementById('handover-dt').value = first.value;
      return;
    }
  }
  // Fallback ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
  setNow();
}

function setNow() {
  const inp = document.getElementById('handover-dt');
  const now = new Date();
  const pad = (n) => String(n).padStart(2, '0');
  inp.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
}

// === –ï–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–º–µ–Ω—ã —Ç–∏–ø–∞ –∞–∫—Ç–∞ ===
function onDocTypeChange(radio) {
  // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–æ–ª—è —ç—Ç–∞–ø–∞
  const isStage = radio.dataset.isStage === 'true';
  const stageFields = document.getElementById('stage-fields');
  const stageSelect = document.getElementById('stage-status');
  stageFields.style.display = isStage ? 'block' : 'none';
  stageSelect.required = isStage;
  if (!isStage) {
    stageSelect.value = '';
    document.getElementById('well-status-id').value = '';
  }
  // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –±–ª–æ–∫ —Å–æ–±—ã—Ç–∏–π
  showPicker(radio.dataset.picker);
}

// === –í—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ ===
function selectHistoryStatus(status, statusId) {
  document.getElementById('stage-status').value = status;
  document.getElementById('well-status-id').value = statusId;
}

// === –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–≤–∞–∂–∏–Ω—ã ===
function reloadWithWell(wellId) {
  window.location.href = `/documents/well-handover/new?well_id=${wellId}`;
}

// === Init ===
document.addEventListener('DOMContentLoaded', function() {
  const checked = document.querySelector('input[name="doc_type_id"]:checked');
  if (checked) {
    showPicker(checked.dataset.picker);
  } else {
    setNow();
  }
});
</script>
{% endblock %}
