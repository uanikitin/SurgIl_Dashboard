{% extends "base.html" %}

{% block title %}–°–£–†–ì–ò–õ ¬∑ {{ equipment.name }}{% endblock %}

{% block extra_head %}
<style>
.equipment-detail { padding: 20px; max-width: 1200px; margin: 0 auto; }
.breadcrumb { display: flex; gap: 8px; margin-bottom: 20px; font-size: 14px; color: #6c757d; }
.breadcrumb a { color: #007bff; text-decoration: none; }
.header { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px; }
.header h1 { margin: 0 0 10px 0; font-size: 28px; }
.header-actions { display: flex; gap: 10px; margin-top: 20px; }
.btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; text-decoration: none; display: inline-block; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.current-status { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
.status-item { display: flex; flex-direction: column; gap: 4px; }
.status-item__label { font-size: 12px; color: #6c757d; text-transform: uppercase; }
.status-item__value { font-size: 16px; font-weight: 600; }
.section { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px; }
.section h2 { font-size: 20px; margin: 0 0 20px 0; padding-bottom: 15px; border-bottom: 2px solid #f1f3f5; }
.timeline { position: relative; padding-left: 30px; }
.timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: #dee2e6; }
.timeline-item { position: relative; margin-bottom: 25px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff; }
.timeline-item--active { border-left-color: #28a745; background: #d4edda; }
.timeline-item::before { content: ''; position: absolute; left: -26px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: white; border: 3px solid #007bff; }
.timeline-item--active::before { border-color: #28a745; background: #28a745; }
.timeline-item h3 { margin: 0 0 8px 0; font-size: 16px; }
.timeline-item__date { font-size: 13px; color: #6c757d; margin-bottom: 8px; }
.timeline-item__meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); font-size: 13px; }
.empty { text-align: center; padding: 40px; color: #6c757d; }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; }
.stat { text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px; }
.stat__value { font-size: 32px; font-weight: 700; color: #007bff; }
.stat__label { font-size: 12px; color: #6c757d; text-transform: uppercase; }
</style>
{% endblock %}

{% block content %}
<div class="equipment-detail">
    
    <div class="breadcrumb">
        <a href="/visual">üìä –î–∞—à–±–æ—Ä–¥</a> ‚Ä∫ 
        <a href="/equipment">üîß –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</a> ‚Ä∫ 
        <span>{{ equipment.name }}</span>
    </div>

    <div class="header">
        <h1>{{ equipment.name }}</h1>
        <div>–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ: <strong>{{ equipment.serial_number or '‚Äî' }}</strong></div>
        
        <div class="current-status">
            <div class="status-item">
                <div class="status-item__label">–°—Ç–∞—Ç—É—Å</div>
                <div class="status-item__value">
                    {% if equipment.status == 'installed' %}üü¢ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                    {% elif equipment.status == 'available' %}üì¶ –ù–∞ —Å–∫–ª–∞–¥—ñ
                    {% else %}{{ equipment.status }}{% endif %}
                </div>
            </div>
            <div class="status-item">
                <div class="status-item__label">–°—Ç–∞–Ω</div>
                <div class="status-item__value">
                    {% if equipment.condition == 'working' %}‚úÖ –†–æ–±–æ—á–µ
                    {% elif equipment.condition == 'broken' %}‚ùå –ù–µ —Ä–æ–±–æ—á–µ
                    {% else %}{{ equipment.condition }}{% endif %}
                </div>
            </div>
            <div class="status-item">
                <div class="status-item__label">–õ–æ–∫–∞—Ü—ñ—è</div>
                <div class="status-item__value">{{ equipment.current_location or '‚Äî' }}</div>
            </div>
            {% if current_installation %}
            <div class="status-item">
                <div class="status-item__label">–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</div>
                <div class="status-item__value">
                    {{ current_installation.installed_at.strftime('%d.%m.%Y') }}
                    <br><small>({{ current_installation.duration_days }} –¥–Ω—ñ–≤)</small>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="header-actions">
            {% if equipment.status == 'available' %}
            <a href="/documents/equipment/new?equipment_id={{ equipment.id }}&kind=install" class="btn btn-success">
                ‚ÜóÔ∏è –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ (–∑ –∞–∫—Ç–æ–º)
            </a>
            {% elif equipment.status == 'installed' and current_installation %}
            <a href="/documents/equipment/new?equipment_id={{ equipment.id }}&well_id={{ current_installation.well_id }}&kind=removal" class="btn btn-danger">
                ‚ÜôÔ∏è –î–µ–º–æ–Ω—Ç—É–≤–∞—Ç–∏ (–∑ –∞–∫—Ç–æ–º)
            </a>
            {% endif %}
            <button class="btn btn-warning" onclick="showMaintenanceModal()">
                üîß –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è
            </button>
            <button class="btn" style="background: #17a2b8; color: white;" onclick="showStatusModal()">
                ‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
            </button>
            <button class="btn" style="background: #6c757d; color: white;" onclick="showMoveModal()">
                üì¶ –ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –±–µ–∑ –∞–∫—Ç—É
            </button>
            <button class="btn" style="background: #dc3545; color: white;" onclick="if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è?')) deleteEquipment()">
                üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏
            </button>
        </div>
    </div>

    <div class="section">
        <h2>üìä –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å</h2>
        {% if installation_history %}
        <div class="timeline">
            {% for inst in installation_history %}
            <div class="timeline-item {% if inst.is_active %}timeline-item--active{% endif %}">
                <h3>
                    {% if inst.is_active %}üü¢{% else %}‚ö™{% endif %}
                    –°–≤–µ—Ä–¥–ª–æ–≤–∏–Ω–∞ {{ inst.well_number }}
                    {% if inst.is_active %}<span style="color: #28a745;">(–∑–∞—Ä–∞–∑)</span>{% endif %}
                </h3>
                <div class="timeline-item__date">
                    {{ inst.installed_at.strftime('%d.%m.%Y %H:%M') }}
                    {% if inst.removed_at %}‚Üí {{ inst.removed_at.strftime('%d.%m.%Y %H:%M') }}{% else %}‚Üí –∑–∞—Ä–∞–∑{% endif %}
                    | ‚è± {{ inst.duration_days }} –¥–Ω—ñ–≤
                </div>
                <div class="timeline-item__meta">
                    <div>–í—Å—Ç–∞–Ω–æ–≤–∏–≤: <strong>{{ inst.installed_by or '‚Äî' }}</strong></div>
                    {% if inst.installation_location %}<div>–ú—ñ—Å—Ü–µ: <strong>{{ inst.installation_location }}</strong></div>{% endif %}
                    {% if inst.removed_by %}<div>–ó–Ω—è–≤: <strong>{{ inst.removed_by }}</strong></div>{% endif %}
                </div>
                {% if inst.has_document %}
                <div style="margin-top: 10px;">
                    üìÑ <a href="/documents/{{ inst.document_id }}" target="_blank">–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∞–∫—Ç</a>
                </div>
                {% elif not inst.no_document_confirmed %}
                <div style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 13px;">
                    ‚ö†Ô∏è <strong>–ë–ï–ó –ê–ö–¢–£</strong> ‚Äî –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞.
                    {% if inst.is_active %}
                    <a href="/documents/equipment/new?equipment_id={{ equipment.id }}&well_id={{ inst.well_id }}&kind=install">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è</a>
                    {% else %}
                    <a href="/documents/equipment/new?equipment_id={{ equipment.id }}&well_id={{ inst.well_id }}&kind=removal">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫—Ç –¥–µ–º–æ–Ω—Ç–∞–∂—É</a>
                    {% endif %}
                </div>
                {% endif %}
                {% if inst.notes %}
                <div style="margin-top: 10px; font-size: 13px; color: #6c757d;">
                    –ü—Ä–∏–º—ñ—Ç–∫–∞: {{ inst.notes }}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty">üìã –Ü—Å—Ç–æ—Ä—ñ—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å –≤—ñ–¥—Å—É—Ç–Ω—è</div>
        {% endif %}
    </div>

    <div class="section">
        <h2>üîß –Ü—Å—Ç–æ—Ä—ñ—è –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è</h2>
        {% if maintenance_history %}
        <div style="display: grid; gap: 15px;">
            {% for maint in maintenance_history %}
            <div style="padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <strong>{{ maint.maintenance_type }}</strong>
                    <span style="font-size: 13px; color: #6c757d;">{{ maint.maintenance_date.strftime('%d.%m.%Y') }}</span>
                </div>
                <div style="margin-bottom: 8px;">{{ maint.description }}</div>
                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #6c757d;">
                    <div>–í–∏–∫–æ–Ω–∞–≤: {{ maint.performed_by }}</div>
                    {% if maint.cost %}<div style="font-weight: 600; color: #28a745;">{{ "{:,.2f}".format(maint.cost) }} –≥—Ä–Ω</div>{% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty">üîß –ó–∞–ø–∏—Å—ñ–≤ –ø—Ä–æ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è –Ω–µ–º–∞—î</div>
        {% endif %}
    </div>

    <div class="section">
        <h2>üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
        <div class="stats">
            <div class="stat">
                <div class="stat__value">{{ stats.total_installations }}</div>
                <div class="stat__label">–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—å</div>
            </div>
            <div class="stat">
                <div class="stat__value">{{ stats.total_days }}</div>
                <div class="stat__label">–î–Ω—ñ–≤ –Ω–∞ —Å–≤–µ—Ä–¥–ª–æ–≤–∏–Ω–∞—Ö</div>
            </div>
            <div class="stat">
                <div class="stat__value">{{ "{:,.0f}".format(stats.total_maintenance_cost) }}</div>
                <div class="stat__label">–í–∞—Ä—Ç—ñ—Å—Ç—å –¢–û (–≥—Ä–Ω)</div>
            </div>
            <div class="stat">
                <div class="stat__value">{{ stats.avg_days_per_installation }}</div>
                <div class="stat__label">–°–µ—Ä–µ–¥–Ω—è —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å</div>
            </div>
        </div>
    </div>

</div>

<!-- –ú–û–î–ê–õ–¨–ù–Ü –í–Ü–ö–ù–ê -->

<!-- –ó–º—ñ–Ω–∞ —Å—Ç–∞—Ç—É—Å—É/—Å—Ç–∞–Ω—É -->
<div id="status-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin: 0 0 20px 0;">‚öôÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</h2>
        <form id="status-form" onsubmit="submitStatus(event)">

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ù–æ–≤–∏–π —Å—Ç–∞—Ç—É—Å *</label>
                <select name="new_status" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Å—Ç–∞—Ç—É—Å...</option>
                    <option value="available">üì¶ –ù–∞ —Å–∫–ª–∞–¥—ñ</option>
                    <option value="installed">üü¢ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</option>
                    <option value="maintenance">üîß –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è/–†–µ–º–æ–Ω—Ç</option>
                    <option value="broken">‚ùå –ó–ª–∞–º–∞–Ω–æ</option>
                    <option value="lost">üîç –í—Ç—Ä–∞—á–µ–Ω–æ</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–°—Ç–∞–Ω –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</label>
                <select name="new_condition" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–ù–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏</option>
                    <option value="working">‚úÖ –†–æ–±–æ—á–µ</option>
                    <option value="broken">‚ùå –ù–µ —Ä–æ–±–æ—á–µ</option>
                    <option value="needs_repair">‚ö†Ô∏è –ü–æ—Ç—Ä–µ–±—É—î —Ä–µ–º–æ–Ω—Ç—É</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ö—É–¥–∏ –ø–µ—Ä–µ–º—ñ—â—É—î—Ç—å—Å—è</label>
                <select name="new_location" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;" onchange="if(this.value==='custom') this.nextElementSibling.style.display='block'; else this.nextElementSibling.style.display='none';">
                    <option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ (–∑–∞ —Å—Ç–∞—Ç—É—Å–æ–º)</option>
                    <option value="–°–∫–ª–∞–¥">üì¶ –°–∫–ª–∞–¥</option>
                    <option value="–ú–∞–π—Å—Ç–µ—Ä–Ω—è">üîß –ú–∞–π—Å—Ç–µ—Ä–Ω—è (—Ä–µ–º–æ–Ω—Ç)</option>
                    <option value="–ö–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è">‚ùÑÔ∏è –ö–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è</option>
                    <option value="–°–ø–∏—Å–∞–Ω–æ">üóëÔ∏è –°–ø–∏—Å–∞–Ω–æ</option>
                    <option value="custom">‚úèÔ∏è –Ü–Ω—à–µ (–≤–∫–∞–∑–∞—Ç–∏)</option>
                </select>
                <input type="text" id="custom-location" placeholder="–í–∫–∞–∂—ñ—Ç—å –ª–æ–∫–∞—Ü—ñ—é..." style="display: none; width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; margin-top: 10px;">
            </div>

            <div style="padding: 15px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 6px; margin: 20px 0; font-size: 14px;">
                <strong>‚ÑπÔ∏è –ü—ñ–¥–∫–∞–∑–∫–∞:</strong><br>
                ‚Ä¢ <strong>–ù–∞ —Å–∫–ª–∞–¥—ñ</strong> ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ "–°–∫–ª–∞–¥"<br>
                ‚Ä¢ <strong>–û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è/–†–µ–º–æ–Ω—Ç</strong> ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ "–ú–∞–π—Å—Ç–µ—Ä–Ω—è"<br>
                ‚Ä¢ <strong>–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ</strong> ‚Üí –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∞ –ª–æ–∫–∞—Ü—ñ—è<br>
                ‚Ä¢ –Ø–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞ —Å–≤–µ—Ä–¥–ª–æ–≤–∏–Ω—ñ - –≤–æ–Ω–∞ –±—É–¥–µ –∑–∞–∫—Ä–∏—Ç–∞
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
                <textarea name="notes" rows="2" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞—Ç—É—Å—É..." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeStatusModal()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; font-weight: 600; cursor: pointer;">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: #007bff; color: white; font-weight: 600; cursor: pointer;">
                    –ó–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showStatusModal() {
    document.getElementById('status-modal').style.display = 'flex';
}

function closeStatusModal() {
    document.getElementById('status-modal').style.display = 'none';
}

async function submitStatus(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω–æ "custom" - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ç–µ–∫—Å—Ç –∑ input
    const locationSelect = form.querySelector('[name="new_location"]');
    if (locationSelect.value === 'custom') {
        const customLocation = document.getElementById('custom-location').value;
        formData.set('new_location', customLocation);
    }

    try {
        const response = await fetch('/api/equipment/{{ equipment.id }}/update_status', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            window.location.reload();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
}

document.getElementById('status-modal').addEventListener('click', function(e) {
    if (e.target === this) closeStatusModal();
});
</script>

<!-- –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–µ–∑ –∞–∫—Ç—É -->
<div id="move-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin: 0 0 20px 0;">üì¶ –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–µ–∑ –∞–∫—Ç—É</h2>
        <form id="move-form" onsubmit="submitMove(event)">
            <input type="hidden" name="action" id="move-action">

            <div id="install-fields" style="display:none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–°–≤–µ—Ä–¥–ª–æ–≤–∏–Ω–∞ *</label>
                <select name="well_id" id="well-id-select" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Å–≤–µ—Ä–¥–ª–æ–≤–∏–Ω—É...</option>
                    {% for well in wells_list %}
                    <option value="{{ well.id }}">{{ well.number }}</option>
                    {% endfor %}
                </select>

                <label style="display: block; margin: 15px 0 6px 0; font-weight: 600;">–ú—ñ—Å—Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è *</label>
                <select name="installation_location" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ...</option>
                    <option value="–£—Å—Ç—å–µ">üîß –£—Å—Ç—å–µ (—É—Å—Ç—å–µ–≤–æ–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è)</option>
                    <option value="–ù–ö–¢">üìè –ù–ö–¢ (–Ω–∞—Å–æ—Å–Ω–æ-–∫–æ–º–ø—Ä–µ—Å–æ—Ä–Ω—ñ —Ç—Ä—É–±–∏)</option>
                    <option value="–®–ª–µ–π—Ñ">üõ§Ô∏è –®–ª–µ–π—Ñ (—Ç—Ä—É–±–æ–ø—Ä–æ–≤—ñ–¥)</option>
                    <option value="–ó–∞—Ç—Ä—É–±">üî© –ó–∞—Ç—Ä—É–± (–∑–∞—Ç—Ä—É–±–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä)</option>
                    <option value="–Ü–Ω—à–µ">üì¶ –Ü–Ω—à–µ</option>
                </select>
            </div>

            <div id="remove-fields" style="display:none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ö—É–¥–∏ –ø–µ—Ä–µ–º—ñ—â—É—î—Ç—å—Å—è</label>
                <input type="text" name="location" value="–°–∫–ª–∞–¥" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–°—Ç–∞–Ω –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è</label>
                <select name="condition" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="working">–†–æ–±–æ—á–µ</option>
                    <option value="broken">–ù–µ —Ä–æ–±–æ—á–µ</option>
                    <option value="needs_repair">–ü–æ—Ç—Ä–µ–±—É—î —Ä–µ–º–æ–Ω—Ç—É</option>
                </select>
            </div>

            <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 6px; margin: 20px 0;">
                <strong style="color: #856404;">‚ö†Ô∏è –£–í–ê–ì–ê</strong><br>
                <span style="font-size: 14px; color: #856404;">–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–µ–∑ –∞–∫—Ç—É –º–∞—î –±—É—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.</span>
            </div>

            <div style="display: flex; align-items: start; gap: 10px; padding: 12px; background: #f8f9fa; border-radius: 6px; margin: 15px 0;">
                <input type="checkbox" name="no_document_confirmed" id="no-doc-checkbox" required style="width: 18px; height: 18px; margin-top: 2px;">
                <label for="no-doc-checkbox" style="margin: 0; font-size: 14px;">
                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—é –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –±–µ–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∞–∫—Ç—É (—Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤)
                </label>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ü—Ä–∏–º—ñ—Ç–∫–∞</label>
                <textarea name="notes" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeMoveModal()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; font-weight: 600; cursor: pointer;">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: #007bff; color: white; font-weight: 600; cursor: pointer;">
                    –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏
                </button>
            </div>
        </form>
    </div>
</div>

<!-- –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è/–†–µ–º–æ–Ω—Ç -->
<div id="maintenance-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%;">
        <h2 style="margin: 0 0 20px 0;">üîß –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è/–†–µ–º–æ–Ω—Ç</h2>
        <form id="maintenance-form" onsubmit="submitMaintenance(event)">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–¢–∏–ø *</label>
                <select name="maintenance_type" required style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø...</option>
                    <option value="–†–µ–º–æ–Ω—Ç">–†–µ–º–æ–Ω—Ç</option>
                    <option value="–¢–û">–¢–µ—Ö–Ω—ñ—á–Ω–µ –æ–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è (–¢–û)</option>
                    <option value="–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è">–ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è</option>
                    <option value="–ö–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è">–ö–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è</option>
                    <option value="–†–æ–∑–∫–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è">–†–æ–∑–∫–æ–Ω—Å–µ—Ä–≤–∞—Ü—ñ—è</option>
                    <option value="–ó–∞–º—ñ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π">–ó–∞–º—ñ–Ω–∞ –¥–µ—Ç–∞–ª–µ–π</option>
                    <option value="–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞">–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–û–ø–∏—Å *</label>
                <textarea name="description" required rows="4" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;" placeholder="–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –≤–∏–∫–æ–Ω–∞–Ω–∏—Ö —Ä–æ–±—ñ—Ç..."></textarea>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–î–∞—Ç–∞</label>
                <input type="datetime-local" name="maintenance_date" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</label>
                <input type="text" name="performed_by" placeholder="–Ü–º'—è –≤–∏–∫–æ–Ω–∞–≤—Ü—è" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 6px; font-weight: 600;">–í–∞—Ä—Ç—ñ—Å—Ç—å (–≥—Ä–Ω)</label>
                <input type="number" name="cost" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="closeMaintenanceModal()" style="padding: 10px 20px; border: none; border-radius: 8px; background: #6c757d; color: white; font-weight: 600; cursor: pointer;">
                    –°–∫–∞—Å—É–≤–∞—Ç–∏
                </button>
                <button type="submit" style="padding: 10px 20px; border: none; border-radius: 8px; background: #28a745; color: white; font-weight: 600; cursor: pointer;">
                    –ó–±–µ—Ä–µ–≥—Ç–∏
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è
function showMoveModal() {
    const status = '{{ equipment.status }}';
    const modal = document.getElementById('move-modal');
    const actionInput = document.getElementById('move-action');
    const installFields = document.getElementById('install-fields');
    const removeFields = document.getElementById('remove-fields');

    if (status === 'available') {
        actionInput.value = 'install';
        installFields.style.display = 'block';
        removeFields.style.display = 'none';
    } else {
        actionInput.value = 'remove';
        installFields.style.display = 'none';
        removeFields.style.display = 'block';
    }

    modal.style.display = 'flex';
}

function closeMoveModal() {
    document.getElementById('move-modal').style.display = 'none';
}

async function submitMove(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    // –í–ê–õ–Ü–î–ê–¶–Ü–Ø: —è–∫—â–æ –¥—ñ—è = install, well_id –æ–±–æ–≤'—è–∑–∫–æ–≤–∏–π
    const action = formData.get('action');
    const wellId = formData.get('well_id');
    const installLocation = formData.get('installation_location');

    if (action === 'install') {
        if (!wellId || wellId === '') {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å —Å–≤–µ—Ä–¥–ª–æ–≤–∏–Ω—É!');
            return;
        }
        if (!installLocation || installLocation === '') {
            alert('–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è!');
            return;
        }
    }

    try {
        const response = await fetch('/api/equipment/{{ equipment.id }}/move', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            window.location.reload();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.detail || JSON.stringify(result)));
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
}

// –û–±—Å–ª—É–≥–æ–≤—É–≤–∞–Ω–Ω—è
function showMaintenanceModal() {
    document.getElementById('maintenance-modal').style.display = 'flex';
}

function closeMaintenanceModal() {
    document.getElementById('maintenance-modal').style.display = 'none';
}

async function submitMaintenance(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    try {
        const response = await fetch('/api/equipment/{{ equipment.id }}/add_maintenance', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            window.location.reload();
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
}

// –í–∏–¥–∞–ª–µ–Ω–Ω—è
async function deleteEquipment() {
    try {
        const response = await fetch('/api/equipment/{{ equipment.id }}', {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            window.location.href = '/equipment';
        } else {
            alert('–ü–æ–º–∏–ª–∫–∞: ' + (result.detail || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
        }
    } catch (error) {
        alert('–ü–æ–º–∏–ª–∫–∞: ' + error.message);
    }
}

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –ø–æ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º–∏
document.getElementById('move-modal').addEventListener('click', function(e) {
    if (e.target === this) closeMoveModal();
});
document.getElementById('maintenance-modal').addEventListener('click', function(e) {
    if (e.target === this) closeMaintenanceModal();
});
</script>
{% endblock %}