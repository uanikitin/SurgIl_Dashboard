{% extends "base.html" %}

{% block title %}–°–£–†–ì–ò–õ ¬∑ –Ü–º–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è{% endblock %}

{% block extra_head %}

<style>
.import-page { padding: 20px; max-width: 1200px; margin: 0 auto; }
.breadcrumb { display: flex; gap: 8px; margin-bottom: 20px; font-size: 14px; color: #6c757d; }
.breadcrumb a { color: #007bff; text-decoration: none; }
.card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px; }
.card h2 { margin: 0 0 20px 0; font-size: 24px; }

/* Upload area */
.upload-area {
    border: 3px dashed #007bff;
    border-radius: 12px;
    padding: 60px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8f9fa;
}
.upload-area:hover { background: #e7f3ff; border-color: #0056b3; }
.upload-area.dragging { background: #cfe2ff; border-color: #0056b3; transform: scale(1.02); }
.upload-icon { font-size: 64px; margin-bottom: 20px; }
.upload-text { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
.upload-hint { font-size: 14px; color: #6c757d; }

/* Preview table */
.preview-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
.preview-table th {
    background: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
}
.preview-table td { padding: 10px 8px; border-bottom: 1px solid #dee2e6; }
.preview-table tr.valid { background: #d4edda; }
.preview-table tr.invalid { background: #f8d7da; }
.preview-table tr:hover { background: #f8f9fa; }
.error-badge { background: #dc3545; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; }
.warning-badge { background: #ffc107; color: #212529; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; }
.success-badge { background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; }

/* Stats */
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 20px 0; }
.stat-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border-left: 4px solid #007bff;
}
.stat-card.valid { border-color: #28a745; }
.stat-card.invalid { border-color: #dc3545; }
.stat-card.duplicate { border-color: #ffc107; }
.stat-value { font-size: 36px; font-weight: bold; margin-bottom: 8px; }
.stat-label { font-size: 14px; color: #6c757d; text-transform: uppercase; }

/* Buttons */
.btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.3s; }
.btn-primary { background: #007bff; color: white; }
.btn-primary:hover { background: #0056b3; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-secondary { background: #6c757d; color: white; }
.btn-secondary:hover { background: #5a6268; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }

.hidden { display: none; }
.table-wrapper { max-height: 500px; overflow-y: auto; }

.file-input-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    opacity: 0;
    pointer-events: none;
}
</style>
{% endblock %}

{% block content %}
<div class="import-page">

    <div class="breadcrumb">
        <a href="/visual">üìä –î–∞—à–±–æ—Ä–¥</a> ‚Ä∫
        <a href="/equipment">üîß –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è</a> ‚Ä∫
        <span>–Ü–º–ø–æ—Ä—Ç –∑ Excel</span>
    </div>

    <div class="card">
        <h2>üìä –Ü–º–ø–æ—Ä—Ç –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –∑ Excel</h2>

        <!-- –ö—Ä–æ–∫ 1: –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ–∞–π–ª—É -->
        <div id="step-upload">
            <p style="margin-bottom: 20px;">
                <strong>üì• –ö—Ä–æ–∫ 1:</strong> –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–π Excel —Ñ–∞–π–ª –∑ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è–º
            </p>

            <div style="margin-bottom: 20px;">
                <a href="/api/equipment/template" download class="btn btn-primary">
                    üìÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —à–∞–±–ª–æ–Ω Excel
                </a>
                <span style="margin-left: 10px; color: #6c757d;">
                    (–°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Ç–∞ –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —à–∞–±–ª–æ–Ω)
                </span>
            </div>

            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å Excel —Ñ–∞–π–ª —Å—é–¥–∏</div>
                <div class="upload-hint">–∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É</div>
                <div class="upload-hint" style="margin-top: 10px;">–ü—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è: .xlsx, .xls</div>
                <input type="file" id="file-input" accept=".xlsx,.xls" class="file-input-hidden">
            </div>

            <div id="file-info" class="hidden" style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                <strong>üìÑ –§–∞–π–ª:</strong> <span id="file-name"></span> (<span id="file-size"></span>)
                <button onclick="clearFile()" style="margin-left: 20px; padding: 4px 12px; border: none; background: #dc3545; color: white; border-radius: 4px; cursor: pointer;">
                    –û—á–∏—Å—Ç–∏—Ç–∏
                </button>
            </div>

            <div style="margin-top: 20px;">
                <button id="preview-btn" class="btn btn-primary" onclick="previewData()" disabled>
                    üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–∞–Ω—ñ
                </button>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 2: –ü–µ—Ä–µ–≥–ª—è–¥ -->
        <div id="step-preview" class="hidden">
            <p style="margin-bottom: 20px;">
                <strong>üëÅÔ∏è –ö—Ä–æ–∫ 2:</strong> –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –¥–∞–Ω—ñ —Ç–∞ –≤–∏–ø—Ä–∞–≤—Ç–µ –ø–æ–º–∏–ª–∫–∏
            </p>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">–í—Å—å–æ–≥–æ —Ä—è–¥–∫—ñ–≤</div>
                </div>
                <div class="stat-card valid">
                    <div class="stat-value" id="stat-valid">0</div>
                    <div class="stat-label">–ö–æ—Ä–µ–∫—Ç–Ω–∏—Ö</div>
                </div>
                <div class="stat-card invalid">
                    <div class="stat-value" id="stat-invalid">0</div>
                    <div class="stat-label">–ó –ø–æ–º–∏–ª–∫–∞–º–∏</div>
                </div>
                <div class="stat-card duplicate">
                    <div class="stat-value" id="stat-duplicates">0</div>
                    <div class="stat-label">–î—É–±–ª—ñ–∫–∞—Ç–∏</div>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="preview-table" id="preview-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–ù–∞–∑–≤–∞</th>
                            <th>–¢–∏–ø</th>
                            <th>–°–µ—Ä—ñ–π–Ω–∏–π ‚Ññ</th>
                            <th>–í–∏—Ä–æ–±–Ω–∏–∫</th>
                            <th>–î–∞—Ç–∞</th>
                            <th>–°—Ç–∞–Ω</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody id="preview-body"></tbody>
                </table>
            </div>

            <div style="margin-top: 30px; display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="backToUpload()">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
                <button id="import-btn" class="btn btn-success" onclick="executeImport()">
                    ‚úÖ –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ (<span id="import-count">0</span> —à—Ç)
                </button>
            </div>
        </div>

        <!-- –ö—Ä–æ–∫ 3: –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ -->
        <div id="step-results" class="hidden">
            <p style="margin-bottom: 20px;">
                <strong>‚úÖ –ö—Ä–æ–∫ 3:</strong> –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —ñ–º–ø–æ—Ä—Ç—É
            </p>

            <div class="stats">
                <div class="stat-card valid">
                    <div class="stat-value" id="result-success">0</div>
                    <div class="stat-label">–£—Å–ø—ñ—à–Ω–æ</div>
                </div>
                <div class="stat-card invalid">
                    <div class="stat-value" id="result-failed">0</div>
                    <div class="stat-label">–ü–æ–º–∏–ª–æ–∫</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="result-skipped">0</div>
                    <div class="stat-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                </div>
            </div>

            <div id="result-errors" class="hidden" style="margin-top: 20px; padding: 20px; background: #f8d7da; border-radius: 8px;">
                <h3 style="margin: 0 0 15px 0; color: #721c24;">‚ùå –ü–æ–º–∏–ª–∫–∏:</h3>
                <ul id="error-list" style="margin: 0; padding-left: 20px;"></ul>
            </div>

            <div style="margin-top: 30px;">
                <a href="/equipment" class="btn btn-primary">
                    üìã –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Å–ø–∏—Å–∫—É –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è
                </a>
                <button class="btn btn-secondary" onclick="location.reload()" style="margin-left: 10px;">
                    üîÑ –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ —â–µ
                </button>
            </div>
        </div>
    </div>

</div>

<script>
let selectedFile = null;
let previewPayload = null;

// Upload area drag & drop
// Upload area drag & drop
document.addEventListener('DOMContentLoaded', () => {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');

    if (!uploadArea || !fileInput) return;

    uploadArea.addEventListener('click', () => fileInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragging');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragging');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragging');
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    window._equipmentFileInput = fileInput;
});

function handleFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
        alert('‚ùå –ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å Excel —Ñ–∞–π–ª (.xlsx –∞–±–æ .xls)');
        return;
    }

    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('file-info').classList.remove('hidden');
    document.getElementById('preview-btn').disabled = false;
}

function clearFile() {
    selectedFile = null;
    if (window._equipmentFileInput) window._equipmentFileInput.value = '';
    document.getElementById('file-info').classList.add('hidden');
    document.getElementById('preview-btn').disabled = true;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function previewData() {
    if (!selectedFile) return;

    document.getElementById('preview-btn').disabled = true;
    document.getElementById('preview-btn').textContent = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';

    const formData = new FormData();
    formData.append('file', selectedFile);

    try {
        const response = await fetch('/api/equipment/import/preview', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.error) {
            alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + data.error);
            document.getElementById('preview-btn').disabled = false;
            document.getElementById('preview-btn').textContent = 'üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–∞–Ω—ñ';
            return;
        }

        previewPayload = data;
        showPreview(data);

    } catch (error) {
        alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: ' + error.message);
        document.getElementById('preview-btn').disabled = false;
        document.getElementById('preview-btn').textContent = 'üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–∞–Ω—ñ';
    }
}

function showPreview(data) {
    document.getElementById('step-upload').classList.add('hidden');
    document.getElementById('step-preview').classList.remove('hidden');

    // Stats
    document.getElementById('stat-total').textContent = data.total;
    document.getElementById('stat-valid').textContent = data.valid;
    document.getElementById('stat-invalid').textContent = data.invalid;
    document.getElementById('stat-duplicates').textContent = data.duplicates;
    document.getElementById('import-count').textContent = data.valid;

    // Table
    const tbody = document.getElementById('preview-body');
    tbody.innerHTML = '';

    data.items.forEach(item => {
        const row = document.createElement('tr');
        row.className = item.errors.length ? 'invalid' : 'valid';

        let status = '';
        if (item.errors.length) {
            status = item.errors.map(e => `<span class="error-badge">${e}</span>`).join('');
        }
        if (item.warnings.length) {
            status += item.warnings.map(w => `<span class="warning-badge">${w}</span>`).join('');
        }
        if (!item.errors.length) {
            status = '<span class="success-badge">‚úì OK</span>';
        }

        row.innerHTML = `
            <td>${item.row_num}</td>
            <td>${item.name || '‚Äî'}</td>
            <td>${item.equipment_type || '‚Äî'}</td>
            <td><strong>${item.serial_number || '‚Äî'}</strong></td>
            <td>${item.manufacturer || '‚Äî'}</td>
            <td>${item.manufacture_date || '‚Äî'}</td>
            <td>${item.condition || 'working'}</td>
            <td>${status}</td>
        `;

        tbody.appendChild(row);
    });

    document.getElementById('import-btn').disabled = data.valid === 0;
}

function backToUpload() {
    document.getElementById('step-preview').classList.add('hidden');
    document.getElementById('step-upload').classList.remove('hidden');
    document.getElementById('preview-btn').disabled = false;
    document.getElementById('preview-btn').textContent = 'üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –¥–∞–Ω—ñ';
}

async function executeImport() {
    if (!previewPayload) return;

    if (!confirm(`–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ ${previewPayload.valid} –æ–¥–∏–Ω–∏—Ü—å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è?`)) return;

    document.getElementById('import-btn').disabled = true;
    document.getElementById('import-btn').textContent = '‚è≥ –Ü–º–ø–æ—Ä—Ç...';

    try {
        const response = await fetch('/api/equipment/import/execute', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(previewPayload)
        });

        const result = await response.json();
        showResults(result);

    } catch (error) {
        alert('‚ùå –ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + error.message);
        document.getElementById('import-btn').disabled = false;
        document.getElementById('import-btn').textContent = '‚úÖ –Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏';
    }
}

function showResults(result) {
    document.getElementById('step-preview').classList.add('hidden');
    document.getElementById('step-results').classList.remove('hidden');

    document.getElementById('result-success').textContent = result.success;
    document.getElementById('result-failed').textContent = result.failed;
    document.getElementById('result-skipped').textContent = result.skipped;

    if (result.errors && result.errors.length) {
        document.getElementById('result-errors').classList.remove('hidden');
        const errorList = document.getElementById('error-list');
        errorList.innerHTML = '';
        result.errors.forEach(err => {
            const li = document.createElement('li');
            li.textContent = `–†—è–¥–æ–∫ ${err.row} (${err.serial}): ${err.error}`;
            errorList.appendChild(li);
        });
    }
}
</script>
{% endblock %}