{% extends "base.html" %}

{% block title %}–°–£–†–ì–ò–õ ¬∑ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–≤–∞–∂–∏–Ω{% endblock %}

{% block extra_head %}
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
>
<style>
/* ============================================================
   VISUAL DASHBOARD ‚Äî PROFESSIONAL LIGHT THEME v3
   ============================================================ */

/* --- Base font ‚Äî darker text --- */
.visual-layout, .daily-stats-grid, .tl-card, .map-block {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, sans-serif;
    font-size: 14px; line-height: 1.5; color: #1e293b;
    -webkit-font-smoothing: antialiased;
}

/* ===== DAILY STATS ===== */
.daily-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 0 0 18px; }
.daily-stats-card {
    background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 14px 16px;
}
.daily-stats-card--yesterday { opacity: 0.75; }
.daily-stats-card__header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.daily-stats-card__title { font-weight: 600; font-size: 14px; color: #1e293b; }
.daily-stats-card__badge {
    background: #f8fafc; border: 1px solid #e2e8f0; padding: 2px 10px;
    border-radius: 8px; font-size: 12px; font-weight: 600; color: #64748b;
    font-variant-numeric: tabular-nums;
}

.daily-stats-active {
    font-size: 13px; margin-bottom: 10px; color: #334155;
    background: #fefce8; padding: 6px 10px; border-radius: 6px;
    border-left: 3px solid #eab308;
}
.daily-stats-active b { color: #1e293b; }

.daily-stats-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
.ds-metric { text-align: center; padding: 8px 4px; border-radius: 6px; border: 1px solid #e2e8f0; }
.ds-metric__value {
    font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums;
    line-height: 1.2;
}
.ds-metric__label { font-size: 11px; color: #64748b; margin-top: 2px; }
.ds-metric--pressure { background: #eff6ff; border-color: #bfdbfe; }
.ds-metric--pressure .ds-metric__value { color: #2563eb; }
.ds-metric--purge { background: #fefce8; border-color: #fde68a; }
.ds-metric--purge .ds-metric__value { color: #a16207; }
.ds-metric--reagent { background: #f0fdf4; border-color: #bbf7d0; }
.ds-metric--reagent .ds-metric__value { color: #16a34a; }
.ds-metric--qty { background: #fef2f2; border-color: #fecaca; }
.ds-metric--qty .ds-metric__value { color: #dc2626; }

/* Details */
.ds-details { margin-bottom: 6px; }
.ds-details summary { cursor: pointer; font-size: 13px; font-weight: 600; }
.ds-details--reagent summary { color: #16a34a; }
.ds-details--bytype summary { color: #2563eb; }
.ds-details--pressure summary { color: #0284c7; }
.ds-details--purge summary { color: #a16207; }
.ds-details .ds-tag-list { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
.ds-tag { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; font-variant-numeric: tabular-nums; }
.ds-tag--reagent { background: #dcfce7; color: #166534; }
.ds-tag--bytype { background: #dbeafe; color: #1e40af; }
.ds-tag--pressure { background: #e0f2fe; color: #075985; font-weight: 400; }
.ds-tag--purge-ok { background: #fef9c3; color: #854d0e; }
.ds-tag--purge-bad { background: #fee2e2; color: #991b1b; }
.ds-details-inner summary { cursor: pointer; font-size: 12px; color: #94a3b8; }
.ds-detail-table { margin-top: 4px; font-size: 12px; border-collapse: collapse; width: 100%; }
.ds-detail-table th { padding: 3px 6px; color: #94a3b8; font-weight: 600; text-align: left; border-bottom: 1px solid #e2e8f0; }
.ds-detail-table th:last-child { text-align: right; }
.ds-detail-table td { padding: 3px 6px; color: #475569; }
.ds-detail-table td:first-child { font-weight: 600; color: #1e293b; }
.ds-detail-table td:last-child { text-align: right; font-variant-numeric: tabular-nums; }
.ds-detail-table tr + tr { border-top: 1px solid #f1f5f9; }
.ds-purge-incomplete { color: #dc2626; }
.ds-no-events { text-align: center; color: #94a3b8; font-size: 13px; padding: 10px; }

/* ===== STATUS CHIPS ‚Äî equal width ===== */
.status-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 4px; cursor: pointer;
    font-size: 12px; font-weight: 600; user-select: none;
    transition: opacity .15s; background: #fff;
    min-width: 120px; justify-content: center;
    box-sizing: border-box;
}
.chip-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.status-cb { display: none; }
#status-checkboxes { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }

/* ===== SIDEBAR ===== */
.status-filter-actions { display: flex; gap: 4px; margin-bottom: 8px; flex-wrap: wrap; }
.status-filter-actions .btn-secondary {
    font-size: 12px; padding: 3px 8px; background: #fff;
    border: 1px solid #e2e8f0; color: #64748b; border-radius: 4px; cursor: pointer;
}
.status-filter-actions .btn-secondary:hover { border-color: #3b82f6; color: #3b82f6; }
.status-filter__hint { font-size: 12px; color: #94a3b8; line-height: 1.4; }
.status-filter__label { margin-bottom: 6px; display: block; color: #64748b; font-size: 12px; font-weight: 600; }

/* ===== WELL TILES ===== */
.well-tile {
    background: #fff !important;
    border: 1px solid #d1d5db !important;
    border-radius: 8px !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04) !important;
    padding: 0 !important;
    gap: 0 !important;
    transition: border-color .15s, box-shadow .15s;
    font-size: 13px;
    overflow: hidden;
    display: flex; flex-direction: column;
}
.well-tile:hover { border-color: #93c5fd !important; box-shadow: 0 2px 8px rgba(59,130,246,0.08) !important; }
.well-tile--hidden { display: none !important; }

/* --- NEW: Unified top block with status color strip --- */
.well-tile__top {
    padding: 10px 14px 8px;
    border-bottom: 1px solid #e2e8f0;
    position: relative;
}
/* Colored top strip ‚Äî 6px bar in status color */
.well-tile__top::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 6px;
    background: var(--tile-status-color, #94a3b8);
    border-radius: 8px 8px 0 0;
}
/* 2-column grid: left = well+id+channel, right = status+date+days */
.well-tile__top-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 6px; align-items: start;
}
/* LEFT: well number + ID below + channel below */
.well-tile__left { display: flex; flex-direction: column; gap: 2px; }
.well-tile__well-num {
    font-size: 18px; font-weight: 800; color: #0f172a;
    letter-spacing: -0.01em; white-space: nowrap; line-height: 1.2;
}
.well-tile__well-num--link {
    cursor: pointer;
    transition: color 0.15s, text-shadow 0.15s;
    border-radius: 4px;
    padding: 2px 4px;
    margin: -2px -4px;
}
.well-tile__well-num--link:hover {
    color: #2563eb;
    text-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
    background: linear-gradient(90deg, rgba(37, 99, 235, 0.08) 0%, transparent 100%);
}
.well-tile__id { font-size: 11px; color: #64748b; line-height: 1.3; }
.well-tile__channel {
    font-size: 13px; color: #334155;
    display: flex; align-items: flex-end; gap: 4px;
    margin-top: 2px; line-height: 1;
}
.well-tile__channel .channel-icon { width: 18px; height: 18px; flex-shrink: 0; vertical-align: bottom; }

/* RIGHT: status + date + days ‚Äî all right-aligned */
.well-tile__right { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; }
.well-tile__status-name {
    font-size: 18px; font-weight: 700;
    color: var(--tile-status-color, #64748b);
    text-transform: uppercase; letter-spacing: 0.02em;
    text-align: right; line-height: 1.2;
}
.well-tile__status-date { font-size: 12px; color: #475569; text-align: right; line-height: 1.3; }
.well-tile__days { font-size: 13px; color: #334155; text-align: right; }
.well-tile__days strong { font-weight: 700; color: #0f172a; font-variant-numeric: tabular-nums; }

/* --- Card body (everything below top block) --- */
.well-tile__body { padding: 8px 14px 10px; display: flex; flex-direction: column; gap: 6px; flex: 1; }

.well-tile__coords { font-size: 12px; color: #64748b; font-variant-numeric: tabular-nums; }
.well-tile__description { font-size: 13px; color: #475569; line-height: 1.4; }

/* ===== PRESSURE TILES (MAIN ACCENT) ===== */
.well-pressure-block {
    margin: 6px 0;
    padding: 8px;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-radius: 10px;
    border: 1px solid #7dd3fc;
}
.well-pressure-block--empty {
    background: #f8fafc;
    border-color: #e2e8f0;
    padding: 10px;
}
.pressure-no-data {
    text-align: center;
    color: #94a3b8;
    font-size: 12px;
}
.pressure-tiles {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}
.pressure-tile {
    background: white;
    border-radius: 8px;
    padding: 10px 2px;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    border-left: 3px solid #0284c7;
}
.pressure-tile--tube {
    border-left-color: #16a34a;
    background: linear-gradient(180deg, #fff 0%, #f0fdf4 100%);
}
.pressure-tile--line {
    border-left-color: #1e88e5;
    background: linear-gradient(180deg, #fff 0%, #e3f2fd 100%);
}
.pressure-tile--diff {
    border-left-color: #7c3aed;
    background: linear-gradient(180deg, #fff 0%, #f3e8ff 100%);
}
.pressure-tile__value {
    font-size: 22px;
    font-weight: 800;
    color: #1e293b;
    font-variant-numeric: tabular-nums;
    line-height: 1.1;
}
.pressure-tile--tube .pressure-tile__value { color: #16a34a; }
.pressure-tile--line .pressure-tile__value { color: #1e88e5; }
.pressure-tile--diff .pressure-tile__value { color: #7c3aed; }
.pressure-tile__label {
    font-size: 10px;
    font-weight: 600;
    color: #64748b;
    margin-top: 2px;
}
.pressure-tile__unit {
    font-weight: 400;
    font-size: 9px;
    color: #94a3b8;
}
.pressure-meta {
    margin-top: 6px;
    text-align: center;
    font-size: 10px;
    color: #64748b;
}
.pressure-period-label {
    font-weight: 600;
    color: #3b82f6;
}

/* ===== EQUIPMENT COLLAPSIBLE ===== */
.well-equipment-details {
    margin: 4px 0;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    overflow: hidden;
}
.well-equipment-details[open] {
    border-color: #93c5fd;
}
.equipment-summary {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: #f8fafc;
    cursor: pointer;
    user-select: none;
    font-size: 12px;
    font-weight: 600;
    color: #475569;
    list-style: none;
}
.equipment-summary::-webkit-details-marker { display: none; }
.equipment-summary::before {
    content: '‚ñ∏';
    margin-right: 6px;
    font-size: 10px;
    color: #94a3b8;
}
.well-equipment-details[open] .equipment-summary::before {
    content: '‚ñæ';
}
.equipment-summary:hover {
    background: #f1f5f9;
}
.equipment-title-text {
    flex: 1;
}
.equipment-count {
    background: #3b82f6;
    color: white;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
}
.well-equipment-details .well-equipment-box {
    padding: 6px 10px;
    background: white;
}

/* Equipment block ‚Äî enlarged icons */
.well-tile .well-equipment-box { margin: 4px 0; }
.well-tile .equipment-title { font-size: 11px; font-weight: 600; color: #64748b; margin-bottom: 4px; }
.well-tile .equipment-badges { gap: 6px; display: flex; flex-direction: row; flex-wrap: nowrap; overflow-x: auto; }
.well-tile .equipment-badge { font-size: 13px; padding: 4px 6px; flex: 1 1 0; min-width: 0; align-items: center; text-align: center; }
.well-tile .equipment-icon { width: 80px !important; height: 80px !important; object-fit: contain; }
.well-tile .equipment-label { font-size: 9px !important; font-weight: 600; line-height: 1.2; }
.well-tile .equipment-location { font-size: 11px; }
.well-tile .equipment-empty { font-size: 13px; }

/* Stats block ‚Äî collapsible events */
.well-tile__stats { font-size: 13px; border-top: 1px solid #e2e8f0; margin-top: auto; padding-top: 6px; }
.well-tile__stats-summary { font-size: 13px; color: #1e293b; line-height: 1.6; }
.well-tile__stats-summary strong { color: #0f172a; font-variant-numeric: tabular-nums; }
.well-tile__stats-summary .muted { color: #64748b; font-size: 12px; }
.well-tile__stats-details { margin-top: 4px; }
.stats-detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin-top: 6px; }
.stats-detail-metric { text-align: center; padding: 5px 2px; border-radius: 4px; border: 1px solid #e2e8f0; background: #f8fafc; }
.stats-detail-metric__value { font-size: 15px; font-weight: 700; color: #0f172a; font-variant-numeric: tabular-nums; }
.stats-detail-metric__label { font-size: 9px; color: #64748b; margin-top: 1px; }
.well-tile__stats-details summary {
    cursor: pointer; font-size: 12px; font-weight: 600; color: #3b82f6;
    list-style: none; user-select: none;
}
.well-tile__stats-details summary::-webkit-details-marker { display: none; }
.well-tile__stats-details summary::before { content: '‚ñ∏ '; }
.well-tile__stats-details[open] summary::before { content: '‚ñæ '; }
.well-tile__stats-details .stats-detail-rows { padding: 4px 0 2px 0; }
.well-tile__stats-details .stats-detail-rows .well-tile__stats-row { font-size: 12px; color: #334155; line-height: 1.6; }
.well-tile__stats-details .stats-detail-rows .well-tile__stats-row strong { color: #0f172a; font-variant-numeric: tabular-nums; }
.well-tile__stats hr { border: 0; border-top: 1px solid #e2e8f0; margin: 6px 0; }

/* Footer button */
.well-tile__footer { padding: 0 14px 10px; }
.well-tile__footer button {
    background: #fff; border: 1px solid #d1d5db; color: #3b82f6;
    font-weight: 600; font-size: 12px; border-radius: 6px; padding: 6px 12px;
    transition: all .15s; cursor: pointer; width: 100%;
}
.well-tile__footer button:hover { background: #3b82f6; color: #fff; border-color: #3b82f6; }


/* ===== MAP ===== */
#wells-map { border: 1px solid #d1d5db; border-radius: 8px; }
.map-block h2 { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 10px; }

/* ===== TIMELINE CARD ===== */
.tl-card {
    background: #fff; border: 1px solid #d1d5db; border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04); margin-top: 24px; margin-bottom: 20px;
}
.tl-card .card-header {
    padding: 12px 16px; border-bottom: 1px solid #e2e8f0;
}
.tl-card .card-header h2 { margin: 0; font-size: 15px; font-weight: 600; color: #1e293b; }
.tl-card .card-body { padding: 16px; }
.tl-header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
.tl-header-controls { display: flex; gap: 8px; align-items: center; }
.tl-header-controls label {
    display: flex; align-items: center; gap: 5px; cursor: pointer;
    user-select: none; font-size: 13px; font-weight: 500; color: #64748b;
}
.tl-subtitle { color: #94a3b8; font-size: 13px; }

/* Period bar */
.tl-period-bar {
    padding: 10px 12px; background: #f8fafc; border: 1px solid #e2e8f0;
    border-radius: 8px; margin-bottom: 14px;
}
.tl-period-bar__title { color: #475569; font-weight: 600; margin-bottom: 8px; font-size: 13px; }
.tl-period-bar__buttons { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
.tl-custom-dates {
    margin-left: 8px; background: #fff; padding: 6px 10px; border-radius: 6px;
    display: flex; align-items: center; gap: 6px; border: 1px solid #e2e8f0;
}
.tl-custom-dates label { color: #475569; font-weight: 500; font-size: 13px; }

/* Color modal */
.tl-color-modal {
    display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%);
    background: #fff; border: 1px solid #d1d5db; padding: 24px;
    box-shadow: 0 16px 48px rgba(0,0,0,0.12); z-index: 1000; border-radius: 10px;
    max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
}
.tl-color-modal h3 { margin-top: 0; color: #1e293b; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; font-size: 15px; }
.tl-color-modal__footer {
    display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px;
    padding-top: 12px; border-top: 1px solid #e2e8f0;
}

/* Legend grid ‚Äî BELOW chart */
.tl-legends-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 16px; margin-bottom: 0; }
.legend-card { background: #f8fafc; padding: 10px 12px; border-radius: 8px; border: 1px solid #e2e8f0; }
.legend-header {
    font-weight: 600; margin-bottom: 6px; font-size: 13px; color: #475569;
    padding-bottom: 4px; border-bottom: 1px solid #e2e8f0;
}
.legend-btn-row { display: flex; gap: 4px; margin-bottom: 6px; }

/* Chart container */
.tl-chart-box { width: 100%; position: relative; background: #fff; border-radius: 8px; padding: 16px; border: 1px solid #e2e8f0; }
.tl-chart-controls { display: flex; gap: 8px; margin-bottom: 12px; justify-content: flex-end; }
.tl-chart-area { height: 600px; background: #fff; border-radius: 6px; }
.tl-chart-hints {
    margin-top: 12px; padding: 8px 12px; background: #f8fafc;
    border-radius: 6px; font-size: 12px; color: #64748b;
    border-left: 3px solid #3b82f6;
}
.tl-chart-hints strong { color: #475569; }

/* Wells legend row */
#legend_wells { gap: 5px !important; }

/* Page header */
.page-header h1 { font-size: 18px; font-weight: 600; color: #1e293b; margin: 0; }

/* ===== LORA SETTINGS PANEL ===== */
.lora-settings-panel {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 1px solid #86efac;
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
}
.lora-settings-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    background: linear-gradient(90deg, #16a34a 0%, #22c55e 100%);
    color: white;
}
.lora-settings-icon {
    font-size: 18px;
}
.lora-settings-title {
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 0.02em;
}
.lora-settings-body {
    padding: 12px 16px;
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
}
.lora-setting-group {
    display: flex;
    align-items: center;
    gap: 10px;
}
.lora-setting-label {
    font-size: 13px;
    font-weight: 600;
    color: #166534;
}
.pressure-period-buttons {
    display: flex;
    gap: 4px;
}
.btn-pressure-period {
    padding: 6px 12px;
    border: 1px solid #e2e8f0;
    background: white;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    transition: all 0.15s;
}
.btn-pressure-period:hover {
    border-color: #3b82f6;
    color: #3b82f6;
}
.btn-pressure-period.active {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border-color: #3b82f6;
}
.lora-actions {
    margin-left: auto;
}
.lora-btn {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: all 0.15s;
    text-decoration: none;
}
.lora-btn--refresh {
    border: 1px solid #10b981;
    background: #ecfdf5;
    color: #059669;
}
.lora-btn--refresh:hover {
    background: #d1fae5;
    border-color: #059669;
}
.lora-btn--admin {
    border: 1px solid #d1d5db;
    background: white;
    color: #6b7280;
}
.lora-btn--admin:hover {
    border-color: #9ca3af;
    color: #374151;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.lora-btn--refresh.loading #refresh-pressure-icon {
    display: inline-block;
    animation: spin 1s linear infinite;
}

/* ===== STATUS GROUP SECTIONS ===== */
.tiles-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
}
.status-group-section {
    background: #f8fafc;
    border-radius: 12px;
    padding: 12px;
    border: 1px solid #e2e8f0;
}
.status-group-header {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    margin-bottom: 12px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid var(--status-color, #94a3b8);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.status-group-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}
.status-group-title {
    font-size: 15px;
    font-weight: 700;
    color: #1e293b;
    flex: 1;
}
.status-group-count {
    background: var(--status-color, #94a3b8);
    color: white;
    font-size: 12px;
    font-weight: 700;
    padding: 3px 10px;
    border-radius: 12px;
    min-width: 24px;
    text-align: center;
}
.status-group-section .tiles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 12px;
}
</style>
{% endblock %}

{% block content %}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item active">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<!-- ===== –î–ù–ï–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== -->
{% set ds = daily_stats %}
<div class="daily-stats-grid">

  {% for period, label in [('today', '–°–µ–≥–æ–¥–Ω—è ¬∑ ' ~ ds.today_label), ('yesterday', '–í—á–µ—Ä–∞ ¬∑ ' ~ ds.yesterday_label)] %}
  {% set s = ds[period] %}
  <div class="daily-stats-card {% if period == 'yesterday' %}daily-stats-card--yesterday{% endif %}">
    <div class="daily-stats-card__header">
      <span class="daily-stats-card__title">{{ label }}</span>
      <span class="daily-stats-card__badge">{{ s.total }} —Å–æ–±—ã—Ç–∏–π</span>
    </div>

    <div class="daily-stats-active" title="–°–∫–≤–∞–∂–∏–Ω—ã —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥">
      <b>{{ s.active_wells_count }}</b> —Å–∫–≤–∞–∂–∏–Ω —Å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
      {% if s.status_summary %}
        {% for st2, wl2 in s.status_summary.items() if st2 not in ['–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞', '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è'] %}
          ¬∑ {{ st2 }} <b>{{ wl2|length }}</b>
        {% endfor %}
      {% endif %}
    </div>

    <div class="daily-stats-metrics">
      <div class="ds-metric ds-metric--pressure">
        <div class="ds-metric__value">{{ s.pressure }}</div>
        <div class="ds-metric__label">–ó–∞–º–µ—Ä–æ–≤</div>
      </div>
      <div class="ds-metric ds-metric--purge">
        <div class="ds-metric__value">{{ s.purge_count }}</div>
        <div class="ds-metric__label">–ü—Ä–æ–¥—É–≤–æ–∫</div>
      </div>
      <div class="ds-metric ds-metric--reagent">
        <div class="ds-metric__value">{{ s.reagent }}</div>
        <div class="ds-metric__label">–í–±—Ä–æ—Å–æ–≤</div>
      </div>
      <div class="ds-metric ds-metric--qty">
        <div class="ds-metric__value">{{ "%.1f"|format(s.reagent_qty) }}</div>
        <div class="ds-metric__label">—à—Ç —Ä–µ–∞–≥–µ–Ω—Ç–∞</div>
      </div>
    </div>

    {% if s.reagent_wells %}
    <details class="ds-details ds-details--reagent">
      <summary>–†–µ–∞–≥–µ–Ω—Ç –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º ({{ s.reagent_wells|length }})</summary>
      <div class="ds-tag-list">
        {% for well_num, qty in s.reagent_wells.items() %}
        <span class="ds-tag ds-tag--reagent">{{ well_num }}: {{ "%.1f"|format(qty|float) }} —à—Ç</span>
        {% endfor %}
      </div>
      {% if s.reagent_well_details %}
      <details class="ds-details-inner" style="margin-top:6px;">
        <summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
        <table class="ds-detail-table">
          <tr><th>–°–∫–≤</th><th>–†–µ–∞–≥–µ–Ω—Ç</th><th>–ö–æ–ª-–≤–æ</th></tr>
          {% for d in s.reagent_well_details %}
          <tr>
            <td>{{ d.well }}</td>
            <td>{{ d.reagent }}</td>
            <td>{{ "%.1f"|format(d.qty) }} —à—Ç</td>
          </tr>
          {% endfor %}
        </table>
      </details>
      {% endif %}
    </details>
    {% endif %}

    {% if s.reagent_by_name %}
    <details class="ds-details ds-details--bytype">
      <summary>–ü–æ —Ç–∏–ø—É —Ä–µ–∞–≥–µ–Ω—Ç–∞</summary>
      <div class="ds-tag-list">
        {% for rname, qty in s.reagent_by_name.items() %}
        <span class="ds-tag ds-tag--bytype">{{ rname }}: {{ "%.1f"|format(qty|float) }} —à—Ç</span>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.pressure_wells %}
    <details class="ds-details ds-details--pressure">
      <summary>–ó–∞–º–µ—Ä—ã –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–∞—Ö ({{ s.pressure_wells|length }})</summary>
      <div class="ds-tag-list">
        {% for wn in s.pressure_wells %}
        <span class="ds-tag ds-tag--pressure">{{ wn }}</span>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.purge_count %}
    <details class="ds-details ds-details--purge">
      <summary>
        –ü—Ä–æ–¥—É–≤–∫–∏: {{ s.purge_by_type.get('—Å–∫–≤–∞–∂–∏–Ω–∞',0) }} —Å–∫–≤ ¬∑ {{ s.purge_by_type.get('—à—Ç—É—Ü–µ—Ä',0) }} —à—Ç—É—Ü ¬∑ {{ s.purge_by_type.get('–º–∞–Ω–æ–º–µ—Ç—Ä',0) }} –º–∞–Ω–æ–º
        {% if s.purge_incomplete %}<span class="ds-purge-incomplete"> ({{ s.purge_incomplete }} –Ω–µ–ø–æ–ª–Ω.)</span>{% endif %}
      </summary>
      <div class="ds-tag-list" style="margin-top:6px; font-size:11px;">
        {% for d in s.purge_details %}
        <span class="ds-tag {% if d.complete %}ds-tag--purge-ok{% else %}ds-tag--purge-bad{% endif %}" style="display:inline-block; margin:2px;">
          {{ d.well }} ¬∑ {{ d.type }} ¬∑ {{ d.phases }} {% if not d.complete %}‚ö†{% endif %}
        </span>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.total == 0 %}
    <div class="ds-no-events">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>
    {% endif %}
  </div>
  {% endfor %}
</div>

{# ===== –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö LORA ===== #}
<div class="lora-settings-panel">
    <div class="lora-settings-header">
        <span class="lora-settings-icon">üì°</span>
        <span class="lora-settings-title">LoRa –¥–∞—Ç—á–∏–∫–∏ –¥–∞–≤–ª–µ–Ω–∏—è</span>
    </div>
    <div class="lora-settings-body">
        <div class="lora-setting-group">
            <span class="lora-setting-label">–£—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –∑–∞:</span>
            <div class="pressure-period-buttons">
                <button type="button" class="btn-pressure-period {% if pressure_period == '10m' %}active{% endif %}"
                        onclick="setPressurePeriod('10m')">10 –º–∏–Ω</button>
                <button type="button" class="btn-pressure-period {% if pressure_period == '1h' or not pressure_period %}active{% endif %}"
                        onclick="setPressurePeriod('1h')">1 —á–∞—Å</button>
                <button type="button" class="btn-pressure-period {% if pressure_period == '1d' %}active{% endif %}"
                        onclick="setPressurePeriod('1d')">–°—É—Ç–∫–∏</button>
                <button type="button" class="btn-pressure-period {% if pressure_period == '1m' %}active{% endif %}"
                        onclick="setPressurePeriod('1m')">–ú–µ—Å—è—Ü</button>
            </div>
        </div>
        <div class="lora-setting-group lora-actions">
            <button id="btn-refresh-pressure-dashboard" onclick="refreshPressureDashboard()" class="lora-btn lora-btn--refresh" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–∞–≤–ª–µ–Ω–∏–π —Å Raspberry Pi">
                <span id="refresh-pressure-icon">&#8635;</span> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏—è
            </button>
            <a href="/api/pressure/admin/page" class="lora-btn lora-btn--admin" title="–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–∞–≤–ª–µ–Ω–∏–π">
                &#9881; –î–∞–≤–ª–µ–Ω–∏—è
            </a>
        </div>
    </div>
</div>

<div class="page-header">
    <h1>–°–∫–≤–∞–∂–∏–Ω—ã</h1>
</div>

<div class="visual-layout">
    {# ===== –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ø–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å–∫–≤–∞–∂–∏–Ω ===== #}
    <aside class="visual-sidebar">
        <h2>–í—ã–±–æ—Ä —Å–∫–≤–∞–∂–∏–Ω</h2>

        <div class="well-search">
            <input
                type="text"
                id="well-search-input"
                placeholder="–ü–æ–∏—Å–∫: 1367, 131, ID –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è..."
                oninput="filterWellCheckboxes()"
            >
        </div>

        <div class="status-filter">
            <label class="status-filter__label">
                –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            </label>

            <div id="status-checkboxes">
              {% set status_opts = [
                  ('status-watch', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',      '#007bff'),
                  ('status-adapt', '–ê–¥–∞–ø—Ç–∞—Ü–∏—è',       '#17a2b8'),
                  ('status-opt',   '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',     '#28a745'),
                  ('status-dev',   '–û—Å–≤–æ–µ–Ω–∏–µ',        '#ffc107'),
                  ('status-idle',  '–ü—Ä–æ—Å—Ç–æ–π',         '#fd7e14'),
                  ('status-other', '–î—Ä—É–≥–æ–µ',          '#343a40'),
                  ('status-off',   '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è','#6c757d'),
                  ('',             '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞',     '#94a3b8'),
              ] %}
              {% for code, label, color in status_opts %}
              <label class="status-chip" data-status="{{ code }}"
                     style="border:2px solid {{ color }};">
                <input type="checkbox" class="status-cb" value="{{ code }}"
                       {% if code != 'status-off' %}checked{% endif %}
                       onchange="onStatusFilterChange()">
                <span class="chip-dot" style="background:{{ color }};"></span>
                {{ label }}
              </label>
              {% endfor %}
            </div>

            <div class="status-filter-actions">
              <button type="button" onclick="setAllStatuses(true)"  class="btn-secondary">–í—Å–µ</button>
              <button type="button" onclick="setAllStatuses(false)" class="btn-secondary">–ù–∏ –æ–¥–Ω–æ–≥–æ</button>
              <button type="button" onclick="selectWellsByStatuses()" class="btn-secondary">–í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</button>
              <button type="button" onclick="deselectWellsByStatuses()" class="btn-secondary">–°–Ω—è—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</button>
            </div>

            <div class="status-filter__hint">
                ¬´–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è¬ª —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã¬ª.
            </div>
        </div>

        <form method="get" action="/visual" class="well-filter-form">
            <div class="well-checkbox-list">

                {# --- –ø–æ—Ä—è–¥–æ–∫ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å-–≥—Ä—É–ø–ø --- #}
                {% set status_groups = [
                    ('status-watch', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ'),
                    ('status-adapt', '–ê–¥–∞–ø—Ç–∞—Ü–∏—è'),
                    ('status-opt',   '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è'),
                    ('status-dev',   '–û—Å–≤–æ–µ–Ω–∏–µ'),
                    ('status-off',   '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è'),
                    ('status-idle',  '–ü—Ä–æ—Å—Ç–æ–π'),
                    ('status-other', '–î—Ä—É–≥–æ–µ')
                ] %}

                {# --- —Å–Ω–∞—á–∞–ª–∞ –≥—Ä—É–ø–ø—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º --- #}
                {% for css_code, title in status_groups %}
                    {% set ns = namespace(have=false) %}
                    {% for w in all_wells %}
                        {% if w.current_status_css == css_code %}
                            {% if not ns.have %}
                                <div class="status-group">
                                    <div class="status-group__header">{{ title }}</div>
                                    {% set ns.have = true %}
                            {% endif %}

                            <label
                                class="well-checkbox-item {{ w.current_status_css or '' }}"
                                data-label="{{ (w.number or w.id)|string }} {{ w.name or '' }} {{ w.current_status or '' }}"
                                data-status-css="{{ w.current_status_css or '' }}"
                            >
                                <input
                                    type="checkbox"
                                    name="selected"
                                    value="{{ w.id }}"
                                    {% if w.id in selected_ids %}checked{% endif %}
                                >
                                <span class="well-checkbox-name">
                                    –°–∫–≤ {{ w.number or w.id }}
                                </span>
                                <span class="well-checkbox-status">
                                    {% if w.current_status %}
                                        ¬∑ {{ w.current_status }}
                                    {% else %}
                                        ¬∑ —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                                    {% endif %}
                                </span>
                            </label>
                        {% endif %}
                    {% endfor %}
                    {% if ns.have %}
                        </div> {# –∑–∞–∫—Ä—ã–≤–∞–µ–º .status-group #}
                    {% endif %}
                {% endfor %}

                {# --- –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ "–°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω" --- #}
                {% set ns = namespace(have=false) %}
                {% for w in all_wells %}
                    {% if not w.current_status_css %}
                        {% if not ns.have %}
                            <div class="status-group">
                                <div class="status-group__header">–°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω</div>
                                {% set ns.have = true %}
                        {% endif %}

                        <label
                            class="well-checkbox-item"
                            data-label="{{ (w.number or w.id)|string }} {{ w.name or '' }}"
                            data-status-css=""
                        >
                            <input
                                type="checkbox"
                                name="selected"
                                value="{{ w.id }}"
                                {% if w.id in selected_ids %}checked{% endif %}
                            >
                            <span class="well-checkbox-name">
                                –°–∫–≤ {{ w.number or w.id }}
                            </span>
                            <span class="well-checkbox-status">
                                ¬∑ —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                            </span>
                        </label>
                    {% endif %}
                {% endfor %}
                {% if ns.have %}
                    </div>
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
                <a href="/visual" class="btn-secondary">
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                </a>
            </div>
        </form>
    </aside>

    {# ===== –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨: –ø–ª–∏—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω ===== #}
    <section class="tiles-container">
        {% if wells %}
            {# –ü–æ—Ä—è–¥–æ–∫ –≥—Ä—É–ø–ø –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º #}
            {% set status_groups_order = [
                ('status-opt',   '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',     '#28a745'),
                ('status-adapt', '–ê–¥–∞–ø—Ç–∞—Ü–∏—è',       '#17a2b8'),
                ('status-watch', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',      '#007bff'),
                ('status-dev',   '–û—Å–≤–æ–µ–Ω–∏–µ',        '#ffc107'),
                ('status-idle',  '–ü—Ä–æ—Å—Ç–æ–π',         '#fd7e14'),
                ('status-off',   '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è','#6c757d'),
                ('status-other', '–î—Ä—É–≥–æ–µ',          '#343a40'),
                ('',             '–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞',     '#94a3b8'),
            ] %}

            {% for status_css, status_label, status_color in status_groups_order %}
                {# –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∫–≤–∞–∂–∏–Ω—ã –ø–æ —Ç–µ–∫—É—â–µ–º—É —Å—Ç–∞—Ç—É—Å—É #}
                {% set status_wells = wells|selectattr('current_status_css', 'equalto', status_css)|list %}
                {% if status_css == '' %}
                    {# –î–ª—è "–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞" –∏—â–µ–º —Å–∫–≤–∞–∂–∏–Ω—ã –±–µ–∑ current_status_css #}
                    {% set status_wells = wells|rejectattr('current_status_css')|list %}
                {% endif %}

                {% if status_wells %}
                <div class="status-group-section" data-status="{{ status_css }}">
                    <div class="status-group-header" style="--status-color: {{ status_color }};">
                        <span class="status-group-dot" style="background: {{ status_color }};"></span>
                        <span class="status-group-title">{{ status_label }}</span>
                        <span class="status-group-count">{{ status_wells|length }}</span>
                    </div>
                    <div class="tiles-grid">
                        {% for w in status_wells %}
                <article
                    class="well-tile"
                    data-well-id="{{ w.id }}"
                    data-lat="{{ w.lat or '' }}"
                    data-lon="{{ w.lon or '' }}"
                    data-name="–°–∫–≤ {{ w.number or w.id }}"
                    data-status="{{ w.current_status or '' }}"
                    data-status-css="{{ w.current_status_css or '' }}"
                    data-status-start="{{ w.current_status_start.isoformat() if w.current_status_start else '' }}"
                    data-status-days="{{ w.current_status_days or '' }}"
                >
{# ==== –ù–û–í–´–ô –í–ï–†–•–ù–ò–ô –ë–õ–û–ö: –°–ö–í + –°—Ç–∞—Ç—É—Å + –ö–∞–Ω–∞–ª + –î–∞—Ç–∞ ==== #}
{% set _status_color_map = {
    'status-watch': 'var(--status-watch-color)',
    'status-adapt': 'var(--status-adapt-color)',
    'status-opt':   'var(--status-opt-color)',
    'status-dev':   'var(--status-dev-color)',
    'status-off':   'var(--status-off-color)',
    'status-idle':  'var(--status-idle-color)',
    'status-other': 'var(--status-other-color)',
} %}
<div class="well-tile__top" style="--tile-status-color: {{ _status_color_map.get(w.current_status_css, '#94a3b8') }};">
    <div class="well-tile__top-grid">
        {# –õ–ï–í–ê–Ø: –°–ö–í + ID + –ö–∞–Ω–∞–ª #}
        <div class="well-tile__left">
            {% if w.lat is not none and w.lon is not none %}
            <div class="well-tile__well-num well-tile__well-num--link"
                 onclick="focusOnWellMarker({{ w.id }})"
                 title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ">–°–ö–í {{ w.number or w.id }} üìç</div>
            {% else %}
            <div class="well-tile__well-num">–°–ö–í {{ w.number or w.id }}</div>
            {% endif %}
            <div class="well-tile__id">ID {{ w.id }}</div>
            <div class="well-tile__channel">
                {% if w.current_channel %}
                    –ö–∞–Ω–∞–ª {{ w.current_channel }}
                {% else %}
                    –ö–∞–Ω–∞–ª ‚Äî
                {% endif %}
                <img src="{{ url_for('static', path='icons/pngegg-2.png') }}" class="channel-icon" alt="–°–≤—è–∑—å">
            </div>
        </div>
        {# –ü–†–ê–í–ê–Ø: –°—Ç–∞—Ç—É—Å + –î–∞—Ç–∞ + –°—É—Ç–∫–∏ #}
        <div class="well-tile__right">
            <div class="well-tile__status-name">{{ w.current_status or '—Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω' }}</div>
            <div class="well-tile__status-date">
                {% if w.current_status_start %}
                    —Å {{ w.current_status_start.strftime("%d.%m.%Y") }}
                {% endif %}
            </div>
            {% if w.current_status_days is not none %}
                <div class="well-tile__days"><strong>{{ "%.1f"|format(w.current_status_days) }}</strong> —Å—É—Ç.</div>
            {% endif %}
        </div>
    </div>
</div>

<div class="well-tile__body">
    <div class="well-tile__coords">
        {% if w.lat is not none and w.lon is not none %}
            {{ "%.6f"|format(w.lat) }}, {{ "%.6f"|format(w.lon) }}
        {% else %}
            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã
        {% endif %}
    </div>

    {# ==== –ë–õ–û–ö –î–ê–í–õ–ï–ù–ò–ô (LoRa) ==== #}
    {% if w.has_pressure %}
    <div class="well-pressure-block">
        <div class="pressure-tiles">
            <div class="pressure-tile pressure-tile--tube">
                <div class="pressure-tile__value">{{ "%.2f"|format(w.pressure_tube or 0) }}</div>
                <div class="pressure-tile__label">Ptr <span class="pressure-tile__unit">–∞—Ç–º</span></div>
            </div>
            <div class="pressure-tile pressure-tile--line">
                <div class="pressure-tile__value">{{ "%.2f"|format(w.pressure_line or 0) }}</div>
                <div class="pressure-tile__label">Pshl <span class="pressure-tile__unit">–∞—Ç–º</span></div>
            </div>
            <div class="pressure-tile pressure-tile--diff">
                <div class="pressure-tile__value">{{ "%.2f"|format(w.pressure_diff or 0) }}</div>
                <div class="pressure-tile__label">ŒîP <span class="pressure-tile__unit">–∞—Ç–º</span></div>
            </div>
        </div>
        <div class="pressure-meta">
            {% if w.pressure_updated %}
            –æ–±–Ω. {{ w.pressure_updated.strftime("%d.%m %H:%M") }}
            {% endif %}
            ¬∑ –ø–µ—Ä–∏–æ–¥: <span class="pressure-period-label" data-period="{{ pressure_period }}">
                {% if pressure_period == '10m' %}10 –º–∏–Ω
                {% elif pressure_period == '1h' %}1 —á–∞—Å
                {% elif pressure_period == '1d' %}—Å—É—Ç–∫–∏
                {% elif pressure_period == '1m' %}–º–µ—Å—è—Ü
                {% else %}1 —á–∞—Å{% endif %}
            </span>
        </div>
    </div>
    {% else %}
    <div class="well-pressure-block well-pressure-block--empty">
        <div class="pressure-no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–∞–≤–ª–µ–Ω–∏—è</div>
    </div>
    {% endif %}

    {# ==== –ë–õ–û–ö –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º—ã–π) ==== #}
    <details class="well-equipment-details">
        <summary class="equipment-summary">
            <span class="equipment-title-text">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</span>
            <span class="equipment-count">{{ w.equipment_active|length if w.equipment_active else 0 }}</span>
        </summary>
        <div class="well-equipment-box">
            {% if w.equipment_active %}
                <div class="equipment-badges">
                    {% for eq in w.equipment_active %}
                        {% set config = eq.config %}
                        <div class="equipment-badge"
                             style="border-color: {{ config.border_color }}; background: {{ config.background_gradient }};"
                             title="{{ config.label }}
{% if eq.model %}–ú–æ–¥–µ–ª—å: {{ eq.model }}{% endif %}
{% if eq.serial %}–°–µ—Ä–∏–π–Ω—ã–π: {{ eq.serial }}{% endif %}
{% if eq.installation_location %}–ú–µ—Å—Ç–æ: {{ eq.installation_location }}{% endif %}
{% if eq.installation_date %}–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{ eq.installation_date.strftime('%d.%m.%Y') }}{% endif %}">
                            <img
                                src="{{ config.icon }}"
                                class="equipment-icon"
                                alt="{{ config.label }}"
                                onerror="this.src='/static/icons/default.png'"
                            >
                            <div class="equipment-info">
                                <div class="equipment-label" style="color: {{ config.color }};">
                                    {{ eq.serial or config.short or config.label }}
                                </div>
                                {% if eq.installation_location %}
                                    <div class="equipment-location">
                                        <small>{{ eq.installation_location|truncate(15) }}</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="equipment-empty muted">
                    –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                </div>
            {% endif %}
        </div>
    </details>

    <div class="well-tile__description">
        {{ w.description or "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ" }}
    </div>

                         <div class="well-tile__stats">
                            {# ---- –°–ï–ì–û–î–ù–Ø: —Å–≤–æ–¥–∫–∞ + —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ---- #}
                            <div class="well-tile__stats-summary">
                                –°–µ–≥–æ–¥–Ω—è: <strong>{{ w.events_today_total or 0 }}</strong> —Å–æ–±—ã—Ç–∏–π
                                <span class="muted">¬∑ –æ–±–Ω–æ–≤–ª–µ–Ω–æ {{ updated_at.strftime("%H:%M") }}</span>
                            </div>

                            <details class="well-tile__stats-details">
                                <summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</summary>
                                <div class="stats-detail-rows stats-detail-grid">
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_today_pressure or 0 }}</div>
                                        <div class="stats-detail-metric__label">–ó–∞–º–µ—Ä–æ–≤</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_today_purges or 0 }}</div>
                                        <div class="stats-detail-metric__label">–ü—Ä–æ–¥—É–≤–æ–∫</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_today_reagents or 0 }}</div>
                                        <div class="stats-detail-metric__label">–í–±—Ä–æ—Å–æ–≤</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ "%.1f"|format(w.events_today_reagent_qty or 0.0) }}</div>
                                        <div class="stats-detail-metric__label">—à—Ç —Ä–µ–∞–≥.</div>
                                    </div>
                                </div>
                                {% if w.events_today_reagent_types %}
                                <div class="well-tile__stats-row muted" style="margin-top:4px;">
                                    –†–µ–∞–≥–µ–Ω—Ç—ã: {{ w.events_today_reagent_types }}
                                </div>
                                {% endif %}
                            </details>

                            <hr>

                            {# ---- –í–ß–ï–†–ê: —Å–≤–æ–¥–∫–∞ + —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º—ã–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ ---- #}
                            <div class="well-tile__stats-summary">
                                –í—á–µ—Ä–∞: <strong>{{ w.events_yesterday_total or 0 }}</strong> —Å–æ–±—ã—Ç–∏–π
                            </div>

                            <details class="well-tile__stats-details">
                                <summary>–ü–æ–¥—Ä–æ–±–Ω–µ–µ –∑–∞ –≤—á–µ—Ä–∞</summary>
                                <div class="stats-detail-rows stats-detail-grid">
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_yesterday_pressure or 0 }}</div>
                                        <div class="stats-detail-metric__label">–ó–∞–º–µ—Ä–æ–≤</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_yesterday_purges or 0 }}</div>
                                        <div class="stats-detail-metric__label">–ü—Ä–æ–¥—É–≤–æ–∫</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ w.events_yesterday_reagents or 0 }}</div>
                                        <div class="stats-detail-metric__label">–í–±—Ä–æ—Å–æ–≤</div>
                                    </div>
                                    <div class="stats-detail-metric">
                                        <div class="stats-detail-metric__value">{{ "%.1f"|format(w.events_yesterday_reagent_qty or 0.0) }}</div>
                                        <div class="stats-detail-metric__label">—à—Ç —Ä–µ–∞–≥.</div>
                                    </div>
                                </div>
                                {% if w.events_yesterday_reagent_types %}
                                <div class="well-tile__stats-row muted" style="margin-top:4px;">
                                    –†–µ–∞–≥–µ–Ω—Ç—ã: {{ w.events_yesterday_reagent_types }}
                                </div>
                                {% endif %}
                            </details>
                        </div>
                    </div>{# /well-tile__body #}

                    <footer class="well-tile__footer">
                        <button type="button" onclick="openWellPage({{ w.id }})">
                            –û—Ç–∫—Ä—ã—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É
                        </button>
                    </footer>
                </article>
                        {% endfor %}
                    </div>{# /tiles-grid #}
                </div>{# /status-group-section #}
                {% endif %}
            {% endfor %}
        {% else %}
            <p>
                –ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                –û—Ç–º–µ—Ç—å –Ω—É–∂–Ω—ã–µ —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ¬ª.
            </p>
        {% endif %}
    </section>
</div>

{# ===== –ë–õ–û–ö –ö–ê–†–¢–´ –ü–û–î –ü–õ–ò–¢–ö–ê–ú–ò ===== #}
<div class="map-block">
    <h2>–ö–∞—Ä—Ç–∞ —Å–∫–≤–∞–∂–∏–Ω</h2>

    <div id="map-status-summary" class="map-status-summary"></div>

    <div id="wells-map"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>

<script>
  // ==== –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∫–≤–∞–∂–∏–Ω—ã –∏–∑ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–ª–∏—Ç–∫–µ ====
  function openWellPage(id) {
    if (!id) return;
    window.location.href = "/well/" + id;
  }

  // ==== –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –¥–∞–≤–ª–µ–Ω–∏–π ====
  function setPressurePeriod(period) {
    const url = new URL(window.location.href);
    url.searchParams.set('pressure_period', period);
    window.location.href = url.toString();
  }

  // ==== –§–æ–∫—É—Å –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ —Å–∫–≤–∞–∂–∏–Ω—ã –Ω–∞ –∫–∞—Ä—Ç–µ ====
  function focusOnWellMarker(wellId) {
    const marker = window.wellMarkers?.[wellId];
    const map = window.wellsMap;
    if (!marker || !map) {
      alert('–ö–∞—Ä—Ç–∞ –∏–ª–∏ –º–∞—Ä–∫–µ—Ä —Å–∫–≤–∞–∂–∏–Ω—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
      return;
    }

    // –°–∫—Ä–æ–ª–ª–∏–º –∫ –∫–∞—Ä—Ç–µ
    const mapEl = document.getElementById('wells-map');
    if (mapEl) {
      mapEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä–∫–µ—Ä–µ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º popup
    setTimeout(() => {
      map.setView(marker.getLatLng(), 15);
      marker.openPopup();
    }, 300);
  }

  // ==== –§–∏–ª—å—Ç—Ä —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø–æ–∏—Å–∫–∞ (+ —É—á—ë—Ç —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞) ====
  function filterWellCheckboxes() {
    const input = document.getElementById("well-search-input");
    const term = (input?.value || "").toLowerCase().trim();
    const activeStatuses = new Set(getActiveStatuses());
    const items = document.querySelectorAll(".well-checkbox-item");

    items.forEach(item => {
      const label = (item.dataset.label || "").toLowerCase();
      const st = item.dataset.statusCss || '';
      const matchSearch = !term || label.includes(term);
      const matchStatus = activeStatuses.size === 0 || activeStatuses.has(st);
      item.style.display = (matchSearch && matchStatus) ? "" : "none";
    });
    // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä—É–ø–ø
    document.querySelectorAll('.status-group').forEach(group => {
      const any = Array.from(group.querySelectorAll('.well-checkbox-item')).some(i => i.style.display !== 'none');
      group.style.display = any ? '' : 'none';
    });
  }

  // ==== –ú—É–ª—å—Ç–∏—Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º ====

  const STATUS_FILTER_KEY = "surgil_status_filter_multi";

  function getActiveStatuses() {
    return Array.from(document.querySelectorAll('.status-cb:checked')).map(cb => cb.value);
  }

  function saveStatusFilterToStorage() {
    try { localStorage.setItem(STATUS_FILTER_KEY, JSON.stringify(getActiveStatuses())); } catch(e) {}
  }

  function loadStatusFilterFromStorage() {
    try {
      const raw = localStorage.getItem(STATUS_FILTER_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
  }

  function onStatusFilterChange() {
    saveStatusFilterToStorage();
    updateChipStyles();
    applyStatusFilter();
  }

  function updateChipStyles() {
    document.querySelectorAll('.status-chip').forEach(chip => {
      const cb = chip.querySelector('.status-cb');
      chip.style.opacity = cb.checked ? '1' : '0.4';
      chip.style.background = cb.checked ? '' : '#f1f5f9';
    });
  }

  function setAllStatuses(on) {
    document.querySelectorAll('.status-cb').forEach(cb => cb.checked = on);
    onStatusFilterChange();
  }

  // –í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã, —á–µ–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ—á–µ–Ω
  function selectWellsByStatuses() {
    const active = new Set(getActiveStatuses());
    document.querySelectorAll('.well-checkbox-item').forEach(item => {
      const st = item.dataset.statusCss || '';
      const cb = item.querySelector('input[type="checkbox"]');
      if (cb && active.has(st)) cb.checked = true;
    });
  }

  // –°–Ω—è—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã, —á–µ–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ—á–µ–Ω
  function deselectWellsByStatuses() {
    const active = new Set(getActiveStatuses());
    document.querySelectorAll('.well-checkbox-item').forEach(item => {
      const st = item.dataset.statusCss || '';
      const cb = item.querySelector('input[type="checkbox"]');
      if (cb && active.has(st)) cb.checked = false;
    });
  }

  function applyStatusFilter() {
    const active = new Set(getActiveStatuses());
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–ª–∏—Ç–∫–∏ (class-based, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å —Å CSS display:flex)
    document.querySelectorAll('.well-tile').forEach(tile => {
      const css = tile.dataset.statusCss || '';
      if (active.has(css)) {
        tile.classList.remove('well-tile--hidden');
      } else {
        tile.classList.add('well-tile--hidden');
      }
    });
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∞–π–¥–±–∞—Ä (—Å —É—á—ë—Ç–æ–º –ø–æ–∏—Å–∫–∞)
    filterWellCheckboxes();
  }

  function initStatusFilter() {
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ localStorage
    const stored = loadStatusFilterFromStorage();
    if (stored) {
      const set = new Set(stored);
      document.querySelectorAll('.status-cb').forEach(cb => {
        cb.checked = set.has(cb.value);
      });
    }
    updateChipStyles();
    applyStatusFilter();
  }

  // ==== –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ CSS-–∫–ª–∞—Å—Å—É —á–µ—Ä–µ–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ :root ====
  function getStatusColor(cssCode) {
    const cls =
      (cssCode || "")
        .split(/\s+/)
        .find(c => c.startsWith("status-")) || "status-other";

    const varName = `--${cls}-color`;

    const value = getComputedStyle(document.documentElement)
      .getPropertyValue(varName)
      .trim();

    return value || "#343a40";
  }

  // ==== SVG-–∏–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –Ω—É–∂–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ ====
  function createStatusIcon(color) {
    return L.divIcon({
      className: "custom-status-marker",
      html: `
        <svg width="28" height="36" viewBox="0 0 24 24"
             xmlns="http://www.w3.org/2000/svg">
          <path fill="${color}"
                d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z"/>
          <circle cx="12" cy="9" r="4" fill="#ffffff" />
        </svg>
      `,
      iconSize: [28, 36],
      iconAnchor: [14, 36],
      popupAnchor: [0, -30]
    });
  }

  function formatStatusStart(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return iso;

    const pad = n => String(n).padStart(2, "0");
    const day = pad(d.getDate());
    const month = pad(d.getMonth() + 1);
    const year = d.getFullYear();
    const hours = pad(d.getHours());
    const minutes = pad(d.getMinutes());

    return `${day}.${month}.${year} ${hours}:${minutes}`;
  }

  // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø–æ–¥ –ø–ª–∏—Ç–∫–∞–º–∏ ====
  (function () {
    const mapEl = document.getElementById("wells-map");
    if (!mapEl) return;

    const tiles = Array.from(document.querySelectorAll(".well-tile"));

    const wells = tiles
      .map(tile => {
        const lat = parseFloat(tile.dataset.lat || "");
        const lon = parseFloat(tile.dataset.lon || "");
        if (isNaN(lat) || isNaN(lon)) return null;

        return {
          lat,
          lon,
          id: tile.dataset.wellId || "",
          name: tile.dataset.name || "",
          statusCss: tile.dataset.statusCss || "",
          status: tile.dataset.status || "",
          statusStart: tile.dataset.statusStart || "",
          statusDays: tile.dataset.statusDays || ""
        };
      })
      .filter(Boolean);

    if (!wells.length) {
      mapEl.innerHTML = "–ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ.";
      return;
    }

    const map = L.map("wells-map", {
      scrollWheelZoom: false
    });
    window.wellsMap = map;
    window.wellMarkers = {};

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const group = L.featureGroup();

    wells.forEach(w => {
      const color = getStatusColor(w.statusCss);
      const icon = createStatusIcon(color);

      const marker = L.marker([w.lat, w.lon], { icon });

      let popupHtml = `${w.name}<br>`;

      if (w.status) {
        popupHtml += `–°—Ç–∞—Ç—É—Å: ${w.status}<br>`;
        if (w.statusStart) {
          popupHtml += `—Å ${formatStatusStart(w.statusStart)}`;
        }
        if (w.statusDays) {
          popupHtml += ` ¬∑ ${w.statusDays} —Å—É—Ç.`;
        }
        popupHtml += "<br>";
      }

      popupHtml += `lat: ${w.lat.toFixed(5)}, lon: ${w.lon.toFixed(5)}`;

      if (w.id) {
        popupHtml +=
          `<br><a href="/well/${w.id}" target="_blank">` +
          `–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∫–≤–∞–∂–∏–Ω—ã</a>`;
      }

      marker.bindPopup(popupHtml);

      marker.bindTooltip(w.name, {
        direction: "top",
        offset: [0, -5]
      });

      group.addLayer(marker);

      if (w.id) {
        window.wellMarkers[w.id] = marker;
      }
    });

    group.addTo(map);
    try {
      map.fitBounds(group.getBounds().pad(0.2));
    } catch (e) {
      const first = wells[0];
      map.setView([first.lat, first.lon], 11);
    }
  })();

  document.addEventListener("DOMContentLoaded", () => {
    initStatusFilter();

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è details: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–¥–Ω–æ–≥–æ ‚Äî
    // –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å —Ç–∞–∫–æ–π –∂–µ (–ø–æ –∏–Ω–¥–µ–∫—Å—É –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏) —É –≤—Å–µ—Ö —Å–∫–≤–∞–∂–∏–Ω
    document.querySelectorAll('.well-tile__stats-details').forEach(det => {
      det.addEventListener('toggle', function() {
        const tile = this.closest('.well-tile');
        if (!tile) return;
        const allInTile = Array.from(tile.querySelectorAll('.well-tile__stats-details'));
        const idx = allInTile.indexOf(this);
        const isOpen = this.open;
        document.querySelectorAll('.well-tile').forEach(other => {
          const otherDetails = other.querySelectorAll('.well-tile__stats-details');
          if (otherDetails[idx] && otherDetails[idx] !== this) {
            otherDetails[idx].open = isOpen;
          }
        });
      });
    });

    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è: –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏/–∑–∞–∫—Ä—ã—Ç–∏–∏ –æ–¥–Ω–æ–≥–æ ‚Äî
    // –æ—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å —É –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
    document.querySelectorAll('.well-equipment-details').forEach(det => {
      det.addEventListener('toggle', function() {
        const isOpen = this.open;
        document.querySelectorAll('.well-equipment-details').forEach(other => {
          if (other !== this) {
            other.open = isOpen;
          }
        });
      });
    });
  });
</script>


{#
  –ì–†–ê–§–Ü–ö –¢–ê–ô–ú–õ–ê–ô–ù–£ –î–õ–Ø VISUAL.HTML - –§–Ü–ù–ê–õ–¨–ù–ê –í–ï–†–°–Ü–Ø
  –í—Å—Ç–∞–≤–∏—Ç–∏ —Ü–µ–π –∫–æ–¥ –ü–ï–†–ï–î {% endblock %} –≤ visual.html
#}

{# ==================== –¢–ê–ô–ú–õ–ê–ô–ù: –ü–û–î–Ü–á –¢–ê –í–ë–†–û–°–ò ==================== #}

<div class="tl-card">
    <div class="card-header">
        <div class="tl-header-row">
            <div>
                <h2>üìä –ì—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º</h2>
                <small class="tl-subtitle">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–ª–∞–π–Ω –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π</small>
            </div>
            <div class="tl-header-controls">
                <label>
                    <input type="checkbox" id="showGridLines" onchange="toggleGridLines()" checked style="cursor: pointer;">
                    <span>üìê –õ–∏–Ω–∏–∏</span>
                </label>
                <label style="display: flex; align-items: center; gap: 6px;" title="–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–ª–æ—Å —Å—Ç–∞—Ç—É—Å–∞ —Å–∫–≤–∞–∂–∏–Ω">
                    <span>üé® –§–æ–Ω:</span>
                    <input type="range" id="stripeOpacity" min="0" max="40" value="15"
                           style="width: 60px; cursor: pointer;"
                           oninput="updateStripeOpacity(this.value)">
                    <span id="stripeOpacityValue" style="font-size: 11px; min-width: 28px;">15%</span>
                </label>
                <button class="btn btn-secondary" onclick="openColorSettings()">
                    üé® –¶–≤–µ—Ç–∞
                </button>
            </div>
        </div>
    </div>

    <div id="colorModal" class="tl-color-modal">
        <h3>üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤</h3>
        <div id="colorInputs" style="margin: 20px 0;"></div>
        <div class="tl-color-modal__footer">
            <button class="btn btn-primary" onclick="saveColors()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeColorSettings()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="card-body">
        <form method="get" action="/visual" id="periodForm">
            {% for well_id in selected_ids %}
            <input type="hidden" name="selected" value="{{ well_id }}">
            {% endfor %}

            <input type="hidden" name="tl_period" id="tl_period_input" value="{{ timeline_filters.period }}">

            <div class="tl-period-bar">
                <div class="tl-period-bar__title">üìÖ –ü–µ—Ä–∏–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                <div class="tl-period-bar__buttons">
                    <button type="button" class="btn-period {% if timeline_filters.period == '1d' %}active{% endif %}" data-period="1d" onclick="setPeriod('1d')">
                        üìÜ –°—É—Ç–∫–∏
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '3d' or not timeline_filters.period %}active{% endif %}" data-period="3d" onclick="setPeriod('3d')">
                        üìÜ 3 —Å—É—Ç–æ–∫
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '1w' %}active{% endif %}" data-period="1w" onclick="setPeriod('1w')">
                        üìÜ –ù–µ–¥–µ–ª—è
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '1m' %}active{% endif %}" data-period="1m" onclick="setPeriod('1m')">
                        üìÜ –ú–µ—Å—è—Ü
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == 'custom' %}active{% endif %}" data-period="custom" onclick="setPeriod('custom')">
                        üìÜ –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥
                    </button>

                    <div id="customDatesRow" class="tl-custom-dates" style="{% if timeline_filters.period != 'custom' %}display: none;{% endif %}">
                        <label>–û—Ç:</label>
                        <input type="date" name="tl_date_from" id="date_from" class="input-date" value="{{ timeline_filters.date_from }}">
                        <label>–î–æ:</label>
                        <input type="date" name="tl_date_to" id="date_to" class="input-date" value="{{ timeline_filters.date_to }}">
                        <button type="button" class="btn-apply-dates" onclick="submitCustomDates()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </form>

        <div class="tl-chart-box">
            <div class="tl-chart-controls" style="display:flex;gap:8px;align-items:center;">
                <button onclick="resetZoom()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                    üè† –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞
                </button>
            </div>

            <div class="tl-chart-area">
                <canvas id="chart_timeline"></canvas>
            </div>

            <div class="tl-chart-hints">
                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong>
                –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à—å—é –¥–ª—è ZOOM ‚Ä¢
                –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ –º–∞—Å—à—Ç–∞–±–∞ ‚Ä¢
                –ö–Ω–æ–ø–∫–∞ "üè† –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞" —Ç–∞–∫–∂–µ —Å–±—Ä–æ—Å–∏—Ç –º–∞—Å—à—Ç–∞–± ‚Ä¢
                Shift + –ø–µ—Ä–µ—Ç—è–≥–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚Ä¢
                –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
            </div>
        </div>

        {# –õ–µ–≥–µ–Ω–¥–∞ ‚Äî –ø–æ–¥ –≥—Ä–∞—Ñ–∏–∫–æ–º #}
        <div class="tl-legends-grid">
            <div class="legend-card">
                <div class="legend-header">üíâ –†–µ–∞–≥–µ–Ω—Ç—ã</div>
                <div class="legend-btn-row">
                    <button class="btn-legend btn-legend-all" onclick="selectAllReagents(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllReagents(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_reagents" class="legend-items"></div>
            </div>

            <div class="legend-card">
                <div class="legend-header">üìå –°–æ–±—ã—Ç–∏—è</div>
                <div class="legend-btn-row">
                    <button class="btn-legend btn-legend-all" onclick="selectAllEvents(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllEvents(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_events" class="legend-items"></div>
            </div>

            <div class="legend-card">
                <div class="legend-header">üìä –°—Ç–∞—Ç—É—Å—ã</div>
                <div class="legend-btn-row">
                    <button class="btn-legend btn-legend-all" onclick="selectAllStatuses(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllStatuses(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_statuses" class="legend-items"></div>
            </div>
        </div>

        <div class="legend-card" style="margin-top: 10px;">
            <div class="legend-header">üéØ –°–∫–≤–∞–∂–∏–Ω—ã</div>
            <div class="legend-btn-row">
                <button class="btn-legend btn-legend-all" onclick="selectAllWellsTimeline(true)">‚úì –í—Å–µ</button>
                <button class="btn-legend btn-legend-none" onclick="selectAllWellsTimeline(false)">‚úó –ù–∏—á–µ–≥–æ</button>
            </div>
            <div id="legend_wells" class="legend-items" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px;"></div>
        </div>
    </div>
</div>

{# JS-–¥–∞–Ω—ñ –¥–ª—è Chart.js #}
<script>
window.reagentsData = {
    timelineInjections: {{ timeline_injections | tojson | safe }},
    timelineEvents: {{ timeline_events | tojson | safe }},
    reagentColors: {{ timeline_reagent_colors | tojson | safe }},
    eventColors: {{ timeline_event_colors | tojson | safe }},
    wellStatuses: {{ timeline_well_statuses | tojson | safe }},
    statusColors: {{ timeline_status_colors | tojson | safe }},
};
</script>

{# Chart.js –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>

<script src="/static/js/visual_timeline.js"></script>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏–π —Å Pi
async function refreshPressureDashboard() {
  const btn = document.getElementById('btn-refresh-pressure-dashboard');
  const icon = document.getElementById('refresh-pressure-icon');
  if (!btn || !icon) return;

  btn.disabled = true;
  btn.classList.add('loading');
  btn.style.opacity = '0.6';

  try {
    const r = await fetch('/api/pressure/refresh', {method: 'POST'});
    const data = await r.json();
    if (data.status === 'ok') {
      btn.style.background = '#d1fae5';
      btn.textContent = '‚úì –ì–æ—Ç–æ–≤–æ!';
      setTimeout(() => {
        btn.innerHTML = '<span id="refresh-pressure-icon">&#8635;</span> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–≤–ª–µ–Ω–∏—è';
        btn.style.background = '';
        btn.classList.remove('loading');
      }, 2000);
    } else {
      alert(data.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      btn.classList.remove('loading');
    }
  } catch(e) {
    alert('–û—à–∏–±–∫–∞: ' + e.message);
    btn.classList.remove('loading');
  } finally {
    btn.disabled = false;
    btn.style.opacity = '1';
  }
}
</script>

<style>
/* Period buttons */
.btn-period {
    padding: 6px 14px; border: 1px solid #e2e8f0; background: #fff;
    border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;
    transition: all 0.15s; color: #475569;
}
.btn-period:hover { border-color: #93c5fd; color: #2563eb; }
.btn-period.active { background: #3b82f6; color: #fff; border-color: #3b82f6; }

/* Date inputs */
.input-date { padding: 5px 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 13px; background: #fff; color: #1e293b; }
.input-date:focus { border-color: #3b82f6; outline: none; box-shadow: 0 0 0 2px rgba(59,130,246,0.12); }
.btn-apply-dates {
    padding: 5px 12px; background: #16a34a; color: #fff; border: none;
    border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer;
    margin-left: 6px; transition: all 0.15s;
}
.btn-apply-dates:hover { background: #15803d; }

/* Legend items */
.legend-items { max-height: 250px; overflow-y: auto; font-size: 13px; }
.legend-items > div { margin-bottom: 1px !important; padding: 3px 8px !important; }

/* Legend buttons */
.btn-legend {
    padding: 3px 8px; font-size: 11px; border: 1px solid transparent;
    border-radius: 4px; cursor: pointer; font-weight: 600; transition: all 0.15s;
}
.btn-legend-all { background: #dcfce7; color: #16a34a; border-color: #bbf7d0; }
.btn-legend-all:hover { background: #bbf7d0; }
.btn-legend-none { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
.btn-legend-none:hover { background: #fecaca; }

/* Generic buttons */
.btn {
    padding: 6px 14px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.15s;
}
.btn.btn-primary { background: #3b82f6; color: #fff; }
.btn.btn-primary:hover { background: #2563eb; }
.btn.btn-secondary { background: #fff; border: 1px solid #e2e8f0; color: #64748b; }
.btn.btn-secondary:hover { border-color: #3b82f6; color: #3b82f6; }
</style>
{% endblock %}