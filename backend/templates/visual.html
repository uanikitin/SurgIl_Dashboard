{% extends "base.html" %}

{% block title %}–°–£–†–ì–ò–õ ¬∑ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–≤–∞–∂–∏–Ω{% endblock %}

{% block extra_head %}
<link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
>
{% endblock %}

{% block content %}
<nav class="top-nav">
  <div class="top-nav-inner">
    <a href="/visual" class="top-nav-item active">üìä –î–∞—à–±–æ—Ä–¥</a>
    <a href="/documents" class="top-nav-item">üìÑ –ê–∫—Ç—ã</a>
    <a href="/admin/reagents" class="top-nav-item">üß™ –†–µ–∞–≥–µ–Ω—Ç—ã</a>
    <a href="/equipment" class="top-nav-item">‚öôÔ∏è –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</a>
    <a href="/admin/users" class="top-nav-item">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a>
  </div>
</nav>

<!-- ===== –î–ù–ï–í–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===== -->
{% set ds = daily_stats %}
<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:0 0 16px 0; max-width:100%;">

  {% for period, label in [('today', '–°–µ–≥–æ–¥–Ω—è ¬∑ ' ~ ds.today_label), ('yesterday', '–í—á–µ—Ä–∞ ¬∑ ' ~ ds.yesterday_label)] %}
  {% set s = ds[period] %}
  <div style="background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:16px; {% if period == 'yesterday' %}opacity:0.85;{% endif %}">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <span style="font-weight:700; font-size:15px;">{{ label }}</span>
      <span style="background:#f0f0f0; padding:3px 10px; border-radius:12px; font-size:12px; font-weight:600;">{{ s.total }} —Å–æ–±—ã—Ç–∏–π</span>
    </div>

    <div style="font-size:13px; margin-bottom:10px; color:#333; background:#fffbe6; padding:6px 10px; border-radius:6px; border-left:3px solid #ffc107;">
      <b>{{ s.active_wells_count }}</b> —Å–∫–≤–∞–∂–∏–Ω
      {% if s.status_summary %}
        {% for st2, wl2 in s.status_summary.items() if st2 not in ['–ë–µ–∑ —Å—Ç–∞—Ç—É—Å–∞', '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è'] %}
          ¬∑ {{ st2 }} <b>{{ wl2|length }}</b>
        {% endfor %}
      {% endif %}
    </div>

    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:8px; margin-bottom:12px;">
      <div style="text-align:center; padding:8px; background:#e7f3ff; border-radius:8px;">
        <div style="font-size:22px; font-weight:700; color:#007bff;">{{ s.pressure }}</div>
        <div style="font-size:11px; opacity:0.7;">–ó–∞–º–µ—Ä–æ–≤</div>
      </div>
      <div style="text-align:center; padding:8px; background:#fff3cd; border-radius:8px;">
        <div style="font-size:22px; font-weight:700; color:#856404;">{{ s.purge_count }}</div>
        <div style="font-size:11px; opacity:0.7;">–ü—Ä–æ–¥—É–≤–æ–∫</div>
      </div>
      <div style="text-align:center; padding:8px; background:#d4edda; border-radius:8px;">
        <div style="font-size:22px; font-weight:700; color:#155724;">{{ s.reagent }}</div>
        <div style="font-size:11px; opacity:0.7;">–í–±—Ä–æ—Å–æ–≤</div>
      </div>
      <div style="text-align:center; padding:8px; background:#fde8e8; border-radius:8px;">
        <div style="font-size:22px; font-weight:700; color:#721c24;">{{ "%.1f"|format(s.reagent_qty) }}</div>
        <div style="font-size:11px; opacity:0.7;">—à—Ç —Ä–µ–∞–≥–µ–Ω—Ç–∞</div>
      </div>
    </div>

    {% if s.reagent_wells %}
    <details style="margin-bottom:8px;">
      <summary style="cursor:pointer; font-size:12px; font-weight:600; color:#155724;">–†–µ–∞–≥–µ–Ω—Ç –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º ({{ s.reagent_wells|length }})</summary>
      <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:6px;">
        {% for well_num, qty in s.reagent_wells.items() %}
        <span style="background:#d4edda; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;">{{ well_num }}: {{ "%.1f"|format(qty|float) }} —à—Ç</span>
        {% endfor %}
      </div>
      {% if s.reagent_well_details %}
      <details style="margin-top:6px;">
        <summary style="cursor:pointer; font-size:11px; opacity:0.7;">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</summary>
        <table style="margin-top:4px; font-size:11px; border-collapse:collapse; width:100%;">
          <tr style="opacity:0.6;"><td style="padding:2px 6px;"><b>–°–∫–≤</b></td><td style="padding:2px 6px;"><b>–†–µ–∞–≥–µ–Ω—Ç</b></td><td style="padding:2px 6px; text-align:right;"><b>–ö–æ–ª-–≤–æ</b></td></tr>
          {% for d in s.reagent_well_details %}
          <tr style="border-top:1px solid #eee;">
            <td style="padding:2px 6px; font-weight:600;">{{ d.well }}</td>
            <td style="padding:2px 6px;">{{ d.reagent }}</td>
            <td style="padding:2px 6px; text-align:right;">{{ "%.1f"|format(d.qty) }} —à—Ç</td>
          </tr>
          {% endfor %}
        </table>
      </details>
      {% endif %}
    </details>
    {% endif %}

    {% if s.reagent_by_name %}
    <details style="margin-bottom:8px;">
      <summary style="cursor:pointer; font-size:12px; font-weight:600; color:#0066cc;">–ü–æ —Ç–∏–ø—É —Ä–µ–∞–≥–µ–Ω—Ç–∞</summary>
      <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:6px;">
        {% for rname, qty in s.reagent_by_name.items() %}
        <span style="background:#e7f3ff; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;">{{ rname }}: {{ "%.1f"|format(qty|float) }} —à—Ç</span>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.pressure_wells %}
    <details style="margin-bottom:8px;">
      <summary style="cursor:pointer; font-size:12px; font-weight:600; color:#007bff;">–ó–∞–º–µ—Ä—ã –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–∞—Ö ({{ s.pressure_wells|length }})</summary>
      <div style="display:flex; flex-wrap:wrap; gap:4px; margin-top:6px;">
        {% for wn in s.pressure_wells %}
        <span style="background:#e7f3ff; padding:2px 8px; border-radius:10px; font-size:11px;">{{ wn }}</span>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.purge_count %}
    <details>
      <summary style="cursor:pointer; font-size:12px; font-weight:600; color:#856404;">
        –ü—Ä–æ–¥—É–≤–∫–∏: {{ s.purge_by_type.get('—Å–∫–≤–∞–∂–∏–Ω–∞',0) }} —Å–∫–≤ ¬∑ {{ s.purge_by_type.get('—à—Ç—É—Ü–µ—Ä',0) }} —à—Ç—É—Ü ¬∑ {{ s.purge_by_type.get('–º–∞–Ω–æ–º–µ—Ç—Ä',0) }} –º–∞–Ω–æ–º
        {% if s.purge_incomplete %}<span style="color:#dc3545;"> ({{ s.purge_incomplete }} –Ω–µ–ø–æ–ª–Ω.)</span>{% endif %}
      </summary>
      <div style="margin-top:6px; font-size:11px;">
        {% for d in s.purge_details %}
        <div style="display:inline-block; background:{% if d.complete %}#fff3cd{% else %}#fde8e8{% endif %}; padding:2px 8px; border-radius:10px; margin:2px;">
          {{ d.well }} ¬∑ {{ d.type }} ¬∑ {{ d.phases }} {% if not d.complete %}‚ö†{% endif %}
        </div>
        {% endfor %}
      </div>
    </details>
    {% endif %}

    {% if s.total == 0 %}
    <div style="text-align:center; opacity:0.5; font-size:13px; padding:8px;">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<div class="page-header">
    <h1>–°–∫–≤–∞–∂–∏–Ω—ã</h1>
</div>

<div class="visual-layout">
    {# ===== –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ø–∞–Ω–µ–ª—å –≤—ã–±–æ—Ä–∞ —Å–∫–≤–∞–∂–∏–Ω ===== #}
    <aside class="visual-sidebar">
        <h2>–í—ã–±–æ—Ä —Å–∫–≤–∞–∂–∏–Ω</h2>

        <div class="well-search">
            <input
                type="text"
                id="well-search-input"
                placeholder="–ü–æ–∏—Å–∫: 1367, 131, ID –∏–ª–∏ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è..."
                oninput="filterWellCheckboxes()"
            >
        </div>

        <div class="status-filter">
            <label class="status-filter__label" style="margin-bottom:8px; display:block;">
                –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É
            </label>

            <div id="status-checkboxes" style="display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px;">
              {% set status_opts = [
                  ('status-watch', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ',      '#17a2b8'),
                  ('status-adapt', '–ê–¥–∞–ø—Ç–∞—Ü–∏—è',       '#28a745'),
                  ('status-opt',   '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è',     '#007bff'),
                  ('status-dev',   '–û—Å–≤–æ–µ–Ω–∏–µ',        '#6f42c1'),
                  ('status-off',   '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è','#dc3545'),
                  ('status-idle',  '–ü—Ä–æ—Å—Ç–æ–π',         '#ffc107'),
                  ('status-other', '–î—Ä—É–≥–æ–µ',          '#6c757d'),
              ] %}
              {% for code, label, color in status_opts %}
              <label class="status-chip" data-status="{{ code }}"
                     style="display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:16px;
                            border:2px solid {{ color }}; cursor:pointer; font-size:12px; font-weight:600;
                            user-select:none; transition:all .15s;">
                <input type="checkbox" class="status-cb" value="{{ code }}"
                       {% if code != 'status-off' %}checked{% endif %}
                       style="display:none;"
                       onchange="onStatusFilterChange()">
                <span class="chip-dot" style="width:8px; height:8px; border-radius:50%; background:{{ color }};"></span>
                {{ label }}
              </label>
              {% endfor %}
            </div>

            <div style="display:flex; gap:6px; margin-bottom:8px;">
              <button type="button" onclick="setAllStatuses(true)"  class="btn-secondary" style="font-size:11px; padding:3px 8px;">–í—Å–µ</button>
              <button type="button" onclick="setAllStatuses(false)" class="btn-secondary" style="font-size:11px; padding:3px 8px;">–ù–∏ –æ–¥–Ω–æ–≥–æ</button>
              <button type="button" onclick="selectWellsByStatuses()" class="btn-secondary" style="font-size:11px; padding:3px 8px;">–í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</button>
              <button type="button" onclick="deselectWellsByStatuses()" class="btn-secondary" style="font-size:11px; padding:3px 8px;">–°–Ω—è—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</button>
            </div>

            <div class="status-filter__hint" style="font-size:11px; opacity:0.6;">
                ¬´–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è¬ª —Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û—Ç–º–µ—Ç—å—Ç–µ –Ω—É–∂–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã¬ª.
            </div>
        </div>

        <form method="get" action="/visual" class="well-filter-form">
            <div class="well-checkbox-list">

                {# --- –ø–æ—Ä—è–¥–æ–∫ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å-–≥—Ä—É–ø–ø --- #}
                {% set status_groups = [
                    ('status-watch', '–ù–∞–±–ª—é–¥–µ–Ω–∏–µ'),
                    ('status-adapt', '–ê–¥–∞–ø—Ç–∞—Ü–∏—è'),
                    ('status-opt',   '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è'),
                    ('status-dev',   '–û—Å–≤–æ–µ–Ω–∏–µ'),
                    ('status-off',   '–ù–µ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç—Å—è'),
                    ('status-idle',  '–ü—Ä–æ—Å—Ç–æ–π'),
                    ('status-other', '–î—Ä—É–≥–æ–µ')
                ] %}

                {# --- —Å–Ω–∞—á–∞–ª–∞ –≥—Ä—É–ø–ø—ã —Å –∑–∞–¥–∞–Ω–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º --- #}
                {% for css_code, title in status_groups %}
                    {% set ns = namespace(have=false) %}
                    {% for w in all_wells %}
                        {% if w.current_status_css == css_code %}
                            {% if not ns.have %}
                                <div class="status-group">
                                    <div class="status-group__header">{{ title }}</div>
                                    {% set ns.have = true %}
                            {% endif %}

                            <label
                                class="well-checkbox-item {{ w.current_status_css or '' }}"
                                data-label="{{ (w.number or w.id)|string }} {{ w.name or '' }} {{ w.current_status or '' }}"
                                data-status-css="{{ w.current_status_css or '' }}"
                            >
                                <input
                                    type="checkbox"
                                    name="selected"
                                    value="{{ w.id }}"
                                    {% if w.id in selected_ids %}checked{% endif %}
                                >
                                <span class="well-checkbox-name">
                                    –°–∫–≤ {{ w.number or w.id }}
                                </span>
                                <span class="well-checkbox-status">
                                    {% if w.current_status %}
                                        ¬∑ {{ w.current_status }}
                                    {% else %}
                                        ¬∑ —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                                    {% endif %}
                                </span>
                            </label>
                        {% endif %}
                    {% endfor %}
                    {% if ns.have %}
                        </div> {# –∑–∞–∫—Ä—ã–≤–∞–µ–º .status-group #}
                    {% endif %}
                {% endfor %}

                {# --- –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ "–°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω" --- #}
                {% set ns = namespace(have=false) %}
                {% for w in all_wells %}
                    {% if not w.current_status_css %}
                        {% if not ns.have %}
                            <div class="status-group">
                                <div class="status-group__header">–°—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω</div>
                                {% set ns.have = true %}
                        {% endif %}

                        <label
                            class="well-checkbox-item"
                            data-label="{{ (w.number or w.id)|string }} {{ w.name or '' }}"
                            data-status-css=""
                        >
                            <input
                                type="checkbox"
                                name="selected"
                                value="{{ w.id }}"
                                {% if w.id in selected_ids %}checked{% endif %}
                            >
                            <span class="well-checkbox-name">
                                –°–∫–≤ {{ w.number or w.id }}
                            </span>
                            <span class="well-checkbox-status">
                                ¬∑ —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                            </span>
                        </label>
                    {% endif %}
                {% endfor %}
                {% if ns.have %}
                    </div>
                {% endif %}
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                </button>
                <a href="/visual" class="btn-secondary">
                    –°–±—Ä–æ—Å–∏—Ç—å –≤—ã–±–æ—Ä
                </a>
            </div>
        </form>
    </aside>

    {# ===== –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨: –ø–ª–∏—Ç–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω ===== #}
    <section class="tiles-grid">
        {% if wells %}
            {% for w in wells %}
                <article
                    class="well-tile"
                    data-well-id="{{ w.id }}"
                    data-lat="{{ w.lat or '' }}"
                    data-lon="{{ w.lon or '' }}"
                    data-name="–°–∫–≤ {{ w.number or w.id }}"
                    data-status="{{ w.current_status or '' }}"
                    data-status-css="{{ w.current_status_css or '' }}"
                    data-status-start="{{ w.current_status_start.isoformat() if w.current_status_start else '' }}"
                    data-status-days="{{ w.current_status_days or '' }}"
                >
<header class="well-tile__header">
    <div class="well-header-grid">
        {# ==== –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–ö–í–ê–ñ–ò–ù–ê + ID ==== #}
        <div class="well-header-col well-header-col--left">
            <div class="well-header-badge well-header-badge--well well-name-badge {{ w.current_status_css or '' }}">
                <span class="well-header-badge-line">–°–∫–≤</span>
                <span class="well-header-badge-line">{{ w.number or w.id }}</span>
            </div>
            <div class="well-header-meta">
                ID: {{ w.id }}
            </div>
        </div>

        {# ==== –¶–ï–ù–¢–†–ê–õ–¨–ù–ê–Ø –ö–û–õ–û–ù–ö–ê: –°–¢–ê–¢–£–° + –î–ê–¢–ê + –°–£–¢–ö–ò ==== #}
        <div class="well-header-col well-header-col--center">
            {% if w.current_status %}
                <div class="well-header-badge well-header-badge--status status-badge {{ w.current_status_css or '' }}">
                    {{ w.current_status }}
                </div>
                <div class="well-header-meta well-header-meta--status">
                    {% if w.current_status_start %}
                        c {{ w.current_status_start.strftime("%d.%m.%Y %H:%M") }}<br>
                    {% endif %}
                    {% if w.current_status_days is not none %}
                        <strong>{{ "%.1f"|format(w.current_status_days) }}</strong> —Å—É—Ç.
                    {% endif %}
                </div>
            {% else %}
                <div class="well-header-badge well-header-badge--status well-header-badge--empty">
                    —Å—Ç–∞—Ç—É—Å –Ω–µ –∑–∞–¥–∞–Ω
                </div>
            {% endif %}
        </div>

              {# ==== –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –ö–ê–ù–ê–õ –°–í–Ø–ó–ò ==== #}
        <div class="well-header-col well-header-col--right">
            {% if w.current_channel %}
                <div class="well-header-badge well-header-badge--channel well-name-badge">
                    <span class="well-header-badge-line">–ö–∞–Ω–∞–ª</span>
                    <span class="well-header-badge-line">{{ w.current_channel }}</span>
                </div>

                {# –ò–∫–æ–Ω–∫–∞ –ø–æ–¥ –ø–ª–∏—Ç–∫–æ–π –∫–∞–Ω–∞–ª–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–∞–Ω–∞–ª –µ—Å—Ç—å) #}
                <div class="channel-icon-wrapper">
                    <img
                        src="{{ url_for('static', path='icons/pngegg-2.png') }}"
                        class="channel-icon"
                        alt="–ö–∞–Ω–∞–ª —Å–≤—è–∑–∏"
                    >
                </div>
            {% else %}
                {# –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –±–µ–∑ –∏–∫–æ–Ω–∫–∏, —á—Ç–æ–±—ã –≤—ã—Å–æ—Ç–∞ –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –ø—Ä—ã–≥–∞–ª–∞ #}
                <div class="well-header-badge well-header-badge--channel well-name-badge well-header-badge--empty">
                    <span class="well-header-badge-line">–ö–∞–Ω–∞–ª</span>
                    <span class="well-header-badge-line">‚Äî</span>
                </div>
            {% endif %}
        </div>
</header>

                    <div class="well-tile__coords">
    {% if w.lat is not none and w.lon is not none %}
        –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ "%.6f"|format(w.lat) }}, {{ "%.6f"|format(w.lon) }}
    {% else %}
        –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –∑–∞–¥–∞–Ω—ã
    {% endif %}
</div>
{# ==== –ë–õ–û–ö –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø –ù–ê –ü–õ–ò–¢–ö–ï ==== #}
<div class="well-equipment-box">
    <div class="equipment-title">
        –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
    </div>

    {% if w.equipment_active %}
        <div class="equipment-badges">
            {% for eq in w.equipment_active %}
                {% set config = eq.config %}
                <div class="equipment-badge"
                     style="border-color: {{ config.border_color }}; background: {{ config.background_gradient }};"
                     title="{{ config.label }}
{% if eq.model %}–ú–æ–¥–µ–ª—å: {{ eq.model }}{% endif %}
{% if eq.serial %}–°–µ—Ä–∏–π–Ω—ã–π: {{ eq.serial }}{% endif %}
{% if eq.installation_location %}–ú–µ—Å—Ç–æ: {{ eq.installation_location }}{% endif %}
{% if eq.installation_date %}–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {{ eq.installation_date.strftime('%d.%m.%Y') }}{% endif %}">
                    <img
                        src="{{ config.icon }}"
                        class="equipment-icon"
                        alt="{{ config.label }}"
                        onerror="this.src='/static/icons/default.png'"
                    >
                    <div class="equipment-info">
                        <div class="equipment-label" style="color: {{ config.color }};">
                            {{ config.short or config.label }}
                        </div>
                        {% if eq.installation_location %}
                            <div class="equipment-location">
                                <small>{{ eq.installation_location|truncate(15) }}</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="equipment-empty muted">
            –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
        </div>
    {% endif %}
</div>

                    <div class="well-tile__description">
                        {{ w.description or "–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–¥–∞–Ω–æ" }}
                    </div>

                         <div class="well-tile__stats">
                            {# ---- –°–ï–ì–û–î–ù–Ø ---- #}
                            <div class="well-tile__stats-row">
                                <span>–°–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è:</span>
                                <strong>{{ w.events_today_total or 0 }}</strong>
                            </div>

                            {# –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –ë–î) #}
                            <div class="well-tile__stats-row">
                                <span class="muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ:</span>
                                <span class="muted">
                                    {{ updated_at.strftime("%d.%m.%Y %H:%M:%S") }}
                                </span>
                            </div>

                            <div class="well-tile__stats-row">
                                <span>–í–±—Ä–æ—Å—ã —Ä–µ–∞–≥–µ–Ω—Ç–∞ (—Å–µ–≥–æ–¥–Ω—è):</span>
                                <strong>{{ w.events_today_reagents or 0 }}</strong>
                                {% if w.events_today_reagent_qty is not none %}
                                    <span class="muted">
                                        ({{ "%.1f"|format(w.events_today_reagent_qty or 0.0) }} —à—Ç)
                                    </span>
                                {% endif %}
                            </div>

                            <div class="well-tile__stats-row">
                                <span>–ó–∞–º–µ—Ä—ã –¥–∞–≤–ª–µ–Ω–∏—è (—Å–µ–≥–æ–¥–Ω—è):</span>
                                <strong>{{ w.events_today_pressure or 0 }}</strong>
                            </div>

                            <div class="well-tile__stats-row">
                                <span>–¢–∏–ø—ã —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ (—Å–µ–≥–æ–¥–Ω—è):</span>
                                <strong>{{ w.events_today_reagent_types or "‚Äî" }}</strong>
                            </div>

                            {# ---- –†–ê–ó–î–ï–õ–ò–¢–ï–õ–¨ ---- #}
                            <hr style="border:0; border-top:1px solid #eee; margin: 6px 0;">

                            {# ---- –í–ß–ï–†–ê ---- #}
                            <div class="well-tile__stats-row">
                                <span>–°–æ–±—ã—Ç–∏—è –∑–∞ –≤—á–µ—Ä–∞:</span>
                                <strong>{{ w.events_yesterday_total or 0 }}</strong>
                            </div>

                            <div class="well-tile__stats-row">
                                <span>–¢–∏–ø—ã —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ –∑–∞ –≤—á–µ—Ä–∞:</span>
                                <strong>{{ w.events_yesterday_reagent_types or "‚Äî" }}</strong>
                            </div>
                        </div>

                    <footer class="well-tile__footer">
                        <button type="button" onclick="openWellPage({{ w.id }})">
                            –û—Ç–∫—Ä—ã—Ç—å —Å–∫–≤–∞–∂–∏–Ω—É
                        </button>
                    </footer>
                </article>
            {% endfor %}
        {% else %}
            <p>
                –ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.
                –û—Ç–º–µ—Ç—å –Ω—É–∂–Ω—ã–µ —Å–ª–µ–≤–∞ –∏ –Ω–∞–∂–º–∏ ¬´–ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ¬ª.
            </p>
        {% endif %}
    </section>
</div>

{# ===== –ë–õ–û–ö –ö–ê–†–¢–´ –ü–û–î –ü–õ–ò–¢–ö–ê–ú–ò ===== #}
<div class="map-block">
    <h2>–ö–∞—Ä—Ç–∞ —Å–∫–≤–∞–∂–∏–Ω</h2>

    <div id="map-status-summary" class="map-status-summary"></div>

    <div id="wells-map"></div>
</div>

{% endblock %}

{% block extra_scripts %}
<script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
></script>

<script>
  // ==== –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∫–≤–∞–∂–∏–Ω—ã –∏–∑ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ø–ª–∏—Ç–∫–µ ====
  function openWellPage(id) {
    if (!id) return;
    window.location.href = "/well/" + id;
  }

  // ==== –§–∏–ª—å—Ç—Ä —á–µ–∫–±–æ–∫—Å–æ–≤ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø–æ–∏—Å–∫–∞ (+ —É—á—ë—Ç —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞) ====
  function filterWellCheckboxes() {
    const input = document.getElementById("well-search-input");
    const term = (input?.value || "").toLowerCase().trim();
    const activeStatuses = new Set(getActiveStatuses());
    const items = document.querySelectorAll(".well-checkbox-item");

    items.forEach(item => {
      const label = (item.dataset.label || "").toLowerCase();
      const st = item.dataset.statusCss || '';
      const matchSearch = !term || label.includes(term);
      const matchStatus = activeStatuses.size === 0 || activeStatuses.has(st);
      item.style.display = (matchSearch && matchStatus) ? "" : "none";
    });
    // –û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å –≥—Ä—É–ø–ø
    document.querySelectorAll('.status-group').forEach(group => {
      const any = Array.from(group.querySelectorAll('.well-checkbox-item')).some(i => i.style.display !== 'none');
      group.style.display = any ? '' : 'none';
    });
  }

  // ==== –ú—É–ª—å—Ç–∏—Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º ====

  const STATUS_FILTER_KEY = "surgil_status_filter_multi";

  function getActiveStatuses() {
    return Array.from(document.querySelectorAll('.status-cb:checked')).map(cb => cb.value);
  }

  function saveStatusFilterToStorage() {
    try { localStorage.setItem(STATUS_FILTER_KEY, JSON.stringify(getActiveStatuses())); } catch(e) {}
  }

  function loadStatusFilterFromStorage() {
    try {
      const raw = localStorage.getItem(STATUS_FILTER_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch(e) { return null; }
  }

  function onStatusFilterChange() {
    saveStatusFilterToStorage();
    updateChipStyles();
    applyStatusFilter();
  }

  function updateChipStyles() {
    document.querySelectorAll('.status-chip').forEach(chip => {
      const cb = chip.querySelector('.status-cb');
      chip.style.opacity = cb.checked ? '1' : '0.35';
      chip.style.background = cb.checked ? '' : '#f0f0f0';
    });
  }

  function setAllStatuses(on) {
    document.querySelectorAll('.status-cb').forEach(cb => cb.checked = on);
    onStatusFilterChange();
  }

  // –í—ã–±—Ä–∞—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã, —á–µ–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ—á–µ–Ω
  function selectWellsByStatuses() {
    const active = new Set(getActiveStatuses());
    document.querySelectorAll('.well-checkbox-item').forEach(item => {
      const st = item.dataset.statusCss || '';
      const cb = item.querySelector('input[type="checkbox"]');
      if (cb && active.has(st)) cb.checked = true;
    });
  }

  // –°–Ω—è—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã, —á–µ–π —Å—Ç–∞—Ç—É—Å –æ—Ç–º–µ—á–µ–Ω
  function deselectWellsByStatuses() {
    const active = new Set(getActiveStatuses());
    document.querySelectorAll('.well-checkbox-item').forEach(item => {
      const st = item.dataset.statusCss || '';
      const cb = item.querySelector('input[type="checkbox"]');
      if (cb && active.has(st)) cb.checked = false;
    });
  }

  function applyStatusFilter() {
    const active = new Set(getActiveStatuses());
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–ª–∏—Ç–∫–∏
    document.querySelectorAll('.well-tile').forEach(tile => {
      const css = tile.dataset.statusCss || '';
      tile.style.display = active.has(css) ? '' : 'none';
    });
    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–∞–π–¥–±–∞—Ä (—Å —É—á—ë—Ç–æ–º –ø–æ–∏—Å–∫–∞)
    filterWellCheckboxes();
  }

  function initStatusFilter() {
    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ localStorage
    const stored = loadStatusFilterFromStorage();
    if (stored) {
      const set = new Set(stored);
      document.querySelectorAll('.status-cb').forEach(cb => {
        cb.checked = set.has(cb.value);
      });
    }
    updateChipStyles();
    applyStatusFilter();
  }

  // ==== –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø–æ CSS-–∫–ª–∞—Å—Å—É —á–µ—Ä–µ–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ :root ====
  function getStatusColor(cssCode) {
    const cls =
      (cssCode || "")
        .split(/\s+/)
        .find(c => c.startsWith("status-")) || "status-other";

    const varName = `--${cls}-color`;

    const value = getComputedStyle(document.documentElement)
      .getPropertyValue(varName)
      .trim();

    return value || "#343a40";
  }

  // ==== SVG-–∏–∫–æ–Ω–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –Ω—É–∂–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ ====
  function createStatusIcon(color) {
    return L.divIcon({
      className: "custom-status-marker",
      html: `
        <svg width="28" height="36" viewBox="0 0 24 24"
             xmlns="http://www.w3.org/2000/svg">
          <path fill="${color}"
                d="M12 2C8 2 5 5 5 9c0 5 7 13 7 13s7-8 7-13c0-4-3-7-7-7z"/>
          <circle cx="12" cy="9" r="4" fill="#ffffff" />
        </svg>
      `,
      iconSize: [28, 36],
      iconAnchor: [14, 36],
      popupAnchor: [0, -30]
    });
  }

  function formatStatusStart(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d)) return iso;

    const pad = n => String(n).padStart(2, "0");
    const day = pad(d.getDate());
    const month = pad(d.getMonth() + 1);
    const year = d.getFullYear();
    const hours = pad(d.getHours());
    const minutes = pad(d.getMinutes());

    return `${day}.${month}.${year} ${hours}:${minutes}`;
  }

  // ==== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø–æ–¥ –ø–ª–∏—Ç–∫–∞–º–∏ ====
  (function () {
    const mapEl = document.getElementById("wells-map");
    if (!mapEl) return;

    const tiles = Array.from(document.querySelectorAll(".well-tile"));

    const wells = tiles
      .map(tile => {
        const lat = parseFloat(tile.dataset.lat || "");
        const lon = parseFloat(tile.dataset.lon || "");
        if (isNaN(lat) || isNaN(lon)) return null;

        return {
          lat,
          lon,
          id: tile.dataset.wellId || "",
          name: tile.dataset.name || "",
          statusCss: tile.dataset.statusCss || "",
          status: tile.dataset.status || "",
          statusStart: tile.dataset.statusStart || "",
          statusDays: tile.dataset.statusDays || ""
        };
      })
      .filter(Boolean);

    if (!wells.length) {
      mapEl.innerHTML = "–ù–µ—Ç —Å–∫–≤–∞–∂–∏–Ω —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ.";
      return;
    }

    const map = L.map("wells-map", {
      scrollWheelZoom: false
    });

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    const group = L.featureGroup();

    wells.forEach(w => {
      const color = getStatusColor(w.statusCss);
      const icon = createStatusIcon(color);

      const marker = L.marker([w.lat, w.lon], { icon });

      let popupHtml = `${w.name}<br>`;

      if (w.status) {
        popupHtml += `–°—Ç–∞—Ç—É—Å: ${w.status}<br>`;
        if (w.statusStart) {
          popupHtml += `—Å ${formatStatusStart(w.statusStart)}`;
        }
        if (w.statusDays) {
          popupHtml += ` ¬∑ ${w.statusDays} —Å—É—Ç.`;
        }
        popupHtml += "<br>";
      }

      popupHtml += `lat: ${w.lat.toFixed(5)}, lon: ${w.lon.toFixed(5)}`;

      if (w.id) {
        popupHtml +=
          `<br><a href="/well/${w.id}" target="_blank">` +
          `–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∫–≤–∞–∂–∏–Ω—ã</a>`;
      }

      marker.bindPopup(popupHtml);

      marker.bindTooltip(w.name, {
        direction: "top",
        offset: [0, -5]
      });

      group.addLayer(marker);
    });

    group.addTo(map);
    try {
      map.fitBounds(group.getBounds().pad(0.2));
    } catch (e) {
      const first = wells[0];
      map.setView([first.lat, first.lon], 11);
    }
  })();

  document.addEventListener("DOMContentLoaded", () => {
    initStatusFilter();
  });
</script>


{#
  –ì–†–ê–§–Ü–ö –¢–ê–ô–ú–õ–ê–ô–ù–£ –î–õ–Ø VISUAL.HTML - –§–Ü–ù–ê–õ–¨–ù–ê –í–ï–†–°–Ü–Ø
  –í—Å—Ç–∞–≤–∏—Ç–∏ —Ü–µ–π –∫–æ–¥ –ü–ï–†–ï–î {% endblock %} –≤ visual.html
#}

{# ==================== –¢–ê–ô–ú–õ–ê–ô–ù: –ü–û–î–Ü–á –¢–ê –í–ë–†–û–°–ò ==================== #}

<div class="card" style="margin-top: 40px;">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div>
                <h2>üìä –ì—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–∫–≤–∞–∂–∏–Ω–∞–º</h2>
                <small style="color: #666;">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–ª–∞–π–Ω –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π</small>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="showGridLines" onchange="toggleGridLines()" style="cursor: pointer;">
                    <span style="font-size: 13px; font-weight: 500;">üìê –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏</span>
                </label>
                <button class="btn btn-secondary" onclick="openColorSettings()">
                    üé® –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ü–≤–µ—Ç–∞
                </button>
            </div>
        </div>
    </div>

    {# –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –∫–æ–ª—å–æ—Ä—ñ–≤ #}
    <div id="colorModal" style="
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
    ">
        <h3 style="margin-top: 0; color: #333; border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">
            üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤
        </h3>
        <div id="colorInputs" style="margin: 20px 0;"></div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 15px; border-top: 1px solid #dee2e6;">
            <button class="btn btn-primary" onclick="saveColors()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn btn-secondary" onclick="closeColorSettings()">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div class="card-body">
        {# –§–Ü–õ–¨–¢–† –ü–ï–†–Ü–û–î–£ - –§–û–†–ú–ê #}
        <form method="get" action="/visual" id="periodForm">
            {# –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤–∏–±—Ä–∞–Ω—ñ —Å–∫–≤–∞–∂–∏–Ω–∏ –∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ—ñ–ª—å—Ç—Ä–∞ #}
            {% for well_id in selected_ids %}
            <input type="hidden" name="selected" value="{{ well_id }}">
            {% endfor %}

            <input type="hidden" name="tl_period" id="tl_period_input" value="{{ timeline_filters.period }}">

            <div style="
                padding: 15px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 8px;
                margin-bottom: 20px;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            ">
                <div style="color: white; font-weight: 600; margin-bottom: 10px; font-size: 15px;">
                    üìÖ –ü–µ—Ä–∏–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                    <button type="button" class="btn-period {% if timeline_filters.period == '1d' %}active{% endif %}" data-period="1d" onclick="setPeriod('1d')">
                        üìÜ –°—É—Ç–∫–∏
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '3d' or not timeline_filters.period %}active{% endif %}" data-period="3d" onclick="setPeriod('3d')">
                        üìÜ 3 —Å—É—Ç–æ–∫
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '1w' %}active{% endif %}" data-period="1w" onclick="setPeriod('1w')">
                        üìÜ –ù–µ–¥–µ–ª—è
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == '1m' %}active{% endif %}" data-period="1m" onclick="setPeriod('1m')">
                        üìÜ –ú–µ—Å—è—Ü
                    </button>
                    <button type="button" class="btn-period {% if timeline_filters.period == 'custom' %}active{% endif %}" data-period="custom" onclick="setPeriod('custom')">
                        üìÜ –í—ã–±—Ä–∞—Ç—å –ø–µ—Ä–∏–æ–¥
                    </button>

                    <div id="customDatesRow" style="{% if timeline_filters.period != 'custom' %}display: none;{% endif %} margin-left: 10px; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                        <label style="color: white; font-weight: 500;">–û—Ç:</label>
                        <input type="date" name="tl_date_from" id="date_from" class="input-date" value="{{ timeline_filters.date_from }}">
                        <label style="color: white; font-weight: 500;">–î–æ:</label>
                        <input type="date" name="tl_date_to" id="date_to" class="input-date" value="{{ timeline_filters.date_to }}">
                        <button type="button" class="btn-apply-dates" onclick="submitCustomDates()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </form>

        {# –õ–µ–≥–µ–Ω–¥–∏ –∑ —á–µ–∫–±–æ–∫—Å–∞–º–∏ (3 –∫–æ–ª–æ–Ω–∫–∏) #}
        <div style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        ">
            {# –†–µ–∞–≥–µ–Ω—Ç–∏ #}
            <div class="legend-card">
                <div class="legend-header">
                    üíâ –†–µ–∞–≥–µ–Ω—Ç—ã
                </div>
                <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    <button class="btn-legend btn-legend-all" onclick="selectAllReagents(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllReagents(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_reagents" class="legend-items"></div>
            </div>

            {# –ü–æ–¥—ñ—ó #}
            <div class="legend-card">
                <div class="legend-header">
                    üìå –°–æ–±—ã—Ç–∏—è
                </div>
                <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    <button class="btn-legend btn-legend-all" onclick="selectAllEvents(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllEvents(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_events" class="legend-items"></div>
            </div>

            {# –°—Ç–∞—Ç—É—Å–∏ #}
            <div class="legend-card">
                <div class="legend-header">
                    üìä –°—Ç–∞—Ç—É—Å—ã
                </div>
                <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    <button class="btn-legend btn-legend-all" onclick="selectAllStatuses(true)">‚úì –í—Å–µ</button>
                    <button class="btn-legend btn-legend-none" onclick="selectAllStatuses(false)">‚úó –ù–∏—á–µ–≥–æ</button>
                </div>
                <div id="legend_statuses" class="legend-items"></div>
            </div>
        </div>

        {# –°–≤–µ—Ä–¥–ª–æ–≤–∏–Ω–∏ - –æ–∫—Ä–µ–º–∏–π —Ä—è–¥–æ–∫ #}
        <div class="legend-card" style="margin-bottom: 20px;">
            <div class="legend-header">
                üéØ –°–∫–≤–∞–∂–∏–Ω—ã
            </div>
            <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                <button class="btn-legend btn-legend-all" onclick="selectAllWellsTimeline(true)">‚úì –í—Å–µ</button>
                <button class="btn-legend btn-legend-none" onclick="selectAllWellsTimeline(false)">‚úó –ù–∏—á–µ–≥–æ</button>
            </div>
            <div id="legend_wells" class="legend-items" style="
                display: grid;
                grid-template-columns: repeat(8, 1fr);
                gap: 6px;
            "></div>
        </div>

        {# –ì—Ä–∞—Ñ—ñ–∫ #}
        <div class="chart-box" style="
            width: 100%;
            position: relative;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #dee2e6;
        ">
            {# –ö–Ω–æ–ø–∫–∏ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–æ–º #}
            <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: flex-end;">
                <button onclick="resetZoom()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">
                    üè† –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞
                </button>
            </div>

            <div style="
                height: 600px;
                background: white;
                border-radius: 6px;
            ">
                <canvas id="chart_timeline"></canvas>
            </div>

            <div style="
                margin-top: 15px;
                padding: 10px 15px;
                background: #e7f3ff;
                border-radius: 4px;
                font-size: 12px;
                color: #495057;
                border-left: 3px solid #0d6efd;
            ">
                <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong>
                –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à—å—é –¥–ª—è ZOOM ‚Ä¢
                –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ –º–∞—Å—à—Ç–∞–±–∞ ‚Ä¢
                –ö–Ω–æ–ø–∫–∞ "üè† –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞" —Ç–∞–∫–∂–µ —Å–±—Ä–æ—Å–∏—Ç –º–∞—Å—à—Ç–∞–± ‚Ä¢
                Shift + –ø–µ—Ä–µ—Ç—è–≥–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚Ä¢
                –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
            </div>
        </div>
    </div>
</div>

{# JS-–¥–∞–Ω—ñ –¥–ª—è Chart.js #}
<script>
window.reagentsData = {
    timelineInjections: {{ timeline_injections | tojson | safe }},
    timelineEvents: {{ timeline_events | tojson | safe }},
    reagentColors: {{ timeline_reagent_colors | tojson | safe }},
    eventColors: {{ timeline_event_colors | tojson | safe }},
    wellStatuses: {{ timeline_well_statuses | tojson | safe }},
    statusColors: {{ timeline_status_colors | tojson | safe }},
};
</script>

{# Chart.js –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ #}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>

<script src="/static/js/visual_timeline.js"></script>

<style>
/* –°—Ç–∏–ª—ñ –¥–ª—è –∫–∞—Ä—Ç–æ–∫ */
.card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border: 1px solid #dee2e6;
    margin-bottom: 20px;
}

.card-header {
    padding: 15px 20px;
    border-bottom: 2px solid #e9ecef;
}

.card-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #212529;
}

.card-body {
    padding: 20px;
}

/* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä—ñ–æ–¥—É */
.btn-period {
    padding: 8px 16px;
    border: 2px solid rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.15);
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.2s;
    color: white;
    backdrop-filter: blur(10px);
}

.btn-period:hover {
    background: rgba(255,255,255,0.3);
    border-color: rgba(255,255,255,0.5);
    transform: translateY(-2px);
}

.btn-period.active {
    background: white;
    color: #667eea;
    border-color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* –Ü–Ω–ø—É—Ç–∏ –¥–∞—Ç */
.input-date {
    padding: 6px 10px;
    border: 1px solid rgba(255,255,255,0.4);
    border-radius: 4px;
    font-size: 13px;
    background: rgba(255,255,255,0.9);
    color: #333;
}

.btn-apply-dates {
    padding: 6px 12px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    margin-left: 8px;
    transition: all 0.2s;
}

.btn-apply-dates:hover {
    background: #218838;
    transform: translateY(-1px);
}

/* –õ–µ–≥–µ–Ω–¥–∏ */
.legend-card {
    background: white;
    padding: 15px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    border: 1px solid #dee2e6;
}

.legend-header {
    font-weight: 600;
    margin-bottom: 10px;
    font-size: 14px;
    color: #212529;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
}

.legend-items {
    max-height: 250px;
    overflow-y: auto;
}

/* –ö–Ω–æ–ø–∫–∏ –ª–µ–≥–µ–Ω–¥ */
.btn-legend {
    padding: 4px 10px;
    font-size: 11px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-legend-all {
    background: #28a745;
    color: white;
}

.btn-legend-all:hover {
    background: #218838;
    transform: translateY(-1px);
}

.btn-legend-none {
    background: #dc3545;
    color: white;
}

.btn-legend-none:hover {
    background: #c82333;
    transform: translateY(-1px);
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #0d6efd;
    color: white;
}

.btn-primary:hover {
    background: #0b5ed7;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.25);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5c636a;
}
</style>
{% endblock %}