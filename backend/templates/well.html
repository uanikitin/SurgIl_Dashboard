{# backend/templates/well.html #}
{% extends "base.html" %}

{# ---------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞ ---------- #}
{% block title %}
  –°–∫–≤–∞–∂–∏–Ω–∞: –°–∫–≤ {{ well.number or well.id }}
{% endblock %}

{# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}
{% block extra_head %}
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    /* === –ñ—ë—Å—Ç–∫–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å–æ–±—ã—Ç–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Å–∫–≤–∞–∂–∏–Ω—ã === */

    /* 0. –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å—Ç—Ä–æ–∫ –∏ –ª–µ–≤—ã–µ –ø–æ–ª–æ—Å–∫–∏ */
    .events-table tr,
    .events-table__row {
      background: transparent !important;
      border-left: none !important;
    }

    /* 1. –ë–∞–∑–æ–≤—ã–π –≤–∏–¥ –≤—Å–µ—Ö —è—á–µ–µ–∫ */
    .events-table td {
      color: #333 !important;
      font-weight: 400;
    }

    /* 2. –ö–æ–ª–æ–Ω–∫–∞ "–¢–∏–ø" ‚Äî –Ω–∞—à–∞ —Ü–µ–ª–µ–≤–∞—è */
    .events-table__type {
      font-weight: 600;
    }

    /* 3. –ö—Ä–∞—Å–∏–º –¢–û–õ–¨–ö–û –∫–æ–ª–æ–Ω–∫—É "–¢–∏–ø" –ø–æ —Ç–∏–ø—É —Å–æ–±—ã—Ç–∏—è */

    /* —Ä–µ–∞–≥–µ–Ω—Ç */
    .events-table__row--reagent .events-table__type {
      color: #e53935 !important;
      font-weight: 700;
    }

    /* –¥–∞–≤–ª–µ–Ω–∏–µ */
    .events-table__row--pressure .events-table__type {
      color: #3949ab !important;
      font-weight: 700;
    }

    /* –ø—Ä–æ–¥—É–≤–∫–∞ */
    .events-table__row--purge .events-table__type {
      color: #ffa000 !important;
      font-weight: 700;
    }

    /* –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ */
    .events-table__row--equip .events-table__type {
      color: #43a047 !important;
      font-weight: 700;
    }

    /* –ø—Ä–æ—á–µ–µ / –∑–∞–º–µ—Ç–∫–∞ */
    .events-table__row--other .events-table__type,
    .events-table__row--note  .events-table__type {
      color: #9e9e9e !important;
      font-weight: 600;
    }

    /* ===== Raw Nearby Popup (chart click) ===== */
    .raw-nearby-popup {
      position: fixed;
      z-index: 9999;
      background: #1e293b;
      color: #e2e8f0;
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      padding: 10px 12px;
      font-size: 11px;
      font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
      min-width: 260px;
      max-height: 420px;
      overflow-y: auto;
    }
    .raw-nearby-popup__title {
      font-size: 11px;
      font-weight: 700;
      color: #94a3b8;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .raw-nearby-popup table { width: 100%; border-collapse: collapse; }
    .raw-nearby-popup th {
      text-align: right; font-size: 10px; color: #64748b;
      padding: 2px 6px; border-bottom: 1px solid #334155; font-weight: 600;
    }
    .raw-nearby-popup th:first-child { text-align: left; }
    .raw-nearby-popup td {
      padding: 2px 6px; text-align: right;
      font-variant-numeric: tabular-nums;
      border-bottom: 1px solid #1e293b;
    }
    .raw-nearby-popup td:first-child { text-align: left; color: #94a3b8; }
    .raw-nearby-popup .val-null { color: #ef4444; }
    .raw-nearby-popup .val-zero { color: #f97316; }
    .raw-nearby-popup .val-ok   { color: #4ade80; }
    .raw-nearby-popup .val-line { color: #60a5fa; }
    .raw-nearby-popup tr.raw-center {
      background: #334155;
      font-weight: 700;
    }
    .raw-nearby-popup tr.raw-center td { border-bottom: 1px solid #475569; }
    .raw-nearby-popup__loading {
      color: #94a3b8; text-align: center; padding: 12px;
    }
  </style>
{% endblock %}

{# ---------- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---------- #}
{% block content %}

<div class="page-header">
  <a href="/visual"
     style="
       display:inline-flex;
       align-items:center;
       gap:10px;
       padding:8px 14px;
       border-radius:999px;
       background:#f3f4f6;
       border:1px solid #e5e7eb;
       text-decoration:none;
       color:#111827;
       font-size:14px;
       line-height:1.2;
     ">
    <span aria-hidden="true" style="
      width:24px;
      height:24px;
      border-radius:999px;
      background:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:center;
    ">
      <svg viewBox="0 0 20 20" width="14" height="14" style="display:block;">
        <path d="M12.5 4.5L8 9l4.5 4.5"
              fill="none"
              stroke="#111827"
              stroke-width="1.7"
              stroke-linecap="round"
              stroke-linejoin="round"/>
      </svg>
    </span>
    <span>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É —Å–∫–≤–∞–∂–∏–Ω</span>
  </a>
</div>

<div class="well-header-row" style="display:flex; justify-content:space-between; align-items:flex-start;">
  <div>
    <h1>–°–∫–≤–∞–∂–∏–Ω–∞: –°–∫–≤ {{ well.number or well.id }}</h1>
    <p class="well-id">ID –≤ –±–∞–∑–µ: {{ well.id }}</p>
  </div>

  {# ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚îÄ‚îÄ #}
  <div style="position:relative;">
    <button id="btn-page-settings" type="button" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã" style="
      padding:7px 14px; border:1px solid #dee2e6; border-radius:8px;
      background:#f8f9fa; color:#555; font-size:13px; cursor:pointer;
      display:flex; align-items:center; gap:6px; white-space:nowrap;
    ">&#9881; –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>

    <div id="page-settings-panel" style="
      display:none; position:absolute; right:0; top:calc(100% + 6px);
      background:#fff; border:1px solid #dee2e6; border-radius:10px;
      box-shadow:0 4px 16px rgba(0,0,0,.12); padding:14px 18px;
      z-index:100; min-width:260px;
    ">
      <div style="font-weight:600; font-size:13px; color:#333; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:8px;">
        –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤
      </div>
      <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-size:13px; color:#444;">
        <input type="checkbox" id="toggle-events-chart" style="width:16px; height:16px; accent-color:#4f46e5; cursor:pointer;">
        –ì—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ
      </label>
      <label style="display:flex; align-items:center; gap:8px; cursor:pointer; font-size:13px; color:#444; margin-top:8px;">
        <input type="checkbox" id="toggle-channel-history" style="width:16px; height:16px; accent-color:#4f46e5; cursor:pointer;">
        –ò—Å—Ç–æ—Ä–∏—è –∫–∞–Ω–∞–ª–æ–≤ —Å–≤—è–∑–∏
      </label>
    </div>
  </div>

  {# –∏—â–µ–º css-–∫–ª–∞—Å—Å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ —Å–µ—Ç–∫–µ well_status.grid #}
  {% set ns = namespace(current_css='') %}
  {% if well_status and well_status.current_status and well_status.grid %}
    {% for col in well_status.grid %}
      {% if col.label == well_status.current_status %}
        {% set ns.current_css = col.css %}
      {% endif %}
    {% endfor %}
  {% endif %}
  {% set current_css = ns.current_css %}
</div>

{# ===== –í–ï–†–•–ù–Ø–Ø –°–¢–†–û–ö–ê: –°–¢–ê–¢–£–° + –ö–ê–ù–ê–õ + –û–ë–û–†–£–î–û–í–ê–ù–ò–ï ===== #}
<div style="display:grid; grid-template-columns:40% 1fr; gap:12px 16px; align-items:stretch; margin:16px 0 24px;">

  {# === –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê: –°—Ç–∞—Ç—É—Å + –ö–∞–Ω–∞–ª —Å—Ç–æ–ø–∫–æ–π === #}
  <div style="display:flex; flex-direction:column; gap:12px;">

  {# === –ö–ê–†–¢–û–ß–ö–ê 1: –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° === #}
  {% if well_status and well_status.current_status %}
    <div style="
      background:white; border-radius:8px; padding:12px 16px;
      border:1px solid #e5e7eb; border-left:4px solid var(--{{ current_css }}-color, #6c757d);
      box-sizing:border-box; display:flex; flex-direction:column;
      {% if is_admin %}cursor:pointer;{% endif %}
    "
    {% if is_admin %}
    onclick="openStatusModal(null)"
    title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å"
    {% endif %}
    >
      <div style="font-size:11px; text-transform:uppercase; font-weight:700; letter-spacing:0.05em; color:#6b7280;">
        –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      </div>
      <div style="font-size:20px; font-weight:800; margin-top:4px; color:#111827;">
        {{ well_status.current_status }}
      </div>
      {% if well_status.current_note %}
        <div style="font-size:11px; margin-top:4px; color:#6b7280;">
          {{ well_status.current_note }}
        </div>
      {% endif %}
      {% if well_status.current_start %}
        <div style="font-size:10px; margin-top:auto; color:#9ca3af;">
          –° {{ well_status.current_start.strftime("%d.%m.%Y %H:%M") }}
          {% if well_status.current_end %}
            –ø–æ {{ well_status.current_end.strftime("%d.%m.%Y %H:%M") }}
          {% else %}
            –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è
          {% endif %}
        </div>
      {% endif %}
    </div>
  {% else %}
    <div style="
      background:white; border-radius:8px; padding:12px 16px;
      border:1px solid #e5e7eb; border-left:4px solid #d1d5db;
      box-sizing:border-box; display:flex; flex-direction:column; justify-content:center;
      {% if is_admin %}cursor:pointer;{% endif %}
    "
    {% if is_admin %}
    onclick="openStatusModal(null)"
    title="–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å —Å—Ç–∞—Ç—É—Å"
    {% endif %}
    >
      <div style="font-size:11px; text-transform:uppercase; letter-spacing:0.05em; color:#6b7280;">
        –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
      </div>
      <div style="font-size:16px; margin-top:4px; font-weight:700; color:#9ca3af;">
        –ù–µ –∑–∞–¥–∞–Ω
      </div>
    </div>
  {% endif %}

  {# === –ö–ê–†–¢–û–ß–ö–ê 2: –ö–ê–ù–ê–õ –°–í–Ø–ó–ò (–∞–≤—Ç–æ –∏–∑ LoRa-–¥–∞—Ç—á–∏–∫–æ–≤) === #}
  <div style="
    background:white; border-radius:8px; padding:12px 16px;
    border:1px solid #e5e7eb; border-left:4px solid #3b82f6;
    box-sizing:border-box; display:flex; flex-direction:column; flex:1;
  ">
    <div style="font-size:11px; text-transform:uppercase; color:#6b7280; font-weight:700; letter-spacing:0.04em; margin-bottom:8px;">
      –ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ / –î–∞—Ç—á–∏–∫–∏
    </div>

    {% if well_lora_sensors and well_lora_sensors|length > 0 %}
      {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –ª–∏ –∫–∞–Ω–∞–ª —É –≤—Å–µ—Ö –¥–∞—Ç—á–∏–∫–æ–≤ #}
      {% set ns_ch = namespace(first_ch=well_lora_sensors[0].csv_channel, same=true) %}
      {% for s in well_lora_sensors %}
        {% if s.csv_channel != ns_ch.first_ch %}{% set ns_ch.same = false %}{% endif %}
      {% endfor %}
      {% if ns_ch.same %}
        <div style="font-size:22px; font-weight:800; color:#1d4ed8; margin-bottom:6px;">
          –ö–∞–Ω–∞–ª {{ ns_ch.first_ch }}
        </div>
      {% else %}
        <div style="font-size:13px; font-weight:700; color:#d97706; margin-bottom:6px;">
          –†–∞–∑–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
        </div>
      {% endif %}

      <div style="display:flex; flex-direction:column; gap:6px;">
        {% for s in well_lora_sensors %}
          <div style="font-size:11px; color:#374151; background:#f3f4f6; padding:5px 8px; border-radius:6px; border-left:3px solid {% if s.position == 'tube' %}#3b82f6{% else %}#10b981{% endif %};">
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <span style="font-weight:700; color:{% if s.position == 'tube' %}#1d4ed8{% else %}#059669{% endif %};">
                {% if s.position == 'tube' %}–£—Å—Ç—å–µ (Ptr){% else %}–®–ª–µ–π—Ñ (Pshl){% endif %}
              </span>
              <span style="font-size:10px; color:#6b7280;">SN: {{ s.serial_number }}</span>
            </div>
            <div style="font-size:10px; color:#6b7280; margin-top:2px;">
              –ü—Ä–æ—à–∏–≤–∫–∞: –≥—Ä—É–ø–ø–∞ {{ s.csv_group }}, –∫–∞–Ω–∞–ª {{ s.csv_channel }}, {{ s.csv_column }}_{{ s.csv_channel }}
              {% if s.label %} &mdash; {{ s.label }}{% endif %}
            </div>
            {% if s.installed_at %}
            <div style="font-size:10px; color:#9ca3af; margin-top:1px;">
              –£—Å—Ç. {{ s.installed_at.strftime("%d.%m.%Y") }}
            </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% elif channel_current %}
      <div style="font-size:22px; font-weight:800; color:#1d4ed8;">
        {{ channel_current.channel }}
      </div>
      {% if channel_current.note %}
        <div style="font-size:11px; margin-top:4px; color:#374151;">{{ channel_current.note }}</div>
      {% endif %}
      {% if channel_current.started_at %}
        <div style="font-size:10px; margin-top:auto; color:#9ca3af;">
          —Å {{ channel_current.started_at.strftime("%d.%m.%Y %H:%M") }}
        </div>
      {% endif %}
    {% else %}
      <div style="font-size:14px; font-weight:600; color:#9ca3af;">
        –î–∞—Ç—á–∏–∫–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
      </div>
    {% endif %}

    {# --- –ò–°–¢–û–†–ò–Ø –î–ê–¢–ß–ò–ö–û–í (–≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫) --- #}
    {% if well_lora_history and well_lora_history|length > 0 %}
      <div style="margin-top:8px; border-top:1px solid #e5e7eb; padding-top:6px;">
        <button onclick="var el=this.nextElementSibling; var show=el.style.display==='none'; el.style.display=show?'flex':'none'; this.querySelector('.hist-arrow').textContent=show?'\u25BC':'\u25B6';"
          style="background:none; border:none; cursor:pointer; font-size:10px; color:#6b7280; font-weight:600; padding:0; display:flex; align-items:center; gap:4px;">
          <span class="hist-arrow" style="font-size:8px;">&blacktriangleright;</span> –ò—Å—Ç–æ—Ä–∏—è –¥–∞—Ç—á–∏–∫–æ–≤ ({{ well_lora_history|length }})
        </button>
        <div style="display:none; margin-top:6px; max-height:200px; overflow-y:auto; flex-direction:column; gap:4px;" id="lora-history-list">
          {% for h in well_lora_history %}
          <div style="font-size:10px; color:#6b7280; background:#fafafa; padding:4px 8px; border-radius:4px; border-left:2px solid #d1d5db;">
            <div style="display:flex; justify-content:space-between;">
              <span style="font-weight:600; color:#374151;">
                {% if h.position == 'tube' %}–£—Å—Ç—å–µ{% else %}–®–ª–µ–π—Ñ{% endif %} &mdash; SN: {{ h.serial_number }}
              </span>
              <span style="font-size:9px; color:#9ca3af;">
                {% if h.eq_status == 'maintenance' %}—Ä–µ–º–æ–Ω—Ç{% elif h.eq_status == 'broken' %}—Å–ª–æ–º–∞–Ω{% elif h.eq_status == 'available' %}—Å–∫–ª–∞–¥{% else %}{{ h.eq_status }}{% endif %}
              </span>
            </div>
            <div style="font-size:9px; color:#9ca3af;">
              –≥{{ h.csv_group }}/{{ h.csv_column }}_{{ h.csv_channel }}
              &nbsp;&middot;&nbsp; {{ h.installed_at.strftime("%d.%m.%Y") }} &mdash; {{ h.removed_at.strftime("%d.%m.%Y") }}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  </div> {# /–ª–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ #}

  {# === –ö–ê–†–¢–û–ß–ö–ê 3: –û–ë–û–†–£–î–û–í–ê–ù–ò–ï (–ø—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞, 60%) === #}
  <div style="
    background:white; border-radius:8px; padding:12px 16px;
    border:1px solid #e5e7eb; border-left:4px solid #d97706;
    box-sizing:border-box; display:flex; flex-direction:column;
  ">
    {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è #}
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <span style="font-size:11px; text-transform:uppercase; color:#92400e; font-weight:700; letter-spacing:0.05em;">
        –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ
      </span>
      {% if is_admin %}
      <button onclick="showInstallEquipmentModal()"
        style="
          width:24px; height:24px; border-radius:50%; border:none;
          background:#059669; color:white; font-size:16px; font-weight:bold;
          cursor:pointer; display:flex; align-items:center; justify-content:center;
        "
        title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ">+</button>
      {% endif %}
    </div>

    {% if current_equipment %}
    <div style="display:flex; flex-wrap:wrap; gap:10px; align-content:flex-start; overflow-y:auto; box-sizing:border-box;">
      {% for eq in current_equipment %}
        {% if eq.type_info %}
          {% set eq_type = eq.type_info %}
        {% else %}
          {% set eq_type = equipment_by_code.get(eq.type_code) %}
        {% endif %}
        {% set eq_type_lower = (eq.equipment_type or eq.type or '')|lower %}

        <a href="/equipment/view/{{ eq.id }}" target="_blank"
           style="display:flex; text-decoration:none; color:inherit; background:#f9fafb; border-radius:10px; padding:10px 12px; border:1px solid #e5e7eb; min-width:240px; max-width:300px; box-sizing:border-box; align-items:stretch; gap:10px; font-size:12px; position:relative; transition:border-color 0.15s, box-shadow 0.15s;"
           onmouseover="this.style.borderColor='#9ca3af';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.06)';var btn=this.querySelector('.eq-remove-btn');if(btn)btn.style.opacity='1';"
           onmouseout="this.style.borderColor='#e5e7eb';this.style.boxShadow='none';var btn=this.querySelector('.eq-remove-btn');if(btn)btn.style.opacity='0';">

          {% if is_admin %}
          <div class="eq-remove-btn" style="position:absolute; top:4px; right:4px; opacity:0; transition:opacity 0.15s; z-index:10;">
            <button onclick="event.preventDefault();event.stopPropagation();toggleEqMenu(this)"
              style="width:22px; height:22px; border-radius:50%; border:1px solid #d1d5db; background:#f3f4f6; color:#6b7280; font-size:14px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center;"
              title="–î–µ–π—Å—Ç–≤–∏—è">&#8230;</button>
            <div class="eq-action-menu" style="display:none; position:absolute; top:24px; right:0; background:white; border:1px solid #e5e7eb; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.12); min-width:180px; overflow:hidden; z-index:20;">
              <button onclick="event.preventDefault();event.stopPropagation();openTransferModal({{ eq.id }}, '{{ (eq.name or eq.serial_number or "")|e }}')"
                style="display:flex; align-items:center; gap:6px; width:100%; padding:8px 12px; border:none; background:none; cursor:pointer; font-size:12px; color:#374151; text-align:left;"
                onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                &#8599; –ù–∞ –¥—Ä—É–≥—É—é —Å–∫–≤–∞–∂–∏–Ω—É
              </button>
              <button onclick="event.preventDefault();event.stopPropagation();sendToRepair({{ eq.id }}, '{{ (eq.name or eq.serial_number or "")|e }}')"
                style="display:flex; align-items:center; gap:6px; width:100%; padding:8px 12px; border:none; background:none; cursor:pointer; font-size:12px; color:#d97706; text-align:left;"
                onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='none'">
                &#128295; –ù–∞ —Ä–µ–º–æ–Ω—Ç
              </button>
              <button onclick="event.preventDefault();event.stopPropagation();changeEquipmentStatus({{ eq.id }}, '{{ (eq.name or eq.serial_number or "")|e }}', 'broken', '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Å–ª–æ–º–∞–Ω–Ω–æ–µ')"
                style="display:flex; align-items:center; gap:6px; width:100%; padding:8px 12px; border:none; background:none; cursor:pointer; font-size:12px; color:#dc2626; text-align:left;"
                onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                &#9888; –°–ª–æ–º–∞–Ω–æ
              </button>
              <button onclick="event.preventDefault();event.stopPropagation();changeEquipmentStatus({{ eq.id }}, '{{ (eq.name or eq.serial_number or "")|e }}', 'lost', '–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ —É—Ç–µ—Ä—è–Ω–Ω–æ–µ')"
                style="display:flex; align-items:center; gap:6px; width:100%; padding:8px 12px; border:none; background:none; cursor:pointer; font-size:12px; color:#6b7280; text-align:left;"
                onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                &#10067; –£—Ç–µ—Ä—è–Ω–æ
              </button>
              <div style="border-top:1px solid #e5e7eb;"></div>
              <button onclick="event.preventDefault();event.stopPropagation();removeEquipmentFromWell({{ eq.id }}, '{{ (eq.name or eq.serial_number or "")|e }}')"
                style="display:flex; align-items:center; gap:6px; width:100%; padding:8px 12px; border:none; background:none; cursor:pointer; font-size:12px; color:#ef4444; text-align:left;"
                onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='none'">
                &#10005; –°–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥
              </button>
            </div>
          </div>
          {% endif %}

          {# –õ–ï–í–ê–Ø –ß–ê–°–¢–¨ - –¢–ï–ö–°–¢ #}
          <div style="flex:1 1 auto; min-width:0; display:flex; flex-direction:column; gap:3px;">
            <span style="font-size:10px; text-transform:uppercase; color:#4b5563; font-weight:700; letter-spacing:0.04em; background:#e5e7eb; padding:2px 8px; border-radius:4px; display:inline-block; align-self:flex-start;">
              {% if eq.equipment_type %}{{ eq.equipment_type }}{% elif eq.type %}{{ eq.type }}{% elif eq_type and eq_type.label %}{{ eq_type.label }}{% elif eq.type_code %}{{ eq.type_code }}{% else %}–¢–∏–ø –Ω–µ —É–∫–∞–∑–∞–Ω{% endif %}
            </span>
            {% if eq.name %}
            <div style="font-size:12px; font-weight:600; color:#374151; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{{ eq.name }}</div>
            {% endif %}
            <div style="font-size:11px; color:#6b7280;">
              SN: <span style="font-weight:600; color:#374151;">{{ eq.serial_number or "‚Äî" }}</span>
            </div>
            {% if eq.installation_location %}
            <div style="font-size:10px; color:#6b7280;">&#9670; {{ eq.installation_location }}</div>
            {% endif %}
            {% if eq.installation_date %}
            <div style="font-size:10px; color:#6b7280; margin-top:auto;">
              –£—Å—Ç. <span style="font-weight:600; color:#374151;">{{ eq.installation_date.strftime("%d.%m.%Y %H:%M") }}</span>
            </div>
            {% elif eq.installed_at %}
            <div style="font-size:10px; color:#6b7280; margin-top:auto;">
              –£—Å—Ç. <span style="font-weight:600; color:#374151;">{{ eq.installed_at.strftime("%d.%m.%Y %H:%M") }}</span>
            </div>
            {% endif %}
            {% if eq.condition %}
            <div style="font-size:10px; margin-top:2px;">
              {% if eq.condition == 'working' %}
                <span style="color:#059669; font-weight:600;">&#9679; –†–æ–±–æ—á–µ</span>
              {% elif eq.condition == 'needs_repair' %}
                <span style="color:#d97706; font-weight:600;">&#9679; –ü–æ—Ç—Ä–µ–±—É—î —Ä–µ–º–æ–Ω—Ç—É</span>
              {% elif eq.condition == 'broken' %}
                <span style="color:#dc2626; font-weight:600;">&#9679; –ù–µ —Ä–æ–±–æ—á–µ</span>
              {% endif %}
            </div>
            {% endif %}
          </div>

          {# –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨ - –ò–ö–û–ù–ö–ê #}
          <div style="flex:0 0 70px; display:flex; align-items:center; justify-content:center;">
            <div style="width:64px; height:90px; display:flex; align-items:center; justify-content:center; background:white; border-radius:12px; padding:8px; border:1px solid #d1d5db;">
              {% if '–¥–∞—Ç—á–∏–∫' in eq_type_lower or '—Å–µ–Ω—Å–æ—Ä' in eq_type_lower or 'sensor' in eq_type_lower %}
                <img src="/static/icons/–°SMOD_1.png" alt="–î–∞—Ç—á–∏–∫" style="width:100%;height:100%;object-fit:contain;">
              {% elif '—à–ª—é–∑' in eq_type_lower or 'gateway' in eq_type_lower %}
                <img src="/static/icons/WH_launcher_1.png" alt="–®–ª—é–∑" style="width:100%;height:100%;object-fit:contain;">
              {% elif eq.icon_path %}
                <img src="{{ eq.icon_path }}" alt="" style="width:100%;height:100%;object-fit:contain;">
              {% elif eq_type and eq_type.icon %}
                <img src="{{ eq_type.icon }}" alt="" style="width:100%;height:100%;object-fit:contain;">
              {% else %}
                <div style="font-size:36px; line-height:1; color:#9ca3af;">&#128295;</div>
              {% endif %}
            </div>
          </div>

        </a>
      {% endfor %}
    </div>
    {% else %}
    <p style="font-size:12px; color:#6b7280; margin:0;">
      –ê–∫—Ç–∏–≤–Ω–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.
    </p>
    {% endif %}
  </div>

</div> {# /grid row #}

{# ===== –ö–û–ù–°–¢–†–£–ö–¶–ò–Ø + –ö–ê–†–¢–ê ===== #}
{% if well_construction or (well.lat is not none and well.lon is not none) %}
<div style="
  display:grid;
  grid-template-columns:40% 60%;
  gap:12px 16px;
  margin:0 0 24px;
  align-items:stretch;
  box-sizing:border-box;
">

  {# === –ö–û–ù–°–¢–†–£–ö–¶–ò–Ø –°–ö–í–ê–ñ–ò–ù–´ === #}
  <div
    style="
      background:#f9fafb;
      border-radius:16px;
      padding:16px 18px;
      border:1px solid #e5e7eb;
      box-shadow:0 4px 10px rgba(15,23,42,0.06);
      min-height:260px;
      display:flex;
      flex-direction:column;
    "
  >
    <h2 style="margin-top:0; margin-bottom:12px; font-size:18px; font-weight:700;">
      –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã
    </h2>

    {% if well_construction %}
      {# ‚Äî —Ç–≤–æ–π –ø—Ä–µ–∂–Ω–∏–π –±–ª–æ–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ —Ç–∞–±–ª–∏—Ü–µ–π –ø–µ—Ä—Ñ–æ—Ä–∞—Ü–∏–∏ ‚Äî #}
      <div style="display:grid; grid-template-columns:auto 1fr; gap:6px 16px; font-size:13px;">

        <div style="font-weight:600; color:#374151;">–î–∏–∞–º–µ—Ç—Ä —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–Ω—ã, –º–º:</div>
        <div>
          {% set v = well_construction["prod_casing_diam_mm"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–ª—É–±–∏–Ω–∞ —Å–ø—É—Å–∫–∞ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–ª–æ–Ω–Ω—ã, –º:</div>
        <div>
          {% set v = well_construction["prod_casing_depth_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–¢–µ–∫—É—â–∏–π –∑–∞–±–æ–π, –º:</div>
        <div>
          {% set v = well_construction["current_bottomhole_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–æ—Ä–∏–∑–æ–Ω—Ç:</div>
        <div>
          {% set v = well_construction["horizon"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–î–∏–∞–º–µ—Ç—Ä –ù–ö–¢, –º–º:</div>
        <div>
          {% set v = well_construction["tubing_diam_mm"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–ª—É–±–∏–Ω–∞ –±–∞—à–º–∞–∫–∞ –ù–ö–¢, –º:</div>
        <div>
          {% set v = well_construction["tubing_shoe_depth_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–ª—É–±–∏–Ω–∞ –ø–∞–∫–µ—Ä–∞, –º:</div>
        <div>
          {% set v = well_construction["packer_depth_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–ª—É–±–∏–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–Ω–∏–∫–∞, –º:</div>
        <div>
          {% set v = well_construction["adapter_depth_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–ì–ª—É–±–∏–Ω–∞ –Ω–µ–ø—Ä–æ—Ö–æ–¥–∞ —à–∞–±–ª–æ–Ω–∞, –º:</div>
        <div>
          {% set v = well_construction["pattern_stuck_depth_m"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>

        <div style="font-weight:600; color:#374151;">–î–∏–∞–º–µ—Ç—Ä —à—Ç—É—Ü–µ—Ä–∞, –º–º:</div>
        <div style="display:flex; align-items:center; gap:6px;">
          {% set choke_val = well_construction["choke_diam_mm"] %}
          <span id="chokeDisplay">
            {% if choke_val is not none and choke_val == choke_val %}{{ choke_val }}{% else %}<span style="color:#ef4444; font-size:12px;">–Ω–µ —É–∫–∞–∑–∞–Ω</span>{% endif %}
          </span>
          <button id="chokeEditBtn" onclick="chokeStartEdit()"
            style="border:none; background:none; cursor:pointer; color:#3b82f6; font-size:11px; padding:1px 3px;"
            title="–ò–∑–º–µ–Ω–∏—Ç—å —à—Ç—É—Ü–µ—Ä">&#9998;</button>
          <span id="chokeEditor" style="display:none; align-items:center; gap:4px;">
            <input type="number" id="chokeInput" step="0.5" min="0" max="50"
              style="width:70px; padding:2px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:13px;"
              value="{% if choke_val is not none and choke_val == choke_val %}{{ choke_val }}{% endif %}"
              placeholder="–º–º">
            <button onclick="chokeSave()"
              style="border:none; background:#22c55e; color:#fff; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">&#10003;</button>
            <button onclick="chokeCancel()"
              style="border:none; background:#e5e7eb; color:#374151; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">&#10005;</button>
          </span>
        </div>

        <div style="font-weight:600; color:#374151;">–î–∞—Ç–∞ –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏:</div>
        <div>
          {% set v = well_construction["data_as_of"] %}
          {% if v is not none and v == v %}{{ v }}{% else %}-{% endif %}
        </div>
      </div>

      {% if perforation_intervals and perforation_intervals|length > 0 %}
        <h3 style="margin-top:16px; margin-bottom:6px; font-size:14px; font-weight:600;">
          –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–µ—Ä—Ñ–æ—Ä–∞—Ü–∏–∏
        </h3>
        <table class="table-history" style="font-size:12px;">
          <thead>
            <tr>
              <th>‚Ññ</th>
              <th>–°–≤–µ—Ä—Ö—É, –º</th>
              <th>–°–Ω–∏–∑—É, –º</th>
            </tr>
          </thead>
          <tbody>
            {% for p in perforation_intervals %}
              <tr>
                <td>{{ p.interval_index }}</td>
                <td>{{ p.top_depth_m }}</td>
                <td>{{ p.bottom_depth_m }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="margin-top:10px; color:#6b7280; font-size:13px;">
          –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–µ—Ä—Ñ–æ—Ä–∞—Ü–∏–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.
        </p>
      {% endif %}
    {% else %}
      <div style="margin-top:8px; font-size:13px; color:#6b7280;">
        –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è —Å–∫–≤–∞–∂–∏–Ω—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞.
      </div>
      <div style="margin-top:12px; display:flex; align-items:center; gap:8px; font-size:13px;">
        <span style="font-weight:600; color:#374151;">–î–∏–∞–º–µ—Ç—Ä —à—Ç—É—Ü–µ—Ä–∞, –º–º:</span>
        <span id="chokeDisplay"><span style="color:#ef4444; font-size:12px;">–Ω–µ —É–∫–∞–∑–∞–Ω</span></span>
        <button id="chokeEditBtn" onclick="chokeStartEdit()"
          style="border:none; background:none; cursor:pointer; color:#3b82f6; font-size:11px; padding:1px 3px;"
          title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à—Ç—É—Ü–µ—Ä">&#9998;</button>
        <span id="chokeEditor" style="display:none; align-items:center; gap:4px;">
          <input type="number" id="chokeInput" step="0.5" min="0" max="50"
            style="width:70px; padding:2px 6px; border:1px solid #d1d5db; border-radius:4px; font-size:13px;"
            placeholder="–º–º">
          <button onclick="chokeSave()"
            style="border:none; background:#22c55e; color:#fff; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">&#10003;</button>
          <button onclick="chokeCancel()"
            style="border:none; background:#e5e7eb; color:#374151; border-radius:4px; padding:2px 8px; font-size:12px; cursor:pointer;">&#10005;</button>
        </span>
      </div>
    {% endif %}
  </div>

  {# === –†–Ø–î 2, –ö–û–õ–û–ù–ö–ê 3: –ö–ê–†–¢–ê / –ü–†–ò–í–Ø–ó–ö–ê === #}
  <div
    style="
      background:#f9fafb;
      border-radius:16px;
      padding:12px 12px 16px;
      border:1px solid #e5e7eb;
      box-shadow:0 4px 10px rgba(15,23,42,0.06);
      min-height:260px;
      display:flex;
      flex-direction:column;
    "
  >
    {% if well.lat is not none and well.lon is not none %}
      <div style="
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:8px;
      ">
        <h2 style="margin:0; font-size:18px; font-weight:700;">
          –ö–∞—Ä—Ç–∞ / –ø—Ä–∏–≤—è–∑–∫–∞
        </h2>
        <div style="font-size:12px; color:#6b7280;">
          Lat: {{ well.lat }} ¬∑ Lon: {{ well.lon }}
        </div>
      </div>

      <div id="well-map"
           style="flex:1 1 auto; min-height:260px; border-radius:12px; overflow:hidden;">
      </div>
    {% else %}
      <div style="
        flex:1 1 auto;
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:14px;
        color:#6b7280;
      ">
        –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–∫–≤–∞–∂–∏–Ω—ã –Ω–µ –∑–∞–¥–∞–Ω—ã.
      </div>
    {% endif %}
  </div>

</div>
{% endif %}

{# ===== –ü–û–õ–ù–û–®–ò–†–ò–ù–ù–´–ï –°–ï–ö–¶–ò–ò ===== #}
<div style="width:100%; max-width:100%;">

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ì–†–ê–§–ò–ö –î–ê–í–õ–ï–ù–ò–ô (LoRa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
{% if pressure_latest and (pressure_latest.p_tube is not none or pressure_latest.p_line is not none) %}
<div class="card" style="width:100%; margin-bottom:20px;">
  <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <h2 style="margin:0;">üìä –î–∞–≤–ª–µ–Ω–∏—è (LoRa-–º–∞–Ω–æ–º–µ—Ç—Ä—ã)</h2>
    <div style="display:flex; gap:8px; align-items:center;">
      <a href="/api/pressure/admin/page" style="font-size:12px; color:#6b7280; text-decoration:none;" title="–ü—Ä–æ—Å–º–æ—Ç—Ä –±–∞–∑—ã">–ë–∞–∑–∞</a>
      <button id="btn-pressure-refresh" onclick="refreshPressureData()" style="
        padding:5px 12px; border:1px solid #10b981; border-radius:6px;
        background:#ecfdf5; color:#059669; cursor:pointer; font-size:12px; font-weight:500;
        display:inline-flex; align-items:center; gap:4px;
      " title="–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å Raspberry Pi">
        <span id="refresh-icon" style="font-size:14px;">&#8635;</span> –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>
  </div>

  <div class="card-body">
  {# –¢–µ–∫—É—â–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è #}
  <div style="display:flex; gap:12px; margin-bottom:15px; flex-wrap:wrap;">
    <div style="
      flex:1; min-width:200px; padding:15px 20px;
      background:linear-gradient(135deg, #fff5f5, #fff);
      border:1px solid #ffcdd2; border-radius:8px;
      border-left:4px solid #e53935;
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–î–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—å—è (Ptr)</div>
      {% if pressure_latest.p_tube is not none %}
      <div style="font-size:28px; font-weight:700; color:#e53935;">
        {{ "%.2f"|format(pressure_latest.p_tube) }}
        <span style="font-size:14px; font-weight:400; color:#999;">–∞—Ç–º</span>
      </div>
      {% else %}
      <div style="font-size:16px; color:#ccc; font-style:italic;">–Ω–µ—Ç —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>
      {% endif %}
      {% if pressure_sensors.get('tube') %}
      <div style="font-size:11px; color:#b0b0b0; margin-top:4px; font-family:monospace;">{{ pressure_sensors.tube }}</div>
      {% endif %}
    </div>

    <div style="
      flex:1; min-width:200px; padding:15px 20px;
      background:linear-gradient(135deg, #e3f2fd, #fff);
      border:1px solid #bbdefb; border-radius:8px;
      border-left:4px solid #1e88e5;
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–î–∞–≤–ª–µ–Ω–∏–µ —à–ª–µ–π—Ñ–∞ (Pshl)</div>
      {% if pressure_latest.p_line is not none %}
      <div style="font-size:28px; font-weight:700; color:#1e88e5;">
        {{ "%.2f"|format(pressure_latest.p_line) }}
        <span style="font-size:14px; font-weight:400; color:#999;">–∞—Ç–º</span>
      </div>
      {% else %}
      <div style="font-size:16px; color:#ccc; font-style:italic;">–Ω–µ—Ç —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>
      {% endif %}
      {% if pressure_sensors.get('line') %}
      <div style="font-size:11px; color:#b0b0b0; margin-top:4px; font-family:monospace;">{{ pressure_sensors.line }}</div>
      {% endif %}
    </div>

    {% if pressure_latest.measured_at %}
    {% set age_seconds = (now_utc - pressure_latest.measured_at).total_seconds() %}
    {% set kunkrad_time = pressure_latest.measured_at_local %}
    <div style="
      flex:1; min-width:200px; padding:15px 20px;
      background:{% if age_seconds < 7200 %}#f0fdf4{% elif age_seconds < 86400 %}#fffbeb{% else %}#fef2f2{% endif %};
      border:1px solid {% if age_seconds < 7200 %}#bbf7d0{% elif age_seconds < 86400 %}#fde68a{% else %}#fecaca{% endif %};
      border-radius:8px;
      border-left:4px solid {% if age_seconds < 7200 %}#22c55e{% elif age_seconds < 86400 %}#f59e0b{% else %}#ef4444{% endif %};
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–º–µ—Ä</div>
      <div style="font-size:16px; font-weight:500; color:#495057;">
        {{ kunkrad_time.strftime('%d.%m.%Y %H:%M') }}
        <span style="font-size:11px; color:#9ca3af;">(–ö—É–Ω–≥—Ä–∞–¥, UTC+5)</span>
      </div>
      <div style="font-size:12px; margin-top:4px; color:{% if age_seconds < 7200 %}#16a34a{% elif age_seconds < 86400 %}#d97706{% else %}#dc2626{% endif %}; font-weight:500;">
        {% if age_seconds < 60 %}—Ç–æ–ª—å–∫–æ —á—Ç–æ
        {% elif age_seconds < 3600 %}{{ (age_seconds // 60)|int }} –º–∏–Ω –Ω–∞–∑–∞–¥
        {% elif age_seconds < 86400 %}{{ (age_seconds // 3600)|int }} —á {{ ((age_seconds % 3600) // 60)|int }} –º–∏–Ω –Ω–∞–∑–∞–¥
        {% else %}{{ (age_seconds // 86400)|int }} –¥–Ω {{ ((age_seconds % 86400) // 3600)|int }} —á –Ω–∞–∑–∞–¥
        {% endif %}
        {% if age_seconds < 7200 %}‚óè –æ–Ω–ª–∞–π–Ω{% elif age_seconds > 86400 %}‚óè –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö{% endif %}
      </div>
    </div>
    {% endif %}

    {% if channel_current %}
    <div style="
      flex:0 0 auto; min-width:120px; padding:15px 20px;
      background:#f0f4ff; border:1px solid #c7d2fe; border-radius:8px;
      border-left:4px solid #6366f1;
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–ö–∞–Ω–∞–ª LoRa</div>
      <div style="font-size:28px; font-weight:700; color:#4f46e5;">{{ channel_current.channel }}</div>
      {% if channel_current.started_at %}
      <div style="font-size:11px; color:#6b7280; margin-top:4px;">
        —Å {{ channel_current.started_at.strftime('%d.%m.%Y') }}
      </div>
      {% endif %}
    </div>
    {% endif %}

    {# TILE 5: ŒîP (–ø–µ—Ä–µ–ø–∞–¥ –¥–∞–≤–ª–µ–Ω–∏—è) #}
    {% if pressure_latest and pressure_latest.p_tube is not none and pressure_latest.p_line is not none %}
    {% set delta_p = pressure_latest.p_tube - pressure_latest.p_line %}
    <div style="
      flex:1; min-width:160px; padding:15px 20px;
      background:linear-gradient(135deg, #f3e5f5, #fff);
      border:1px solid #ce93d8; border-radius:8px;
      border-left:4px solid #8e24aa;
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–ü–µ—Ä–µ–ø–∞–¥ ŒîP</div>
      <div style="font-size:28px; font-weight:700; color:#8e24aa;">
        {{ "%.2f"|format(delta_p) }}
        <span style="font-size:14px; font-weight:400; color:#999;">–∫–≥—Å/—Å–º¬≤</span>
      </div>
      <div style="font-size:11px; color:#9e9e9e; margin-top:4px;">Ptr ‚àí Pshl</div>
    </div>
    {% endif %}

    {# TILE 6: –¢–µ–∫—É—â–∏–π –¥–µ–±–∏—Ç (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS) #}
    <div id="tile-current-flow" style="
      flex:1; min-width:160px; padding:15px 20px;
      background:linear-gradient(135deg, #fff3e0, #fff);
      border:1px solid #ffcc80; border-radius:8px;
      border-left:4px solid #ef6c00;
      display:none;
    ">
      <div style="font-size:12px; color:#999; margin-bottom:4px;">–¢–µ–∫—É—â–∏–π –¥–µ–±–∏—Ç</div>
      <div style="font-size:28px; font-weight:700; color:#ef6c00;">
        <span id="tile-flow-value">‚Äî</span>
        <span style="font-size:14px; font-weight:400; color:#999;">—Ç—ã—Å.–º¬≥/—Å—É—Ç</span>
      </div>
      <div style="font-size:11px; color:#9e9e9e; margin-top:4px;">
        <span id="tile-flow-hint">–∑–∞ 24—á</span>
      </div>
    </div>
  </div>

  {# ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥ ‚ïê‚ïê‚ïê #}
  <div id="events-summary-panel" style="
    display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;
  ">
    {# –†–µ–∞–≥–µ–Ω—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥ #}
    <div style="
      flex:1; min-width:200px;
      background:linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
      border:1px solid #ffcdd2; border-radius:10px; padding:12px 16px;
    ">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="font-size:20px;">üíâ</span>
        <span style="font-size:13px; font-weight:700; color:#c62828;">–†–µ–∞–≥–µ–Ω—Ç—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
      </div>
      <div id="summary-reagents" style="font-size:12px; color:#333;">
        <div style="display:flex; flex-wrap:wrap; gap:6px;" id="summary-reagents-list">
          {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS #}
        </div>
        <div id="summary-reagents-total" style="margin-top:6px; font-weight:600; color:#c62828;"></div>
      </div>
    </div>

    {# –°–æ–±—ã—Ç–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥ #}
    <div style="
      flex:1; min-width:200px;
      background:linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
      border:1px solid #ffe082; border-radius:10px; padding:12px 16px;
    ">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="font-size:20px;">üìä</span>
        <span style="font-size:13px; font-weight:700; color:#f57c00;">–°–æ–±—ã—Ç–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥</span>
      </div>
      <div id="summary-events" style="font-size:12px; color:#333;">
        <div style="display:flex; flex-wrap:wrap; gap:6px;" id="summary-events-list">
          {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS #}
        </div>
      </div>
    </div>

    {# –°–æ–±—ã—Ç–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è #}
    <div style="
      flex:1; min-width:180px;
      background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border:1px solid #a5d6a7; border-radius:10px; padding:12px 16px;
    ">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
        <span style="font-size:20px;">üìÖ</span>
        <span style="font-size:13px; font-weight:700; color:#2e7d32;">–°–µ–≥–æ–¥–Ω—è</span>
      </div>
      <div id="summary-today" style="font-size:12px; color:#333;">
        <div id="summary-today-list">
          {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS #}
        </div>
      </div>
    </div>
  </div>

  {# ‚ïê‚ïê‚ïê –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫: LoRa + –°–æ–±—ã—Ç–∏—è ‚ïê‚ïê‚ïê #}
  <div style="
    background:#f8f9fa; border-radius:8px; padding:20px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #dee2e6;
  ">
    {# ‚îÄ‚îÄ –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–∏–æ–¥–∞ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ ‚îÄ‚îÄ #}
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; flex-wrap:wrap; gap:8px;">
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:11px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:.03em;">–ü–µ—Ä–∏–æ–¥:</span>
        <div style="display:flex; gap:4px; flex-wrap:wrap;">
          <button data-sync-days="1" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">24—á</button>
          <button data-sync-days="3" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">3–¥</button>
          <button data-sync-days="7" style="padding:4px 10px; border:1px solid #1565c0; border-radius:4px; background:#1565c0; color:white; cursor:pointer; font-size:11px; font-weight:500;">7–¥</button>
          <button data-sync-days="30" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">30–¥</button>
          <button data-sync-days="90" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">90–¥</button>
        </div>
        {# –†—É—á–Ω–æ–π –≤—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞ #}
        <div style="display:flex; gap:4px; align-items:center;">
          <input type="date" id="sync-date-from"
            style="padding:3px 6px; border:1px solid #90a4ae; border-radius:4px; font-size:11px; color:#333; background:#f5f5f5;">
          <span style="color:#999; font-size:10px;">‚Äî</span>
          <input type="date" id="sync-date-to"
            style="padding:3px 6px; border:1px solid #90a4ae; border-radius:4px; font-size:11px; color:#333; background:#f5f5f5;">
          <button id="sync-date-apply"
            style="padding:4px 10px; border:1px solid #1565c0; border-radius:4px; background:#e3f2fd; color:#1565c0; cursor:pointer; font-size:11px; font-weight:600;">
            OK
          </button>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
        <span style="font-size:11px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:.03em;">–ò–Ω—Ç–µ—Ä–≤–∞–ª:</span>
        <div style="display:flex; gap:4px; flex-wrap:wrap;">
          <button data-sync-interval="2" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">2–º</button>
          <button data-sync-interval="5" style="padding:4px 10px; border:1px solid #1565c0; border-radius:4px; background:#1565c0; color:white; cursor:pointer; font-size:11px; font-weight:500;">5–º</button>
          <button data-sync-interval="10" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">10–º</button>
          <button data-sync-interval="15" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">15–º</button>
          <button data-sync-interval="30" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">30–º</button>
          <button data-sync-interval="60" style="padding:4px 10px; border:1px solid #90a4ae; border-radius:4px; background:#f5f5f5; color:#333; cursor:pointer; font-size:11px; font-weight:500;">60–º</button>
        </div>
      </div>
    </div>

    {# ‚îÄ‚îÄ –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–∞ ‚îÄ‚îÄ #}
    <div id="sync-filter-panel" style="
      display:flex; align-items:center; gap:12px; margin-bottom:8px;
      padding:6px 12px; background:#fff3e0; border:1px solid #ffe0b2;
      border-radius:6px; flex-wrap:wrap;
    ">
      <span style="font-size:11px; color:#e65100; font-weight:600; text-transform:uppercase; letter-spacing:.03em;">
        –§–∏–ª—å—Ç—Ä—ã:
      </span>
      <label style="font-size:12px; display:flex; align-items:center; gap:4px; cursor:pointer; color:#333;"
        title="–£–±—Ä–∞—Ç—å –ª–æ–∂–Ω—ã–µ –Ω—É–ª–∏ (0.0 ‚Üí –ø—Ä–æ–ø—É—Å–∫)">
        <input type="checkbox" id="sync-filter-zeros" style="accent-color:#e65100;">
        –£–±—Ä–∞—Ç—å –Ω—É–ª–∏
      </label>
      <label style="font-size:12px; display:flex; align-items:center; gap:4px; cursor:pointer; color:#333;"
        title="Hampel-—Ñ–∏–ª—å—Ç—Ä: —Å–ø–∞–π–∫–∏ > 1 –∞—Ç–º –æ—Ç –º–µ–¥–∏–∞–Ω—ã ‚Üí –∑–∞–º–µ–Ω—è—é—Ç—Å—è –º–µ–¥–∏–∞–Ω–æ–π">
        <input type="checkbox" id="sync-filter-spikes" style="accent-color:#e65100;">
        –°–≥–ª–∞–¥–∏—Ç—å —Å–ø–∞–π–∫–∏
      </label>
      <label style="font-size:12px; display:flex; align-items:center; gap:4px; color:#333;">
        –ü—Ä–æ–ø—É—Å–∫–∏:
        <select id="sync-filter-fill-mode" style="padding:3px 6px; border:1px solid #dee2e6; border-radius:4px; font-size:12px; background:white; color:#333;">
          <option value="none">–ù–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å</option>
          <option value="ffill">Forward-fill</option>
          <option value="interpolate">–ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è</option>
        </select>
      </label>
      <label style="font-size:12px; display:flex; align-items:center; gap:4px; color:#333;">
        –ú–∞–∫—Å.–ø—Ä–æ–ø—É—Å–∫:
        <input type="number" id="sync-filter-max-gap" value="10" min="1" max="60" step="1"
          style="width:50px; padding:3px 6px; border:1px solid #dee2e6; border-radius:4px; font-size:12px; text-align:center; color:#333;">
        <span style="font-size:11px; color:#666;">–º–∏–Ω</span>
      </label>
    </div>

    {# ‚îÄ‚îÄ –ö–∞—Å—Ç–æ–º–Ω–∞—è –ª–µ–≥–µ–Ω–¥–∞ —Å –≥—Ä—É–ø–ø–∞–º–∏ ‚îÄ‚îÄ #}
    <div id="sync-custom-legend" style="
      display:flex; flex-wrap:wrap; gap:12px; margin-bottom:8px;
      padding:8px 12px; background:white; border:1px solid #e9ecef; border-radius:6px;
      font-size:11px; align-items:flex-start;
    ">
      {# –ì—Ä—É–ø–ø–∞: –î–∞–≤–ª–µ–Ω–∏–µ #}
      <div style="display:flex; align-items:center; gap:8px;">
        <span style="font-weight:700; color:#666; text-transform:uppercase; letter-spacing:.03em;">–î–∞–≤–ª–µ–Ω–∏–µ:</span>
        <label id="legend-ptr" class="sync-legend-item" style="display:flex; align-items:center; gap:4px; cursor:pointer; padding:2px 6px; border-radius:4px; background:#fce4ec;">
          <span style="width:12px; height:3px; background:#e53935; border-radius:2px;"></span>
          <span style="color:#e53935; font-weight:600;">Ptr</span>
        </label>
        <label id="legend-pshl" class="sync-legend-item" style="display:flex; align-items:center; gap:4px; cursor:pointer; padding:2px 6px; border-radius:4px; background:#e3f2fd;">
          <span style="width:12px; height:3px; background:#1e88e5; border-radius:2px;"></span>
          <span style="color:#1e88e5; font-weight:600;">Pshl</span>
        </label>
      </div>

      {# –ì—Ä—É–ø–ø–∞: –°–æ–±—ã—Ç–∏—è (–≤—ã–ø–∞–¥–∞—é—â–∏–π) #}
      <div style="position:relative;">
        <button id="legend-events-toggle" type="button" style="
          display:flex; align-items:center; gap:4px; padding:4px 8px;
          background:#fff3e0; border:1px solid #ffcc80; border-radius:4px;
          font-size:11px; font-weight:600; color:#e65100; cursor:pointer;
        ">
          <span>üìã –°–æ–±—ã—Ç–∏—è</span>
          <span id="legend-events-count" style="background:#e65100; color:white; padding:0 4px; border-radius:8px; font-size:10px;">0</span>
          <span id="legend-events-arrow" style="transition:transform 0.2s;">‚ñº</span>
        </button>
        <div id="legend-events-dropdown" style="
          display:none; position:absolute; top:100%; left:0; z-index:100;
          min-width:180px; background:white; border:1px solid #dee2e6;
          border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
          padding:6px 0; margin-top:4px;
        ">
          {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS #}
        </div>
      </div>

      {# –ì—Ä—É–ø–ø–∞: –†–µ–∞–≥–µ–Ω—Ç—ã (–≤—ã–ø–∞–¥–∞—é—â–∏–π) #}
      <div style="position:relative;">
        <button id="legend-reagents-toggle" type="button" style="
          display:flex; align-items:center; gap:4px; padding:4px 8px;
          background:#fce4ec; border:1px solid #f48fb1; border-radius:4px;
          font-size:11px; font-weight:600; color:#c2185b; cursor:pointer;
        ">
          <span>üíâ –†–µ–∞–≥–µ–Ω—Ç—ã</span>
          <span id="legend-reagents-count" style="background:#c2185b; color:white; padding:0 4px; border-radius:8px; font-size:10px;">0</span>
          <span id="legend-reagents-arrow" style="transition:transform 0.2s;">‚ñº</span>
        </button>
        <div id="legend-reagents-dropdown" style="
          display:none; position:absolute; top:100%; left:0; z-index:100;
          min-width:200px; background:white; border:1px solid #dee2e6;
          border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
          padding:6px 0; margin-top:4px;
        ">
          {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS #}
        </div>
      </div>

      {# –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ü–≤–µ—Ç–æ–≤ #}
      <div style="position:relative; margin-left:auto;">
        <button id="color-settings-toggle" type="button" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–≤–µ—Ç–æ–≤" style="
          display:flex; align-items:center; gap:4px; padding:4px 8px;
          background:#f3f4f6; border:1px solid #d1d5db; border-radius:4px;
          font-size:11px; font-weight:600; color:#6b7280; cursor:pointer;
        ">
          <span>üé®</span>
          <span>–¶–≤–µ—Ç–∞</span>
        </button>
        <div id="color-settings-dropdown" style="
          display:none; position:absolute; top:100%; right:0; z-index:100;
          width:280px; background:white; border:1px solid #dee2e6;
          border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.15);
          padding:12px; margin-top:4px;
        ">
          <div style="font-weight:700; color:#333; margin-bottom:10px; font-size:12px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

          {# –ó–∞—Ö–≤–∞—Ç —Å–æ–±—ã—Ç–∏–π #}
          <div style="margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid #e9ecef;">
            <div style="font-size:11px; color:#666; font-weight:600; margin-bottom:6px; text-transform:uppercase;">–ó–∞—Ö–≤–∞—Ç —Å–æ–±—ã—Ç–∏–π</div>
            <div style="display:flex; align-items:center; gap:8px;">
              <input id="sync-event-sensitivity" type="range"
                min="20" max="200" step="10" value="60"
                style="flex:1; height:16px; cursor:pointer; accent-color:#1565c0;"
                title="–†–∞–¥–∏—É—Å –∑–∞—Ö–≤–∞—Ç–∞ —Å–æ–±—ã—Ç–∏–π (–ø–∏–∫—Å–µ–ª–µ–π)">
              <span id="sync-event-sensitivity-label" style="min-width:36px; text-align:right; font-weight:600; color:#1565c0; font-size:11px;">60px</span>
            </div>
          </div>

          {# –°–æ–±—ã—Ç–∏—è #}
          <div style="margin-bottom:12px;">
            <div style="font-size:11px; color:#666; font-weight:600; margin-bottom:6px; text-transform:uppercase;">–°–æ–±—ã—Ç–∏—è</div>
            <div id="color-settings-events" style="display:flex; flex-direction:column; gap:6px;">
              {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS #}
            </div>
          </div>

          {# –†–µ–∞–≥–µ–Ω—Ç—ã #}
          <div style="margin-bottom:12px;">
            <div style="font-size:11px; color:#666; font-weight:600; margin-bottom:6px; text-transform:uppercase;">–†–µ–∞–≥–µ–Ω—Ç—ã</div>
            <div id="color-settings-reagents" style="display:flex; flex-direction:column; gap:6px;">
              {# –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ JS #}
            </div>
          </div>

          {# –†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–æ–≤ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ #}
          <div style="padding-top:10px; border-top:1px solid #e9ecef;">
            <div style="font-size:11px; color:#666; font-weight:600; margin-bottom:6px; text-transform:uppercase;">–†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–æ–≤</div>
            <div style="display:flex; align-items:center; gap:8px;">
              <input id="reagent-marker-size" type="range"
                min="3" max="20" step="1" value="8"
                style="flex:1; height:16px; cursor:pointer; accent-color:#e53935;"
                title="–†–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–æ–≤ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤">
              <span id="reagent-marker-size-label" style="min-width:28px; text-align:right; font-weight:600; color:#e53935; font-size:11px;">8</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    {# ‚îÄ‚îÄ –ì—Ä–∞—Ñ–∏–∫ + Y-—Å–ª–∞–π–¥–µ—Ä + Tooltip –ø–∞–Ω–µ–ª—å ‚îÄ‚îÄ #}
    <div style="display:flex; gap:8px;">
      {# –°–ª–∞–π–¥–µ—Ä Y-–¥–∞–≤–ª–µ–Ω–∏–µ (–ª–µ–≤–∞—è –æ—Å—å) #}
      <div style="display:flex; flex-direction:column; align-items:center; gap:4px; width:40px; padding:8px 0;">
        <span style="font-size:10px; color:#e53935; font-weight:600;">P</span>
        <input id="sync-y-pressure-slider" type="range"
          style="writing-mode:vertical-lr; direction:rtl; flex:1; width:28px; cursor:pointer; accent-color:#e53935;"
          min="1" max="100" step="1" value="100">
        <span id="sync-y-pressure-label" style="font-size:10px; color:#6b7280; white-space:nowrap;">–∞–≤—Ç–æ</span>
      </div>

      {# Canvas + overlay controls #}
      <div style="flex:1; height:400px; background:white; border-radius:6px; padding:15px; border:1px solid #e9ecef; position:relative;">
        <canvas id="chart_synchronized" data-well-id="{{ well.id }}"></canvas>
        {# ‚îÄ‚îÄ Overlay –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚îÄ‚îÄ #}
        <div id="sync-chart-controls" style="
          position:absolute; top:8px; right:8px; display:flex; gap:3px; z-index:10;
          background:rgba(255,255,255,.85); border-radius:6px; padding:3px;
          border:1px solid #e0e0e0; backdrop-filter:blur(4px);
        ">
          <button id="sync-pan-toggle" title="–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞" style="
            width:28px; height:28px; border:1px solid #ccc; border-radius:4px;
            background:#fff; cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center;
            color:#333;
          ">&#9995;</button>
          <button id="sync-zoom-back" title="–ù–∞–∑–∞–¥" style="
            width:28px; height:28px; border:1px solid #ccc; border-radius:4px;
            background:#fff; cursor:pointer; font-size:13px; display:flex; align-items:center; justify-content:center;
            color:#333;
          ">&#8592;</button>
          <button id="sync-reset-zoom" title="–°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞" style="
            width:28px; height:28px; border:1px solid #ccc; border-radius:4px;
            background:#fff; cursor:pointer; font-size:13px; display:flex; align-items:center; justify-content:center;
            color:#333;
          ">&#8634;</button>
        </div>
      </div>

      {# ‚ïê‚ïê‚ïê –í–Ω–µ—à–Ω—è—è –ø–∞–Ω–µ–ª—å Tooltip (—Å–ø—Ä–∞–≤–∞) ‚Äî —Å–µ—Ä–∞—è ‚ïê‚ïê‚ïê #}
      <div id="sync-tooltip-panel" style="
        width:240px; min-width:240px;
        background:#f8f9fa;
        border:1px solid #dee2e6;
        border-radius:8px;
        padding:12px;
        display:flex; flex-direction:column; gap:8px;
        color:#333;
        font-size:13px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      ">
        {# –í—Ä–µ–º—è + –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ #}
        <div style="border-bottom:1px solid #dee2e6; padding-bottom:8px;">
          <div style="display:flex; align-items:center; justify-content:space-between;">
            <div style="flex:1; text-align:center;">
              <div style="font-size:11px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em;">–í—Ä–µ–º—è</div>
              <div id="sync-tooltip-time" style="font-size:16px; font-weight:700; color:#212529;">‚Äî</div>
            </div>
            <div id="sync-mode-indicator" style="display:none; padding:4px 8px; background:#1565c0; color:white; border-radius:4px; font-size:10px; font-weight:600;">
              üîí –§–∏–∫—Å
            </div>
          </div>
          {# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—ã–±–æ—Ä–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ #}
          <div id="sync-range-indicator" style="display:none; margin-top:6px; padding:6px; background:#fff3e0; border-radius:4px; font-size:11px; text-align:center;">
            <div style="color:#e65100; font-weight:600;">üìê –í—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞</div>
            <div id="sync-range-start" style="color:#666; margin-top:2px;">–ù–∞—á–∞–ª–æ: ‚Äî</div>
            <div id="sync-range-end" style="color:#666;">–ö–æ–Ω–µ—Ü: ‚Äî</div>
          </div>
        </div>

        {# –î–∞–≤–ª–µ–Ω–∏–µ Ptr #}
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span style="color:#e53935; font-weight:700; font-size:13px;">Ptr</span>
          <span id="sync-tooltip-ptr" style="font-family:monospace; font-size:14px; color:#333; font-weight:500;">‚Äî</span>
        </div>

        {# –î–∞–≤–ª–µ–Ω–∏–µ Pshl #}
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span style="color:#1e88e5; font-weight:700; font-size:13px;">Pshl</span>
          <span id="sync-tooltip-pshl" style="font-family:monospace; font-size:14px; color:#333; font-weight:500;">‚Äî</span>
        </div>

        {# –î–µ–ª—å—Ç–∞ #}
        <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #dee2e6; padding-top:8px;">
          <span style="color:#2e7d32; font-weight:700; font-size:13px;">ŒîP</span>
          <span id="sync-tooltip-delta" style="font-family:monospace; font-size:14px; color:#333; font-weight:500;">‚Äî</span>
        </div>

        {# –°–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å) - –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π #}
        <div id="sync-tooltip-events-container" style="display:none; border-top:1px solid #dee2e6; padding-top:8px; margin-top:4px; max-height:300px; overflow-y:auto;">
          <div style="font-size:11px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px; font-weight:600;">
            –°–æ–±—ã—Ç–∏—è <span id="sync-tooltip-events-count" style="font-weight:700; color:#333;"></span>
          </div>
          <div id="sync-tooltip-events-list" style="display:flex; flex-direction:column; gap:8px;">
            {# –≠–ª–µ–º–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JS #}
          </div>
        </div>
      </div>
    </div>

    {# ‚ïê‚ïê‚ïê –ú–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º ‚ïê‚ïê‚ïê #}
    <div id="sync-range-menu" style="
      display:none; margin-top:8px; padding:10px;
      background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border:1px solid #dee2e6; border-radius:8px;
    ">
      <div style="font-size:12px; font-weight:600; color:#333; margin-bottom:8px;">
        üìê –í—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: <span id="sync-range-info" style="color:#1565c0;"></span>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="sync-range-export-excel" type="button" style="
          padding:6px 12px; background:#28a745; color:white; border:none;
          border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:4px;
        ">üìä –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button id="sync-range-save-image" type="button" style="
          padding:6px 12px; background:#17a2b8; color:white; border:none;
          border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:4px;
        ">üì∑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫</button>
        <button id="sync-range-calculate" type="button" style="
          padding:6px 12px; background:#6f42c1; color:white; border:none;
          border-radius:4px; font-size:11px; cursor:pointer; display:flex; align-items:center; gap:4px;
        ">üßÆ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
        <button id="sync-range-cancel" type="button" style="
          padding:6px 12px; background:#6c757d; color:white; border:none;
          border-radius:4px; font-size:11px; cursor:pointer;
        ">‚úï –û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <div style="margin-top:8px; font-size:11px; color:#999; text-align:center;">
      –ö—Ä–∏–≤—ã–µ –¥–∞–≤–ª–µ–Ω–∏—è (LoRa) + —Å–æ–±—ã—Ç–∏—è (Telegram) ‚Ä¢
      –ü–ö–ú = —Ñ–∏–∫—Å–∞—Ü–∏—è –∫—É—Ä—Å–æ—Ä–∞ / –≤—ã–±–æ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ ‚Ä¢
      –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à–∫–æ–π –¥–ª—è –∑—É–º–∞ ‚Ä¢ Shift + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    </div>
  </div>

  {# ‚îÄ‚îÄ –ü–æ–ø–∞–ø —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–∞–≤—ã–π –∫–ª–∏–∫ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ) ‚îÄ‚îÄ #}
  <div id="raw-data-popup" style="
    display:none; position:fixed; z-index:9999;
    background:white; border:1px solid #dee2e6; border-radius:8px;
    box-shadow:0 8px 32px rgba(0,0,0,0.25); padding:14px; max-width:540px;
    font-size:12px;
  ">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <b style="color:#333;">üìã –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ pressure_readings</b>
      <span id="raw-data-close" style="cursor:pointer; color:#999; font-size:18px; line-height:1; padding:0 4px;">&times;</span>
    </div>
    <div id="raw-data-content" style="overflow-x:auto;">
      <table id="raw-data-table" style="width:100%; border-collapse:collapse; font-family:'JetBrains Mono',monospace; font-size:11px;">
      </table>
    </div>
  </div>
  </div>{# /card-body #}
</div>{# /card #}

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ì–†–ê–§–ò–ö ŒîP (—Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–≤–ª–µ–Ω–∏–π) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
<div class="card" style="width:100%; margin-bottom:20px;">
  <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h2 style="margin:0;">üìâ ŒîP ‚Äî —Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–≤–ª–µ–Ω–∏–π</h2>
      <small style="color: #6c757d;">ŒîP = Ptr (—É—Å—Ç—å–µ) ‚àí Pshl (—à–ª–µ–π—Ñ). –ß–µ–º –≤—ã—à–µ ‚Äî —Ç–µ–º –ª—É—á—à–µ.</small>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <label style="font-size:12px; color:#6b7280; font-weight:500; display:flex; align-items:center; gap:4px;">
        –ü–æ—Ä–æ–≥:
        <input id="delta-threshold-input" type="number" step="0.05" min="0" max="10" value="0.5"
          style="width:65px; padding:4px 6px; border:1px solid #dee2e6; border-radius:4px; font-size:12px; text-align:center;">
        <span style="font-size:11px; color:#999;">–∞—Ç–º</span>
      </label>
      <button id="delta-reset-zoom"
        style="padding:5px 12px; border:1px solid #dee2e6; border-radius:4px; background:white; cursor:pointer; font-size:12px;">
        –°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±
      </button>
    </div>
  </div>
  <div class="card-body">
    <div style="
      background:#f8f9fa; border-radius:8px; padding:20px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08); border:1px solid #dee2e6;
    ">
      <div style="display:flex; gap:8px;">
        {# Y-—Å–ª–∞–π–¥–µ—Ä —Å–ª–µ–≤–∞ #}
        <div style="display:flex; flex-direction:column; align-items:center; gap:4px; width:40px; padding:8px 0;">
          <span style="font-size:10px; color:#2e7d32; font-weight:600;">ŒîP</span>
          <input id="delta-y-slider" type="range"
            style="writing-mode:vertical-lr; direction:rtl; flex:1; width:28px; cursor:pointer; accent-color:#2e7d32;"
            min="0.5" max="10" step="0.1" value="2.0">
          <span id="delta-y-label" style="font-size:10px; color:#6b7280; white-space:nowrap;">2.0</span>
        </div>

        {# Canvas #}
        <div style="flex:1; height:300px; background:white; border-radius:6px; padding:15px; border:1px solid #e9ecef;">
          <canvas id="chart_delta_pressure" data-well-id="{{ well.id }}"></canvas>
        </div>

        {# ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ŒîP (—Å–ø—Ä–∞–≤–∞) ‚ïê‚ïê‚ïê #}
        <div id="delta-stats-panel" style="
          width:240px; min-width:240px;
          background:#f8f9fa;
          border:1px solid #dee2e6;
          border-radius:8px;
          padding:12px;
          display:flex; flex-direction:column; gap:6px;
          color:#333;
          font-size:12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        ">
          {# –ö—É—Ä—Å–æ—Ä: –≤—Ä–µ–º—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ #}
          <div style="text-align:center; border-bottom:1px solid #dee2e6; padding-bottom:8px;">
            <div style="font-size:11px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em;">–ö—É—Ä—Å–æ—Ä</div>
            <div id="delta-cursor-time" style="font-size:14px; font-weight:700; color:#212529;">‚Äî</div>
            <div id="delta-cursor-value" style="font-size:16px; font-weight:700; color:#2e7d32;">‚Äî</div>
          </div>

          {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ #}
          <div style="text-align:center; padding-bottom:4px;">
            <div style="font-size:10px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          </div>

          {# –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ) #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#e8f5e9; padding:6px 8px; border-radius:4px;">
            <span style="color:#2e7d32; font-weight:600;">–ü–æ—Å–ª–µ–¥–Ω–µ–µ</span>
            <span id="delta-stat-current" style="font-family:monospace; font-size:13px; font-weight:700; color:#2e7d32;">‚Äî</span>
          </div>

          {# –ú–∞–∫—Å–∏–º—É–º #}
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#666;">–ú–∞–∫—Å</span>
            <span id="delta-stat-max" style="font-family:monospace; color:#333;">‚Äî</span>
          </div>

          {# –ú–∏–Ω–∏–º—É–º #}
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#666;">–ú–∏–Ω</span>
            <span id="delta-stat-min" style="font-family:monospace; color:#333;">‚Äî</span>
          </div>

          {# –°—Ä–µ–¥–Ω–µ–µ #}
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ</span>
            <span id="delta-stat-avg" style="font-family:monospace; color:#333;">‚Äî</span>
          </div>

          {# –ú–µ–¥–∏–∞–Ω–∞ #}
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="color:#666;">–ú–µ–¥–∏–∞–Ω–∞</span>
            <span id="delta-stat-median" style="font-family:monospace; color:#333;">‚Äî</span>
          </div>

          {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å #}
          <div style="border-top:1px solid #dee2e6; margin:4px 0;"></div>

          {# –í—Ä–µ–º—è –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#e8f5e9; padding:4px 8px; border-radius:4px;">
            <span style="color:#2e7d32; font-size:11px;">‚ñ≤ –í—ã—à–µ –ø–æ—Ä–æ–≥–∞</span>
            <span id="delta-stat-above" style="font-family:monospace; font-size:11px; font-weight:600; color:#2e7d32;">‚Äî</span>
          </div>

          {# –í—Ä–µ–º—è –Ω–∏–∂–µ –ø–æ—Ä–æ–≥–∞ #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#ffebee; padding:4px 8px; border-radius:4px;">
            <span style="color:#c62828; font-size:11px;">‚ñº –ù–∏–∂–µ –ø–æ—Ä–æ–≥–∞</span>
            <span id="delta-stat-below" style="font-family:monospace; font-size:11px; font-weight:600; color:#c62828;">‚Äî</span>
          </div>
        </div>
      </div>
      <div style="margin-top:10px; font-size:11px; color:#999; text-align:center;">
        –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à–∫–æ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Ä¢ –ü–æ–ª–∑—É–Ω–æ–∫ ŒîP ‚Äî –º–∞—Å—à—Ç–∞–± ‚Ä¢ –ü–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –¥–∞–≤–ª–µ–Ω–∏–π
      </div>
    </div>
  </div>
</div>
{% endif %}

{# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê –ì–†–ê–§–ò–ö –î–ï–ë–ò–¢–ê –ì–ê–ó–ê (—Ä–∞—Å—á—ë—Ç –ø–æ –¥–∞–≤–ª–µ–Ω–∏—è–º) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê #}
{% if well_construction and well_construction["choke_diam_mm"] is not none and well_construction["choke_diam_mm"] == well_construction["choke_diam_mm"] %}
<div class="card" style="width:100%; margin-bottom:20px;">
  <div class="card-header" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div>
      <h2 style="margin:0;">‚õΩ –î–µ–±–∏—Ç –≥–∞–∑–∞ (—Ä–∞—Å—á—ë—Ç –ø–æ –¥–∞–≤–ª–µ–Ω–∏—è–º)</h2>
      <small style="color: #6c757d;">
        –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –ì–∏–ª–±–µ—Ä—Ç–∞-–ü–∏—Ä–≤–µ—Ä–¥—è–Ω–∞ ‚Ä¢ –®—Ç—É—Ü–µ—Ä: {{ well_construction["choke_diam_mm"] }} –º–º
      </small>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="flow-toggle-info" type="button" style="
        padding:5px 12px; border:1px solid #dee2e6; border-radius:6px;
        background:#f8f9fa; color:#666; font-size:12px; cursor:pointer;
        display:inline-flex; align-items:center; gap:4px;
      " title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ —Ñ–æ—Ä–º—É–ª—ã">üìñ –§–æ—Ä–º—É–ª–∞</button>
      <button id="flow-toggle-coeffs" type="button" style="
        padding:5px 12px; border:1px solid #dee2e6; border-radius:6px;
        background:#f8f9fa; color:#666; font-size:12px; cursor:pointer;
        display:inline-flex; align-items:center; gap:4px;
      " title="–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤">‚öô –ö–æ—ç—Ñ—Ñ.</button>
      <button id="flow-reset-zoom" type="button" style="
        padding:5px 12px; border:1px solid #dee2e6; border-radius:6px;
        background:#f8f9fa; color:#666; font-size:12px; cursor:pointer;
        display:inline-flex; align-items:center; gap:4px;
      " title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±">üîç –°–±—Ä–æ—Å</button>
      <button id="flow-segment-mode" type="button" style="
        padding:5px 12px; border:1px solid #dee2e6; border-radius:6px;
        background:#f8f9fa; color:#666; font-size:12px; cursor:pointer;
        display:inline-flex; align-items:center; gap:4px;
      " title="–í—ã–¥–µ–ª–∏—Ç—å —É—á–∞—Å—Ç–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞">üìä –ê–Ω–∞–ª–∏–∑</button>
    </div>
  </div>

  <div class="card-body">

    {# ‚ïê‚ïê‚ïê –ë–ª–æ–∫ –æ–ø–∏—Å–∞–Ω–∏—è —Ñ–æ—Ä–º—É–ª—ã (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚ïê‚ïê‚ïê #}
    <div id="flow-info-block" style="display:none; margin-bottom:16px; padding:16px; background:linear-gradient(135deg, #f5f5f5, #fafafa); border:1px solid #e0e0e0; border-radius:8px; font-size:13px; line-height:1.6; color:#333;">
      <div style="font-weight:700; font-size:14px; color:#212529; margin-bottom:10px;">–û–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—á—ë—Ç–∞</div>

      <div style="margin-bottom:10px;">
        –†–∞—Å—á—ë—Ç–Ω—ã–π –¥–µ–±–∏—Ç –≥–∞–∑–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º—É–ª–µ <b>–ì–∏–ª–±–µ—Ä—Ç–∞-–ü–∏—Ä–≤–µ—Ä–¥—è–Ω–∞</b>,
        —Å–≤—è–∑—ã–≤–∞—é—â–µ–π –ø–µ—Ä–µ–ø–∞–¥ –¥–∞–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ —à—Ç—É—Ü–µ—Ä (P<sub>—Ç—Ä</sub> –∏ P<sub>—à–ª</sub>) —Å —Ä–∞—Å—Ö–æ–¥–æ–º –≥–∞–∑–∞.
      </div>

      <div style="background:white; border:1px solid #e0e0e0; border-radius:6px; padding:12px 16px; margin-bottom:10px; font-family:'JetBrains Mono',monospace; font-size:12px;">
        <div style="font-weight:600; color:#666; margin-bottom:6px; font-family:inherit; font-size:11px;">–§–û–†–ú–£–õ–ê (–¥–æ–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º, r &lt; 0.5):</div>
        <div style="color:#1565c0;">Q = M &middot; (C‚ÇÅ &middot; P<sub>—Ç—Ä</sub> &minus; C‚ÇÇ &middot; P<sub>—à–ª</sub>) &middot; d<sup>2</sup> / C‚ÇÉ</div>
        <div style="margin-top:8px; font-weight:600; color:#666; font-family:inherit; font-size:11px;">–§–û–†–ú–£–õ–ê (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º, r &ge; 0.5):</div>
        <div style="color:#c62828;">Q = M &middot; C‚ÇÅ &middot; P<sub>—Ç—Ä</sub> &middot; (1 &minus; r) &middot; d<sup>2</sup> / C‚ÇÉ</div>
        <div style="margin-top:8px; font-size:11px; color:#888;">–≥–¥–µ r = P<sub>—à–ª</sub> / P<sub>—Ç—Ä</sub> ‚Äî –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏–π</div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:12px;">
        <div><b>Q</b> ‚Äî –¥–µ–±–∏—Ç –≥–∞–∑–∞, —Ç—ã—Å. –º¬≥/—Å—É—Ç</div>
        <div><b>M</b> ‚Äî –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4.1)</div>
        <div><b>P<sub>—Ç—Ä</sub></b> ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—å—è (—Ç—Ä—É–±–Ω–æ–µ), –∫–≥—Å/—Å–º¬≤</div>
        <div><b>P<sub>—à–ª</sub></b> ‚Äî –¥–∞–≤–ª–µ–Ω–∏–µ —à–ª–µ–π—Ñ–∞, –∫–≥—Å/—Å–º¬≤</div>
        <div><b>d</b> ‚Äî –¥–∏–∞–º–µ—Ç—Ä —à—Ç—É—Ü–µ—Ä–∞, –º–º</div>
        <div><b>C‚ÇÅ, C‚ÇÇ, C‚ÇÉ</b> ‚Äî —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã</div>
      </div>

      <div style="margin-top:10px; border-top:1px solid #e0e0e0; padding-top:10px;">
        <div style="font-weight:700; font-size:13px; color:#212529; margin-bottom:6px;">–ê–ª–≥–æ—Ä–∏—Ç–º</div>
        <ol style="margin:0; padding-left:20px; font-size:12px; color:#555;">
          <li>–ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–∞–≤–ª–µ–Ω–∏—è –∏–∑ PostgreSQL (—Ç–∞–±–ª–∏—Ü–∞ <code>pressure_raw</code>)</li>
          <li>–û—á–∏—Å—Ç–∫–∞: –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è ‚Üí NaN, –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è (ffill/bfill)</li>
          <li>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ: —Ñ–∏–ª—å—Ç—Ä –°–∞–≤–∏—Ü–∫–æ–≥–æ-–ì–æ–ª–µ—è (–æ–∫–Ω–æ 17, –ø–æ–ª–∏–Ω–æ–º 3, 2 –ø—Ä–æ—Ö–æ–¥–∞)</li>
          <li>–†–∞—Å—á—ë—Ç –¥–µ–±–∏—Ç–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ (numpy-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è)</li>
          <li>–î–µ—Ç–µ–∫—Ü–∏—è –ø—Ä–æ–¥—É–≤–æ–∫ –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º –≤ –ë–î (start‚Üípress‚Üístop) –∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏ –ø–æ –∫—Ä–∏–≤–æ–π –¥–∞–≤–ª–µ–Ω–∏—è</li>
          <li>–ü–æ—Ç–µ—Ä–∏ –ø—Ä–∏ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–∏: –ø–æ —É—Ä–∞–≤–Ω–µ–Ω–∏—é –ë–µ—Ä–Ω—É–ª–ª–∏ —á–µ—Ä–µ–∑ —à—Ç—É—Ü–µ—Ä (—Ç–æ–ª—å–∫–æ —Ñ–∞–∑–∞ venting)</li>
          <li>–ü—Ä–æ—Å—Ç–æ–∏: –≤—Å–µ –ø–µ—Ä–∏–æ–¥—ã P<sub>—Ç—Ä</sub> &le; P<sub>—à–ª</sub> (–¥–µ–±–∏—Ç = 0, –ø–æ—Ç–µ—Ä—å –Ω–µ—Ç)</li>
          <li>–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –¥–µ–±–∏—Ç: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç—Ä–∞–ø–µ—Ü–∏—è–º–∏ (Œît = 1/1440 —Å—É—Ç–æ–∫)</li>
        </ol>
      </div>

      <div style="margin-top:10px; border-top:1px solid #e0e0e0; padding-top:10px;">
        <div style="font-weight:700; font-size:13px; color:#c62828; margin-bottom:6px;">–ü—Ä–æ–¥—É–≤–∫–∞ vs –ü—Ä–æ—Å—Ç–æ–π</div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:12px;">
          <div style="background:#ffebee; padding:8px; border-radius:6px; border-left:3px solid #e53935;">
            <div style="font-weight:700; color:#c62828; margin-bottom:4px;">üî• –ü—Ä–æ–¥—É–≤–∫–∞ (—Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–µ)</div>
            <div style="color:#555;">–ó–∞–¥–≤–∏–∂–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞, –≥–∞–∑ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.</div>
            <div style="color:#555; margin-top:4px;"><b>–ü–æ—Ç–µ—Ä–∏</b> —Å—á–∏—Ç–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —à—Ç—É—Ü–µ—Ä (–ë–µ—Ä–Ω—É–ª–ª–∏).</div>
            <div style="color:#555; margin-top:2px;">–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –º–∞—Ä–∫–µ—Ä–∞–º (start‚Üípress) –∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∏—á–µ—Å–∫–∏.</div>
          </div>
          <div style="background:#fff8e1; padding:8px; border-radius:6px; border-left:3px solid #ffa000;">
            <div style="font-weight:700; color:#e65100; margin-bottom:4px;">‚è± –ü—Ä–æ—Å—Ç–æ–π (P<sub>—Ç—Ä</sub> &le; P<sub>—à–ª</sub>)</div>
            <div style="color:#555;">–ì–∞–∑ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –≤ —à–ª–µ–π—Ñ. –î–µ–±–∏—Ç = 0.</div>
            <div style="color:#555; margin-top:4px;">–í–∫–ª—é—á–∞–µ—Ç: –Ω–∞–±–æ—Ä –¥–∞–≤–ª–µ–Ω–∏—è (press‚Üístop), —Ç–µ—Ö. –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.</div>
            <div style="color:#555; margin-top:2px;"><b>–ü–æ—Ç–µ—Ä—å –Ω–µ—Ç</b> ‚Äî –≥–∞–∑ –Ω–µ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.</div>
          </div>
        </div>
      </div>

      <div style="margin-top:10px; border-top:1px solid #e0e0e0; padding-top:10px;">
        <div style="font-weight:700; font-size:13px; color:#212529; margin-bottom:6px;">–§–æ—Ä–º—É–ª–∞ –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–∏</div>
        <div style="background:white; border:1px solid #e0e0e0; border-radius:6px; padding:10px 14px; font-family:'JetBrains Mono',monospace; font-size:12px;">
          <div style="color:#c62828;">Q<sub>loss</sub> = C<sub>d</sub> &middot; A &middot; &radic;(2&middot;ŒîP / &rho;)</div>
          <div style="margin-top:6px; font-size:11px; color:#888;">
            C<sub>d</sub> = 0.9 (–∫–æ—ç—Ñ—Ñ. —Ä–∞—Å—Ö–æ–¥–∞),
            A = &pi;&middot;d¬≤/4 (—Å–µ—á–µ–Ω–∏–µ —à—Ç—É—Ü–µ—Ä–∞ –ø—Ä–æ–¥—É–≤–∫–∏),
            ŒîP = P<sub>—É—Å—Ç</sub> &minus; P<sub>–∞—Ç–º</sub>,
            &rho; ‚Äî –ø–ª–æ—Ç–Ω–æ—Å—Ç—å –≥–∞–∑–∞ –ø—Ä–∏ P<sub>—É—Å—Ç</sub>
          </div>
        </div>
      </div>
    </div>

    {# ‚ïê‚ïê‚ïê –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) ‚ïê‚ïê‚ïê #}
    <div id="flow-coeffs-block" style="display:none; margin-bottom:16px; padding:16px; background:linear-gradient(135deg, #fff8e1, #fffde7); border:1px solid #ffe0b2; border-radius:8px;">
      <div style="font-weight:700; font-size:14px; color:#e65100; margin-bottom:12px;">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—É–ª—ã</div>
      <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:12px;">

        <div>
          <label style="font-size:11px; color:#666; font-weight:600; display:block; margin-bottom:3px;">
            M ‚Äî –º–Ω–æ–∂–∏—Ç–µ–ª—å
          </label>
          <input id="flow-coeff-M" type="number" step="0.1" min="0.1" max="50" value="4.1"
            style="width:100%; padding:6px 8px; border:1px solid #ffe0b2; border-radius:4px; font-size:13px; text-align:center; font-weight:600; background:white;">
          <div style="font-size:10px; color:#999; margin-top:2px;">–∫–∞–ª–∏–±—Ä–æ–≤–∫–∞ (–ø–æ —É–º–æ–ª—á. 4.1)</div>
        </div>

        <div>
          <label style="font-size:11px; color:#666; font-weight:600; display:block; margin-bottom:3px;">
            C‚ÇÅ
          </label>
          <input id="flow-coeff-C1" type="number" step="0.001" min="0" max="100" value="2.919"
            style="width:100%; padding:6px 8px; border:1px solid #ffe0b2; border-radius:4px; font-size:13px; text-align:center; background:white;">
          <div style="font-size:10px; color:#999; margin-top:2px;">–ø–æ —É–º–æ–ª—á. 2.919</div>
        </div>

        <div>
          <label style="font-size:11px; color:#666; font-weight:600; display:block; margin-bottom:3px;">
            C‚ÇÇ
          </label>
          <input id="flow-coeff-C2" type="number" step="0.001" min="0" max="100" value="4.654"
            style="width:100%; padding:6px 8px; border:1px solid #ffe0b2; border-radius:4px; font-size:13px; text-align:center; background:white;">
          <div style="font-size:10px; color:#999; margin-top:2px;">–ø–æ —É–º–æ–ª—á. 4.654</div>
        </div>

        <div>
          <label style="font-size:11px; color:#666; font-weight:600; display:block; margin-bottom:3px;">
            C‚ÇÉ
          </label>
          <input id="flow-coeff-C3" type="number" step="0.01" min="0" max="1000" value="286.95"
            style="width:100%; padding:6px 8px; border:1px solid #ffe0b2; border-radius:4px; font-size:13px; text-align:center; background:white;">
          <div style="font-size:10px; color:#999; margin-top:2px;">–ø–æ —É–º–æ–ª—á. 286.95</div>
        </div>

        <div>
          <label style="font-size:11px; color:#666; font-weight:600; display:block; margin-bottom:3px;">
            r<sub>–∫—Ä–∏—Ç</sub> ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ
          </label>
          <input id="flow-coeff-Rcrit" type="number" step="0.01" min="0" max="1" value="0.5"
            style="width:100%; padding:6px 8px; border:1px solid #ffe0b2; border-radius:4px; font-size:13px; text-align:center; background:white;">
          <div style="font-size:10px; color:#999; margin-top:2px;">–≥—Ä–∞–Ω–∏—Ü–∞ —Ä–µ–∂–∏–º–æ–≤ (–ø–æ —É–º–æ–ª—á. 0.5)</div>
        </div>

        <div style="display:flex; align-items:flex-end;">
          <button id="flow-apply-coeffs" type="button" style="
            width:100%; padding:8px 12px; border:none; border-radius:6px;
            background:#ff9800; color:white; font-size:13px; font-weight:600;
            cursor:pointer; display:flex; align-items:center; justify-content:center; gap:4px;
          ">‚ñ∂ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å</button>
        </div>
      </div>
      <div style="margin-top:8px; font-size:11px; color:#999;">
        –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ—Ç –¥–µ–±–∏—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –ó–Ω–∞—á–µ–Ω–∏—è <b>–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è</b> –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏.
      </div>
    </div>

    {# ‚îÄ‚îÄ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ ‚îÄ‚îÄ #}
    <div id="flow-stats-loading" style="text-align:center; padding:15px; color:#999; font-size:13px;">
      ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–µ–±–∏—Ç–∞...
    </div>

    {# ‚ïê‚ïê‚ïê –ì—Ä–∞—Ñ–∏–∫ + –ø—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–∫–∞–∫ —É –¥–∞–≤–ª–µ–Ω–∏—è / ŒîP) ‚ïê‚ïê‚ïê #}
    <div id="flow-main-content" style="display:none;">
      <div style="display:flex; gap:8px; align-items:stretch;">

        {# ‚îÄ‚îÄ –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –≥—Ä–∞—Ñ–∏–∫ + –ø–ª–∏—Ç–∫–∏ ‚îÄ‚îÄ #}
        <div style="flex:1; display:flex; flex-direction:column; gap:8px;">

          {# Canvas –≥—Ä–∞—Ñ–∏–∫–∞ #}
          <div style="flex:1; min-height:400px; background:white; border-radius:6px; padding:15px; border:1px solid #e9ecef; position:relative;">
            {# –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞ #}
            <div id="flow-chart-loading" style="
              display:none; position:absolute; top:0; left:0; right:0; bottom:0;
              background:rgba(255,255,255,0.85); z-index:10;
              align-items:center; justify-content:center;
              font-size:14px; color:#999; border-radius:8px;
            ">
              <div style="text-align:center;">
                <div style="font-size:24px; margin-bottom:6px;">‚è≥</div>
                <div>–†–∞—Å—á—ë—Ç –¥–µ–±–∏—Ç–∞...</div>
              </div>
            </div>
            <canvas id="chart_flow_rate" data-well-id="{{ well.id }}"></canvas>
          </div>

          {# ‚îÄ‚îÄ –ü–ª–∏—Ç–∫–∏: vs –ë–∞–∑–æ–≤—ã–π + –û—Ç —Ç–æ—á–∫–∏ –æ—Ç—Å—á—ë—Ç–∞ ‚îÄ‚îÄ #}
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">

            {# –ó–ï–õ–Å–ù–ê–Ø –ø–ª–∏—Ç–∫–∞ ‚Äî vs –ë–∞–∑–æ–≤—ã–π #}
            <div id="flow-baseline-stats" style="display:none;
              background:linear-gradient(135deg, #e8f5e9, #f1f8e9);
              border:1px solid #c8e6c9; border-radius:8px;
              padding:12px 14px;
            ">
              <div style="font-size:11px; color:#2e7d32; text-transform:uppercase; letter-spacing:0.05em; font-weight:700; margin-bottom:4px;">
                vs –ë–∞–∑–æ–≤—ã–π –¥–µ–±–∏—Ç
              </div>
              <div style="font-size:10px; color:#558b2f; margin-bottom:8px; line-height:1.3;">
                –û—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Å—Ä–µ–¥–Ω–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–∞–∑–æ–≤–æ–≥–æ –¥–µ–±–∏—Ç–∞
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px 8px; font-size:12px;">
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666; white-space:nowrap;">&#916; —Ç–µ–∫—É—â–∏–π:</span>
                  <span id="flow-base-delta-current" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666; white-space:nowrap;">&#916; —Å—Ä–µ–¥–Ω–µ–µ:</span>
                  <span id="flow-base-delta-mean" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666; white-space:nowrap;">&#916; –º–µ–¥–∏–∞–Ω–∞:</span>
                  <span id="flow-base-delta-median" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666; white-space:nowrap;">&#916; —ç—Ñ—Ñ–µ–∫—Ç.:</span>
                  <span id="flow-base-daily-delta" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
              </div>
            </div>

            {# –°–ò–ù–Ø–Ø –ø–ª–∏—Ç–∫–∞ ‚Äî –û—Ç —Ç–æ—á–∫–∏ –æ—Ç—Å—á—ë—Ç–∞ #}
            <div id="flow-refpoint-stats" style="display:none;
              background:linear-gradient(135deg, #e3f2fd, #e8eaf6);
              border:1px solid #90caf9; border-radius:8px;
              padding:12px 14px;
            ">
              <div style="font-size:11px; color:#1565c0; text-transform:uppercase; letter-spacing:0.05em; font-weight:700; margin-bottom:4px;">
                –û—Ç —Ç–æ—á–∫–∏ –æ—Ç—Å—á—ë—Ç–∞
              </div>
              <div style="font-size:10px; color:#1976d2; margin-bottom:8px; line-height:1.3;">
                –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤—ã–º –¥–µ–±–∏—Ç–æ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–æ—á–∫–∏ –æ—Ç—Å—á—ë—Ç–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ
              </div>

              <div style="display:grid; grid-template-columns:1fr 1fr; gap:4px 8px; font-size:12px;">
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">–ü–µ—Ä–∏–æ–¥:</span>
                  <span id="flow-ref-duration" style="font-family:monospace; font-size:13px; font-weight:700; color:#1565c0;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">Q —Å—Ç–∞—Ä—Ç:</span>
                  <span id="flow-ref-q-start" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">Q —Ç–µ–∫—É—â–∏–π:</span>
                  <span id="flow-ref-q-current" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ:</span>
                  <span id="flow-ref-mean" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">–ú–µ–¥–∏–∞–Ω–∞:</span>
                  <span id="flow-ref-median" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
                <div style="display:flex; align-items:center; gap:4px;">
                  <span style="color:#666;">&#916; –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ:</span>
                  <span id="flow-ref-vs-baseline" style="font-family:monospace; font-size:13px; font-weight:700;">‚Äî</span>
                </div>
              </div>
            </div>

          </div>{# /grid tiles #}
        </div>{# /left column #}

        {# ‚ïê‚ïê‚ïê –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å–ø—Ä–∞–≤–∞) ‚Äî –∫–∞–∫ —É ŒîP ‚ïê‚ïê‚ïê #}
        <div id="flow-stats-panel" style="
          width:240px; min-width:240px;
          background:#f8f9fa;
          border:1px solid #dee2e6;
          border-radius:8px;
          padding:12px;
          display:flex; flex-direction:column; gap:6px;
          color:#333;
          font-size:12px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        ">
          {# –ö—É—Ä—Å–æ—Ä: –≤—Ä–µ–º—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ #}
          <div style="text-align:center; border-bottom:1px solid #dee2e6; padding-bottom:8px;">
            <div style="font-size:11px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em;">–ö—É—Ä—Å–æ—Ä</div>
            <div id="flow-cursor-time" style="font-size:14px; font-weight:700; color:#212529;">‚Äî</div>
            <div id="flow-cursor-value" style="font-size:16px; font-weight:700; color:#ff9800;">‚Äî</div>
          </div>

          {# –ë–∞–∑–æ–≤—ã–π –¥–µ–±–∏—Ç ‚Äî –≤–≤–æ–¥ + –∫–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å #}
          <div style="border-bottom:1px solid #dee2e6; padding-bottom:8px; margin-bottom:2px;">
            <div style="font-size:10px; color:#2e7d32; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px; font-weight:600;">–ë–∞–∑–æ–≤—ã–π –¥–µ–±–∏—Ç</div>
            <div style="display:flex; align-items:center; gap:4px;">
              <input type="number" id="flow-baseline-input" step="0.5" min="0"
                style="width:72px; padding:3px 6px; border:1px solid #ced4da; border-radius:4px; font-size:13px; font-family:monospace;"
                placeholder="‚Äî">
              <span style="font-size:10px; color:#999;">—Ç—ã—Å.–º¬≥/—Å—É—Ç</span>
              <button id="flow-baseline-save" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                style="border:none; background:#e8f5e9; color:#2e7d32; border-radius:4px; padding:3px 7px; font-size:12px; cursor:pointer; font-weight:600; line-height:1;">
                &#10003;</button>
            </div>
            <div id="flow-baseline-saved-msg" style="display:none; font-size:10px; color:#2e7d32; margin-top:2px; font-weight:600;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
          </div>

          {# –¢–æ—á–∫–∞ –æ—Ç—Å—á—ë—Ç–∞ #}
          <div style="border-bottom:1px solid #dee2e6; padding-bottom:8px; margin-bottom:2px;">
            <div style="font-size:10px; color:#1565c0; text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px; font-weight:600;">–¢–æ—á–∫–∞ –æ—Ç—Å—á—ë—Ç–∞</div>
            <div style="display:flex; align-items:center; gap:3px;">
              <input type="datetime-local" id="flow-refpoint-input"
                style="width:145px; padding:2px 4px; border:1px solid #ced4da; border-radius:4px; font-size:11px; font-family:monospace;">
              <button id="flow-refpoint-set" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
                style="border:none; background:#e3f2fd; color:#1565c0; border-radius:4px; padding:3px 6px; font-size:11px; cursor:pointer; font-weight:600;">
                &#10003;</button>
              <button id="flow-refpoint-clear" title="–°–±—Ä–æ—Å–∏—Ç—å"
                style="border:none; background:#ffebee; color:#c62828; border-radius:4px; padding:3px 6px; font-size:11px; cursor:pointer; font-weight:600;">
                &#10007;</button>
            </div>
            <div style="font-size:9px; color:#999; margin-top:2px;">–∏–ª–∏ Shift+–∫–ª–∏–∫ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É</div>
          </div>

          {# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ #}
          <div style="text-align:center; padding-bottom:4px;">
            <div style="font-size:10px; color:#6c757d; text-transform:uppercase; letter-spacing:0.05em;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
          </div>

          {# –ú–µ–¥–∏–∞–Ω–∞ #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#fff8e1; padding:6px 8px; border-radius:4px;" title="–¢–∏–ø–∏—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–±–∏—Ç. –ù–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º –ø—Ä–æ–≤–∞–ª–∞–º –∏ –Ω—É–ª—è–º –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ—è—Ö. –ó–∞–≤—ã—à–∞–µ—Ç –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–æ—Å—Ç–æ–µ–≤.">
            <span style="color:#e65100; font-weight:600;">–ú–µ–¥–∏–∞–Ω–∞</span>
            <span id="flow-stat-median" style="font-family:monospace; font-size:13px; font-weight:700; color:#e65100;">‚Äî</span>
          </div>

          {# –°—Ä–µ–¥–Ω–µ–µ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–ê—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –≤—Å–µ—Ö –º–∏–Ω—É—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –¥–µ–±–∏—Ç–∞, –≤–∫–ª—é—á–∞—è –Ω—É–ª–∏ –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ—è—Ö –∏ –ø—Ä–æ–¥—É–≤–∫–∞—Ö.">
            <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ</span>
            <span id="flow-stat-mean" style="font-family:monospace; color:#333;">‚Äî</span>
          </div>

          {# –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–†–µ–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–Ω–µ—Å—É—Ç–æ—á–Ω–∞—è –¥–æ–±—ã—á–∞ = –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π / –¥–Ω–∏. –£—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Å—Ç–æ–∏, –ø—Ä–æ–¥—É–≤–∫–∏ –∏ buildup. –ì–∞–∑ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –Ω–µ –≤–∫–ª—é—á—ë–Ω.">
            <span style="color:#666;">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π</span>
            <span id="flow-stat-effective" style="font-family:monospace; color:#2e7d32;">‚Äî</span>
          </div>

          {# –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–ò–Ω—Ç–µ–≥—Ä–∞–ª –¥–µ–±–∏—Ç–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (–ø–ª–æ—â–∞–¥—å –ø–æ–¥ –∫—Ä–∏–≤–æ–π). –¢–æ–ª—å–∫–æ –≥–∞–∑, –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –≤ —Ç—Ä—É–±–æ–ø—Ä–æ–≤–æ–¥.">
            <span style="color:#666;">–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π</span>
            <span id="flow-stat-cumulative" style="font-family:monospace; color:#1565c0;">‚Äî</span>
          </div>

          {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –ü—Ä–æ–¥—É–≤–∫–∏ #}
          <div style="border-top:1px solid #dee2e6; margin:4px 0;"></div>
          <div style="text-align:center; padding-bottom:2px;">
            <div style="font-size:10px; color:#c62828; text-transform:uppercase; letter-spacing:0.05em; font-weight:600;">–ü—Ä–æ–¥—É–≤–∫–∏</div>
          </div>

          {# –°—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–µ #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#ffebee; padding:4px 8px; border-radius:4px;" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ü–∏–∫–ª–æ–≤ –ø—Ä–æ–¥—É–≤–æ–∫ (—Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–µ –≥–∞–∑–∞ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —á–µ—Ä–µ–∑ –ø—Ä–æ–¥—É–≤–æ—á–Ω—ã–π –∫–ª–∞–ø–∞–Ω).">
            <span style="color:#c62828; font-size:11px;">üî• –°—Ç—Ä–∞–≤–ª.</span>
            <span id="flow-stat-venting-count" style="font-family:monospace; font-size:11px; font-weight:600; color:#c62828;">‚Äî</span>
          </div>

          {# –í—Ä–µ–º—è —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏—è #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è —Ñ–∞–∑ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏—è (–æ—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–ª–∞–ø–∞–Ω–∞ –¥–æ –º–∏–Ω–∏–º—É–º–∞ –¥–∞–≤–ª–µ–Ω–∏—è). –ì–∞–∑ —É—Ö–æ–¥–∏—Ç –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.">
            <span style="color:#666; font-size:11px;">–í—Ä–µ–º—è —Å—Ç—Ä–∞–≤–ª.</span>
            <span id="flow-stat-venting-hours" style="font-family:monospace; font-size:11px; color:#c62828;">‚Äî</span>
          </div>

          {# –ü–æ—Ç–µ—Ä–∏ –ø—Ä–∏ —Å—Ç—Ä–∞–≤–ª–∏–≤–∞–Ω–∏–∏ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–û–±—ä—ë–º –≥–∞–∑–∞, –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–≥–æ –≤ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –ø—Ä–∏ –ø—Ä–æ–¥—É–≤–∫–∞—Ö (—Ç—ã—Å. –º¬≥). –†–∞—Å—Å—á–∏—Ç–∞–Ω –ø–æ —Ñ–æ—Ä–º—É–ª–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ —à—Ç—É—Ü–µ—Ä –ø—Ä–æ–¥—É–≤–∫–∏.">
            <span style="color:#666; font-size:11px;">–ü–æ—Ç–µ—Ä–∏</span>
            <span id="flow-stat-purge-loss" style="font-family:monospace; font-size:11px; color:#ad1457;">‚Äî</span>
          </div>

          {# –ù–∞–±–æ—Ä –¥–∞–≤–ª–µ–Ω–∏—è #}
          <div style="display:flex; justify-content:space-between; align-items:center; background:#fff8e1; padding:4px 8px; border-radius:4px;" title="–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞–±–æ—Ä–∞ –¥–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–æ–¥—É–≤–æ–∫. –°–∫–≤–∞–∂–∏–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∞, –¥–µ–±–∏—Ç = 0, –ø–æ—Ç–µ—Ä—å –Ω–µ—Ç.">
            <span style="color:#e65100; font-size:11px;">‚è± –ù–∞–±–æ—Ä</span>
            <span id="flow-stat-buildup-hours" style="font-family:monospace; font-size:11px; font-weight:600; color:#e65100;">‚Äî</span>
          </div>

          {# –ò—Å—Ç–æ—á–Ω–∏–∫–∏ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–ö–∞–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–¥—É–≤–∫–∏: –º–∞—Ä–∫–µ—Ä (–∏–∑ –∂—É—Ä–Ω–∞–ª–∞ —Å–æ–±—ã—Ç–∏–π) –∏–ª–∏ –∞–ª–≥–æ—Ä–∏—Ç–º (–ø–æ V-–æ–±—Ä–∞–∑–Ω–æ–º—É –ø–∞—Ç—Ç–µ—Ä–Ω—É –¥–∞–≤–ª–µ–Ω–∏—è).">
            <span style="color:#666; font-size:11px;">–ò—Å—Ç–æ—á–Ω–∏–∫</span>
            <span id="flow-stat-purge-source" style="font-family:monospace; font-size:10px; color:#666;">‚Äî</span>
          </div>

          {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: –ü–æ—Ç–µ—Ä–∏/–ø—Ä–æ—Å—Ç–æ–∏ #}
          <div style="border-top:1px solid #dee2e6; margin:4px 0;"></div>

          {# –ü–æ—Ç–µ—Ä–∏/—Å—É—Ç #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–°—É–º–º–∞—Ä–Ω—ã–µ —Å—É—Ç–æ—á–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏ = –ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ –ø—Ä–æ–¥—É–≤–∫–∞—Ö + —É—Å–ª–æ–≤–Ω—ã–µ –ø–æ—Ç–µ—Ä–∏ –æ—Ç –ø—Ä–æ—Å—Ç–æ–µ–≤ (—Ç—ã—Å. –º¬≥/—Å—É—Ç).">
            <span style="color:#666; font-size:11px;">–ü–æ—Ç–µ—Ä–∏/—Å—É—Ç</span>
            <span id="flow-stat-total-loss" style="font-family:monospace; font-size:11px; color:#ad1457;">‚Äî</span>
          </div>

          {# –ö–æ—ç—Ñ—Ñ. –ø–æ—Ç–µ—Ä—å #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–î–æ–ª—è –ø–æ—Ç–µ—Ä—å –æ—Ç –æ–±—â–µ–π –¥–æ–±—ã—á–∏ (%). (–ø–æ—Ç–µ—Ä–∏ –ø—Ä–∏ –ø—Ä–æ–¥—É–≤–∫–∞—Ö + –ø–æ—Ç–µ—Ä–∏ –æ—Ç –ø—Ä–æ—Å—Ç–æ–µ–≤) / –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π √ó 100%.">
            <span style="color:#666; font-size:11px;">–ö–æ—ç—Ñ—Ñ. –ø–æ—Ç–µ—Ä—å</span>
            <span id="flow-stat-loss-pct" style="font-family:monospace; font-size:11px; color:#7b1fa2;">‚Äî</span>
          </div>

          {# –ü—Ä–æ—Å—Ç–æ–∏ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–°—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–æ–µ–≤ ‚Äî –≤—Å–µ –ø–µ—Ä–∏–æ–¥—ã –≥–¥–µ P —Ç—Ä—É–±–Ω–æ–µ ‚â§ P —à–ª–µ–π—Ñ–∞ –∏ –¥–µ–±–∏—Ç = 0 (–≤–∫–ª—é—á–∞—è buildup –ø–æ—Å–ª–µ –ø—Ä–æ–¥—É–≤–æ–∫).">
            <span style="color:#666; font-size:11px;">–ü—Ä–æ—Å—Ç–æ–∏</span>
            <span id="flow-stat-downtime-hours" style="font-family:monospace; font-size:11px; color:#795548;">‚Äî</span>
          </div>

          {# –ö–æ–ª-–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ –ø—Ä–æ—Å—Ç–æ–µ–≤ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –ø—Ä–æ—Å—Ç–æ—è (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ —Å –Ω—É–ª–µ–≤—ã–º –¥–µ–±–∏—Ç–æ–º).">
            <span style="color:#666; font-size:11px;">–ü–µ—Ä–∏–æ–¥–æ–≤ –ø—Ä–æ—Å—Ç–æ–µ–≤</span>
            <span id="flow-stat-downtime-count" style="font-family:monospace; font-size:11px; color:#666;">‚Äî</span>
          </div>

          {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å #}
          <div style="border-top:1px solid #dee2e6; margin:4px 0;"></div>

          {# –ù–∞–±–ª—é–¥–µ–Ω–∏–µ #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞–±–ª—é–¥–∞–µ–º–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ (–æ—Ç –ø–µ—Ä–≤–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö).">
            <span style="color:#666; font-size:11px;">–ù–∞–±–ª—é–¥–µ–Ω–∏–µ</span>
            <span id="flow-stat-obs-days" style="font-family:monospace; font-size:11px; color:#666;">‚Äî</span>
          </div>

          {# –®—Ç—É—Ü–µ—Ä #}
          <div style="display:flex; justify-content:space-between; align-items:center;" title="–î–∏–∞–º–µ—Ç—Ä —Ä–∞–±–æ—á–µ–≥–æ —à—Ç—É—Ü–µ—Ä–∞ (–º–º). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º—É–ª–µ –ì–∏–ª–±–µ—Ä—Ç–∞-–ü–∏—Ä–≤–µ—Ä–¥—è–Ω–∞ –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–µ–±–∏—Ç–∞.">
            <span style="color:#666; font-size:11px;">–®—Ç—É—Ü–µ—Ä</span>
            <span id="flow-stat-choke" style="font-family:monospace; font-size:11px; color:#666;">‚Äî</span>
          </div>
        </div>
      </div>

      {# ‚îÄ‚îÄ –ü–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞ —É—á–∞—Å—Ç–∫–æ–≤ ‚îÄ‚îÄ #}
      <div id="flow-segment-panel" style="display:none; margin-top:10px;">

        {# --- Preview –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞ --- #}
        <div id="flow-segment-preview" style="display:none;
          background:linear-gradient(135deg, #f3e5f5, #ede7f6);
          border:1px solid #ce93d8; border-radius:8px;
          padding:12px 16px; margin-bottom:10px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div>
              <span style="font-size:11px; color:#7b1fa2; text-transform:uppercase; letter-spacing:0.05em; font-weight:700;">–í—ã–¥–µ–ª–µ–Ω–Ω—ã–π —É—á–∞—Å—Ç–æ–∫</span>
              <span id="seg-preview-range" style="font-size:12px; color:#4a148c; margin-left:8px; font-weight:600;">‚Äî</span>
            </div>
            <button id="seg-preview-close" title="–ó–∞–∫—Ä—ã—Ç—å preview" style="border:none; background:none; color:#999; font-size:16px; cursor:pointer; padding:0 4px;">&#10005;</button>
          </div>

          {# stats grid #}
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:8px; font-size:12px;">
            {# –î–µ–±–∏—Ç #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#e65100; font-size:10px; text-transform:uppercase; margin-bottom:4px;">–î–µ–±–∏—Ç (—Ç—ã—Å.–º¬≥/—Å—É—Ç)</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;" title="–°—Ä–µ–¥–Ω–µ–µ –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–æ–µ –¥–µ–±–∏—Ç–∞ –∑–∞ —É—á–∞—Å—Ç–æ–∫ (–≤–∫–ª—é—á–∞—è –Ω—É–ª–∏)">–°—Ä–µ–¥–Ω–µ–µ:</span><span id="seg-p-mean-flow" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666;" title="–¢–∏–ø–∏—á–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–±–∏—Ç. –ù–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ –Ω—É–ª—è–º –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ—è—Ö">–ú–µ–¥–∏–∞–Ω–∞:</span><span id="seg-p-median-flow" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666;">–ú–∏–Ω:</span><span id="seg-p-min-flow" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∞–∫—Å:</span><span id="seg-p-max-flow" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666; font-weight:600;" title="–†–µ–∞–ª—å–Ω–∞—è —Å—Ä–µ–¥–Ω–µ—Å—É—Ç–æ—á–Ω–∞—è –¥–æ–±—ã—á–∞ = –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π / –¥–Ω–∏. –£—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ–∏ –∏ –ø—Ä–æ–¥—É–≤–∫–∏">Q —ç—Ñ—Ñ–µ–∫—Ç.:</span><span id="seg-p-effective" style="font-family:monospace; font-weight:700; color:#e65100;">‚Äî</span>
                <span style="color:#666;" title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ ‚Äî % –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å–∫–≤–∞–∂–∏–Ω—ã">–ö–ò–í %:</span><span id="seg-p-utilization" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –î–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä—É–±–Ω–æ–µ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#1565c0; font-size:10px; text-transform:uppercase; margin-bottom:4px;">P —Ç—Ä—É–±–Ω–æ–µ (–∫–≥—Å/—Å–º¬≤)</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ:</span><span id="seg-p-mean-ptube" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∏–Ω:</span><span id="seg-p-min-ptube" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∞–∫—Å:</span><span id="seg-p-max-ptube" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –î–∞–≤–ª–µ–Ω–∏–µ –ª–∏–Ω–µ–π–Ω–æ–µ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#2e7d32; font-size:10px; text-transform:uppercase; margin-bottom:4px;">P –ª–∏–Ω–µ–π–Ω–æ–µ (–∫–≥—Å/—Å–º¬≤)</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ:</span><span id="seg-p-mean-pline" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∏–Ω:</span><span id="seg-p-min-pline" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∞–∫—Å:</span><span id="seg-p-max-pline" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –ü–µ—Ä–µ–ø–∞–¥ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#6a1b9a; font-size:10px; text-transform:uppercase; margin-bottom:4px;">–ü–µ—Ä–µ–ø–∞–¥ ŒîP</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;">–°—Ä–µ–¥–Ω–µ–µ:</span><span id="seg-p-mean-dp" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∏–Ω:</span><span id="seg-p-min-dp" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ú–∞–∫—Å:</span><span id="seg-p-max-dp" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –ü—Ä–æ–¥—É–≤–∫–∏ –∏ –ø—Ä–æ—Å—Ç–æ–∏ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#c62828; font-size:10px; text-transform:uppercase; margin-bottom:4px;">–ü—Ä–æ–¥—É–≤–∫–∏ / –ü—Ä–æ—Å—Ç–æ–∏</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;">–ü—Ä–æ–¥—É–≤–æ–∫:</span><span id="seg-p-purge-count" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ü—Ä–æ—Å—Ç–æ–µ–≤:</span><span id="seg-p-downtime-count" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ü—Ä–æ—Å—Ç–æ–π (—á):</span><span id="seg-p-downtime-hours" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–ü–æ—Ç–µ—Ä–∏:</span><span id="seg-p-loss" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –ò—Ç–æ–≥–æ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px;">
              <div style="font-weight:700; color:#333; font-size:10px; text-transform:uppercase; margin-bottom:4px;">–ò—Ç–æ–≥–æ</div>
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:2px;">
                <span style="color:#666;">–ù–∞–∫–æ–ø–ª–µ–Ω–æ:</span><span id="seg-p-cumulative" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666;">–ü–µ—Ä–∏–æ–¥ (—á):</span><span id="seg-p-duration" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666;">–¢–æ—á–µ–∫:</span><span id="seg-p-data-points" style="font-family:monospace;">‚Äî</span>
              </div>
            </div>
            {# –¢—Ä–µ–Ω–¥ #}
            <div style="background:rgba(255,255,255,0.7); border-radius:6px; padding:8px; grid-column: 1 / -1;">
              <div style="font-weight:700; color:#0d47a1; font-size:10px; text-transform:uppercase; margin-bottom:4px;">
                –¢—Ä–µ–Ω–¥ (–ª–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è)
              </div>
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:2px; font-size:12px;">
                <span style="color:#666; cursor:help;" title="–°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–µ–±–∏—Ç–∞ –∑–∞ —Å—É—Ç–∫–∏ (—Ç—ã—Å.–º¬≥/—Å—É—Ç¬≤)">Q —Ç—Ä–µ–Ω–¥:</span>
                <span id="seg-p-trend-flow" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666; cursor:help;" title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏ –¥–µ–±–∏—Ç–∞ (1.0 = –∏–¥–µ–∞–ª—å–Ω–∞—è –ª–∏–Ω–∏—è, &lt;0.5 = —Å–ª–∞–±—ã–π —Ç—Ä–µ–Ω–¥)">R¬≤ (Q):</span>
                <span id="seg-p-trend-r2-flow" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666; cursor:help;" title="–°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–ø–∞–¥–∞ –¥–∞–≤–ª–µ–Ω–∏—è –∑–∞ —Å—É—Ç–∫–∏ (–∫–≥—Å/—Å–º¬≤/—Å—É—Ç)">ŒîP —Ç—Ä–µ–Ω–¥:</span>
                <span id="seg-p-trend-dp" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666; cursor:help;" title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏ ŒîP">R¬≤ (ŒîP):</span>
                <span id="seg-p-trend-r2-dp" style="font-family:monospace;">‚Äî</span>
                <span style="color:#666; cursor:help;" title="–°–∫–æ—Ä–æ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç—Ä—É–±–Ω–æ–≥–æ –¥–∞–≤–ª–µ–Ω–∏—è –∑–∞ —Å—É—Ç–∫–∏ (–∫–≥—Å/—Å–º¬≤/—Å—É—Ç)">P —Ç—Ä. —Ç—Ä–µ–Ω–¥:</span>
                <span id="seg-p-trend-ptube" style="font-family:monospace; font-weight:600;">‚Äî</span>
                <span style="color:#666; cursor:help;" title="–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –¥–µ—Ç–µ—Ä–º–∏–Ω–∞—Ü–∏–∏ P —Ç—Ä—É–±–Ω–æ–≥–æ">R¬≤ (P —Ç—Ä.):</span>
                <span id="seg-p-trend-r2-ptube" style="font-family:monospace;">‚Äî</span>
              </div>
              {# –ü–æ—Ä–æ–≥ + –ø—Ä–æ–≥–Ω–æ–∑ #}
              <div style="margin-top:6px; border-top:1px solid #e0e0e0; padding-top:6px;">
                <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                  <span style="color:#666; font-size:11px;">–ü–æ—Ä–æ–≥ Q:</span>
                  <input id="seg-threshold-flow" type="number" step="0.1" placeholder="0"
                    style="width:60px; padding:2px 6px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                  <span style="color:#666; font-size:11px;">ŒîP:</span>
                  <input id="seg-threshold-dp" type="number" step="0.1" placeholder="0"
                    style="width:60px; padding:2px 6px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                  <span style="color:#666; font-size:11px;">P —Ç—Ä.:</span>
                  <input id="seg-threshold-ptube" type="number" step="0.1" placeholder="0"
                    style="width:60px; padding:2px 6px; border:1px solid #ccc; border-radius:4px; font-size:11px;">
                  <button id="seg-predict-btn"
                    style="padding:2px 10px; border:1px solid #0d47a1; border-radius:4px;
                      background:#0d47a1; color:white; font-size:11px; cursor:pointer;">
                    –ü—Ä–æ–≥–Ω–æ–∑
                  </button>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:2px; margin-top:4px; font-size:12px;">
                  <span style="color:#666; cursor:help;" title="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å—É—Ç–æ–∫ Q —É–ø–∞–¥—ë—Ç –¥–æ 0 –ø—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç—Ä–µ–Ω–¥–µ">Q ‚Üí 0:</span>
                  <span id="seg-p-predict-zero-flow" style="font-family:monospace;">‚Äî</span>
                  <span style="color:#666; cursor:help;" title="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å—É—Ç–æ–∫ Q —É–ø–∞–¥—ë—Ç –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞">Q ‚Üí –ø–æ—Ä–æ–≥:</span>
                  <span id="seg-p-predict-thresh-flow" style="font-family:monospace;">‚Äî</span>
                  <span style="color:#666; cursor:help;" title="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å—É—Ç–æ–∫ ŒîP —É–ø–∞–¥—ë—Ç –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞">ŒîP ‚Üí –ø–æ—Ä–æ–≥:</span>
                  <span id="seg-p-predict-thresh-dp" style="font-family:monospace;">‚Äî</span>
                  <span style="color:#666; cursor:help;" title="–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å—É—Ç–æ–∫ P —Ç—Ä—É–±–Ω–æ–µ —É–ø–∞–¥—ë—Ç –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞">P —Ç—Ä. ‚Üí –ø–æ—Ä–æ–≥:</span>
                  <span id="seg-p-predict-thresh-ptube" style="font-family:monospace;">‚Äî</span>
                </div>
              </div>
            </div>
          </div>

          {# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ #}
          <div style="display:flex; align-items:center; gap:8px; margin-top:10px;">
            <input id="seg-name-input" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞"
              style="flex:1; max-width:250px; padding:5px 10px; border:1px solid #ce93d8; border-radius:6px; font-size:13px;">
            <button id="seg-save-btn" style="padding:5px 14px; border:1px solid #9c27b0; border-radius:6px;
              background:#9c27b0; color:white; font-size:12px; cursor:pointer; font-weight:600;
              display:inline-flex; align-items:center; gap:4px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <span id="seg-save-msg" style="display:none; font-size:11px; color:#2e7d32; font-weight:600;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>
          </div>
        </div>

        {# --- –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ --- #}
        <div id="flow-segments-table-wrap" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <span style="font-size:13px; font-weight:600; color:#374151;">üìã –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
              <span id="seg-table-count" style="font-weight:400; color:#999; margin-left:4px;">0</span>
            </span>
            <button id="seg-compare-btn" disabled style="padding:4px 12px; border:1px solid #9c27b0; border-radius:6px;
              background:#f3e5f5; color:#7b1fa2; font-size:12px; cursor:pointer; font-weight:600; opacity:0.5;">
              –°—Ä–∞–≤–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
          </div>
          <div style="max-height:250px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:6px;">
            <table id="flow-segments-table" style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr style="background:#f8f9fa; position:sticky; top:0; z-index:1;">
                  <th style="padding:5px 6px; width:28px;"><input type="checkbox" id="seg-check-all" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"></th>
                  <th style="padding:5px 6px; text-align:left; font-weight:600; color:#666; font-size:10px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th style="padding:5px 6px; text-align:left; font-weight:600; color:#666; font-size:10px;">–ü–µ—Ä–∏–æ–¥</th>
                  <th style="padding:5px 6px; text-align:right; font-weight:600; color:#666; font-size:10px;">Q —Å—Ä</th>
                  <th style="padding:5px 6px; text-align:right; font-weight:600; color:#666; font-size:10px;">Q –º–µ–¥</th>
                  <th style="padding:5px 6px; text-align:right; font-weight:600; color:#666; font-size:10px;">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</th>
                  <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–ü—Ä–æ–¥—É–≤–æ–∫</th>
                  <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–ü—Ä–æ—Å—Ç–æ–µ–≤ (—á)</th>
                  <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;"></th>
                </tr>
              </thead>
              <tbody id="flow-segments-tbody"></tbody>
            </table>
          </div>
        </div>

        {# --- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è --- #}
        <div id="flow-segment-compare" style="display:none; margin-top:10px;
          background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:12px 16px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span style="font-size:12px; font-weight:700; color:#7b1fa2;">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—á–∞—Å—Ç–∫–æ–≤</span>
            <button id="seg-compare-close" title="–ó–∞–∫—Ä—ã—Ç—å" style="border:none; background:none; color:#999; font-size:16px; cursor:pointer;">&#10005;</button>
          </div>
          <div style="overflow-x:auto;">
            <table id="seg-compare-table" style="width:100%; border-collapse:collapse; font-size:12px;"></table>
          </div>
        </div>

        <div style="margin-top:6px; font-size:11px; color:#9c27b0; text-align:center;">
          –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–µ –¥–ª—è –Ω–∞—á–∞–ª–∞ —É—á–∞—Å—Ç–∫–∞, –∑–∞—Ç–µ–º –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∫–æ–Ω—Ü–∞
        </div>
      </div>

      {# ‚îÄ‚îÄ –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å—Ç–æ–µ–≤ ‚îÄ‚îÄ #}
      <div id="flow-downtime-section" style="display:none; margin-top:16px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div style="font-size:13px; font-weight:600; color:#374151;">
            üìã –ü—Ä–æ–¥—É–≤–∫–∏ –∏ –ø—Ä–æ—Å—Ç–æ–∏
            <span id="flow-downtime-count" style="font-weight:400; color:#999; margin-left:6px;">0</span>
          </div>
        </div>
        <div style="max-height:300px; overflow-y:auto; border:1px solid #f0f0f0; border-radius:6px;">
          <table id="flow-downtime-table" style="width:100%; border-collapse:collapse; font-size:12px;">
            <thead>
              <tr style="background:#f8f9fa; position:sticky; top:0; z-index:1;">
                <th style="padding:5px 6px; text-align:left; font-weight:600; color:#666; font-size:10px;">#</th>
                <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–¢–∏–ø</th>
                <th style="padding:5px 6px; text-align:left; font-weight:600; color:#666; font-size:10px;">–ù–∞—á–∞–ª–æ</th>
                <th style="padding:5px 6px; text-align:left; font-weight:600; color:#666; font-size:10px;">–ö–æ–Ω–µ—Ü</th>
                <th style="padding:5px 6px; text-align:right; font-weight:600; color:#666; font-size:10px;">–°—Ç—Ä–∞–≤–ª.</th>
                <th style="padding:5px 6px; text-align:right; font-weight:600; color:#666; font-size:10px;">–ù–∞–±–æ—Ä</th>
                <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–ò—Å—Ç–æ—á–Ω.</th>
                <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–£–≤–µ—Ä–µ–Ω.</th>
                <th style="padding:5px 6px; text-align:center; font-weight:600; color:#666; font-size:10px;">–î–µ–π—Å—Ç–≤–∏–µ</th>
              </tr>
            </thead>
            <tbody id="flow-downtime-tbody"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-top:10px; font-size:11px; color:#999; text-align:center;">
        –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à–∫–æ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ ‚Ä¢ –ü–µ—Ä–∏–æ–¥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –≥—Ä–∞—Ñ–∏–∫–æ–º –¥–∞–≤–ª–µ–Ω–∏–π
      </div>
    </div>{# /flow-main-content #}

  </div>{# /card-body #}
</div>{# /card #}
{% endif %}

{# ========== –ì–†–ê–§–ò–ö –°–û–ë–´–¢–ò–ô (–æ—Ç–∫–ª—é—á–∞–µ–º—ã–π) ========== #}
{% if timeline_injections or timeline_events %}
<div class="card" id="events-chart-section" style="display:none; width:100%; margin-top:20px; margin-bottom:20px;">
  <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
    <div>
      <h2 style="margin:0;">üìä –ì—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ</h2>
      <small style="color: #6c757d;">–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ç–∞–π–º–ª–∞–π–Ω –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π</small>
    </div>
    <button id="events-chart-toggle" type="button" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –≥—Ä–∞—Ñ–∏–∫ —Å–æ–±—ã—Ç–∏–π" style="
      padding:6px 12px; border:1px solid #dee2e6; border-radius:6px;
      background:#f8f9fa; color:#666; font-size:12px; cursor:pointer;
      display:flex; align-items:center; gap:6px;
    ">
      <span id="events-chart-toggle-icon">üëÅÔ∏è</span>
      <span id="events-chart-toggle-text">–°–∫—Ä—ã—Ç—å</span>
    </button>
  </div>

  <div id="events-chart-content" class="card-body">
    {# –õ–µ–≥–µ–Ω–¥—ã #}
    <div style="
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    ">
      {# –õ–µ–≥–µ–Ω–¥–∞ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤ #}
      <div style="
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
      ">
        <div style="
          font-weight: 600;
          margin-bottom: 10px;
          font-size: 14px;
          color: #212529;
          display: flex;
          align-items: center;
          gap: 8px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e9ecef;
        ">
          <span style="font-size: 18px;">üíâ</span>
          <span>–†–µ–∞–≥–µ–Ω—Ç—ã</span>
        </div>
        <div id="legend_reagents_well" style="padding: 8px 0;"></div>
      </div>

      {# –õ–µ–≥–µ–Ω–¥–∞ —Å–æ–±—ã—Ç–∏–π #}
      <div style="
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
      ">
        <div style="
          font-weight: 600;
          margin-bottom: 10px;
          font-size: 14px;
          color: #212529;
          display: flex;
          align-items: center;
          gap: 8px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e9ecef;
        ">
          <span style="font-size: 18px;">üìå</span>
          <span>–°–æ–±—ã—Ç–∏—è</span>
        </div>
        <div id="legend_events_well" style="padding: 8px 0;"></div>
      </div>

      {# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–≤–∞–∂–∏–Ω–µ #}
      <div style="
        background: white;
        padding: 15px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        border: 1px solid #dee2e6;
      ">
        <div style="
          font-weight: 600;
          margin-bottom: 10px;
          font-size: 14px;
          color: #212529;
          display: flex;
          align-items: center;
          gap: 8px;
          padding-bottom: 10px;
          border-bottom: 2px solid #e9ecef;
        ">
          <span style="font-size: 18px;">üéØ</span>
          <span>–°–∫–≤–∞–∂–∏–Ω–∞ {{ well.number or well.id }}</span>
        </div>
        <div style="padding: 8px 0; font-size: 13px; color: #6c757d;">
          <div><strong>–í–±—Ä–æ—Å–æ–≤ —Ä–µ–∞–≥–µ–Ω—Ç–æ–≤:</strong> {{ timeline_injections|length }}</div>
          <div><strong>–î—Ä—É–≥–∏—Ö —Å–æ–±—ã—Ç–∏–π:</strong> {{ timeline_events|length }}</div>
          <div><strong>–í—Å–µ–≥–æ —Å–æ–±—ã—Ç–∏–π:</strong> {{ (timeline_injections|length) + (timeline_events|length) }}</div>
        </div>
      </div>
    </div>

    {# –ì—Ä–∞—Ñ–∏–∫ #}
    <div class="chart-box" style="
      width: 100%;
      position: relative;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border: 1px solid #dee2e6;
    ">
      <div style="
        height: 450px;
        background: white;
        border-radius: 6px;
        padding: 15px;
        border: 1px solid #e9ecef;
      ">
        <canvas id="chart_timeline_well"></canvas>
      </div>

      <div style="
        margin-top: 15px;
        padding: 10px 15px;
        background: #e7f3ff;
        border-radius: 4px;
        font-size: 12px;
        color: #495057;
        border-left: 3px solid #0d6efd;
      ">
        <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong>
        –í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –º—ã—à–∫–æ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è ‚Ä¢
        Shift + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è ‚Ä¢
        –ù–∞–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
      </div>
    </div>
  </div>
</div>
{% endif %}

</div> {# –∫–æ–Ω–µ—Ü –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã—Ö —Å–µ–∫—Ü–∏–π #}

<div class="well-layout">
  {# –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ #}
  <section class="well-grid">
    <article class="card" id="notes-card">
      <h2>–û–ø–∏—Å–∞–Ω–∏–µ / –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</h2>

      <div style="
        display:grid;
        grid-template-columns:minmax(0, 2fr) minmax(0, 3fr);
        gap:16px;
        align-items:stretch;
      ">

        {# ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ / —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ ===== #}
        <div style="
          background:#f9fafb;
          border-radius:12px;
          padding:10px 10px;
          border:1px solid #e5e7eb;
          display:flex;
          flex-direction:column;
          height:100%;
        ">

          <div style="font-size:13px; color:#4b5563; margin-bottom:10px;">
            <strong>–¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã:</strong><br>
            {% if well.description %}
              <span>{{ well.description }}</span>
            {% else %}
              <span style="color:#9ca3af;">–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –∑–∞–¥–∞–Ω–æ.</span>
            {% endif %}
          </div>

            {# –æ–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–º–µ—Ç–∫—É #}
            {% if note_edit is defined and note_edit %}
              {% set current_note = note_edit %}
            {% else %}
              {% set current_note = None %}
            {% endif %}

            <form method="post"
                  action="/well/{{ well.id }}/notes/save"
                  class="well-form">

              <input type="hidden" name="note_id"
                     value="{% if current_note %}{{ current_note.id }}{% endif %}">

              <div class="form-group" style="margin-bottom:10px;">
                <label for="noteTimeInput">–î–∞—Ç–∞ / –≤—Ä–µ–º—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è</label>
                <input
                  type="datetime-local"
                  id="noteTimeInput"
                  name="note_time"
                  style="width:50%; max-width:50%; box-sizing:border-box;"
                  value="{% if current_note and current_note.created_at %}{{ current_note.created_at.strftime('%Y-%m-%dT%H:%M') }}{% endif %}"
                />
              </div>

              <div class="form-group" style="margin-bottom:10px;">
                <label for="noteTextInput">–ó–∞–º–µ—Ç–∫–∞ / –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ</label>
                <textarea
                  id="noteTextInput"
                  name="note_text"
                  rows="4"
                  style="width:100%; max-width:100%; box-sizing:border-box; min-height:110px;"
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞–±–ª—é–¥–∞–µ—Ç—Å—è –ø–∞–¥–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è, —É–≤–µ–ª–∏—á–∏–ª—Å—è –¥–µ–±–∏—Ç –≤–æ–¥—ã..."
                >{% if current_note %}{{ current_note.text }}{% endif %}</textarea>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary">
                  {% if current_note %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å{% endif %}
                </button>

                {% if current_note %}
                  <a href="/well/{{ well.id }}#notes-card" class="btn-secondary btn-xs">
                    –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                  </a>
                {% endif %}
              </div>
            </form>

        </div>

        {# ===== –ü–†–ê–í–ê–Ø –ß–ê–°–¢–¨: —Å–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ –∏–∑ –±–∞–∑—ã ===== #}
        <div style="
          background:#f9fafb;
          border-radius:12px;
          padding:12px 14px;
          border:1px solid #e5e7eb;
          max-height:340px;
          overflow:auto;
          display:flex;
          flex-direction:column;
          height:100%;
        ">
<h3 style="margin-top:0; font-size:14px; font-weight:600;">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–º–µ—Ç–æ–∫</h3>

{% if notes is defined and notes %}
  <div id="notesList"
       style="display:flex; flex-direction:column; gap:3px;">
    {% for n in notes %}
      <div
        class="note-row"
        data-note-id="{{ n.id }}"
        onclick="selectNote({{ n.id }})"
        style="
          border-radius:6px;
          border:1px solid #e5e7eb;
          padding:3px 6px;
          background:#ffffff;
          font-size:12px;
          line-height:1.2;
          cursor:pointer;
          display:flex;
          align-items:baseline;
          gap:4px;
        "
      >
        <span style="font-weight:600; color:#111827; white-space:nowrap;">
          {{ n.created_at.strftime("%d.%m.%Y %H:%M") if n.created_at else "‚Äî" }}
        </span>
        <span>‚Äî</span>
        <span style="
          color:#4b5563;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
        ">
          {{ n.text }}
        </span>
      </div>
    {% endfor %}
  </div>

          {% if is_admin %}
     <div style="margin-top:6px; display:flex; justify-content:flex-end; gap:8px;">
    <button type="button"
            class="btn-secondary btn-xs"
            onclick="editSelectedNote()">
      –ò–∑–º–µ–Ω–∏—Ç—å
    </button>
    <button type="button"
            class="btn-secondary btn-xs danger"
            onclick="deleteSelectedNote()">
      –£–¥–∞–ª–∏—Ç—å
    </button>
  </div>

  <form id="noteDeleteForm" method="post" style="display:none;"></form>
  {% endif %}


{% else %}
  <p style="font-size:13px; color:#6b7280;">
    –î–ª—è —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã –µ—â—ë –Ω–µ—Ç –∑–∞–º–µ—Ç–æ–∫.
  </p>
{% endif %}
        </div>

      </div>
    </article>

    {# ===== 2. –°–û–ë–´–¢–ò–Ø –ü–û –°–ö–í–ê–ñ–ò–ù–ï (—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π) ===== #}
    <article class="card">
      <h2>–°–æ–±—ã—Ç–∏—è –ø–æ —Å–∫–≤–∞–∂–∏–Ω–µ</h2>

      {% if events and events|length > 0 %}
        <div class="events-table-wrapper" id="events-scroll-wrapper" style="max-height:500px; overflow-y:scroll;">
          <table class="events-table">
  <thead>
    <tr>
      <th class="events-table__time">–î–∞—Ç–∞ / –≤—Ä–µ–º—è</th>
      <th class="events-table__type">–¢–∏–ø</th>
      <th class="events-table__reagent">–†–µ–∞–≥–µ–Ω—Ç</th>
      <th class="events-table__qty">–ö–æ–ª-–≤–æ</th>
      <th class="events-table__p">P—Ç—Ä, –∞—Ç–º</th>
      <th class="events-table__p">P—à–ª, –∞—Ç–º</th>
      <th class="events-table__details">–û–ø–∏—Å–∞–Ω–∏–µ / –¥–µ—Ç–∞–ª–∏</th>
      <th class="events-table__operator">–û–ø–µ—Ä–∞—Ç–æ—Ä</th>
      <th class="events-table__geo">–ì–µ–æ—Å—Ç–∞—Ç—É—Å</th>
    </tr>
  </thead>
  <tbody>
    {# namespace –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã #}
    {% set ns = namespace(current_date=None) %}

    {% for e in events %}
      {# –≤—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É —Å–æ–±—ã—Ç–∏—è (–±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏) #}
      {% if e.event_time %}
        {% set this_date = e.event_time.date() %}
      {% else %}
        {% set this_date = None %}
      {% endif %}

      {# –µ—Å–ª–∏ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ–º —Å–µ—Ä—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å #}
      {% if this_date != ns.current_date %}
        <tr class="events-date-separator">
          <td colspan="9">
            {% if e.event_time %}
              {{ e.event_time.strftime("%d.%m.%Y") }}
            {% else %}
              –ë–µ–∑ –¥–∞—Ç—ã
            {% endif %}
          </td>
        </tr>
        {% set ns.current_date = this_date %}
      {% endif %}

      {# –æ–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ–±—ã—Ç–∏—è #}
      {% set row_type = (e.event_type or 'other')|lower %}
      <tr class="events-table__row events-table__row--{{ row_type }}">
        <td class="events-table__time">
          {% if e.event_time %}
            {{ e.event_time.strftime("%d.%m.%Y %H:%M") }}
          {% else %}‚Äî{% endif %}
        </td>

        <td class="events-table__type">
          {{ e.type_label }}
        </td>

        <td class="events-table__reagent">
          {{ e.reagent or "" }}
        </td>

        <td class="events-table__qty">
          {% if e.qty is not none %}
            {{ "%.2f"|format(e.qty) }}
          {% endif %}
        </td>

        <td class="events-table__p">
          {% if e.p_tube is not none %}
            {{ "%.2f"|format(e.p_tube) }}
          {% endif %}
        </td>

        <td class="events-table__p">
          {% if e.p_line is not none %}
            {{ "%.2f"|format(e.p_line) }}
          {% endif %}
        </td>

        <td class="events-table__details">
          {% if e.description %}
            {{ e.description }}
          {% endif %}

          {% if e.equip_type or e.equip_points or e.equip_other
                or e.purge_phase or e.geo_status %}
            {% if e.description %} ¬∑ {% endif %}
            {% if e.equip_type %}–æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ: {{ e.equip_type }}{% endif %}
            {% if e.equip_points %} ({{ e.equip_points }} —Ç–æ—á–µ–∫){% endif %}
            {% if e.equip_other %} {{ e.equip_other }}{% endif %}
            {% if e.purge_phase %} ¬∑ –ø—Ä–æ–¥—É–≤–∫–∞: {{ e.purge_phase }}{% endif %}
          {% endif %}
        </td>

        <td class="events-table__operator">
          {{ e.user_full_name or "" }}
        </td>

        <td class="events-table__geo">
          {{ e.geo_status_label or "" }}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
        </div>

        <div class="events-actions">
          <a href="/api/well/{{ well.id }}/events.csv" class="btn-secondary" target="_blank">
            –°–∫–∞—á–∞—Ç—å CSV
          </a>
          <a href="/api/well/{{ well.id }}/events.xlsx" class="btn-secondary" target="_blank">
            –°–∫–∞—á–∞—Ç—å Excel
          </a>
        </div>
      {% else %}
        <p>–î–ª—è —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–±—ã—Ç–∏–π –≤ —Ç–∞–±–ª–∏—Ü–µ <code>events</code>.</p>
      {% endif %}
    </article>

    {# ===== 3. –ò–°–¢–û–†–ò–Ø –°–¢–ê–¢–£–°–û–í ===== #}
    <article class="card">
  <h2>–ò—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤</h2>

  {% if well_status and well_status.grid %}
    <div class="status-grid">
      {% for col in well_status.grid %}
        <div class="status-column">
          <div class="status-column-header {{ col.css }}">
            {{ col.label }}
          </div>

          {% for st in col["items"] %}
            <div
              class="status-card {{ col.css }} status-card--history"
              data-status-id="{{ st.id }}"
              onclick="selectStatus({{ st.id }})"
            >
              <div class="status-card-dates">
                {{ st.start.strftime("%d.%m.%Y %H:%M") }} ‚Äî
                {% if st.end %}
                  {{ st.end.strftime("%d.%m.%Y %H:%M") }}
                {% else %}
                  –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è
                {% endif %}
              </div>
              <div class="status-card-days">
                {{ st.days }} —Å—É—Ç.
              </div>

              {% if st.note %}
                <div class="status-card-note">
                  {{ st.note }}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>

    {% if is_admin %}
      <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
        <button type="button"
                class="btn-primary btn-xs"
                onclick="openStatusModal(null)">
          –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
        <button type="button"
                class="btn-secondary btn-xs"
                onclick="editSelectedStatus()">
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button type="button"
                class="btn-secondary btn-xs danger"
                onclick="deleteSelectedStatus()">
          –£–¥–∞–ª–∏—Ç—å
        </button>
      </div>

      <form id="statusDeleteForm" method="post" style="display:none;"></form>
    {% endif %}
  {% else %}
    <p>–î–ª—è —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã –µ—â—ë –Ω–µ –∑–∞–¥–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤.</p>
    {% if is_admin %}
      <div style="margin-top:8px; display:flex; justify-content:flex-end;">
        <button type="button"
                class="btn-primary btn-xs"
                onclick="openStatusModal(null)">
          –î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
        </button>
      </div>
    {% endif %}
  {% endif %}
</article>

    {# ===== 4. –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–û –°–û–ë–´–¢–ò–Ø–ú (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –∏–∑ –ø–æ–ª–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã—Ö —Å–µ–∫—Ü–∏–π) ===== #}
    <article class="card">
      <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—è–º</h2>

      <form method="get" class="events-filter">
        <div class="events-filter__row">
          <label for="preset">–ü–µ—Ä–∏–æ–¥:</label>
          <select id="preset" name="preset">
            <option value="week"  {% if preset == 'week' %}selected{% endif %}>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</option>
            <option value="day"   {% if preset == 'day' %}selected{% endif %}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—É—Ç–∫–∏</option>
            <option value="month" {% if preset == 'month' %}selected{% endif %}>–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</option>
            <option value="all"   {% if preset == 'all' %}selected{% endif %}>–° –Ω–∞—á–∞–ª–∞ –±–∞–∑—ã</option>
            <option value="custom" {% if preset == 'custom' %}selected{% endif %}>–ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥</option>
          </select>

          <label for="start">—Å</label>
          <input type="date" id="start" name="start" value="{{ start_date_value or '' }}">

          <label for="end">–ø–æ</label>
          <input type="date" id="end" name="end" value="{{ end_date_value or '' }}">

          <button type="submit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
      </form>

      {% if stats %}
        <div class="events-stats-cards">
          <div class="events-stats-card events-stats-card--reagent">
            <div class="events-stats-card__title">–í–±—Ä–æ—Å–æ–≤ —Ä–µ–∞–≥–µ–Ω—Ç–∞</div>
            <div class="events-stats-card__value" id="stat-reagent-count">
              {{ stats.summary.total_reagent_injections }}
            </div>
            <div class="events-stats-card__sub">
              –í—Å–µ–≥–æ —Ä–µ–∞–≥–µ–Ω—Ç–∞:
              <span id="stat-reagent-qty">{{ "%.2f"|format(stats.summary.total_reagent_qty) }}</span>
            </div>
          </div>

          <div class="events-stats-card events-stats-card--purge">
            <div class="events-stats-card__title">–ü—Ä–æ–¥—É–≤–æ–∫</div>
            <div class="events-stats-card__value" id="stat-purge-count">
              {{ stats.summary.total_purges }}
            </div>
          </div>

          <div class="events-stats-card events-stats-card--pressure">
            <div class="events-stats-card__title">–ó–∞–º–µ—Ä–æ–≤ –¥–∞–≤–ª–µ–Ω–∏—è</div>
            <div class="events-stats-card__value" id="stat-pressure-count">
              {{ stats.summary.total_measurements }}
            </div>
          </div>

          <div class="events-stats-card events-stats-card--interval">
            <div class="events-stats-card__title">
              –°—Ä–µ–¥–Ω–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –≤–±—Ä–æ—Å–∞–º–∏
            </div>
            <div class="events-stats-card__value">
              {% if stats.summary.global_avg_interval_hours is not none %}
                {{ "%.1f"|format(stats.summary.global_avg_interval_hours) }} —á
              {% else %}
                ‚Äî
              {% endif %}
            </div>
          </div>
        </div>

        <p class="events-stats-period" id="stat-period">
          –ü–µ—Ä–∏–æ–¥:
          {% if stats.start %}{{ stats.start.strftime("%d.%m.%Y") }}{% else %}‚Äî{% endif %}
          ‚Äî
          {% if stats.end %}{{ stats.end.strftime("%d.%m.%Y") }}{% else %}‚Äî{% endif %}
        </p>

        {% if stats.per_reagent %}
          <h3>–ü–æ —Ä–µ–∞–≥–µ–Ω—Ç–∞–º</h3>
          <div class="well-table-block well-table-block--reagents">
            <table class="well-table well-table--reagents">
              <thead>
                <tr>
                  <th>–†–µ–∞–≥–µ–Ω—Ç</th>
                  <th class="is-number">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–±—Ä–æ—Å–æ–≤</th>
                  <th class="is-number">–°—É–º–º–∞—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                </tr>
              </thead>
              <tbody>
                {% for r in stats.per_reagent %}
                  <tr>
                    <td>{{ r.reagent }}</td>
                    <td class="is-number">{{ r.injections }}</td>
                    <td class="is-number">{{ "%.2f"|format(r.total_qty) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% endif %}
      {% else %}
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
      {% endif %}
    </article>

    {# ===== 5. –ò–°–¢–û–†–ò–Ø –ö–ê–ù–ê–õ–û–í (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, toggle —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) ===== #}
    <article class="card" id="channel-history-section" style="display:none;">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –∫–∞–Ω–∞–ª–æ–≤</h2>

      {% if channel_history %}
        <div class="well-table-block well-table-block--channels">
          <table class="well-table well-table--channels">
            <thead>
              <tr>
                <th>–ö–∞–Ω–∞–ª</th>
                <th class="is-date">–ù–∞—á–∞–ª–æ</th>
                <th class="is-date">–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
              </tr>
            </thead>
            <tbody>
              {% for ch in channel_history %}
                <tr
                  class="channel-row"
                  data-channel-id="{{ ch.id }}"
                  onclick="selectChannel({{ ch.id }})"
                >
                  <td>{{ ch.channel }}</td>
                  <td class="is-date">
                    {{ ch.started_at.strftime("%d.%m.%Y %H:%M") if ch.started_at else "‚Äî" }}
                  </td>
                  <td class="is-date">
                    {% if ch.ended_at %}
                      {{ ch.ended_at.strftime("%d.%m.%Y %H:%M") }}
                    {% else %}
                      ‚Äî
                    {% endif %}
                  </td>
                  <td>{{ ch.note or "" }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if is_admin %}
        <div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
          <button type="button"
                  class="btn-primary btn-xs"
                  onclick="openChannelModal(null)">
            –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª
          </button>
          <button type="button"
                  class="btn-secondary btn-xs"
                  onclick="editSelectedChannel()">
            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button type="button"
                  class="btn-secondary btn-xs danger"
                  onclick="deleteSelectedChannel()">
            –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>

        <form id="channelDeleteForm" method="post" style="display:none;"></form>
        {% endif %}
      {% else %}
        <p>–î–ª—è —ç—Ç–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã –ø–æ–∫–∞ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–Ω–∞–ª–æ–≤.</p>
        {% if is_admin %}
        <div style="margin-top:8px; display:flex; justify-content:flex-end;">
          <button type="button"
                  class="btn-primary btn-xs"
                  onclick="openChannelModal(null)">
            –î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª
          </button>
        </div>
        {% endif %}
      {% endif %}
    </article>




  {# –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è #}
    {% if is_admin %}
      <section class="well-edit">
      <article class="card">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω—ã</h2>

        <form method="post" action="/well/{{ well.id }}/update" class="well-form">
          <div class="form-group">
            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã</label>
            <input
              type="text"
              id="name"
              name="name"
              value="{{ well.name or '' }}"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–≤ 1367"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="lat">–®–∏—Ä–æ—Ç–∞ (lat)</label>
              <input
                type="text"
                id="lat"
                name="lat"
                value="{{ well.lat if well.lat is not none else '' }}"
                placeholder="45.12345"
              />
            </div>
            <div class="form-group">
              <label for="lon">–î–æ–ª–≥–æ—Ç–∞ (lon)</label>
              <input
                type="text"
                id="lon"
                name="lon"
                value="{{ well.lon if well.lon is not none else '' }}"
                placeholder="63.54321"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea
              id="description"
              name="description"
              rows="4"
              placeholder="–ö—Ä–∞—Ç–∫–∞—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ —Å–∫–≤–∞–∂–∏–Ω—ã, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏..."
            >{{ well.description or "" }}</textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
            <a href="/well/{{ well.id }}" class="btn-secondary">
              –û—Ç–º–µ–Ω–∏—Ç—å
            </a>
          </div>
        </form>

      </article>
      </section>
    {% endif %}
</div> {# –∫–æ–Ω–µ—Ü .well-layout #}

{% endblock %}  {# –∫–æ–Ω–µ—Ü block content #}

{# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã #}

{% block extra_scripts %}
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
//     (function() {
//       const lat = {{ well.lat if well.lat is not none else "null" }};
//       const lon = {{ well.lon if well.lon is not none else "null" }};
//
//       if (lat === null || lon === null) {
//         return;
//       }
//
//       const map = L.map('well-map', {
//   scrollWheelZoom: false    // <-- –≥–ª–∞–≤–Ω–æ–µ: –∫–æ–ª–µ—Å–æ –º—ã—à–∏ –ù–ï –∑—É–º–∏—Ç –∫–∞—Ä—Ç—É
// }).setView([lat, lon], 14);
//
//       L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
//         maxZoom: 19,
//         attribution: '&copy; OpenStreetMap contributors'
//       }).addTo(map);
//
//       const statusCss = "{{ current_css }}";
//       const color = getStatusColor(statusCss);
//       const icon = createStatusIcon(color);
//
//       const marker = L.marker([lat, lon], { icon }).addTo(map);
//
//       marker.bindPopup(
//         `–°–∫–≤–∞–∂–∏–Ω–∞: {{ (well.name or ("–°–∫–≤ " ~ well.id))|e }}<br>` +
//         `lat: ${lat}, lon: ${lon}`
//       );
//
//       marker.bindPopup(
//         `–°–∫–≤–∞–∂–∏–Ω–∞: {{ (well.name or ("–°–∫–≤ " ~ well.id))|e }}<br>` +
//         `lat: ${lat}, lon: ${lon}`
//       );
//     })();
  (function() {
      const lat = {{ well.lat if well.lat is not none else "null" }};
      const lon = {{ well.lon if well.lon is not none else "null" }};

      if (lat === null || lon === null) {
        return;
      }

      const map = L.map('well-map', {
        scrollWheelZoom: false
      }).setView([lat, lon], 14);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // <<< –≤–æ—Ç —ç—Ç–æ –º–µ–Ω—è–µ–º >>>
      const marker = L.marker([lat, lon]).addTo(map);

      marker.bindPopup(
        `–°–∫–≤–∞–∂–∏–Ω–∞: {{ (well.name or ("–°–∫–≤ " ~ well.id))|e }}<br>` +
        `lat: ${lat}, lon: ${lon}`
      );
  })();
  </script>
  <script>
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∞ –ø–æ–ª—è "–°–≤–æ–π —Å—Ç–∞—Ç—É—Å"
    (function () {
      const select = document.getElementById('status');
      const customGroup = document.getElementById('custom-status-group');
      if (!select || !customGroup) return;

      function updateCustom() {
        if (select.value === 'custom') {
          customGroup.style.display = '';
        } else {
          customGroup.style.display = 'none';
        }
      }

      select.addEventListener('change', updateCustom);
      updateCustom(); // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
    })();
  </script>

{% if is_admin %}
{# ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –°–¢–ê–¢–£–°–ê –°–ö–í–ê–ñ–ò–ù–´ ==== #}
<dialog id="statusModal">
  <form id="statusForm" method="post">
    <h3 id="statusFormTitle">–°—Ç–∞—Ç—É—Å —Å–∫–≤–∞–∂–∏–Ω—ã</h3>

    <label>
      –°—Ç–∞—Ç—É—Å
      <select name="status" id="statusModalSelect">
        {% for s in allowed_statuses %}
          <option value="{{ s }}">{{ s }}</option>
        {% endfor %}
        <option value="custom">–°–≤–æ–π —Å—Ç–∞—Ç—É—Å‚Ä¶</option>
      </select>
    </label>

    <div id="customStatusModalGroup" style="display:none; margin-top:6px;">
      <label>
        –°–≤–æ–π —Å—Ç–∞—Ç—É—Å
        <input type="text" name="custom_status" id="customStatusModalInput">
      </label>
    </div>

    <label>
      –ù–∞—á–∞–ª–æ –¥–µ–π—Å—Ç–≤–∏—è
      <input type="datetime-local" name="status_start" id="statusStartModalInput">
    </label>

    <label>
      –û–∫–æ–Ω—á–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      <input type="datetime-local" name="status_end" id="statusEndModalInput">
    </label>

    <label>
      –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
      <textarea name="status_note" id="statusNoteModalInput" rows="2"></textarea>
    </label>

    <div class="form-actions">
      <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button"
              class="btn-secondary"
              onclick="closeStatusModal()">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </form>
</dialog>

<script>
  // –°–æ–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–∞—Ä—å —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ id
  window.statusData = {
    {% if well_status and well_status.grid %}
      {% for col in well_status.grid %}
        {% for st in col["items"] %}
          {{ st.id }}: {
            label: {{ (st.label or col.label)|tojson }},
            start: "{{ st.start.strftime('%Y-%m-%dT%H:%M') if st.start else '' }}",
            end: "{{ st.end.strftime('%Y-%m-%dT%H:%M') if st.end else '' }}",
            note: {{ (st.note or '')|tojson }}
          },
        {% endfor %}
      {% endfor %}
    {% endif %}
  };

  const allowedStatusList = {{ allowed_statuses|tojson }};

  function openStatusModal(statusId) {
    const dlg = document.getElementById('statusModal');
    const form = document.getElementById('statusForm');
    const title = document.getElementById('statusFormTitle');

    const statusSelect = document.getElementById('statusModalSelect');
    const customGroup  = document.getElementById('customStatusModalGroup');
    const customInput  = document.getElementById('customStatusModalInput');
    const startInput   = document.getElementById('statusStartModalInput');
    const endInput     = document.getElementById('statusEndModalInput');
    const noteInput    = document.getElementById('statusNoteModalInput');

    function updateCustomVisibility() {
      if (statusSelect.value === 'custom') {
        customGroup.style.display = '';
      } else {
        customGroup.style.display = 'none';
      }
    }
    statusSelect.onchange = updateCustomVisibility;

    if (statusId && window.statusData[statusId]) {
      // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å';
      form.action = '/well/{{ well.id }}/status/' + statusId + '/edit';

      const data = window.statusData[statusId];
      const label = data.label || '';

      if (allowedStatusList.indexOf(label) !== -1) {
        statusSelect.value = label;
        customInput.value = '';
      } else {
        statusSelect.value = 'custom';
        customInput.value = label;
      }

      startInput.value = data.start || '';
      endInput.value   = data.end || '';
      noteInput.value  = data.note || '';
    } else {
      // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
      title.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å';
      form.action = '/well/{{ well.id }}/status';

      statusSelect.value = allowedStatusList.length > 0
        ? allowedStatusList[0]
        : 'custom';
      customInput.value  = '';
      startInput.value   = '';
      endInput.value     = '';
      noteInput.value    = '';
    }

    updateCustomVisibility();
    dlg.showModal();
  }

  function closeStatusModal() {
    document.getElementById('statusModal').close();
  }
</script>
{% endif %}
{# ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ö–ê–ù–ê–õ–ê –°–í–Ø–ó–ò ==== #}
{% if is_admin %}
<dialog id="channelModal">
  <form id="channelForm" method="post">
    <h3 id="channelFormTitle">–ö–∞–Ω–∞–ª —Å–≤—è–∑–∏</h3>

    <label>
      –ö–∞–Ω–∞–ª —Å–≤—è–∑–∏ (1‚Äì50)
      <input type="number" name="channel" id="channelInput" min="1" max="50" required>
    </label>

    <label>
      –î–∞—Ç–∞/–≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
      <input type="datetime-local" name="dt_start" id="channelStartInput">
    </label>

    <label>
      –î–∞—Ç–∞/–≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
      <input type="datetime-local" name="dt_end" id="channelEndInput">
    </label>

    <label>
      –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
      <textarea name="note" id="channelNoteInput" rows="2"></textarea>
    </label>

    <div class="form-actions">
      <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button"
              class="btn-secondary"
              onclick="closeChannelModal()">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </form>
</dialog>

<script>
  // –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–Ω–∞–ª–∞–º (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
  window.channelData = {
    {% for ch in channel_history %}
      {{ ch.id }}: {
        channel: {{ ch.channel }},
        dt_start: "{{ ch.started_at.strftime('%Y-%m-%dT%H:%M') if ch.started_at else '' }}",
        dt_end: "{{ ch.ended_at.strftime('%Y-%m-%dT%H:%M') if ch.ended_at else '' }}",
        note: {{ (ch.note or '')|tojson }}
      }{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  function openChannelModal(channelId) {
    const dlg   = document.getElementById('channelModal');
    const form  = document.getElementById('channelForm');
    const title = document.getElementById('channelFormTitle');

    const inpChannel = document.getElementById('channelInput');
    const inpStart   = document.getElementById('channelStartInput');
    const inpEnd     = document.getElementById('channelEndInput');
    const inpNote    = document.getElementById('channelNoteInput');

    if (channelId) {
      // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏';
      form.action = '/well/{{ well.id }}/channel/' + channelId + '/edit';

      const data = window.channelData[channelId];
      inpChannel.value = data.channel || '';
      inpStart.value   = data.dt_start || '';
      inpEnd.value     = data.dt_end || '';
      inpNote.value    = data.note || '';
    } else {
      // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
      title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏';
      form.action = '/well/{{ well.id }}/channel/add';

      inpChannel.value = '';
      inpStart.value   = '';
      inpEnd.value     = '';
      inpNote.value    = '';
    }

    dlg.showModal();
  }

  function closeChannelModal() {
    document.getElementById('channelModal').close();
  }
</script>
{% endif %}

{# ==== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø ==== #}

<dialog id="equipmentModal">
  <form id="equipmentForm" method="post">
    <h3 id="equipmentFormTitle">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</h3>

<label>
  –¢–∏–ø –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
  <select name="type_code" id="eqTypeInput" required>
    {% for eq_type in equipment_types %}
      <option value="{{ eq_type.code }}">{{ eq_type.label }}</option>
    {% endfor %}
  </select>
</label>

    <label>
      –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä
      <input type="text" name="serial_number" id="eqSerialInput">
    </label>


    <label>
  –î–∞—Ç–∞/–≤—Ä–µ–º—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  <input type="datetime-local" name="installed_at" id="eqInstalledInput">
</label>

<label>
  –î–∞—Ç–∞/–≤—Ä–µ–º—è –¥–µ–º–æ–Ω—Ç–∞–∂–∞
  <input type="datetime-local" name="removed_at" id="eqRemovedInput">
</label>

<label>
  –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
  <textarea name="note" id="eqNoteInput" rows="2"></textarea>
</label>

    <div class="form-actions">
      <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button type="button"
              class="btn-secondary"
              onclick="closeEquipmentModal()">
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </form>
</dialog>

<script>
  // –î–∞–Ω–Ω—ã–µ –ø–æ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—é –¥–ª—è —Ä–µ–∂–∏–º–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
  window.equipmentData = {
    {% for eq in equipment_history %}
      {{ eq.id }}: {
        type_code: "{{ eq.type_code }}",
        serial_number: {{ (eq.serial_number or '')|tojson }},
        installed_at: "{{ eq.installed_at.strftime('%Y-%m-%dT%H:%M') if eq.installed_at else '' }}",
        removed_at: "{{ eq.removed_at.strftime('%Y-%m-%dT%H:%M') if eq.removed_at else '' }}",
        note: {{ (eq.note or '')|tojson }}
      }{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  function openEquipmentModal(eqId) {
    const dlg   = document.getElementById('equipmentModal');
    const form  = document.getElementById('equipmentForm');
    const title = document.getElementById('equipmentFormTitle');

    const typeInput      = document.getElementById('eqTypeInput');
    const serialInput    = document.getElementById('eqSerialInput');
    const installedInput = document.getElementById('eqInstalledInput');
    const removedInput   = document.getElementById('eqRemovedInput');
    const noteInput      = document.getElementById('eqNoteInput');

    if (eqId) {
      // --- —Ä–µ–∂–∏–º –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
      title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
      form.action = '/well/{{ well.id }}/equipment/' + eqId + '/edit';

      const data = window.equipmentData[eqId];

      typeInput.value      = data.type_code || '';
      serialInput.value    = data.serial_number || '';
      installedInput.value = data.installed_at || '';
      removedInput.value   = data.removed_at || '';
      noteInput.value      = data.note || '';
    } else {
      // --- —Ä–µ–∂–∏–º –î–û–ë–ê–í–õ–ï–ù–ò–Ø ---
      title.textContent = '–î–æ–±–∞–≤–∏—Ç—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ';
      form.action = '/well/{{ well.id }}/equipment/add';

      typeInput.value      = '';
      serialInput.value    = '';
      installedInput.value = '';
      removedInput.value   = '';
      noteInput.value      = '';
    }

    dlg.showModal();
  }

  function closeEquipmentModal() {
    document.getElementById('equipmentModal').close();
  }
</script>

<script>
  // –ï—Å–ª–∏ —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É –∏ –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—É—Å—Ç–æ–µ ‚Äî
  // –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è
  (function () {
    const input = document.getElementById('noteTimeInput');
    if (!input) return;
    if (input.value) return;  // –∑–Ω–∞—á–∏—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å

    const now = new Date();
    const offset = now.getTimezoneOffset();
    now.setMinutes(now.getMinutes() - offset);
    input.value = now.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
  })();
</script>

{% if is_admin %}
<script>
  // ================== –ó–ê–ú–ï–¢–ö–ò ==================
  let selectedNoteId = null;

  function selectNote(id) {
    selectedNoteId = id;

    const rows = document.querySelectorAll('.note-row');
    rows.forEach((row) => {
      if (parseInt(row.dataset.noteId, 10) === id) {
        row.style.background = '#e5f0ff';
        row.style.borderColor = '#3b82f6';
      } else {
        row.style.background = '#ffffff';
        row.style.borderColor = '#e5e7eb';
      }
    });
  }

  function editSelectedNote() {
    if (!selectedNoteId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∑–∞–º–µ—Ç–∫—É.');
      return;
    }
    window.location.href =
      '/well/{{ well.id }}?edit_note=' + selectedNoteId + '#notes-card';
  }

  function deleteSelectedNote() {
    if (!selectedNoteId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∑–∞–º–µ—Ç–∫—É.');
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–ø–∏—Å—å?')) {
      return;
    }
    const form = document.getElementById('noteDeleteForm');
    form.action = '/well/{{ well.id }}/notes/' + selectedNoteId + '/delete';
    form.submit();
  }

  // ================== –ö–ê–ù–ê–õ–´ –°–í–Ø–ó–ò ==================
  let selectedChannelId = null;

  function selectChannel(id) {
    selectedChannelId = id;

    const rows = document.querySelectorAll('.channel-row');
    rows.forEach((row) => {
      if (parseInt(row.dataset.channelId, 10) === id) {
        row.style.background = '#e5f0ff';
      } else {
        row.style.background = '';
      }
    });
  }

  function editSelectedChannel() {
    if (!selectedChannelId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª.');
      return;
    }
    openChannelModal(selectedChannelId);
  }

  function deleteSelectedChannel() {
    if (!selectedChannelId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –∫–∞–Ω–∞–ª.');
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª?')) {
      return;
    }
    const form = document.getElementById('channelDeleteForm');
    form.action = '/well/{{ well.id }}/channel/' + selectedChannelId + '/delete';
    form.submit();
  }

  // ================== –û–ë–û–†–£–î–û–í–ê–ù–ò–ï ==================
  let selectedEquipmentId = null;

  function selectEquipment(id) {
    selectedEquipmentId = id;

    const rows = document.querySelectorAll('.equipment-row');
    rows.forEach((row) => {
      if (parseInt(row.dataset.equipmentId, 10) === id) {
        row.style.background = '#e5f0ff';
      } else {
        row.style.background = '';
      }
    });
  }

  function editSelectedEquipment() {
    if (!selectedEquipmentId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.');
      return;
    }
    openEquipmentModal(selectedEquipmentId);
  }

  function deleteSelectedEquipment() {
    if (!selectedEquipmentId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ.');
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ?')) {
      return;
    }
    const form = document.getElementById('equipmentDeleteForm');
    form.action = '/well/{{ well.id }}/equipment/' + selectedEquipmentId + '/delete';
    form.submit();
  }

  // ================== –°–¢–ê–¢–£–°–´ –°–ö–í–ê–ñ–ò–ù–´ ==================
  let selectedStatusId = null;

  function selectStatus(id) {
    selectedStatusId = id;

    const cards = document.querySelectorAll('.status-card--history');
    cards.forEach((card) => {
      if (parseInt(card.dataset.statusId, 10) === id) {
        card.style.outline = '2px solid #3b82f6';
        card.style.backgroundColor = 'rgba(59,130,246,0.08)';
      } else {
        card.style.outline = '';
        card.style.backgroundColor = '';
      }
    });
  }

  function editSelectedStatus() {
    if (!selectedStatusId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å—Ç–∞—Ç—É—Å.');
      return;
    }
    openStatusModal(selectedStatusId);
  }

  function deleteSelectedStatus() {
    if (!selectedStatusId) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ —Å—Ç–∞—Ç—É—Å.');
      return;
    }
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å?')) {
      return;
    }
    const form = document.getElementById('statusDeleteForm');
    form.action = '/well/{{ well.id }}/status/' + selectedStatusId + '/delete';
    form.submit();
  }
</script>
{% endif %}

{# JS-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π #}
<script>
  window.wellEventsData = {
    timelineInjections: {{ timeline_injections | tojson | safe }},
    timelineEvents: {{ timeline_events | tojson | safe }},
    reagentColors: {{ reagent_colors | tojson | safe }},
    eventColors: {{ event_colors | tojson | safe }},
    wellNumber: "{{ well_number }}",
  };
  // –°–µ—Ä–≤–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è UTC+5 (–ö—É–Ω–≥—Ä–∞–¥) –∫–∞–∫ naive ISO —Å—Ç—Ä–æ–∫–∞.
  // new Date() –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç –µ—ë –≤ TZ –±—Ä–∞—É–∑–µ—Ä–∞ ‚Äî –¢–û–ß–ù–û –¢–ê–ö –ñ–ï, –∫–∞–∫ event_time.
  // chart_sync.js –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏–π –ø–æ ¬´–ø–æ—Å–ª–µ–¥–Ω–∏–µ N –¥–Ω–µ–π¬ª.
  window.serverNowIso = "{{ server_now_iso }}";
  // wellEventsFiltered –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω chart_sync.js –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
</script>

<!-- Chart.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
<script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>

<!-- well_events_chart.js –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->

<!-- –°–∫—Ä–∏–ø—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞: –î–∞–≤–ª–µ–Ω–∏–µ LoRa + –°–æ–±—ã—Ç–∏—è Telegram -->
<script src="/static/js/synchronized_chart.js?v=25"></script>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ ŒîP (—Ä–∞–∑–Ω–∏—Ü–∞ –¥–∞–≤–ª–µ–Ω–∏–π) ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –æ—Å–Ω–æ–≤–Ω—ã–º -->
<script src="/static/js/delta_pressure_chart.js?v=14"></script>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞ –¥–µ–±–∏—Ç–∞ –≥–∞–∑–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –æ—Å–Ω–æ–≤–Ω—ã–º -->
<script src="/static/js/flow_rate_chart.js?v=5"></script>

<!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–±–∏—Ç–∞ –≤ –ø–ª–∏—Ç–∫—É -->
<script>
(function() {
  var tile = document.getElementById('tile-current-flow');
  var valEl = document.getElementById('tile-flow-value');
  var hintEl = document.getElementById('tile-flow-hint');
  if (!tile || !valEl) return;
  fetch('/api/flow-rate/summary/{{ well.id }}?days=1')
    .then(function(r) { return r.ok ? r.json() : null; })
    .then(function(d) {
      if (!d || d.error) return;
      var q = d.actual_avg_flow;
      if (q != null && q > 0) {
        valEl.textContent = q.toFixed(1);
        tile.style.display = '';
        if (hintEl) hintEl.textContent = '—Å—Ä–µ–¥–Ω–∏–π –∑–∞ 24—á';
      }
    })
    .catch(function() {});
})();
</script>

<!-- –°–∫—Ä–∏–ø—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–≤–ª–µ–Ω–∏–π -->
<script>
async function refreshPressureData() {
  const btn = document.getElementById('btn-pressure-refresh');
  const icon = document.getElementById('refresh-icon');
  if (!btn) return;

  btn.disabled = true;
  btn.style.opacity = '0.6';
  btn.style.cursor = 'wait';
  icon.style.animation = 'spin 1s linear infinite';

  // –î–æ–±–∞–≤–ª—è–µ–º CSS –∞–Ω–∏–º–∞—Ü–∏—é –µ—Å–ª–∏ –Ω–µ—Ç
  if (!document.getElementById('spin-style')) {
    const style = document.createElement('style');
    style.id = 'spin-style';
    style.textContent = '@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }';
    document.head.appendChild(style);
  }

  try {
    const resp = await fetch('/api/pressure/refresh?skip_sync=false', { method: 'POST' });
    const data = await resp.json();

    if (data.status === 'ok' && data.result && data.result.success) {
      btn.style.background = '#d1fae5';
      btn.style.borderColor = '#059669';
      btn.innerHTML = '<span>‚úÖ</span> –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞ ' + data.result.duration_sec + '—Å';
      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      setTimeout(() => location.reload(), 2000);
    } else if (data.status === 'already_running') {
      btn.innerHTML = '<span>‚è≥</span> –£–∂–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...';
      setTimeout(() => location.reload(), 5000);
    } else {
      btn.style.background = '#fef2f2';
      btn.style.borderColor = '#ef4444';
      btn.style.color = '#dc2626';
      const err = data.result?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
      btn.innerHTML = '<span>‚ùå</span> –û—à–∏–±–∫–∞';
      console.error('Refresh error:', err);
    }
  } catch (e) {
    btn.style.background = '#fef2f2';
    btn.style.borderColor = '#ef4444';
    btn.style.color = '#dc2626';
    btn.innerHTML = '<span>‚ùå</span> –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
    console.error('Refresh fetch error:', e);
  }

  icon.style.animation = '';
  btn.disabled = false;
  btn.style.cursor = 'pointer';
  btn.style.opacity = '1';
}
</script>
{# ==============================================================================
   –î–û–ë–ê–í–ò–¢–¨ –í well.html –ü–ï–†–ï–î –ó–ê–ö–†–´–í–ê–Æ–©–ò–ú {% endblock %}
   (–ø–æ—Å–ª–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
   ============================================================================== #}

{# ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ù–ê–°–¢–†–û–ô–ö–ò –¶–í–ï–¢–û–í ========== #}
<dialog id="colorModalWell" style="
  border: none;
  border-radius: 12px;
  padding: 0;
  max-width: 600px;
  width: 90%;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
">
  <div style="
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 20px;
    border-radius: 12px 12px 0 0;
    color: white;
  ">
    <h3 style="margin: 0; font-size: 20px; font-weight: 700;">
      üé® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ –≥—Ä–∞—Ñ–∏–∫–∞
    </h3>
  </div>

  <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
    <div id="colorInputsWell"></div>
  </div>

  <div style="
    display: flex;
    gap: 10px;
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
    border-top: 1px solid #dee2e6;
  ">
    <button
      onclick="saveColorsWell()"
      style="
        flex: 1;
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      "
      onmouseover="this.style.background='#218838'"
      onmouseout="this.style.background='#28a745'"
    >
      ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
    </button>
    <button
      onclick="closeColorSettingsWell()"
      style="
        flex: 1;
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      "
      onmouseover="this.style.background='#5a6268'"
      onmouseout="this.style.background='#6c757d'"
    >
      ‚úó –û—Ç–º–µ–Ω–∞
    </button>
  </div>
</dialog>

<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
#colorModalWell::backdrop {
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
}

#colorModalWell[open] {
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
#colorInputsWell::-webkit-scrollbar {
  width: 8px;
}

#colorInputsWell::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

#colorInputsWell::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}

#colorInputsWell::-webkit-scrollbar-thumb:hover {
  background: #555;
}
</style>
<!--
=<!--
===========================================
–î–û–î–ê–¢–ò –í –ö–Ü–ù–ï–¶–¨ well.html (–ø–µ—Ä–µ–¥ </body>)
===========================================
-->

<!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –î–õ–Ø –ü–ï–†–ï–í–û–î–£ –û–ë–õ–ê–î–ù–ê–ù–ù–Ø -->
<div id="transfer-equipment-modal" style="
    display:none;
    position:fixed;
    top:0; left:0; right:0; bottom:0;
    background:rgba(0,0,0,0.5);
    z-index:1000;
    align-items:center;
    justify-content:center;
">
  <div style="
    background:white;
    border-radius:12px;
    padding:24px;
    width:90%;
    max-width:420px;
    box-shadow:0 8px 30px rgba(0,0,0,0.2);
  ">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h3 style="margin:0; font-size:16px; color:#374151;">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é —Å–∫–≤–∞–∂–∏–Ω—É</h3>
      <button onclick="closeTransferModal()" style="border:none; background:none; font-size:20px; cursor:pointer; color:#9ca3af;">&times;</button>
    </div>
    <div id="transfer-equipment-name" style="font-size:13px; color:#6b7280; margin-bottom:16px;"></div>
    <form onsubmit="submitTransfer(event)">
      <input type="hidden" id="transfer-equipment-id" value="">
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">–¶–µ–ª–µ–≤–∞—è —Å–∫–≤–∞–∂–∏–Ω–∞</label>
        <select id="transfer-target-well" required style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–≤–∞–∂–∏–Ω—É...</option>
          {% for w in all_wells|default([]) %}
            {% if w.id != well.id %}
            <option value="{{ w.id }}">{{ w.number }} ‚Äî {{ w.name or '' }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">–ú–µ—Å—Ç–æ —É—Å—Ç–∞–Ω–æ–≤–∫–∏</label>
        <select id="transfer-location" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
          <option value="">‚Äî –ù–µ –º–µ–Ω—è—Ç—å ‚Äî</option>
          <option value="–£—Å—Ç—å–µ">–£—Å—Ç—å–µ</option>
          <option value="–®–ª–µ–π—Ñ">–®–ª–µ–π—Ñ</option>
          <option value="–ù–ö–¢">–ù–ö–¢</option>
          <option value="–ó–∞—Ç—Ä—É–±">–ó–∞—Ç—Ä—É–±</option>
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label style="font-size:12px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
        <input type="datetime-local" id="transfer-datetime" style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="font-size:12px; font-weight:600; color:#374151; display:block; margin-bottom:4px;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
        <input type="text" id="transfer-notes" placeholder="–ü—Ä–∏—á–∏–Ω–∞ –ø–µ—Ä–µ–≤–æ–¥–∞..." style="width:100%; padding:8px 10px; border:1px solid #d1d5db; border-radius:6px; font-size:13px;">
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end;">
        <button type="button" onclick="closeTransferModal()" style="padding:8px 16px; border:1px solid #d1d5db; border-radius:6px; background:#f9fafb; cursor:pointer; font-size:13px; color:#374151;">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" id="transfer-submit-btn" style="padding:8px 16px; border:none; border-radius:6px; background:#3b82f6; color:white; cursor:pointer; font-size:13px; font-weight:600;">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –î–õ–Ø –í–°–¢–ê–ù–û–í–õ–ï–ù–ù–Ø –û–ë–õ–ê–î–ù–ê–ù–ù–Ø -->
<div id="install-equipment-modal" style="
    display:none;
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.5);
    z-index:2000;
    align-items:center;
    justify-content:center;
  ">
  <div style="
      background:white;
      padding:30px;
      border-radius:12px;
      max-width:600px;
      width:90%;
      max-height:80vh;
      overflow-y:auto;
    ">
    <h2 style="margin:0 0 20px 0;font-size:24px;">
      ‚ûï –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –Ω–∞ —Å–≤–µ—Ä–¥–ª–æ–≤–∏–Ω—É {{ well.number }}
    </h2>

    <form id="install-equipment-form" onsubmit="submitInstallForm(event)"
      method="post" action="/api/wells/15/install-equipment">

      <!-- –í–∏–±—ñ—Ä –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-weight:600;margin-bottom:8px;">
          –û–±–ª–∞–¥–Ω–∞–Ω–Ω—è *
        </label>
        <select name="equipment_id" required style="
            width:100%;
            padding:10px;
            border:1px solid #d1d5db;
            border-radius:6px;
            font-size:14px;
          ">
          <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è...</option>
          {% if available_equipment %}
            {% for eq in available_equipment %}
            <option value="{{ eq.id }}">
              {{ eq.equipment_type }} - {{ eq.name }} (SN: {{ eq.serial_number }})
              {% if eq.condition != 'working' %} - {{ eq.condition }}{% endif %}
            </option>
            {% endfor %}
          {% endif %}
        </select>
        {% if not available_equipment %}
          <p style="color:#dc2626;font-size:13px;margin-top:8px;">
            ‚ö†Ô∏è –ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è –Ω–∞ —Å–∫–ª–∞–¥—ñ.
            <a href="/equipment/add" target="_blank" style="color:#2563eb;">–î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ</a>
          </p>
        {% endif %}
      </div>

      <!-- –ú—ñ—Å—Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-weight:600;margin-bottom:8px;">
          –ú—ñ—Å—Ü–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è *
        </label>
        <select name="installation_location" required style="
            width:100%;
            padding:10px;
            border:1px solid #d1d5db;
            border-radius:6px;
            font-size:14px;
          ">
          <option value="">–í–∏–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ü–µ...</option>
          <option value="–£—Å—Ç—å–µ">üîß –£—Å—Ç—å–µ (—É—Å—Ç—å–æ–≤–µ –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è)</option>
          <option value="–ù–ö–¢">üìè –ù–ö–¢ (–Ω–∞—Å–æ—Å–Ω–æ-–∫–æ–º–ø—Ä–µ—Å–æ—Ä–Ω—ñ —Ç—Ä—É–±–∏)</option>
          <option value="–®–ª–µ–π—Ñ">üõ§Ô∏è –®–ª–µ–π—Ñ (—Ç—Ä—É–±–æ–ø—Ä–æ–≤—ñ–¥)</option>
          <option value="–ó–∞—Ç—Ä—É–±">üî© –ó–∞—Ç—Ä—É–± (–∑–∞—Ç—Ä—É–±–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä)</option>
          <option value="–Ü–Ω—à–µ">üì¶ –Ü–Ω—à–µ</option>
        </select>
      </div>

      <!-- –î–∞—Ç–∞ —ñ —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è (–ù–û–í–ï) -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-weight:600;margin-bottom:8px;">
          –î–∞—Ç–∞ —ñ —á–∞—Å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è *
        </label>
        <input type="datetime-local" name="installed_at" required
               style="
                 width:100%;
                 padding:10px;
                 border:1px solid #d1d5db;
                 border-radius:6px;
                 font-size:14px;
               ">
        <small style="color:#6b7280;font-size:12px;margin-top:4px;display:block;">
          –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø–æ—Ç–æ—á–Ω–∞ –¥–∞—Ç–∞ —ñ —á–∞—Å
        </small>
      </div>

      <!-- –ü—Ä–∏–º—ñ—Ç–∫–∏ -->
      <div style="margin-bottom:20px;">
        <label style="display:block;font-weight:600;margin-bottom:8px;">
          –ü—Ä–∏–º—ñ—Ç–∫–∏
        </label>
        <textarea name="notes" rows="3" style="
            width:100%;
            padding:10px;
            border:1px solid #d1d5db;
            border-radius:6px;
            font-size:14px;
            resize:vertical;
          " placeholder="–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è..."></textarea>
      </div>

      <!-- –°—Ç–≤–æ—Ä–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç -->
      <div style="margin-bottom:20px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" name="create_document" value="true">
          <span>–°—Ç–≤–æ—Ä–∏—Ç–∏ –∞–∫—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è</span>
        </label>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div style="display:flex;gap:10px;margin-top:30px;">
        <button type="button" onclick="closeInstallEquipmentModal()" style="
            flex:1;
            padding:12px;
            background:#6b7280;
            color:white;
            border:none;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
          ">
          –°–∫–∞—Å—É–≤–∞—Ç–∏
        </button>
        <button type="submit" style="
            flex:1;
            padding:12px;
            background:linear-gradient(135deg,#10b981 0%,#059669 100%);
            color:white;
            border:none;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
          ">
          ‚úì –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏
        </button>
      </div>
    </form>
  </div>
</div>

<!-- JAVASCRIPT -->
<script>
// –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É —ñ —á–∞—Å –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ –º–æ–¥–∞–ª—É
function showInstallEquipmentModal() {
  document.getElementById('install-equipment-modal').style.display = 'flex';

  // –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –ø–æ—Ç–æ—á–Ω—É –¥–∞—Ç—É —ñ —á–∞—Å
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hours = String(now.getHours()).padStart(2, '0');
  const minutes = String(now.getMinutes()).padStart(2, '0');

  const dateTimeValue = `${year}-${month}-${day}T${hours}:${minutes}`;
  const dateTimeInput = document.querySelector('input[name="installed_at"]');
  if (dateTimeInput) {
    dateTimeInput.value = dateTimeValue;
  }
}

function closeInstallEquipmentModal() {
  document.getElementById('install-equipment-modal').style.display = 'none';
  document.getElementById('install-equipment-form').reset();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–Ω—è—Ç–∏—è –æ–±–ª–∞–¥–Ω–∞–Ω–Ω—è —Å–æ —Å–∫–≤–∞–∂–∏–Ω—ã (–Ω–∞ —Å–∫–ª–∞–¥)
function removeEquipmentFromWell(equipmentId, equipmentName) {
  changeEquipmentStatus(equipmentId, equipmentName, 'available', '–°–Ω—è—Ç—å –Ω–∞ —Å–∫–ª–∞–¥');
}

// ‚îÄ‚îÄ Dropdown-–º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π ‚îÄ‚îÄ
function toggleEqMenu(btn) {
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
  document.querySelectorAll('.eq-action-menu').forEach(m => { m.style.display = 'none'; });
  var menu = btn.nextElementSibling;
  if (menu) menu.style.display = 'block';
}
// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
document.addEventListener('click', function() {
  document.querySelectorAll('.eq-action-menu').forEach(m => { m.style.display = 'none'; });
});

// ‚îÄ‚îÄ –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –¥—Ä—É–≥—É—é —Å–∫–≤–∞–∂–∏–Ω—É ‚îÄ‚îÄ
function openTransferModal(equipmentId, equipmentName) {
  document.querySelectorAll('.eq-action-menu').forEach(m => { m.style.display = 'none'; });
  document.getElementById('transfer-equipment-id').value = equipmentId;
  document.getElementById('transfer-equipment-name').textContent = equipmentName;
  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É/–≤—Ä–µ–º—è
  var now = new Date();
  now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
  document.getElementById('transfer-datetime').value = now.toISOString().slice(0, 16);
  document.getElementById('transfer-notes').value = '';
  document.getElementById('transfer-target-well').value = '';
  document.getElementById('transfer-location').value = '';
  document.getElementById('transfer-equipment-modal').style.display = 'flex';
}

function closeTransferModal() {
  document.getElementById('transfer-equipment-modal').style.display = 'none';
}

async function submitTransfer(event) {
  event.preventDefault();
  var equipmentId = document.getElementById('transfer-equipment-id').value;
  var targetWellId = document.getElementById('transfer-target-well').value;
  var transferAt = document.getElementById('transfer-datetime').value;
  var notes = document.getElementById('transfer-notes').value;

  if (!targetWellId) { alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–≤–∞–∂–∏–Ω—É'); return; }

  var btn = document.getElementById('transfer-submit-btn');
  btn.disabled = true;
  btn.textContent = '–ü–µ—Ä–µ–≤–æ–¥–∏–º...';

  var installLocation = document.getElementById('transfer-location').value;

  var formData = new FormData();
  formData.append('target_well_id', targetWellId);
  if (transferAt) formData.append('transfer_at', transferAt);
  if (notes) formData.append('notes', notes);
  if (installLocation) formData.append('installation_location', installLocation);

  try {
    var resp = await fetch('/api/equipment/' + equipmentId + '/transfer', { method: 'POST', body: formData });
    var result = await resp.json();
    if (result.success) {
      alert(result.message);
      location.reload();
    } else {
      alert('–û—à–∏–±–∫–∞: ' + (result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
      btn.disabled = false;
      btn.textContent = '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏';
    }
  } catch (err) {
    alert('–û—à–∏–±–∫–∞: ' + err.message);
    btn.disabled = false;
    btn.textContent = '–ü–µ—Ä–µ–≤–µ—Å—Ç–∏';
  }
}

// ‚îÄ‚îÄ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (—Ä–µ–º–æ–Ω—Ç, —Å–ª–æ–º–∞–Ω, —É—Ç–µ—Ä—è–Ω, –Ω–∞ —Å–∫–ª–∞–¥) ‚îÄ‚îÄ
async function changeEquipmentStatus(equipmentId, equipmentName, newStatus, statusLabel) {
  document.querySelectorAll('.eq-action-menu').forEach(m => { m.style.display = 'none'; });
  if (!confirm(statusLabel + ' "' + equipmentName + '"?')) return;

  var formData = new FormData();
  formData.append('new_status', newStatus);
  if (newStatus === 'maintenance') {
    formData.append('new_condition', 'needs_repair');
  } else if (newStatus === 'broken') {
    formData.append('new_condition', 'broken');
  } else if (newStatus === 'available') {
    formData.append('new_condition', 'working');
  }

  try {
    var resp = await fetch('/api/equipment/' + equipmentId + '/update_status', { method: 'POST', body: formData });
    if (resp.ok) {
      var result = await resp.json();
      alert(result.message || statusLabel + ' –≤—ã–ø–æ–ª–Ω–µ–Ω–æ');
      location.reload();
    } else {
      var error = await resp.json();
      alert('–û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (err) {
    alert('–û—à–∏–±–∫–∞: ' + err.message);
  }
}

function sendToRepair(equipmentId, equipmentName) {
  changeEquipmentStatus(equipmentId, equipmentName, 'maintenance', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–µ–º–æ–Ω—Ç');
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
document.getElementById('transfer-equipment-modal').addEventListener('click', function(e) {
  if (e.target === this) closeTransferModal();
});

async function submitInstallEquipment(event) {
  event.preventDefault();

  const form = event.target;
  const formData = new FormData(form);

  // Disable button
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è...';

  try {
    const response = await fetch('/api/wells/{{ well.id }}/install-equipment', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();

    if (result.success) {
      if (result.redirect) {
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–∫—Ç—É
        window.location.href = result.redirect;
      } else if (result.reload) {
        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
        alert('‚úÖ ' + result.message);
        window.location.reload();
      }
    } else {
      alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + (result.detail || result.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'));
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    }
  } catch (error) {
    alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

// –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—É –ø–æ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
document.getElementById('install-equipment-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeInstallEquipmentModal();
  }
});
</script>


<script>
// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
document.addEventListener('DOMContentLoaded', function() {
  const installForm = document.getElementById('install-equipment-form');
  if (installForm) {
    console.log('–ù–∞–π–¥–µ–Ω–∞ —Ñ–æ—Ä–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è, –∏—Å–ø—Ä–∞–≤–ª—è—é...');

    // 1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å action
    installForm.action = '/api/wells/' + {{ well.id }} + '/install-equipment';

    // 2. –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é submitInstallForm –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if (typeof submitInstallForm === 'function') {
      const originalSubmitInstallForm = submitInstallForm;

      window.submitInstallForm = function(event) {
        event.preventDefault();

        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è...');

        const form = document.getElementById('install-equipment-form');
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn ? submitBtn.textContent : '';

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        if (submitBtn) {
          submitBtn.textContent = '–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è...';
          submitBtn.disabled = true;
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å
        fetch(form.action, {
          method: 'POST',
          body: new FormData(form)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('HTTP error ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('–£—Å–ø–µ—Ö:', data);

          if (data.success) {
            // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('install-equipment-modal');
            if (modal) {
              modal.classList.remove('show');
              modal.style.display = 'none';
              document.body.classList.remove('modal-open');

              // –£–¥–∞–ª–∏—Ç—å backdrop
              const backdrop = document.querySelector('.modal-backdrop');
              if (backdrop) backdrop.remove();
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
            alert(data.message);

            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
            setTimeout(() => {
              window.location.reload();
            }, 800);
          } else {
            alert('–û—à–∏–±–∫–∞: ' + (data.error || data.detail));
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞:', error);
          alert('–û—à–∏–±–∫–∞: ' + error.message);
        })
        .finally(() => {
          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É
          if (submitBtn) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }
        });

        return false;
      };

      console.log('–§—É–Ω–∫—Ü–∏—è submitInstallForm –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞');
    }

    // 3. –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π onsubmit –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
    installForm.onsubmit = null;
    installForm.addEventListener('submit', function(event) {
      if (typeof submitInstallForm === 'function') {
        return submitInstallForm(event);
      }

      // –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞—à –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
      event.preventDefault();
      handleInstallEquipment();
      return false;
    });

    console.log('–§–æ—Ä–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞');
  }

  function handleInstallEquipment() {
    const form = document.getElementById('install-equipment-form');
    if (!form) return;

    fetch(form.action, {
      method: 'POST',
      body: new FormData(form)
    })
    .then(r => r.json())
    .then(data => {
      alert(data.message);
      setTimeout(() => window.location.reload(), 500);
    })
    .catch(err => alert('–û—à–∏–±–∫–∞: ' + err.message));
  }
});
</script>

{# ========== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–º —Å–æ–±—ã—Ç–∏–π + –∏—Å—Ç–æ—Ä–∏—è –∫–∞–Ω–∞–ª–æ–≤ ========== #}
<script>
(function() {
  const STORAGE_KEY = 'wellPageSettings';
  const defaults = { eventsChart: false, channelHistory: false };

  function loadSettings() {
    try { return { ...defaults, ...JSON.parse(localStorage.getItem(STORAGE_KEY)) }; }
    catch { return { ...defaults }; }
  }
  function saveSettings(s) { localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }

  const settings = loadSettings();

  // --- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ) ---
  const btnSettings = document.getElementById('btn-page-settings');
  const panel = document.getElementById('page-settings-panel');
  if (btnSettings && panel) {
    btnSettings.addEventListener('click', function(e) {
      e.stopPropagation();
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    });
    document.addEventListener('click', function(e) {
      if (!panel.contains(e.target) && e.target !== btnSettings) {
        panel.style.display = 'none';
      }
    });
  }

  // --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π ---
  const chk = document.getElementById('toggle-events-chart');
  const section = document.getElementById('events-chart-section');
  const headerToggle = document.getElementById('events-chart-toggle');

  let scriptLoaded = false;
  function applyEventsChart(enabled) {
    if (!section) return;
    section.style.display = enabled ? '' : 'none';
    if (chk) chk.checked = enabled;

    if (headerToggle) {
      const iconEl = document.getElementById('events-chart-toggle-icon');
      const textEl = document.getElementById('events-chart-toggle-text');
      if (iconEl) iconEl.textContent = enabled ? '\uD83D\uDC41\uFE0F' : '\uD83D\uDC41\uFE0F\u200D\uD83D\uDDE8\uFE0F';
      if (textEl) textEl.textContent = enabled ? '\u0421\u043a\u0440\u044b\u0442\u044c' : '\u041f\u043e\u043a\u0430\u0437\u0430\u0442\u044c';
    }

    if (enabled && !scriptLoaded) {
      scriptLoaded = true;
      const s = document.createElement('script');
      s.src = '/static/js/well_events_chart.js?v=4';
      document.body.appendChild(s);
    }
  }

  if (chk) {
    chk.addEventListener('change', function() {
      settings.eventsChart = chk.checked;
      saveSettings(settings);
      applyEventsChart(chk.checked);
    });
  }

  if (headerToggle) {
    headerToggle.addEventListener('click', function() {
      settings.eventsChart = false;
      saveSettings(settings);
      applyEventsChart(false);
    });
  }

  applyEventsChart(settings.eventsChart);

  // --- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∏—Å—Ç–æ—Ä–∏–∏ –∫–∞–Ω–∞–ª–æ–≤ ---
  const chkChannel = document.getElementById('toggle-channel-history');
  const channelSection = document.getElementById('channel-history-section');

  function applyChannelHistory(enabled) {
    if (!channelSection) return;
    channelSection.style.display = enabled ? '' : 'none';
    if (chkChannel) chkChannel.checked = enabled;
  }

  if (chkChannel) {
    chkChannel.addEventListener('change', function() {
      settings.channelHistory = chkChannel.checked;
      saveSettings(settings);
      applyChannelHistory(chkChannel.checked);
    });
  }

  applyChannelHistory(settings.channelHistory);
})();

// –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–±—ã—Ç–∏–π ‚Äî —Ç–æ–ª—å–∫–æ –ø–æ–ª–∑—É–Ω–æ–∫
(function() {
  var wrap = document.getElementById('events-scroll-wrapper');
  if (wrap) {
    wrap.addEventListener('wheel', function(e) { e.preventDefault(); }, { passive: false });
  }
})();
</script>

<script>
/* ‚îÄ‚îÄ Inline-edit: –¥–∏–∞–º–µ—Ç—Ä —à—Ç—É—Ü–µ—Ä–∞ ‚îÄ‚îÄ */
function chokeStartEdit() {
  document.getElementById('chokeDisplay').style.display = 'none';
  document.getElementById('chokeEditBtn').style.display = 'none';
  var editor = document.getElementById('chokeEditor');
  editor.style.display = 'inline-flex';
  document.getElementById('chokeInput').focus();
}
function chokeCancel() {
  document.getElementById('chokeDisplay').style.display = '';
  document.getElementById('chokeEditBtn').style.display = '';
  document.getElementById('chokeEditor').style.display = 'none';
}
function chokeSave() {
  var val = document.getElementById('chokeInput').value.trim();
  var choke = val ? parseFloat(val) : null;
  fetch('/api/well/{{ well.id }}/choke', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({choke_diam_mm: choke})
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (data.ok) {
      var display = document.getElementById('chokeDisplay');
      if (data.choke_diam_mm != null) {
        display.textContent = data.choke_diam_mm;
        display.style.color = '';
      } else {
        display.innerHTML = '<span style="color:#ef4444; font-size:12px;">–Ω–µ —É–∫–∞–∑–∞–Ω</span>';
      }
      chokeCancel();
    }
  })
  .catch(function(err) {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + err.message);
  });
}
/* Enter ‚Üí —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å */
document.getElementById('chokeInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') { e.preventDefault(); chokeSave(); }
  if (e.key === 'Escape') { e.preventDefault(); chokeCancel(); }
});
</script>
{% endblock %}