# –ü—Ä–æ–º—Ç: Telegram Mini App ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∞–≤–ª–µ–Ω–∏–π —Å–∫–≤–∞–∂–∏–Ω

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Telegram Mini App (WebApp) –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –¥–∞–≤–ª–µ–Ω–∏–π –≥–∞–∑–æ–≤—ã—Ö —Å–∫–≤–∞–∂–∏–Ω –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç —Å LoRa-–¥–∞—Ç—á–∏–∫–æ–≤ SMOD-PT-60 —á–µ—Ä–µ–∑ backend API.

---

## API Endpoints (Backend: FastAPI)

Base URL: `https://<host>/api/pressure`

### 1. –í—Å–µ —Å–∫–≤–∞–∂–∏–Ω—ã ‚Äî —Ç–µ–∫—É—â–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è

```
GET /api/pressure/latest
```

–û—Ç–≤–µ—Ç:
```json
{
  "wells": [
    {
      "well_id": 15,
      "well_name": "–°–∫–≤–∞–∂–∏–Ω–∞ 51",
      "well_number": "51",
      "p_tube": 16.80,
      "p_line": 16.70,
      "measured_at": "2026-02-12T13:46:51",
      "updated_at": "2026-02-12T13:48:06"
    }
  ]
}
```

**–í–∞–∂–Ω–æ:** `measured_at` –∏ `updated_at` ‚Äî UTC. –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–±–∞–≤–ª—è—Ç—å +5 —á–∞—Å–æ–≤.

### 2. –û–¥–Ω–∞ —Å–∫–≤–∞–∂–∏–Ω–∞ ‚Äî —Ç–µ–∫—É—â–∏–µ –¥–∞–≤–ª–µ–Ω–∏—è

```
GET /api/pressure/latest/{well_id}
```

–û—Ç–≤–µ—Ç:
```json
{
  "well_id": 15,
  "p_tube": 16.80,
  "p_line": 16.70,
  "measured_at": "2026-02-12T13:46:51"
}
```

### 3. –ü–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—ã—Ä—ã—Ö –∑–∞–º–µ—Ä–æ–≤ (–¥–ª—è popup/–¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)

```
GET /api/pressure/raw_last/{well_id}?n=15
```

–û—Ç–≤–µ—Ç:
```json
{
  "well_id": 15,
  "rows": [
    {"t": "18:52:51", "p_tube": 16.80, "p_line": 16.70},
    {"t": "18:51:51", "p_tube": 16.80, "p_line": null},
    {"t": "18:50:51", "p_tube": null,  "p_line": 16.70}
  ]
}
```

- –í—Ä–µ–º—è `t` —É–∂–µ –≤ UTC+5 (–ö—É–Ω–≥—Ä–∞–¥)
- `null` = –ø—Ä–æ–ø—É—Å–∫ –ø–∞–∫–µ—Ç–∞ –¥–∞—Ç—á–∏–∫–æ–º (–∞—Ä—Ç–µ—Ñ–∞–∫—Ç, –Ω–µ —Ä–µ–∞–ª—å–Ω—ã–π –Ω–æ–ª—å)
- –ù—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (0.0) —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã ‚Üí –ø—Ä–∏—Ö–æ–¥—è—Ç –∫–∞–∫ `null`

### 4. –ß–∞—Å–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤)

```
GET /api/pressure/hourly/{well_id}?days=7
GET /api/pressure/hourly/{well_id}?start=2026-02-01&end=2026-02-12
```

### 5. –î–µ—Ç–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (5-–º–∏–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã)

```
GET /api/pressure/chart/{well_id}?days=3
```

---

## –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### –ü—Ä–∞–≤–∏–ª–æ 1: –ù—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–∞—Ç—á–∏–∫–∞

LoRa-–¥–∞—Ç—á–∏–∫–∏ SMOD-PT-60 —Ç–µ—Ä—è—é—Ç ~4% –ø–æ–∫–∞–∑–∞–Ω–∏–π –∏ –ø–µ—Ä–µ–¥–∞—é—Ç `0.0` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
–†–µ–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ 0.0 –∞—Ç–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ –≥–∞–∑–æ–≤–æ–π —Å–∫–≤–∞–∂–∏–Ω–µ (—Ä–∞–±–æ—á–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è 10-40 –∞—Ç–º).

```
–ï–°–õ–ò p_tube == 0.0  ‚Üí —Å—á–∏—Ç–∞—Ç—å null (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
–ï–°–õ–ò p_line == 0.0  ‚Üí —Å—á–∏—Ç–∞—Ç—å null (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
–ï–°–õ–ò p_tube == null  ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî"
–ï–°–õ–ò p_line == null  ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî"
```

**API —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –Ω—É–ª–∏**, –Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã ‚Äî –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ —Ç–æ–∂–µ:

```javascript
function safeValue(v) {
  return (v !== null && v !== undefined && v !== 0.0) ? v : null;
}
```

### –ü—Ä–∞–≤–∏–ª–æ 2: –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–∞–Ω–∞–ª—ã

Tube (—É—Å—Ç—å–µ) –∏ Line (—à–ª–µ–π—Ñ) ‚Äî —ç—Ç–æ –î–í–ê –†–ê–ó–ù–´–• –¥–∞—Ç—á–∏–∫–∞. –û–Ω–∏ —Ç–µ—Ä—è—é—Ç –ø–∞–∫–µ—Ç—ã –ù–ï–ó–ê–í–ò–°–ò–ú–û.
–û–¥–∏–Ω –∫–∞–Ω–∞–ª –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å `null` –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

**–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**
- –ï—Å–ª–∏ `p_tube == null`, –∞ `p_line` –µ—Å—Ç—å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å line –Ω–æ—Ä–º–∞–ª—å–Ω–æ, tube = "‚Äî"
- –ï—Å–ª–∏ `p_line == null`, –∞ `p_tube` –µ—Å—Ç—å ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å tube –Ω–æ—Ä–º–∞–ª—å–Ω–æ, line = "‚Äî"
- –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–∫—Ä—ã–≤–∞—Ç—å –≤—Å—é —Å–∫–≤–∞–∂–∏–Ω—É –∏–∑-–∑–∞ –æ–¥–Ω–æ–≥–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∫–∞–Ω–∞–ª–∞
- ŒîP –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –æ–±–∞ –∫–∞–Ω–∞–ª–∞ –∏–º–µ—é—Ç –∑–Ω–∞—á–µ–Ω–∏–µ

### –ü—Ä–∞–≤–∏–ª–æ 3: –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ö—É–Ω–≥—Ä–∞–¥ (UTC+5)

```
measured_at –∏–∑ API ‚Üí UTC
–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: –≤—Ä–µ–º—è_–∫—É–Ω–≥—Ä–∞–¥ = measured_at + 5 —á–∞—Å–æ–≤
```

```javascript
function toKungrad(isoUtc) {
  const dt = new Date(isoUtc + 'Z');  // force UTC
  dt.setHours(dt.getHours() + 5);
  return dt;
}
```

### –ü—Ä–∞–≤–∏–ª–æ 4: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

```
–ï–°–õ–ò (now_utc - measured_at) > 1 —á–∞—Å  ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å "—É—Å—Ç–∞—Ä–µ–ª–æ" (–∂—ë–ª—Ç—ã–π)
–ï–°–õ–ò (now_utc - measured_at) > 24 —á–∞—Å–∞ ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å "–Ω–µ—Ç —Å–≤—è–∑–∏" (–∫—Ä–∞—Å–Ω—ã–π)
```

```javascript
function getAgeStatus(measuredAtUtc) {
  const ageMs = Date.now() - new Date(measuredAtUtc + 'Z').getTime();
  const ageHours = ageMs / 3600000;
  if (ageHours > 24) return { icon: 'üî¥', warning: '–ù–µ—Ç —Å–≤—è–∑–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º (>24—á)' };
  if (ageHours > 1)  return { icon: 'üü°', warning: `–î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ (${Math.floor(ageHours)}—á)` };
  return { icon: 'üîµ', warning: null };
}
```

### –ü—Ä–∞–≤–∏–ª–æ 5: –§–æ—Ä–º–∞—Ç —á–∏—Å–µ–ª

- –î–∞–≤–ª–µ–Ω–∏–µ: `%.2f –∞—Ç–º` (2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
- ŒîP = Ptr - Pshl (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å—Ç—å)
- –í—Ä–µ–º—è: `dd.mm HH:MM (+5)` ‚Äî –∫—É–Ω–≥—Ä–∞–¥—Å–∫–æ–µ

---

## UI: –ü–ª–∏—Ç–∫–∏ –¥–∞–≤–ª–µ–Ω–∏–π

### –†–∞–∑–º–µ—Ç–∫–∞ –æ–¥–Ω–æ–π –ø–ª–∏—Ç–∫–∏

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üîµ –°–∫–≤ 51 | –ö–∞–Ω–∞–ª 3        ‚îÇ
‚îÇ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‚îÇ
‚îÇ   Ptr:  16.80 –∞—Ç–º           ‚îÇ
‚îÇ   Pshl: 16.70 –∞—Ç–º           ‚îÇ
‚îÇ   ŒîP:    0.10 –∞—Ç–º           ‚îÇ
‚îÇ ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ ‚îÇ
‚îÇ ‚è± 12.02 17:53 (+5)          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –°–æ—Å—Ç–æ—è–Ω–∏—è

**–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ** (üîµ): –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–≤–µ–∂–∏–µ

**–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–æ—Ç–µ—Ä—è** ‚Äî –æ–¥–∏–Ω –∫–∞–Ω–∞–ª null:
```
üîµ –°–∫–≤ 128 | –ö–∞–Ω–∞–ª 7
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:  16.50 –∞—Ç–º
  Pshl:   ‚Äî
  ŒîP:     ‚Äî
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 12.02 17:49 (+5)
‚ö† Pshl: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
```

**–£—Å—Ç–∞—Ä–µ–≤—à–∏–µ** (üü°):
```
üü° –°–∫–≤ 4 | –ö–∞–Ω–∞–ª 4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:  33.70 –∞—Ç–º
  Pshl: 24.90 –∞—Ç–º
  ŒîP:    8.80 –∞—Ç–º
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 12.02 17:52 (+5)
‚ö† –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ (3—á)
```

**–ù–µ—Ç —Å–≤—è–∑–∏** (üî¥):
```
üî¥ –°–∫–≤ 4 | –ö–∞–Ω–∞–ª 4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:   ‚Äî
  Pshl:  ‚Äî
  ŒîP:    ‚Äî
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 10.02 14:12 (+5)
‚ö† –ù–µ—Ç —Å–≤—è–∑–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º (>24—á)
```

---

## UI: Popup –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏ (long press / tap-and-hold)

–ü—Ä–∏ **–¥–æ–ª–≥–æ–º –Ω–∞–∂–∞—Ç–∏–∏** (long press 500ms) –Ω–∞ –ø–ª–∏—Ç–∫—É –¥–∞–≤–ª–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å popup
—Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 15 —Å—ã—Ä—ã–º–∏ –∑–∞–º–µ—Ä–∞–º–∏. –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–æ—Ç–µ—Ä—å –ø–∞–∫–µ—Ç–æ–≤.

### –ó–∞–ø—Ä–æ—Å

```javascript
async function showRawPopup(wellId) {
  const res = await fetch(`/api/pressure/raw_last/${wellId}?n=15`);
  const data = await res.json();
  // data.rows = [{t: "18:52:51", p_tube: 16.80, p_line: 16.70}, ...]
}
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ popup

```
‚îå‚îÄ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 15 –∑–∞–º–µ—Ä–æ–≤ (UTC+5) ‚îÄ‚îê
‚îÇ                                  ‚îÇ
‚îÇ  –í—Ä–µ–º—è     Ptr      Pshl        ‚îÇ
‚îÇ  18:52:51  16.80    16.70       ‚îÇ
‚îÇ  18:51:51  16.80      ‚Äî         ‚îÇ  ‚Üê line –ø–æ—Ç–µ—Ä—è–ª –ø–∞–∫–µ—Ç
‚îÇ  18:50:51    ‚Äî      16.70       ‚îÇ  ‚Üê tube –ø–æ—Ç–µ—Ä—è–ª –ø–∞–∫–µ—Ç
‚îÇ  18:49:51  16.80    16.70       ‚îÇ
‚îÇ  ...                             ‚îÇ
‚îÇ                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –¶–≤–µ—Ç–æ–≤–∞—è –∫–æ–¥–∏—Ä–æ–≤–∫–∞ –≤ popup

| –ó–Ω–∞—á–µ–Ω–∏–µ | –¶–≤–µ—Ç | –ü—Ä–∏–º–µ—Ä |
|----------|------|--------|
| Ptr (–µ—Å—Ç—å) | –ó–µ–ª—ë–Ω—ã–π `#4ade80` | `16.80` |
| Pshl (–µ—Å—Ç—å) | –°–∏–Ω–∏–π `#60a5fa` | `16.70` |
| null (–ø–æ—Ç–µ—Ä—è) | –ö—Ä–∞—Å–Ω—ã–π `#ef4444` | `‚Äî` |

### Long press —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

```javascript
let pressTimer = null;

function onTouchStart(e, wellId) {
  pressTimer = setTimeout(() => {
    showRawPopup(wellId);
  }, 500);
}

function onTouchEnd() {
  clearTimeout(pressTimer);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ popup
function closePopup() {
  const popup = document.querySelector('.raw-popup');
  if (popup) popup.remove();
}
document.addEventListener('click', closePopup);
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏ (JavaScript)

```javascript
/**
 * –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–ª–∏—Ç–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API /api/pressure/latest.
 *
 * @param {Object} well - —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –º–∞—Å—Å–∏–≤–∞ wells
 * @returns {Object} –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞ –ø–ª–∏—Ç–∫–∏
 */
function buildTileData(well) {
  // –ü—Ä–∞–≤–∏–ª–æ 1: –Ω—É–ª–∏ ‚Üí null (API —É–∂–µ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç, –Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã)
  const pTube = safeValue(well.p_tube);
  const pLine = safeValue(well.p_line);

  // –ü—Ä–∞–≤–∏–ª–æ 2: ŒîP —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –∫–∞–Ω–∞–ª–∞ –µ—Å—Ç—å
  const pDiff = (pTube !== null && pLine !== null)
    ? Math.round((pTube - pLine) * 100) / 100
    : null;

  // –ü—Ä–∞–≤–∏–ª–æ 3: –≤—Ä–µ–º—è ‚Üí –ö—É–Ω–≥—Ä–∞–¥
  const measuredAt = well.measured_at;
  const kTime = measuredAt ? toKungrad(measuredAt) : null;
  const timeStr = kTime
    ? `${pad(kTime.getDate())}.${pad(kTime.getMonth()+1)} ${pad(kTime.getHours())}:${pad(kTime.getMinutes())}`
    : '‚Äî';

  // –ü—Ä–∞–≤–∏–ª–æ 4: —Å–≤–µ–∂–µ—Å—Ç—å
  const status = measuredAt ? getAgeStatus(measuredAt) : { icon: 'üî¥', warning: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö' };

  // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –∫–∞–Ω–∞–ª–∞—Ö
  let channelWarning = null;
  if (pTube === null && pLine !== null) channelWarning = '‚ö† Ptr: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  else if (pLine === null && pTube !== null) channelWarning = '‚ö† Pshl: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
  else if (pTube === null && pLine === null) channelWarning = '‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤';

  return {
    wellName: well.well_name || `–°–∫–≤ ${well.well_number}`,
    wellId: well.well_id,
    icon: status.icon,
    pTube, pLine, pDiff,
    timeStr,
    warning: status.warning,
    channelWarning,
  };
}

function safeValue(v) {
  return (v !== null && v !== undefined && v !== 0 && v !== 0.0) ? v : null;
}

function toKungrad(isoUtc) {
  const dt = new Date(isoUtc + (isoUtc.endsWith('Z') ? '' : 'Z'));
  return new Date(dt.getTime() + 5 * 3600000);
}

function pad(n) { return n < 10 ? '0' + n : '' + n; }

function fmtPressure(v) {
  return v !== null ? v.toFixed(2) + ' –∞—Ç–º' : '  ‚Äî';
}
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏ (Python ‚Äî –¥–ª—è Telegram bot message)

```python
from datetime import datetime, timedelta

def build_pressure_tile(well_name, channel, p_tube, p_line, measured_at):
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–ª–∏—Ç–∫–∏ –¥–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Telegram message.

    Args:
        well_name: "–°–∫–≤ 51"
        channel: 3 (–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª)
        p_tube: float –∏–ª–∏ None (–∏–∑ pressure_latest)
        p_line: float –∏–ª–∏ None
        measured_at: datetime (UTC)
    """
    # –ü—Ä–∞–≤–∏–ª–æ 1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω—É–ª–µ–π
    if p_tube is not None and p_tube == 0.0:
        p_tube = None
    if p_line is not None and p_line == 0.0:
        p_line = None

    # –ü—Ä–∞–≤–∏–ª–æ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    kungrad_time = measured_at + timedelta(hours=5) if measured_at else None

    # –ü—Ä–∞–≤–∏–ª–æ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è
    status_icon = "üîµ"
    warning = ""
    if measured_at:
        age_hours = (datetime.utcnow() - measured_at).total_seconds() / 3600
        if age_hours > 24:
            status_icon = "üî¥"
            warning = "‚ö† –ù–µ—Ç —Å–≤—è–∑–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º (>24—á)"
        elif age_hours > 1:
            status_icon = "üü°"
            warning = f"‚ö† –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ ({age_hours:.0f}—á)"

    # –ü—Ä–∞–≤–∏–ª–æ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    fmt = lambda v: f"{v:.2f} –∞—Ç–º" if v is not None else "  ‚Äî"

    # –ü—Ä–∞–≤–∏–ª–æ 2 (–∫–∞–Ω–∞–ª—ã): ŒîP —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –µ—Å—Ç—å
    p_diff = None
    if p_tube is not None and p_line is not None:
        p_diff = p_tube - p_line

    time_str = kungrad_time.strftime("%d.%m %H:%M") if kungrad_time else "‚Äî"

    lines = [
        f"{status_icon} {well_name} | –ö–∞–Ω–∞–ª {channel}",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        f"  Ptr:  {fmt(p_tube)}",
        f"  Pshl: {fmt(p_line)}",
        f"  ŒîP:   {fmt(p_diff)}",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        f"‚è± {time_str} (+5)",
    ]

    if warning:
        lines.append(warning)

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö
    if p_tube is None and p_line is not None:
        lines.append("‚ö† Ptr: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    elif p_line is None and p_tube is not None:
        lines.append("‚ö† Pshl: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    elif p_tube is None and p_line is None:
        lines.append("‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤")

    return "\n".join(lines)
```

---

## SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è Telegram –±–æ—Ç–∞ (–≤—Å–µ —Å–∫–≤–∞–∂–∏–Ω—ã)

```sql
SELECT
    w.id,
    w.name,
    -- –õ–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª: (csv_group - 1) * 5 + csv_channel
    (ls.csv_group - 1) * 5 + ls.csv_channel AS logical_channel,
    pl.p_tube,
    pl.p_line,
    pl.measured_at,
    pl.updated_at
FROM wells w
JOIN equipment_installation ei ON ei.well_id = w.id AND ei.removed_at IS NULL
JOIN equipment e ON e.id = ei.equipment_id
JOIN lora_sensors ls ON ls.serial_number = e.serial_number
LEFT JOIN pressure_latest pl ON pl.well_id = w.id
WHERE ls.csv_column = 'Ptr'  -- –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω—É (Ptr-–¥–∞—Ç—á–∏–∫)
ORDER BY w.name
```

**–í–∞–∂–Ω–æ:** JOIN —á–µ—Ä–µ–∑ `Ptr` –¥–∞—ë—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω—É. `p_tube` –∏ `p_line` —É–∂–µ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ `pressure_latest`.

---

## Backend: –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á—ë—Ç–∞ pressure_latest

Backend –æ–±–Ω–æ–≤–ª—è–µ—Ç `pressure_latest` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç. –ê–ª–≥–æ—Ä–∏—Ç–º –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞:

```
–î–ª—è –∫–∞–∂–¥–æ–π —Å–∫–≤–∞–∂–∏–Ω—ã:
  p_tube = AVG(tube) –∑–∞ 3 –º–∏–Ω –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ù–ï–ù–£–õ–ï–í–û–ì–û tube-–∑–∞–º–µ—Ä–∞
  p_line = AVG(line) –∑–∞ 3 –º–∏–Ω –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ù–ï–ù–£–õ–ï–í–û–ì–û line-–∑–∞–º–µ—Ä–∞
  measured_at = MAX(tube_timestamp, line_timestamp)
```

**–ü–æ—á–µ–º—É –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ–∫–Ω–∞:**
–î–∞—Ç—á–∏–∫–∏ tube –∏ line —Ç–µ—Ä—è—é—Ç –ø–∞–∫–µ—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ. –°–µ—Ä–∏—è –Ω—É–ª–µ–π –æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –º–æ–∂–µ—Ç –¥–ª–∏—Ç—å—Å—è 7-16 –º–∏–Ω—É—Ç, –ø–æ–∫–∞ –¥—Ä—É–≥–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –û–î–ù–û –æ–±—â–µ–µ –æ–∫–Ω–æ ‚Äî –∫–∞–Ω–∞–ª —Å –¥–ª–∏–Ω–Ω–æ–π NULL-—Å–µ—Ä–∏–µ–π –ø–æ–∫–∞–∂–µ—Ç `‚Äî`, —Ö–æ—Ç—è —É –Ω–µ–≥–æ –µ—Å—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º –æ–∫–Ω–µ.

```sql
-- SQLite: –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ 3-–º–∏–Ω –æ–∫–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
SELECT
    w.well_id,
    -- Tube: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ
    (SELECT AVG(r.p_tube)
     FROM pressure_readings r
     WHERE r.well_id = w.well_id
       AND r.p_tube IS NOT NULL AND r.p_tube != 0.0
       AND r.measured_at >= datetime(
           (SELECT MAX(r2.measured_at) FROM pressure_readings r2
            WHERE r2.well_id = w.well_id
              AND r2.p_tube IS NOT NULL AND r2.p_tube != 0.0),
           '-3 minutes')
    ) AS p_tube,
    -- Line: —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç tube)
    (SELECT AVG(r.p_line)
     FROM pressure_readings r
     WHERE r.well_id = w.well_id
       AND r.p_line IS NOT NULL AND r.p_line != 0.0
       AND r.measured_at >= datetime(
           (SELECT MAX(r2.measured_at) FROM pressure_readings r2
            WHERE r2.well_id = w.well_id
              AND r2.p_line IS NOT NULL AND r2.p_line != 0.0),
           '-3 minutes')
    ) AS p_line
FROM (SELECT DISTINCT well_id FROM pressure_readings
      WHERE measured_at >= datetime('now', '-1 hour')) w
```

---

## –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

| –ü–µ—Ä–∏–æ–¥ | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| –î–µ–Ω—å (07:00-22:00 UTC+5) | 5 –º–∏–Ω | –ê–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| –ù–æ—á—å (22:00-07:00 UTC+5) | 30 –º–∏–Ω | –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–≥–∞—é—â–∏–π —Ä–µ–∂–∏–º |

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `scripts/schedule_config.json`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è Mini App:** –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–ª–∏—Ç–∫–∏ –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ (`setInterval`), —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞:

```javascript
setInterval(async () => {
  const res = await fetch('/api/pressure/latest');
  const data = await res.json();
  data.wells.forEach(w => updateTile(w));
}, 60000);
```

---

## –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤ SMOD-PT-60

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| –ü–æ—Ç–µ—Ä—è –ø–∞–∫–µ—Ç–æ–≤ | ~4% (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è 0.0) |
| –°–µ—Ä–∏–∏ –Ω—É–ª–µ–π (—Ç–∏–ø–∏—á–Ω–æ) | 1-3 –º–∏–Ω—É—Ç—ã |
| –°–µ—Ä–∏–∏ –Ω—É–ª–µ–π (–º–∞–∫—Å–∏–º—É–º) | ~16 –º–∏–Ω—É—Ç |
| Tube –∏ Line | –¢–µ—Ä—è—é—Ç –ø–∞–∫–µ—Ç—ã –ù–ï–ó–ê–í–ò–°–ò–ú–û |
| –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ | 0.1 –∞—Ç–º |
| –î–∏–∞–ø–∞–∑–æ–Ω | 0-60 –∞—Ç–º |
| –†–∞–±–æ—á–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è | 10-40 –∞—Ç–º |
| –ò–Ω—Ç–µ—Ä–≤–∞–ª –∑–∞–º–µ—Ä–æ–≤ | 1 –º–∏–Ω—É—Ç–∞ |

---

## –ú–∞–ø–ø–∏–Ω–≥ well_id ‚Üí –Ω–∞–∑–≤–∞–Ω–∏–µ

–ù–µ –ø—É—Ç–∞—Ç—å ID —Å–∫–≤–∞–∂–∏–Ω—ã –∏ –µ—ë –Ω–æ–º–µ—Ä:

| well_id | –ù–∞–∑–≤–∞–Ω–∏–µ | –ù–æ–º–µ—Ä |
|---------|----------|-------|
| 3 | –°–∫–≤–∞–∂–∏–Ω–∞ 47 | 47 |
| 4 | –°–∫–≤–∞–∂–∏–Ω–∞ 61 | 61 |
| 6 | –°–∫–≤–∞–∂–∏–Ω–∞ 48 | 48 |
| 7 | –°–∫–≤–∞–∂–∏–Ω–∞ 5 | 5 |
| 15 | –°–∫–≤–∞–∂–∏–Ω–∞ 51 | 51 |
| 17 | –°–∫–≤–∞–∂–∏–Ω–∞ 128 | 128 |
| 18 | –°–∫–≤–∞–∂–∏–Ω–∞ 12 | 12 |
| 19 | –°–∫–≤–∞–∂–∏–Ω–∞ 60 | 60 |
| 20 | –°–∫–≤–∞–∂–∏–Ω–∞ 4 | 4 |

API `/api/pressure/latest` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `well_name` –∏ `well_number` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –∏—Ö, –∞ –Ω–µ well_id.
