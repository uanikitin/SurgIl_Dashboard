# –ü—Ä–æ–º—Ç: –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–≤–ª–µ–Ω–∏–π –Ω–∞ –ø–ª–∏—Ç–∫–∞—Ö (Telegram / Dashboard)

## –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `pressure_latest` (PostgreSQL)

```sql
SELECT well_id, measured_at, p_tube, p_line, updated_at
FROM pressure_latest
WHERE well_id = :well_id
```

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `well_id` | int | ID —Å–∫–≤–∞–∂–∏–Ω—ã (FK ‚Üí wells.id) |
| `measured_at` | datetime | –í—Ä–µ–º—è –∑–∞–º–µ—Ä–∞ (UTC) |
| `p_tube` | float | –î–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—å—è (Ptr), –∞—Ç–º |
| `p_line` | float | –î–∞–≤–ª–µ–Ω–∏–µ —à–ª–µ–π—Ñ–∞ (Pshl), –∞—Ç–º |
| `updated_at` | datetime | –ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å (UTC) |

–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (–¥–µ–Ω—å 07:00-22:00 –ö—É–Ω–≥—Ä–∞–¥) –∏–ª–∏ 30 –º–∏–Ω—É—Ç (–Ω–æ—á—å).

### –ü—Ä–∏–≤—è–∑–∫–∞ —Å–∫–≤–∞–∂–∏–Ω –∫ –¥–∞—Ç—á–∏–∫–∞–º

```sql
SELECT ei.well_id, w.name, ls.serial_number, ls.csv_column
FROM equipment_installation ei
JOIN equipment e ON e.id = ei.equipment_id
JOIN wells w ON w.id = ei.well_id
JOIN lora_sensors ls ON ls.serial_number = e.serial_number
WHERE ei.removed_at IS NULL
ORDER BY ei.well_id
```

`csv_column = 'Ptr'` ‚Äî —É—Å—Ç—å–µ–≤–æ–π –º–∞–Ω–æ–º–µ—Ç—Ä, `'Pshl'` ‚Äî —à–ª–µ–π—Ñ–æ–≤—ã–π.

---

## –ü—Ä–∞–≤–∏–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û)

### –ü—Ä–∞–≤–∏–ª–æ 1: –ù—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è = –∞—Ä—Ç–µ—Ñ–∞–∫—Ç –¥–∞—Ç—á–∏–∫–∞

LoRa-–¥–∞—Ç—á–∏–∫–∏ SMOD-PT-60 —Ç–µ—Ä—è—é—Ç ~4% –ø–æ–∫–∞–∑–∞–Ω–∏–π –∏ –ø–µ—Ä–µ–¥–∞—é—Ç `0.0` –≤–º–µ—Å—Ç–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
–†–µ–∞–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ 0.0 –∞—Ç–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞ –≥–∞–∑–æ–≤–æ–π —Å–∫–≤–∞–∂–∏–Ω–µ.

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è:**

```
–ï–°–õ–ò p_tube == 0.0 ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî" (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
–ï–°–õ–ò p_line == 0.0 ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî" (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
–ï–°–õ–ò p_tube IS NULL ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî" (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
–ï–°–õ–ò p_line IS NULL ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "‚Äî" (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)
```

–í SQL: `NULLIF(p_tube, 0.0)`, `NULLIF(p_line, 0.0)`

### –ü—Ä–∞–≤–∏–ª–æ 2: –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ö—É–Ω–≥—Ä–∞–¥ (UTC+5)

–í—Å–µ timestamps –≤ –ë–î —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ UTC.
–î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è: `–≤—Ä–µ–º—è_–∫—É–Ω–≥—Ä–∞–¥ = measured_at + 5 —á–∞—Å–æ–≤`

### –ü—Ä–∞–≤–∏–ª–æ 3: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ

```
–ï–°–õ–ò (now_utc - measured_at) > 1 —á–∞—Å ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å "—É—Å—Ç–∞—Ä–µ–ª–æ" (–∂—ë–ª—Ç—ã–π)
–ï–°–õ–ò (now_utc - measured_at) > 24 —á–∞—Å–∞ ‚Üí –ø–æ–º–µ—Ç–∏—Ç—å "–Ω–µ—Ç —Å–≤—è–∑–∏" (–∫—Ä–∞—Å–Ω—ã–π)
```

### –ü—Ä–∞–≤–∏–ª–æ 4: –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

- –î–∞–≤–ª–µ–Ω–∏–µ: `%.2f –∞—Ç–º` (2 –∑–Ω–∞–∫–∞ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π)
- –†–∞–∑–Ω–∏—Ü–∞: `ŒîP = Ptr - Pshl` (–ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å—Ç—å)
- –í—Ä–µ–º—è: `dd.mm HH:MM (+5)` ‚Äî –∫—É–Ω–≥—Ä–∞–¥—Å–∫–æ–µ

---

## –§–æ—Ä–º–∞—Ç –ø–ª–∏—Ç–∫–∏ (Telegram message)

```
üîµ –°–∫–≤ 51 | –ö–∞–Ω–∞–ª 3
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:  16.80 –∞—Ç–º
  Pshl: 16.70 –∞—Ç–º
  ŒîP:    0.10 –∞—Ç–º
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 12.02 17:53 (+5)
```

–ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

```
üîµ –°–∫–≤ 128 | –ö–∞–Ω–∞–ª 7
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:  16.50 –∞—Ç–º
  Pshl:   ‚Äî
  ŒîP:     ‚Äî
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 12.02 17:49 (+5)
‚ö† Pshl: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
```

–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏:

```
üü° –°–∫–≤ 4 | –ö–∞–Ω–∞–ª 4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  Ptr:  33.70 –∞—Ç–º
  Pshl: 24.90 –∞—Ç–º
  ŒîP:    8.80 –∞—Ç–º
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚è± 12.02 17:52 (+5)
‚ö† –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ (>1—á)
```

---

## –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–ª–∏—Ç–∫–∏

```python
from datetime import datetime, timedelta

def build_pressure_tile(well_name, channel, p_tube, p_line, measured_at):
    """
    –ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Ç–µ–∫—Å—Ç –ø–ª–∏—Ç–∫–∏ –¥–∞–≤–ª–µ–Ω–∏—è –¥–ª—è Telegram.

    Args:
        well_name: "–°–∫–≤ 51"
        channel: 3 (–ª–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª)
        p_tube: float –∏–ª–∏ None (–∏–∑ pressure_latest)
        p_line: float –∏–ª–∏ None
        measured_at: datetime (UTC)
    """
    # –ü—Ä–∞–≤–∏–ª–æ 1: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω—É–ª–µ–π
    if p_tube is not None and p_tube == 0.0:
        p_tube = None
    if p_line is not None and p_line == 0.0:
        p_line = None

    # –ü—Ä–∞–≤–∏–ª–æ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏
    kungrad_time = measured_at + timedelta(hours=5) if measured_at else None

    # –ü—Ä–∞–≤–∏–ª–æ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞—Ä–µ–≤–∞–Ω–∏—è
    age_hours = None
    status_icon = "üîµ"
    warning = ""
    if measured_at:
        age_hours = (datetime.utcnow() - measured_at).total_seconds() / 3600
        if age_hours > 24:
            status_icon = "üî¥"
            warning = "‚ö† –ù–µ—Ç —Å–≤—è–∑–∏ —Å –¥–∞—Ç—á–∏–∫–æ–º (>24—á)"
        elif age_hours > 1:
            status_icon = "üü°"
            warning = f"‚ö† –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ ({age_hours:.0f}—á)"

    # –ü—Ä–∞–≤–∏–ª–æ 4: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    fmt = lambda v: f"{v:.2f} –∞—Ç–º" if v is not None else "  ‚Äî"

    p_diff = None
    if p_tube is not None and p_line is not None:
        p_diff = p_tube - p_line

    time_str = kungrad_time.strftime("%d.%m %H:%M") if kungrad_time else "‚Äî"

    lines = [
        f"{status_icon} {well_name} | –ö–∞–Ω–∞–ª {channel}",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        f"  Ptr:  {fmt(p_tube)}",
        f"  Pshl: {fmt(p_line)}",
        f"  ŒîP:   {fmt(p_diff)}",
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ",
        f"‚è± {time_str} (+5)",
    ]

    if warning:
        lines.append(warning)

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
    if p_tube is None and p_line is not None:
        lines.append("‚ö† Ptr: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    elif p_line is None and p_tube is not None:
        lines.append("‚ö† Pshl: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
    elif p_tube is None and p_line is None:
        lines.append("‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö —Å –¥–∞—Ç—á–∏–∫–æ–≤")

    return "\n".join(lines)
```

---

## SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è Telegram –±–æ—Ç–∞ (–≤—Å–µ —Å–∫–≤–∞–∂–∏–Ω—ã —Å –¥–∞—Ç—á–∏–∫–∞–º–∏)

```sql
SELECT
    w.id,
    w.name,
    -- –õ–æ–≥–∏—á–µ—Å–∫–∏–π –∫–∞–Ω–∞–ª: (csv_group - 1) * 5 + csv_channel
    (ls.csv_group - 1) * 5 + ls.csv_channel AS logical_channel,
    pl.p_tube,
    pl.p_line,
    pl.measured_at,
    pl.updated_at
FROM wells w
JOIN equipment_installation ei ON ei.well_id = w.id AND ei.removed_at IS NULL
JOIN equipment e ON e.id = ei.equipment_id
JOIN lora_sensors ls ON ls.serial_number = e.serial_number
LEFT JOIN pressure_latest pl ON pl.well_id = w.id
WHERE ls.csv_column = 'Ptr'  -- –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω—É (Ptr-–¥–∞—Ç—á–∏–∫)
ORDER BY w.name
```

**–í–∞–∂–Ω–æ:** –û–¥–∏–Ω `JOIN` —á–µ—Ä–µ–∑ `Ptr` –¥–∞—ë—Ç –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –Ω–∞ —Å–∫–≤–∞–∂–∏–Ω—É. `p_tube` –∏ `p_line` —É–∂–µ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ `pressure_latest`.

---

## –ß–∞—Å—Ç–æ—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

| –ü–µ—Ä–∏–æ–¥ | –ò–Ω—Ç–µ—Ä–≤–∞–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|----------|
| –î–µ–Ω—å (07:00-22:00 UTC+5) | 5 –º–∏–Ω | –ê–∫—Ç–∏–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ |
| –ù–æ—á—å (22:00-07:00 UTC+5) | 30 –º–∏–Ω | –≠–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–≥–∞—é—â–∏–π —Ä–µ–∂–∏–º |

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: `scripts/schedule_config.json`

---

## –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –¥–∞—Ç—á–∏–∫–æ–≤ SMOD-PT-60

- –ü–æ—Ç–µ—Ä—è –ø–∞–∫–µ—Ç–æ–≤: ~4% (–ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è 0.0)
- –°–µ—Ä–∏–∏ –Ω—É–ª–µ–π: –æ–±—ã—á–Ω–æ 1-3 –º–∏–Ω, –º–∞–∫—Å–∏–º—É–º ~16 –º–∏–Ω
- Tube –∏ line –¥–∞—Ç—á–∏–∫–∏ —Ç–µ—Ä—è—é—Ç –ø–∞–∫–µ—Ç—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: 0.1 –∞—Ç–º
- –î–∏–∞–ø–∞–∑–æ–Ω: 0-60 –∞—Ç–º (—Ä–∞–±–æ—á–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è 10-40 –∞—Ç–º)
